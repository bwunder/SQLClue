/******************************************************************************
add ArchiveError
update node
remove QueryBaseLine 
make date locale agnostic
******************************************************************************/

ALTER TABLE [SQLCfg].[tArchiveLog]
ADD [ArchiveError] [VARCHAR] (MAX) SPARSE NULL

GO

/******************************************************************************
update node
******************************************************************************/

IF EXISTS (SELECT * from sys.indexes WHERE name = 'ixn_tChange_Node_i')
 DROP INDEX SQLCfg.tChange.ixn_tChange_Node_i
IF EXISTS (SELECT * from sys.indexes WHERE name = 'ixn_tChange_RecCreatedDt_i')
 DROP INDEX SQLCfg.tChange.ixn_tChange_RecCreatedDt_i
IF EXISTS (SELECT * from sys.indexes WHERE name = 'ixn_tChange_Version_i')
 DROP INDEX SQLCfg.tChange.ixn_tChange_Version_i
GO
IF OBJECT_ID('SQLCfg.fLastVersion') IS NOT NULL 
 DROP FUNCTION SQLCfg.fLastVersion

GO
-- if any of these are used they must be manuallky recreate after the upgrade is complete
-- they are all commented out in the instSQLClueRepository.sql - not created by default
IF OBJECT_ID('SQLCfg.GetCollection') IS NOT NULL 
 DROP FUNCTION SQLCfg.GetCollection
IF OBJECT_ID('SQLCfg.GetDatabase') IS NOT NULL 
 DROP FUNCTION SQLCfg.GetDatabase
IF OBJECT_ID('SQLCfg.GetInstance') IS NOT NULL 
 DROP FUNCTION SQLCfg.GetInstance
IF OBJECT_ID('SQLCfg.GetItem') IS NOT NULL 
 DROP FUNCTION SQLCfg.GetItem
IF OBJECT_ID('SQLCfg.GetLength') IS NOT NULL 
 DROP FUNCTION SQLCfg.GetLength
IF OBJECT_ID('SQLCfg.GetPath') IS NOT NULL 
 DROP FUNCTION SQLCfg.GetPath
IF OBJECT_ID('SQLCfg.GetSubType') IS NOT NULL 
 DROP FUNCTION SQLCfg.GetSubType

GO

IF EXISTS (SELECT * 
           FROM sys.triggers 
           WHERE parent_id = OBJECT_ID('SQLCfg.tChange')
           AND is_disabled = 0)
 ALTER TABLE SQLCfg.tChange
 DISABLE TRIGGER ALL

GO

IF NOT EXISTS (SELECT *
               FROM sys.columns
               WHERE object_id = OBJECT_ID('SQLCfg.tChange')
               AND name = 'savenode')
 ALTER TABLE SQLCfg.tChange
 ADD savenode NVARCHAR(512) 

GO

UPDATE SQLCfg.tChange
SET savenode = Node.ToString()

GO

IF NOT EXISTS (SELECT * 
               FROM SQLCfg.tChange 
               WHERE savenode <> Node.ToString())
 ALTER TABLE SQLCfg.tChange
 DROP COLUMN Node

GO

DROP TYPE SQLCfg.SQLCfgNode 

GO

DROP ASSEMBLY SQLClueCLR

GO
-- v1.4.1.1
  EXEC sp_executesql N'CREATE ASSEMBLY [SQLClueCLR]
AUTHORIZATION [dbo]
FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C0104001566164B0000000000000000E00002210B01080000260000000E0000000000009E45000000200000006000000000400000200000000200000400000000000000040000000000000000C00000000400008FDF0000020040850000100000100000000010000010000000000000100000000000000000000000444500005700000000800000C80800000000000000000000000000000000000000A000000C000000006000001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000A4250000002000000026000000040000000000000000000000000000200000602E736461746100008E0000000060000000020000002A0000000000000000000000000000400000C02E72737263000000C808000000800000000A0000002C0000000000000000000000000000400000402E72656C6F6300000C00000000A00000000200000036000000000000000000000000000040000042000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080450000000000004800000002000500DC2B00006819000009000000000000000000000000000000502000008000000000000000000000000000000000000000000000000000000000000000000000006A170090FE1AAD18E69D74742F00D15A3EC66ABB1627E5187C961D2E4D69532346991D9B7F1F1213D308F194A1EC584AC689637FCD704FCC948411E9D205408DF515A94DD7191BD65A75CD7C0FD368587A6DB447CA7D2CA605D4525AFD6453C5E9D8A38308ED3BBE6F6EACC11BCBE08059B247928EBEDF8EC564D46463EFE42D133001002500000001000011000228020000062C0A72010000700A2B122B0F00027B030000046F0400000A0A2B0100062A000000133001000C0000000200001100027B020000040A2B00062A133002001700000003000011001200FE15020000021200177D02000004060B2B00072A0013300500B807000004000011000F00280500000A2C0B28030000060A38A1070000001201FE150200000212010F00FE16040000016F0600000A7D03000004120112017B03000004178D0A0000010C08161F7C9D086F0700000A7D04000004120112017B040000048EB77D070000040012017B04000004169A0D0009720B00007016280800000A16404E02000000120172290000707D05000004120112017B04000004179A7D0A0000040012017B0A0000041304001104723B00007016280800000A16333600120172590000707D08000004120172590000707D090000041201725B0000707D060000041201725B0000707D0C00000438DA010000001104726B00007016280800000A16334200120172970000707D06000004120112017B04000004189A7D08000004120112017B04000004199A7D09000004120112017B04000004199A7D0C000004388701000000110472B300007016280800000A16334200120172C90000707D06000004120112017B04000004189A7D08000004120112017B04000004199A7D09000004120112017B04000004199A7D0C000004383401000000110472DB00007016280800000A16333E00120172FF0000707D06000004120112017B04000004189A7D08000004120172590000707D09000004120112017B04000004189A7D0C00000438E5000000001104721301007016280800000A16333E00120172350100707D06000004120112017B04000004189A7D08000004120172590000707D09000004120112017B04000004189A7D0C0000043896000000001104724301007016280800000A16333B00120172690100707D06000004120112017B04000004189A7D08000004120172590000707D09000004120112017B04000004189A7D0C0000042B4A001104727F01007016280800000A16333900120172A10100707D06000004120112017B04000004189A7D08000004120172590000707D09000004120112017B04000004189A7D0C0000040038BA04000000120172B30100707D05000004120112017B04000004169A7D08000004120172350100707D06000004120172590000707D09000004120172590000707D0A000004120172590000707D0B000004120172590000707D0C00000412017B040000048EB7173315120112017B04000004169A7D0C000004383F0400000012017B04000004179A72CB01007016280800000A16FE0112017B04000004179A72EB01007016280800000A16FE016012017B04000004179A720702007016280800000A16FE016012017B04000004179A722702007016280800000A16FE016012017B04000004179A723F02007016280800000A16FE016012017B04000004179A724902007016280800000A16FE016012017B04000004179A726302007016280800000A16FE016012017B04000004179A728502007016280800000A16FE016012017B04000004179A729702007016280800000A16FE01602C15120112017B04000004179A7D0C000004384F03000012017B04000004179A72B302007016280800000A16FE0112017B04000004179A72CF02007016280800000A16FE016012017B04000004179A72DD02007016280800000A16FE016012017B04000004179A72F502007016280800000A16FE016012017B04000004179A722303007016280800000A16FE016012017B04000004179A723703007016280800000A16FE016012017B04000004179A725303007016280800000A16FE016012017B04000004179A726103007016280800000A16FE016012017B04000004179A726D03007016280800000A16FE016012017B04000004179A72A103007016280800000A16FE016012017B04000004179A72B303007016280800000A16FE01602C32120112017B04000004179A7D0A00000412017B040000048EB7193310120112017B04000004189A7D0C00000400381402000012017B04000004179A72FF00007016280800000A16408900000012017B040000048EB7183312120112017B04000004179A7D0C0000042B6500120172FF0000707D0600000412017B04000004189A72DB03007016280800000A163312120112017B04000004189A7D0C0000042B1100120112017B04000004189A7D0A0000040012017B040000048EB71A3310120112017B04000004199A7D0C0000040000387101000012017B04000004179A72F303007016280800000A16405701000012017B040000048EB7183315120112017B04000004179A7D0A000004383501000012017B040000048EB7193325120112017B04000004179A7D0A000004120112017B04000004189A7D0C000004380401000000120172C90000707D06000004120112017B04000004189A7D0900000412017B04000004199A72CB01007016280800000A16FE0112017B04000004199A720704007016280800000A16FE01602C15120112017B04000004199A7D0C00000438A000000012017B04000004199A729700007016280800000A16335B12017B040000048EB71A3312120112017B04000004199A7D0C0000042B3A00120172970000707D06000004120112017B040000041A9A7D0A00000412017B040000048EB71C3310120112017B040000041B9A7D0C00000400002B2E00120112017B04000004199A7D0A00000412017B040000048EB71B3310120112017B040000041A9A7D0C000004000000000000120112017B03000004722704007012017B0C000004280900000A72590000706F0A00000A7D0B000004070A2B00062A3E0002036F0B00000A7D03000004002A420003027B030000046F0C00000A00002A000000133001001E0000000500001100027B03000004280D00000A28040000060B12017B070000040A2B00062A0000133001001E0000000600001100027B03000004280D00000A28040000060B12017B050000040A2B00062A0000133001001E0000000700001100027B03000004280D00000A28040000060B12017B060000040A2B00062A0000133001001E0000000800001100027B03000004280D00000A28040000060B12017B080000040A2B00062A0000133001001E0000000900001100027B03000004280D00000A28040000060B12017B090000040A2B00062A0000133001001E0000000A00001100027B03000004280D00000A28040000060B12017B0A0000040A2B00062A0000133004005C0000000B00001100027B03000004280D00000A28040000060B12017B0A000004725900007016280800000A16FE0116FE01027B03000004280D00000A28040000060C12027B0C000004725900007016280800000A16FE015F2D03162B01170A2B00062A133001001E0000000C00001100027B03000004280D00000A28040000060B12017B0B0000040A2B00062A0000133001001E0000000D00001100027B03000004280D00000A28040000060B12017B0C0000040A2B00062A00002602281100000A00002A000013300100120000000E000011000F00280C000006280D00000A0A2B00062A000013300100120000000F000011000F00280B000006280D00000A0A2B00062A0000133001001200000010000011000F00280F000006280D00000A0A2B00062A0000133001001200000011000011000F00280E000006280D00000A0A2B00062A0000133001001200000012000011000F00280A000006280D00000A0A2B00062A0000133001001200000013000011000F002809000006280D00000A0A2B00062A0000133001001200000014000011000F002807000006281200000A0A2B00062A000042534A4201000100000000000C00000076322E302E35303732370000000005006C0000009C050000237E000008060000B005000023537472696E677300000000B80B00002C04000023555300E40F0000100000002347554944000000F40F00007409000023426C6F620000000000000002000001571FA2030900000000FA0133001600000100000020000000030000000C000000170000000A0000000200000022000000010000001900000014000000010000000B0000000B00000003000000010000000300000000009F0501000000000006005B0054000E00860071000E00AB0090000E00450171000600610157010600750157010600500254000E00A30271000600B60254000600BD0254000A00EF02C8020E002D0390000E00490390000600500354000E006603900006008C0379030E00A90390000600BE0379034B00D203000006000104E10306002104E103060051043F0406007F046E040600C004A1040600CE04A1040600E20454000600F8043F04060013053F0406002E053F04060047053F04060060053F0406007D053F0400000000010000000000010001000921000029003400050001000100010000003F0034001D000D0010005180BC0013000100C2001F000100C90013000100D00022000100DA0013000100E10013000100EB0026000100F400130001000201130001000D01130001001A011300010021011300D020000000004602280129000100042100000000660B31012D0001001C210000000016083C013100010040210000000016004F013600010004290000000066036E013D000200142900000000660382014300030028290000000006088A0149000400542900000000060895012900040080290000000006089E0129000400AC29000000000608AA0129000400D829000000000608BA0129000400042A000000000608C70129000400302A000000000608D6012D000400982A000000000608E70129000400C42A000000000608F00129000400F02A00000000061857025E000400FC2A0000000016005D02620004001C2B0000000016007002620005003C2B0000000016007C02620006005C2B0000000016008402620007007C2B0000000016008C02620008009C2B000000001600980262000900BC2B000000001600AC0269000A00000001005501000001007301000001008801000001006B02000001006B02000001006B02000001006B02000001006B02000001006B02000001006B020200090002000D00110031012D0019006E013D00190082014300490028012900210031012D003900280129004900C2027F005900F9028600490007038D0049000E03930029001603290031008201A40021002103A90061005702C300710057025E00790057025E00390057025E00410021036502810057025E00890057025E0091005702C807A1005702CE07A90057025E00B1005702A400B9005702A400C1005702A400C9005702D307D1005702D307D9005702A400E1005702A400E9005702A400F1005702A400F9005702A40001015702A4000E00040016002000830018012E00B30083082E00BB008C082E00130167092E00AB007A082E00E300E8082E000B0134092E00CB00B8082E00D300BE082E00DB00B8082E00C300AB082E00EB00B8082E00F300EE082E00FB0016092E000301230943007300C90080008300180100029B0070022002A30075024002A3003B036002A300FF038002A300BF04A002A3007F05C002A3004306E002A30006077000740078009900AF00B500B500B500B500B500BB00B500B5006002600260026002600260026B02020001000000F9014D0000000002510000000502560000000C025A00000011025A00000019025A00000025025A0000002E025A00000039024D00000046025A0000004B025A00020002000300020003000500020007000700020008000900020009000B0002000A000D0002000B000F0002000C00110002000D00130002000E00150002000F00170002000400030002000A00050002000C00070004800000010004000100010001000000D8079405000002000000000000000000000001000A00000000000800000000000000000000000A0013000000000002000000000000000000000001006500000000000000003C4D6F64756C653E006D73636F726C6962004D6963726F736F66742E56697375616C42617369630053514C4366674E6F64650053514C4367664E6F64650055736572446566696E656446756E6374696F6E730053797374656D0056616C7565547970650053797374656D2E446174610053797374656D2E446174612E53716C547970657300494E756C6C61626C65004D6963726F736F66742E53716C5365727665722E536572766572004942696E61727953657269616C697A65005F4E554C4C006D5F4E756C6C006D5F4E6F6465006D5F537472696E6773006D5F54797065006D5F53756254797065006D5F4C656E677468006D5F53514C496E7374616E6365006D5F4461746162617365006D5F436F6C6C656374696F6E006D5F50617468006D5F4974656D00546F537472696E67006765745F49734E756C6C006765745F4E756C6C0053716C537472696E6700506172736500730053797374656D2E494F0042696E617279526561646572005265616400720042696E6172795772697465720057726974650077006765745F4C656E677468006765745F54797065006765745F53756254797065006765745F53514C496E7374616E6365006765745F4461746162617365006765745F436F6C6C656374696F6E006765745F4973436F6C6C656374696F6E006765745F50617468006765745F4974656D0049734E756C6C004E756C6C004C656E677468005479706500537562547970650053514C496E7374616E636500446174616261736500436F6C6C656374696F6E004973436F6C6C656374696F6E0050617468004974656D004F626A656374002E63746F7200476574436F6C6C656374696F6E004E6F6465004765744461746162617365004765744974656D004765745061746800476574496E7374616E636500476574537562547970650053716C496E743332004765744C656E67746800537472696E6700436861720053706C6974004D6963726F736F66742E56697375616C42617369632E436F6D70696C65725365727669636573004F70657261746F727300436F6D70617265537472696E6700436F6E636174005265706C6163650052656164537472696E67006F705F496D706C696369740053716C55736572446566696E65645479706541747472696275746500466F726D61740053657269616C697A61626C654174747269627574650053716C4D6574686F644174747269627574650053797374656D2E446961676E6F73746963730044656275676765724E6F6E55736572436F64654174747269627574650053716C46756E6374696F6E4174747269627574650044656275676761626C6541747472696275746500446562756767696E674D6F6465730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C6974794174747269627574650053797374656D2E5265666C656374696F6E00417373656D626C7946696C6556657273696F6E4174747269627574650053797374656D2E5265736F7572636573004E65757472616C5265736F75726365734C616E67756167654174747269627574650053797374656D2E52756E74696D652E496E7465726F705365727669636573004775696441747472696275746500436F6D56697369626C6541747472696275746500434C53436F6D706C69616E7441747472696275746500417373656D626C7954726164656D61726B41747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F6D70616E7941747472696275746500417373656D626C794465736372697074696F6E41747472696275746500417373656D626C795469746C654174747269627574650053514C436C7565434C520053514C436C7565434C522E646C6C00000000094E0055004C004C00001D530051004C004300660067004D00650074006100640061007400610000114D006500740061006400610074006100001D530051004C004300660067002E007400530051004C004300660067000001000F4C006900630065006E0073006500002B530051004C004300660067002E0074005300650072007600690063006500420072006F006B0065007200001B5300650072007600690063006500420072006F006B00650072000015530051004C004300660067002E007400440062000011440061007400610062006100730065000023530051004C004300660067002E0074004A006F00620053006500720076006500720000134A006F0062005300650072007600650072000021530051004C004300660067002E00740049006E007300740061006E0063006500000D5300650072007600650072000025530051004C004300660067002E00740043006F006E006E0065006300740069006F006E00001543006F006E006E0065006300740069006F006E000021530051004C004300660067002E0074005300630068006500640075006C00650000115300630068006500640075006C0065000017530051004C0049006E007300740061006E0063006500001F4100630074006900760065004400690072006500630074006F0072007900001B43006F006E00660069006700750072006100740069006F006E00001F460075006C006C0054006500780074005300650072007600690063006500001749006E0066006F0072006D006100740069006F006E0000094D00610069006C000019500072006F00780079004100630063006F0075006E00740000215200650073006F00750072006300650047006F007600650072006E006F0072000011530065007400740069006E0067007300001B5400610072006700650074005300650072007600650072007300001B4200610063006B00750070004400650076006900630065007300000D4100750064006900740073000017430072006500640065006E007400690061006C007300002D430072007900700074006F006700720061007000680069006300500072006F00760069006400650072007300001345006E00640070006F0069006E0074007300001B4C0069006E006B00650064005300650072007600650072007300000D4C006F00670069006E007300000B52006F006C0065007300003353006500720076006500720041007500640069007400530070006500630069006600690063006100740069006F006E0073000011540072006900670067006500720073000027550073006500720044006500660069006E00650064004D006500730073006100670065007300001741006C00650072007400530079007300740065006D000013440061007400610062006100730065007300001F440061007400610062006100730065004F007000740069006F006E00730000037C000000408F099CFC29CF44AB60809A082E839F0008B77A5C561934E08908B03F5F7F11D50A3A02060E084E0055004C004C0002060203061D0E0206080320000E0320000204000011080600011108111105200101121505200101121903200008032800020408001108032800080328000E0320000106000111111108060001112111080307010E03070102060702110811080620011D0E1D03060003080E0E020500020E0E0E0520020E0E0E0A0705110811081D030E0E042001010E05000111110E0507020811080507020E110807070302110811080520010111354E010002000000040054020D4973427974654F7264657265640154020D497346697865644C656E6774680054080B4D61784279746553697A6500030000540E044E616D650A53514C4366674E6F646581460100040054020F497344657465726D696E697374696301540209497350726563697365015455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054557F4D6963726F736F66742E53716C5365727665722E5365727665722E53797374656D446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038391053797374656D446174614163636573730000000004070111110500011121080407011121040100000080C4010004005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E69737469630154020949735072656369736501540E044E616D650D476574436F6C6C656374696F6E80C2010004005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E69737469630154020949735072656369736501540E044E616D650B476574446174616261736580BE010004005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E69737469630154020949735072656369736501540E044E616D65074765744974656D80BE010004005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E69737469630154020949735072656369736501540E044E616D65074765745061746880C2010004005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E69737469630154020949735072656369736501540E044E616D650B476574496E7374616E636580C1010004005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E69737469630154020949735072656369736501540E044E616D650A4765745375625479706580C0010004005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E69737469630154020949735072656369736501540E044E616D65094765744C656E67746805200101114D0420010108042001010280A00024000004800000940000000602000000240000525341310004000001000100399F902A59B25D05A2415FEF2B54121D451200DA894C0265DC6EE75DA7E618C25B36A056E6E52EAF4C076E32497F4C3173C0E661AD4F90A9EBFE1849BB3C02FBBD3096098DEF03636CEF6DADDF9DFA290D810BA87F26A4C71DAD19921FD902F3462B084DAA51E763697B5B7094DA2FC4BA4B8A42E61A1D7CC8FD51834B21F1BB0801000301000000000801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010C010007312E342E312E3100000501000000002901002462343736313261632D666636662D343034652D623536362D316132396533623733643236000005010001000027010022436F7079726967687420C2A92042696C6C2057756E64657220323030372D3230313000000C01000753514C436C756500001001000B42696C6C2057756E64657200003201002D53514C436C756520436F6E66696775726174696F6E204172636869766520434C5220496E746567726174696F6E0000090100044E6F646500000000006C45000000000000000000008E450000002000000000000000000000000000000000000000000000804500000000000000000000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF25002040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001566164B0000000002000000720000001C6000001C2A0000525344531E092383E22CC440B5B24438FD1BDA7D01000000433A5C55736572735C62696C6C5C446F63756D656E74735C56697375616C2053747564696F20323030385C50726F6A656374735C53514C436C75655C4E6F64655C6F626A5C44656275675C53514C436C7565434C522E70646200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030003000000280000800E000000480000801000000060000080000000000000000000000000000002000200000078000080030000009000008000000000000000000000000000000100007F0000A80000800000000000000000000000000000010001000000C00000800000000000000000000000000000010000000000D80000000000000000000000000000000000010000000000E80000000000000000000000000000000000010000000000F800000000000000000000000000000000000100000000000801000090840000E8020000000000000000000078870000280100000000000000000000A088000022000000000000000000000018810000780300000000000000000000780334000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100040001000100010004000100010001003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004D8020000010053007400720069006E006700460069006C00650049006E0066006F000000B4020000010030003000300030003000340062003000000074002E00010043006F006D006D0065006E00740073000000530051004C0043006C0075006500200043006F006E00660069006700750072006100740069006F006E0020004100720063006800690076006500200043004C005200200049006E0074006500670072006100740069006F006E00000038000C00010043006F006D00700061006E0079004E0061006D00650000000000420069006C006C002000570075006E006400650072000000340005000100460069006C0065004400650073006300720069007000740069006F006E00000000004E006F006400650000000000300008000100460069006C006500560065007200730069006F006E000000000031002E0034002E0031002E003100000040000F00010049006E007400650072006E0061006C004E0061006D0065000000530051004C0043006C007500650043004C0052002E0064006C006C00000000006800220001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A9002000420069006C006C002000570075006E00640065007200200032003000300037002D003200300031003000000048000F0001004F0072006900670069006E0061006C00460069006C0065006E0061006D0065000000530051004C0043006C007500650043004C0052002E0064006C006C0000000000300008000100500072006F0064007500630074004E0061006D00650000000000530051004C0043006C00750065000000340008000100500072006F006400750063007400560065007200730069006F006E00000031002E0034002E0031002E003100000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0034002E0031002E0031000000280000002000000040000000010004000000000080020000000000000000000000000000000000000000000000008000008000000080800080000000800080008080000080808000C0C0C0000000FF0000FF000000FFFF00FF000000FF00FF00FFFF0000FFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007777777777777777777777777777700444444444444444444444444444447004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF4700488888888888888888888888888847004444444444444444444444444444470044C4C4C4C4C4C4C4C4C4ECECE49747004CCCCCCCCCCCCCCCCCCCCCCCCCCC40000444444444444444444444444444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFC00000018000000180000001800000018000000180000001800000018000000180000001800000018000000180000001800000018000000180000001800000018000000180000001800000018000000180000001800000018000000180000003C0000007FFFFFFFFFFFFFFFFFFFFFFFF2800000010000000200000000100040000000000C0000000000000000000000000000000000000000000000000008000008000000080800080000000800080008080000080808000C0C0C0000000FF0000FF000000FFFF00FF000000FF00FF00FFFF0000FFFFFF000000000000000000077777777777777744444444444444474FFFFFFFFFFFF8474FFFFFFFFFFFF8474FFFFFFFFFFFF8474FFFFFFFFFFFF8474FFFFFFFFFFFF8474FFFFFFFFFFFF8474FFFFFFFFFFFF8474FFFFFFFFFFFF84748888888888888474CCCCCCCCCCCCC47C4444444444444C000000000000000000000000000000000FFFF000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000FFFF0000FFFF00000000010002002020100001000400E802000002001010100001000400280100000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000C000000A03500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
WITH PERMISSION_SET = SAFE';
   EXEC sp_executesql N'ALTER ASSEMBLY [SQLClueCLR]
ADD FILE FROM 0x4D6963726F736F667420432F432B2B204D534620372E30300D0A1A445300000000020000020000002B000000D8000000000000002A000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000C0FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF3800000000F8FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0BCA3101380000000010000000100000000000001100FFFF04000000038000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000942E31011566164B010000001E092383E22CC440B5B24438FD1BDA7D000000000000000001000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000BCA310138000000001000000010000000000000FFFFFFFF040000000380000000000000FFFFFFFF00000000FFFFFFFF00000000FFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B8D0123A6CC2D011B44200A0244A1DD2C4454B99E9E6D211903F00C04FA302A10B9D865A1166D311BD2A0000F80849BD60A66E40CF64824CB6F042D48172A7991000000000000000FE10A9CD41A6B4BD1C07DB7A291D807500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B8D0123A6CC2D011B44200A0244A1DD2C4454B99E9E6D211903F00C04FA302A10B9D865A1166D311BD2A0000F80849BD60A66E40CF64824CB6F042D48172A79910000000000000007C9682B7222640465DC22541A92E121E00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B8D0123A6CC2D011B44200A0244A1DD2C4454B99E9E6D211903F00C04FA302A10B9D865A1166D311BD2A0000F80849BD60A66E40CF64824CB6F042D48172A7991000000000000000D32E3D5F9F6E1DF5BE60DBE9D242CB2200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B8D0123A6CC2D011B44200A0244A1DD2C4454B99E9E6D211903F00C04FA302A10B9D865A1166D311BD2A0000F80849BD60A66E40CF64824CB6F042D48172A79910000000000000003B85414835B83BE89E5616C1B4E19657000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E909000000000000E9090000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FEEFFEEF01000000310200000031376431346635632D613333372D343937382D383238312D353334393333373863313037312E76620000433A5C55736572735C62696C6C5C446F63756D656E74735C56697375616C2053747564696F20323030385C50726F6A656374735C53514C436C75655C4E6F64655C4D792050726F6A6563745C417373656D626C79496E666F2E766200633A5C75736572735C62696C6C5C646F63756D656E74735C76697375616C2073747564696F20323030385C70726F6A656374735C73716C636C75655C6E6F64655C6D792070726F6A6563745C617373656D626C79696E666F2E766200433A5C55736572735C62696C6C5C446F63756D656E74735C56697375616C2053747564696F20323030385C50726F6A656374735C53514C436C75655C4E6F64655C53514C4366674E6F64652E766200633A5C75736572735C62696C6C5C646F63756D656E74735C76697375616C2073747564696F20323030385C70726F6A656374735C73716C636C75655C6E6F64655C73716C6366676E6F64652E766200433A5C55736572735C62696C6C5C446F63756D656E74735C56697375616C2053747564696F20323030385C50726F6A656374735C53514C436C75655C4E6F64655C53514C4366674E6F646546756E6374696F6E732E766200633A5C75736572735C62696C6C5C646F63756D656E74735C76697375616C2073747564696F20323030385C70726F6A656374735C73716C636C75655C6E6F64655C73716C6366676E6F646566756E6374696F6E732E7662000B000000000000002A0000000000000001000000000000002B0000008700000081010000E300000032010000D9010000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001BE2300104010000008BFA1C5073CA010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000006000000010000002B0000000000000032010000280000001BE230014B8E5B1758000000E30000002A0000003201000065000000000000000000000001000000280000001BE23001F3AA9CDE58000000010000002A0000000100000065000000000000000000000087000000280000001BE2300162DB7A9E580000002B0000002A00000087000000650000000000000000000000D9010000280000001BE23001AB4540FE58000000810100002A000000D90100006500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000032002A1100000000640100000000000025000000000000000000000001000006000000000100000000546F537472696E670000001600031104000000600100002500000000000000010000001200241140463A53797374656D2E5465787400002200241140463A4D6963726F736F66742E53716C5365727665722E5365727665720000001A00241140463A53797374656D2E446174612E53716C5479706573000E00241140463A53797374656D0000000E0024112A53514C4367664E6F646500320024114050583A786D6C3D687474703A2F2F7777772E77332E6F72672F584D4C2F313939382F6E616D657370616365000000002A0024114050583A786D6C6E733D687474703A2F2F7777772E77332E6F72672F323030302F786D6C6E732F000A0024114050583A3D0000000E00241153514C4367664E6F646500001E00201100000000010000110000000000000000546F537472696E6700000000020006000200060032002A1100000000F4010000000000000C0000000000000000000000020000062500000001000000006765745F49734E756C6C001600031168010000F00100000C00000025000000010000000E0024112831303036363332393700000E0024114031303036363332393700001A0020110000000002000011000000000000000049734E756C6C0000020006000200060032002A11000000009C02000000000000170000000000000000000000030000063100000001000000006765745F4E756C6C00000016000311F8010000980200001700000031000000010000000E0024112831303036363332393700000E0024114031303036363332393700001600201100000000030000110000000000000000680000001A002011010000000300001100000000000000004E756C6C0000000002000600020006002E002A1100000000AC03000000000000B80700000000000000000000040000064800000001000000005061727365000016000311A0020000A8030000B807000048000000010000000E0024112831303036363332393700000E0024114031303036363332393700001A0020110000000004000011000000000000000050617273650000001600201101000000040000110000000000000000750000002200201102000000040000110000000000000400564224745F61727261792453300000002200201103000000040000110000000000000400564224745F737472696E67244C3000002200201104000000040000110000000000000400564224745F737472696E67244C31000002000600020006002E002A11000000001C040000000000000F0000000000000000000000050000060008000001000000005265616400000016000311B0030000180400000F00000000080000010000000E0024112831303036363332393700000E00241140313030363633323937000002000600020006002E002A11000000008C04000000000000100000000000000000000000060000060F080000010000000057726974650000160003112004000088040000100000000F080000010000000E0024112831303036363332393700000E002411403130303636333239370000020006000200060032002A110000000040050000000000001E0000000000000000000000070000061F08000001000000006765745F4C656E6774680016000311900400003C0500001E0000001F080000010000000E0024112831303036363332393700000E0024114031303036363332393700001A002011000000000500001100000000000000004C656E67746800002200201101000000050000110000000000000400564224745F7374727563742453300000020006000200060032002A1100000000F4050000000000001E0000000000000000000000080000063D08000001000000006765745F547970650000001600031144050000F00500001E0000003D080000010000000E0024112831303036363332393700000E0024114031303036363332393700001A0020110000000006000011000000000000000054797065000000002200201101000000060000110000000000000400564224745F7374727563742453300000020006000200060036002A1100000000AC060000000000001E0000000000000000000000090000065B08000001000000006765745F537562547970650000000016000311F8050000A80600001E0000005B080000010000000E0024112831303036363332393700000E0024114031303036363332393700001A0020110000000007000011000000000000000053756254797065002200201101000000070000110000000000000400564224745F737472756374245330000002000600020006003A002A11000000006C070000000000001E00000000000000000000000A0000067908000001000000006765745F53514C496E7374616E63650000000016000311B0060000680700001E00000079080000010000000E0024112831303036363332393700000E0024114031303036363332393700001E0020110000000008000011000000000000000053514C496E7374616E6365002200201101000000080000110000000000000400564224745F7374727563742453300000020006000200060036002A110000000028080000000000001E00000000000000000000000B0000069708000001000000006765745F44617461626173650000001600031170070000240800001E00000097080000010000000E0024112831303036363332393700000E0024114031303036363332393700001E002011000000000900001100000000000000004461746162617365000000002200201101000000090000110000000000000400564224745F7374727563742453300000020006000200060036002A1100000000E4080000000000001E00000000000000000000000C000006B508000001000000006765745F436F6C6C656374696F6E00160003112C080000E00800001E000000B5080000010000000E0024112831303036363332393700000E0024114031303036363332393700001E002011000000000A0000110000000000000000436F6C6C656374696F6E000022002011010000000A0000110000000000000400564224745F737472756374245330000002000600020006003A002A1100000000CC090000000000005C00000000000000000000000D000006D308000001000000006765745F4973436F6C6C656374696F6E00000016000311E8080000C80900005C000000D3080000010000000E0024112831303036363332393700000E00241140313030363633323937000022002011000000000B00001100000000000000004973436F6C6C656374696F6E0000000022002011010000000B0000110000000000000400564224745F737472756374245330000022002011020000000B0000110000000000000400564224745F7374727563742453310000020006000200060032002A1100000000800A0000000000001E00000000000000000000000E0000062F09000001000000006765745F5061746800000016000311D00900007C0A00001E0000002F090000010000000E0024112831303036363332393700000E0024114031303036363332393700001A002011000000000C0000110000000000000000506174680000000022002011010000000C0000110000000000000400564224745F7374727563742453300000020006000200060032002A1100000000340B0000000000001E00000000000000000000000F0000064D09000001000000006765745F4974656D00000016000311840A0000300B00001E0000004D090000010000000E0024112831303036363332393700000E0024114031303036363332393700001A002011000000000D00001100000000000000004974656D0000000022002011010000000D0000110000000000000400564224745F73747275637424533000000200060002000600F20000006C0000000000000001000100250000000000000007000000600000000000000026000080010000002700008009000000280000801300000029000080140000002A000080220000002B000080230000002C0000800500330009001A000D00190009000D000D00260009000F0005001100F20000003C00000025000000010001000C000000000000000300000030000000000000002F00008001000000300000800A0000003100008009000C000D001A0009001000F2000000540000003100000001000100170000000000000005000000480000000000000035000080010000003600008009000000370000801100000038000080150000003900008009000C00110031000D001C000D00150009001000F2000000DC0500004800000001000100B8070000000000007B000000D0050000000000004000008001000000410000800A00000042000080150000004300008016000000440000801E000000450000803200000046000080520000004700008062000000480000806D000000EEEFFE808000000049000080810000004B0000808D0000004C0000809D0000004D000080A7000000EEEFFE80B80000004E000080B90000004F000080C500000050000080D100000051000080DD00000052000080EE000000EEEFFE80FF0000005300008000010000540000800C010000550000801C010000560000802C0100005700008041010000EEEFFE80520100005800008053010000590000805F0100005A0000806F0100005B0000807F0100005C00008094010000EEEFFE80A50100005D000080A60100005E000080B20100005F000080C201000060000080CE01000061000080E3010000EEEFFE80F401000062000080F501000063000080010200006400008011020000650000801D0200006600008032020000EEEFFE80430200006700008044020000680000805002000069000080600200006A0000806C0200006B0000807E020000EEEFFE808F0200006C000080900200006D0000809C0200006E000080AC0200006F000080B802000070000080C802000071000080CE02000072000080CF02000073000080DB02000074000080EB02000076000080F70200007700008003030000780000800F030000790000801B0300007A000080270300007B000080330300007C000080480300007D000080490300007F0000882204000089000080370400008A00008A400500009600008050050000970000805C050000980000806C05000099000080720500009A0000808C0500009C000080980500009D000080AA0500009E000080AB050000A0000080B7050000A1000080CE050000A2000080E0050000A3000080E1050000A4000080F1050000A5000080F2050000A6000080FE050000A70000800E060000A80000800F060000A900008015060000AA0000802F060000AC0000803B060000AD00008050060000AE0000805C060000B00000806C060000B100008081060000B200008082060000B40000808E060000B50000809E060000B7000081CF060000B9000080E4060000BA000080FB060000BD00008007070000BE00008019070000BF0000801A070000C100008026070000C200008036070000C300008042070000C400008052070000C500008053070000C600008056070000C700008057070000C900008067070000CA00008073070000CB00008083070000CC00008084070000CD00008085070000CE00008086070000CF00008087070000D000008088070000D100008089070000D2000080B2070000D3000080B6070000D400008005004500090019000D00180009000F000D002D0009001E00090031000900280009002300010002000D002700110026001100300011002B000100020015002A0019002D0019002A001900300019002D000100020015003100190036001900390019003600190032000100020015002600190031001900390019003600190032000100020015002D00190032001900390019002A00190032000100020015002C0019002F001900390019002A00190032000100020015002E00190033001900390019002A00190032000100020015002C00190031001900390019002A001900320011001B000D001600110029001100310011002700110022001100240011001E0011001E0011002F0015002E001100150015003D00190032001500430019003800190037001D00360019001F0015003D00190037001D00360019001D001D0036001D00430021003A001D002100210040001D0023001D003B0021003A001D00230019001F0015003D00190037001D003C0019003B001D003C001D00360019001D001D0035001D003A001D00470021003A001D00490021003F0025003E00210025002500420025004400250043002900420025002B00210027001D0021002100400021003F0025003E00210027001D00230019001F0015001B001100170009001300090038000900110005001100F20000003C00000000080000010001000F00000000000000030000003000000000000000D600008001000000D80000800D000000D90000800500370009001E0005000C00F20000003C0000000F080000010001001000000000000000030000003000000000000000DB00008001000000DD0000800E000000DE000080050038000900180005000C00F20000003C0000001F080000010001001E00000000000000030000003000000000000000E100008001000000E20000801C000000E300008009000C000D002C0009001000F20000003C0000003D080000010001001E00000000000000030000003000000000000000E700008001000000E80000801C000000E900008009000C000D002A0009001000F20000003C0000005B080000010001001E00000000000000030000003000000000000000ED00008001000000EF0000801C000000F000008009000C000D002D0009001000F20000003C00000079080000010001001E00000000000000030000003000000000000000F400008001000000F50000801C000000F600008009000C000D00310009001000F20000003C00000097080000010001001E00000000000000030000003000000000000000FA00008001000000FB0000801C000000FC00008009000C000D002E0009001000F20000003C000000B5080000010001001E000000000000000300000030000000000000000001008001000000010100801C0000000201008009000C000D00300009001000F20000003C000000D3080000010001005C000000000000000300000030000000000000000601008001000000070100805A0000000801008009000C000D006C0009001000F20000003C0000002F090000010001001E000000000000000300000030000000000000000C010080010000000D0100801C0000000E01008009000C000D002A0009001000F20000003C0000004D090000010001001E000000000000000300000030000000000000001201008001000000130100801C0000001401008009000C000D002A0009001000F400000008000000E300000000000000780000000000000018000000300000004C000000640000007C00000094000000A8000000C0000000D4000000EC0000000001000018010000340100004C010000640100007C01000098010000B0010000D0010000E8010000040200001C0200003C02000054020000740200008C020000A4020000BC020000D4020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000036002A11000000009C01000000000000120000000000000000000000110000066B0900000100000000476574436F6C6C656374696F6E0000160003110400000098010000120000006B090000010000000E0024112831303036363332393700002200241140463A4D6963726F736F66742E53716C5365727665722E5365727665720000001A00241140463A53797374656D2E446174612E53716C5479706573001E00241140463A53797374656D2E446174612E53716C436C69656E74000000001200241140463A53797374656D2E4461746100000E00241140463A53797374656D0000000E0024112A53514C4367664E6F646500320024114050583A786D6C3D687474703A2F2F7777772E77332E6F72672F584D4C2F313939382F6E616D657370616365000000002A0024114050583A786D6C6E733D687474703A2F2F7777772E77332E6F72672F323030302F786D6C6E732F000A0024114050583A3D0000000E00241153514C4367664E6F6465000022002011000000000E0000110000000000000000476574436F6C6C656374696F6E000000020006000200060036002A11000000003402000000000000120000000000000000000000120000067D090000010000000047657444617461626173650000000016000311A001000030020000120000007D090000010000000E0024112831303036363332393700000E0024114031303036363333313300001E002011000000000F0000110000000000000000476574446174616261736500020006000200060032002A1100000000C402000000000000120000000000000000000000130000068F09000001000000004765744974656D000000001600031138020000C0020000120000008F090000010000000E0024112831303036363332393700000E0024114031303036363333313300001A002011000000001000001100000000000000004765744974656D00020006000200060032002A1100000000540300000000000012000000000000000000000014000006A10900000100000000476574506174680000000016000311C80200005003000012000000A1090000010000000E0024112831303036363332393700000E0024114031303036363333313300001A002011000000001100001100000000000000004765745061746800020006000200060036002A1100000000EC0300000000000012000000000000000000000015000006B30900000100000000476574496E7374616E6365000000001600031158030000E803000012000000B3090000010000000E0024112831303036363332393700000E0024114031303036363333313300001E00201100000000120000110000000000000000476574496E7374616E636500020006000200060032002A1100000000800400000000000012000000000000000000000016000006C50900000100000000476574537562547970650016000311F00300007C04000012000000C5090000010000000E0024112831303036363332393700000E0024114031303036363333313300001E00201100000000130000110000000000000000476574537562547970650000020006000200060032002A1100000000140500000000000012000000000000000000000017000006D709000001000000004765744C656E677468000016000311840400001005000012000000D7090000010000000E0024112831303036363332393700000E0024114031303036363333313300001E002011000000001400001100000000000000004765744C656E6774680000000200060002000600F20000003C0000006B09000001000100120000000000000003000000300000000000000012000080010000001400008010000000150000800500500009001F0005001100F20000003C0000007D0900000100010012000000000000000300000030000000000000001B000080010000001D000080100000001E00008005004E0009001D0005001100F20000003C0000008F090000010001001200000000000000030000003000000000000000240000800100000026000080100000002700008005004A000900190005001100F20000003C000000A10900000100010012000000000000000300000030000000000000002D000080010000002F000080100000003000008005004A000900190005001100F20000003C000000B3090000010001001200000000000000030000003000000000000000360000800100000038000080100000003900008005004E000900200005001100F20000003C000000C50900000100010012000000000000000300000030000000000000003F0000800100000041000080100000004200008005004D0009001C0005001100F20000003C000000D709000001000100120000000000000003000000300000000000000048000080010000004A000080100000004B00008005004B0009001B0005001100F400000008000000810100000000000038000000EC02000008030000200300003C030000540300006C030000840300009C030000B4030000D0030000E8030000040400001C04000034040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFF1A092FF160010000B40200004D0000000100000005020000010000003D03000001000000E9010000010000001D020000010000007D000000010000003D020000010000006D030000010000004D01000001000000010000000100000021030000010000001900000001000000D10100000100000009030000010000000101000001000000D50200000100000065000000010000000504000001000000350100000100000035040000010000001D04000001000000BD02000001000000A90000000100000075020000010000009D03000001000000D500000001000000A502000001000000190100000100000031000000010000008D02000001000000D1030000010000005503000001000000B50300000100000055020000010000006501000001000000ED020000010000009901000001000000ED000000010000009500000001000000E903000001000000C1000000010000007D01000001000000B1010000010000008503000001000000010400000200000000000000000002000000000000000000000200000000000001040000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000820000000000000000010400000200000000000000000000000000000000000000000000000000000001040200020000000000000000000000000000000000000000000000000000000100000002000088000000000000000000000000000000000000000000000000010400000200000000000000000000000000000000000000000000000000000001842400020000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000040000000000000000000002000000000000000000000000004000000000000000000000000000000000000200000000000000000000000000000800000000000000000000000000000000200000000000000000080000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000008000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000C0000001800000024000000300000003C0000004800000054000000600000006C0000007800000084000000900000009C000000A8000000B4000000C0000000CC000000D8000000E4000000F0000000FC0000000801000014010000200100002C0100003801000044010000500100005C0100006801000074010000800100008C01000098010000A4010000B0010000BC010000C8010000D4010000E0010000EC010000F80100000402000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001600251100000000040000000100546F537472696E6700001600291100000000040000000100303630303030303100001A002511000000006801000001006765745F49734E756C6C000000001600291100000000680100000100303630303030303200001600251100000000F801000001006765745F4E756C6C00001600291100000000F80100000100303630303030303300001200251100000000A002000001005061727365001600291100000000A00200000100303630303030303400001200251100000000B003000001005265616400001600291100000000B003000001003036303030303035000012002511000000002004000001005772697465001600291100000000200400000100303630303030303600001A002511000000009004000001006765745F4C656E6774680000000016002911000000009004000001003036303030303037000016002511000000004405000001006765745F5479706500001600291100000000440500000100303630303030303800001A00251100000000F805000001006765745F537562547970650000001600291100000000F80500000100303630303030303900001E00251100000000B006000001006765745F53514C496E7374616E63650000001600291100000000B00600000100303630303030306100001A002511000000007007000001006765745F446174616261100000000000000000000000000000000000000000000000C80F0000FFFFFFFF1A092FF10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000736500001600291100000000700700000100303630303030306200001E002511000000002C08000001006765745F436F6C6C656374696F6E0000000016002911000000002C0800000100303630303030306300001E00251100000000E808000001006765745F4973436F6C6C656374696F6E00001600291100000000E80800000100303630303030306400001600251100000000D009000001006765745F5061746800001600291100000000D00900000100303630303030306500001600251100000000840A000001006765745F4974656D00001600291100000000840A00000100303630303030306600001A00251100000000040000000200476574436F6C6C656374696F6E001600291100000000040000000200303630303030313100001A00251100000000A0010000020047657444617461626173650000001600291100000000A001000002003036303030303132000016002511000000003802000002004765744974656D0000001600291100000000380200000200303630303030313300001600251100000000C80200000200476574506174680000001600291100000000C80200000200303630303030313400001A00251100000000580300000200476574496E7374616E63650000001600291100000000580300000200303630303030313500001A00251100000000F0030000020047657453756254797065000000001600291100000000F003000002003036303030303136000016002511000000008404000002004765744C656E6774680016002911000000008404000002003036303030303137000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFF77093101010000000E0000880F0027C61000B00FCC0000006C0200002C000000BC000000000000000000000016000000190000000000EEC00000000000000000FFFF000000000000FFFFFFFF00000000FFFF0000000000000000000000000C00380B000000000000F4090000010000005897472C000000000000000053514C4367664E6F64652E53514C4366674E6F6465004243363831413235000000000000FFFF000000000000FFFFFFFF00000000FFFF0000000000000000000000000D001805000000000000EC010000010000003897472C000000000000000053514C4367664E6F64652E55736572446566696E656446756E6374696F6E73003231303734413046000000002DBA2EF1010000000000000025000000000000000000000000000000000000000100672D250000000C000000000000000000672D0000000000000000010000003100000017000000000000000000000000000000000000000100000048000000B80700000000000000000000000000000000000001000000000800000F000000000000000000000000000000000000000100672D0F08000010000000000000000000672D0000000000000000010000001F0800001E00000000000000000000000000000000000000010000003D0800001E00000000000000000000000000000000000000010000005B0800001E0000000000000000000000000000000000000001000000790800001E000000000000000000522C00000000000000000100FFFF970800001E0000000000000000000000000000000000000001000000B50800001E0000000000000000000000000000000000000001000000D30800005C00000000000000000001000000000000000000010000002F0900001E00000000000000000000000000000000000000010000004D0900001E00000000000000000000000000000000000000010010006B0900001200000000000000010000000000000000000000010000007D0900001200000000000000010000000000000000000000010000008F09000012000000000000000100000000000000000000000100672DA109000012000000000000000100672D000000000000000001006100B3090000120000000000000001006F66000000000000000001004620C5090000120000000000000001000000000000000000000001000000D70900001200000000000000010000000000000000000000020002000D01000000000100FFFFFFFF00000000E90900000802000000000000FFFFFFFF00000000FFFFFFFF020002000000010001000100000000004F000000433A5C55736572735C62696C6C5C446F63756D656E74735C56697375616C2053747564696F20323030385C50726F6A656374735C53514C436C75655C4E6F64655C53514C4366674E6F64652E766200433A5C55736572735C62696C6C5C446F63756D656E74735C56697375616C2053747564696F20323030385C50726F6A656374735C53514C436C75655C4E6F64655C53514C4366674E6F646546756E6374696F6E732E76620000FEEFFEEF010000000100000000010000000000000000000000FFFFFFFFFFFFFFFFFFFF0B00FFFFFFFFFFFFFFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000942E31011566164B010000001E092383E22CC440B5B24438FD1BDA7D7A0100002F4C696E6B496E666F002F6E616D6573002F7372632F686561646572626C6F636B002F7372632F66696C65732F31376431346635632D613333372D343937382D383238312D353334393333373863313037312E7662002F7372632F66696C65732F633A5C75736572735C62696C6C5C646F63756D656E74735C76697375616C2073747564696F20323030385C70726F6A656374735C73716C636C75655C6E6F64655C6D792070726F6A6563745C617373656D626C79696E666F2E7662002F7372632F66696C65732F633A5C75736572735C62696C6C5C646F63756D656E74735C76697375616C2073747564696F20323030385C70726F6A656374735C73716C636C75655C6E6F64655C73716C6366676E6F64652E7662002F7372632F66696C65732F633A5C75736572735C62696C6C5C646F63756D656E74735C76697375616C2073747564696F20323030385C70726F6A656374735C73716C636C75655C6E6F64655C73716C6366676E6F646566756E6374696F6E732E766200070000000E00000001000000E00F0000000000000A00000005000000BD000000090000000000000004000000170100000A00000011000000060000005600000008000000220000000700000000000000000000000000000000000000000000000000000000001100000018000000EA010000380000008F0400000000000071020000040100005800000058000000580000005800000028000000A815000040070000240400002C0000004C0400000300000028000000060000002500000026000000270000000C0000000D0000000E0000000700000008000000090000000A0000000B0000000F000000100000001100000012000000130000001400000015000000160000001700000018000000190000001A0000001B0000001C0000001D0000001E0000001F000000200000002200000021000000230000002400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
AS N''SQLClueCLR.pdb''';

GO

EXEC [sys].[sp_addextendedproperty] 
  @name=N'AutoDeployed'
, @value=N'no'
, @level0type=N'ASSEMBLY'
, @level0name=N'SQLClueCLR';

IF EXISTS (SELECT * FROM [sys].[fn_listextendedproperty] (N'SqlAssemblyProjectRoot'
                                                         ,  N'ASSEMBLY'
                                                         , 'SQLClueCLR'
                                                         , NULL
                                                         , NULL
                                                         , NULL
                                                         , NULL))
  EXEC [sys].[sp_dropextendedproperty] 
      @name=N'SqlAssemblyProjectRoot'
    , @level0type=N'ASSEMBLY'
    , @level0name=N'SQLClueCLR';

EXEC [sys].[sp_addextendedproperty] 
  @name=N'SqlAssemblyProjectRoot'
, @value=N'..\Visual Studio 2008\Projects\SQLClue\SQLCfgNode' 
, @level0type=N'ASSEMBLY'
, @level0name=N'SQLClueCLR';

GO

  EXEC sp_executesql N'CREATE TYPE [SQLCfg].[SQLCfgNode] EXTERNAL NAME [SQLClueCLR].[SQLCgfNode.SQLCfgNode]'

GO
  EXEC sys.sp_addextendedproperty 
       @name=N'AutoDeployed'
    , @value=N'no' 
    , @level0type=N'SCHEMA'
    , @level0name=N'SQLCfg'
    , @level1type=N'TYPE'
    , @level1name=N'SQLCfgNode';

  EXEC sys.sp_addextendedproperty 
      @name=N'SqlAssemblyFile'
    , @value=N'SQLCfgNode.vb' 
    , @level0type=N'SCHEMA'
    , @level0name=N'SQLCfg'
    , @level1type=N'TYPE'
    , @level1name=N'SQLCfgNode';

  EXEC sys.sp_addextendedproperty 
      @name=N'SqlAssemblyFileLine'
    , @value=13 
    , @level0type=N'SCHEMA'
    , @level0name=N'SQLCfg'
    , @level1type=N'TYPE'
    , @level1name=N'SQLCfgNode';
 

GO

ALTER TABLE SQLCfg.tChange
ADD Node [SQLCfg].[SQLCfgNode] NOT NULL DEFAULT 0x0

GO

UPDATE SQLCfg.tchange
SET Node = savenode 

GO

DECLARE @Cmd NVARCHAR(500)
SELECT @Cmd = 'ALTER TABLE SQLCfg.tChange DROP CONSTRAINT ' + dft.name 
FROM sys.default_constraints AS dft
JOIN sys.columns AS col
ON dft.parent_object_id = col.object_id
AND dft.parent_column_id = col.column_id
WHERE dft.parent_object_id = OBJECT_ID('SQLCfg.tChange')
AND col.name = 'Node'
IF @@ROWCOUNT = 1
 EXEC sp_executesql @Cmd

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: get the last inserted version for a specified node 
**
**    Note : changes need to be appliaed to assyRefresh too
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE FUNCTION [SQLCfg].[fLastVersion] 
( @Node  [SQLCfgNode] )
RETURNS [INT]
AS
BEGIN
 DECLARE @LastVersion [INT];
 SET @LastVersion = ISNULL( ( SELECT MAX(ISNULL([Version],0))
                              FROM [SQLCfg].[tChange]
                              WHERE [Node] = @Node), 0);
 RETURN @LastVersion;
END

GO

ALTER TABLE SQLCfg.tChange
ENABLE TRIGGER ALL

GO

CREATE NONCLUSTERED INDEX [ixn_tChange_Node_i]
ON [SQLCfg].[tChange] ([Node])
INCLUDE ([Version], [Id])

GO

CREATE UNIQUE NONCLUSTERED INDEX [ixn_tChange_Version_i]  
ON [SQLCfg].[tChange] ([Version], [Node])
INCLUDE ([Id], [Action])

GO

CREATE NONCLUSTERED INDEX [ixn_tChange_RecCreatedDt_i]
ON [SQLCfg].[tChange] ([RecCreatedDt])
INCLUDE ([Node],[Action])
  
GO  

IF NOT EXISTS (SELECT * 
               FROM SQLCfg.tChange 
               WHERE savenode <> Node.ToString())
 ALTER TABLE SQLCfg.tChange
 DROP COLUMN savenode

GO

/******************************************************************************
remove QueryBaseline references
the querybaseline component should have been uninstalled bore running this update
******************************************************************************/

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
*******************************************************************************
**    Date           Author             Description of Change
**    11/10/2009     bw                 remove QueryBaseline references 
**              
*******************************************************************************/

ALTER VIEW [SQLCfg].[vArchive]
AS
SELECT [Id] AS [ArchiveId] 
 , [InstanceName] 
 , [Interval]
 , [IntervalType]
 , [IntervalBaseDt] AS [NextRunDt]
 , CASE WHEN [UseEventNotifications] = 1 THEN 'True'
        ELSE 'False' END AS [UseEventNotifications] 
 , [IsActive] AS [IsScheduleActive] 
FROM [SQLCfg].[tSchedule]   

GO

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pScheduleSelectByBaselinePlanId' )
 DROP PROCEDURE [SQLCfg].[pScheduleSelectByBaselinePlanId];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/10/2009     bw                 remove QueryBaseline references 
**              
*******************************************************************************/

ALTER TRIGGER [SQLCfg].[trgtSchedule_Insert_Update_Delete]
ON [SQLCfg].[tSchedule]
FOR INSERT, UPDATE, Delete
AS
BEGIN
 DECLARE @icount [INT]
  , @dcount [INT] 
  , @NodeBase [NVARCHAR] (50) 
  , @TextData [VARCHAR] (2047)
  , @InstanceName [NVARCHAR] (128);

 SET NOCOUNT ON;

 BEGIN TRY
  SELECT @icount = COUNT(*) FROM [inserted];
  SELECT @dcount = COUNT(*) FROM [deleted];

  SET @NodeBase = 'SQLCfgMetadata|SQLCfg.tSchedule|';

  -- no multi-row
  IF @icount > 1 OR @dcount > 1
   BEGIN
    SET @TextData = 'Multi-row [SQLCfg].[tSchedule] operations are not permitted';
    RAISERROR (@TextData,16,1);
   END

  -- inserts
  IF @icount = 1 AND @dcount = 0
   BEGIN
  
    UPDATE s
    SET [InstanceName] = s.[InstanceName] 
    FROM [SQLCfg].[tSchedule] s
    JOIN [inserted] i 
    ON s.[InstanceName] = i.[InstanceName];

    INSERT [SQLCfg].[tChange]
     ( [Node]
     , [Version]
     , [Action] 
     , [Definition]
     , [DefinitionDt] )
    SELECT
       @NodeBase + [InstanceName] + '|ScheduleId=' + CAST(Id as [VARCHAR] (10))
     , [SQLCfg].[fLastVersion](@NodeBase + [InstanceName] + '|ScheduleId=' + CAST(Id as [VARCHAR] (10))) + 1
     , 'Include'
     , 'INSERT [SQLCfg].[tSchedule]
 ( [InstanceName]
 , [Interval]
 , [IntervalType]
 , [IntervalBaseDt]
 , [UseEventNotifications]
 , [IsActive]
 , [RecCreatedDt] 
 , [RecCreatedUser]
 , [RecUpdatedDt]
 , [RecUpdatedUser] )
SELECT [InstanceName] = ''' + [InstanceName] + '''
AND [Interval] = ' + CAST([Interval] AS [VARCHAR] (10)) + ' 
AND [IntervalType] = ''' + [IntervalType] + ''' 
AND [IntervalBaseDt] = ''' + CAST([IntervalBaseDt] AS [VARCHAR] (20)) + ''' 
AND [UseEventNotifications] = ' + CAST([UseEventNotifications] AS [CHAR] (1)) + ' 
AND [IsActive] = ' + CAST([IsActive] AS [CHAR] (1)) + ' 
AND [RecCreatedDt] = ''' + CAST([RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + [RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST([RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + [RecUpdatedUser] + ''''
     , CURRENT_TIMESTAMP
    FROM [inserted] 
    WHERE [InstanceName] NOT IN (SELECT [InstanceName] FROM [deleted]);
   END

  -- updates
  IF @icount = 1 AND @dcount = 1
   BEGIN    

    UPDATE s
    SET [RecUpdatedDt] = CURRENT_TIMESTAMP
     , [RecUpdatedUser] = ORIGINAL_LOGIN()
     , [InstanceName] = s.[InstanceName]
    FROM [SQLCfg].[tSchedule] s
    JOIN [inserted] i 
    ON s.[Id] = i.[Id]
    JOIN [deleted] d
    ON i.[Id] = d.[Id];
    
    -- if only IntervalBaseDate changes do not write a change record
    If (UPDATE(Id) 
        OR UPDATE(InstanceName)
        OR UPDATE(Interval)
        OR UPDATE(IntervalType)
        OR UPDATE(UseEventNotifications)
        OR UPDATE(IsActive))
     BEGIN
      INSERT [SQLCfg].[tChange]
       ( [Node]
       , [Version]
       , [Action] 
       , [Definition]
       , [DefinitionDt] )
      SELECT
         @NodeBase + i.[InstanceName] + '|ScheduleId=' + CAST(i.Id as [VARCHAR] (10))
       , [SQLCfg].[fLastVersion](@NodeBase + i.[InstanceName] + '|ScheduleId=' + CAST(i.Id as [VARCHAR] (10))) + 1
       , 'Modify'
       , 'UPDATE [SQLCfg].[tSchedule]
SET [InstanceName] = ''' + i.[InstanceName] + '''
 , [Interval] = ' + CAST(i.[Interval] AS [VARCHAR] (10)) + ' 
 , [IntervalType] = ''' + i.[IntervalType] + ''' 
 , [IntervalBaseDt] = ''' + CAST(i.[IntervalBaseDt] AS [VARCHAR] (20)) + ''' 
 , [UseEventNotifications] = ' + CAST(i.[UseEventNotifications] AS [CHAR] (1)) + ' 
 , [IsActive] = ' + CAST(i.[IsActive] AS [CHAR] (1)) + ' 
 , [RecCreatedDt] = ''' + CAST(i.[RecCreatedDt] AS [VARCHAR] (20)) + '''
 , [RecCreatedUser] = ''' + i.[RecCreatedUser] + '''
 , [RecUpdatedDt] = ''' + CAST(i.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
 , [RecUpdatedUser] = ''' + i.[RecUpdatedUser] + '''
WHERE [InstanceName] = ''' + d.[InstanceName] + '''
AND [Interval] = ' + CAST(d.[Interval] AS [VARCHAR] (10)) + ' 
AND [IntervalType] = ''' + d.[IntervalType] + ''' 
AND [IntervalBaseDt] = ''' + CAST(d.[IntervalBaseDt] AS [VARCHAR] (20)) + ''' 
AND [UseEventNotifications] = ' + CAST(d.[UseEventNotifications] AS [CHAR] (1)) + ' 
AND [IsActive] = ' + CAST(d.[IsActive] AS [CHAR] (1)) + ' 
AND [RecCreatedDt] = ''' + CAST(d.[RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + d.[RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST(d.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + d.[RecUpdatedUser] + ''''
       , CURRENT_TIMESTAMP
      FROM [inserted] i 
      JOIN [deleted] d
      ON i.[InstanceName] = d.[InstanceName];
     END
   END

  -- deletes
  IF @icount = 0 AND @dcount = 1
   BEGIN

    -- active schedule with notifications enabled means there is still
    -- notification metadata deployed to the instance
    SELECT @InstanceName = [InstanceName] FROM [deleted]
    WHERE [UseEventNotifications] = 1
    AND [IsActive] = 1;

    IF @@ROWCOUNT > 0
      RAISERROR ('Remove event notifications configuration on Instance [%s] before deleting the Schedule',16,1, @InstanceName);
  
    INSERT [SQLCfg].[tChange]
     ( [Node]
     , [Version]
     , [Action] 
     , [Definition]
     , [DefinitionDt] )
    SELECT
       @NodeBase + [InstanceName] + '|ScheduleId=' + CAST(Id as [VARCHAR] (10))
     , SQLCfg.[fLastVersion](@NodeBase + [InstanceName] + '|ScheduleId=' + CAST(Id as [VARCHAR] (10))) + 1
     , 'Remove'
     , 'DELETE [SQLCfg].[tSchedule]
WHERE [InstanceName] = ''' + [InstanceName] + '''
AND [Interval] = ' + CAST([Interval] AS [VARCHAR] (10)) + ' 
AND [IntervalType] = ''' + [IntervalType] + ''' 
AND [IntervalBaseDt] = ''' + CAST([IntervalBaseDt] AS [VARCHAR] (20)) + ''' 
AND [UseEventNotifications] = ' + CAST([UseEventNotifications] AS [CHAR] (1)) + ' 
AND [IsActive] = ' + CAST([IsActive] AS [CHAR] (1)) + ' 
AND [RecCreatedDt] = ''' + CAST([RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + [RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST([RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + [RecUpdatedUser] + ''''
     , CURRENT_TIMESTAMP
    FROM [deleted] 
    WHERE [InstanceName] NOT IN (SELECT [InstanceName] FROM [inserted]);
   
  END

 END TRY

 BEGIN CATCH

  EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH 

END;

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/10/2009     bw                 remove QueryBaseline references 
**              
*******************************************************************************/

ALTER TRIGGER [SQLCfg].[trgtInstance_Insert_Update_Delete]
ON [SQLCfg].[tInstance]
FOR INSERT, UPDATE, DELETE
AS
BEGIN

 DECLARE @NodeBase [NVARCHAR](50) 
  , @TextData [VARCHAR] (2048);

 SET NOCOUNT ON;

 BEGIN TRY

  SET @NodeBase = 'SQLCfgMetadata|SQLCfg.tInstance|';

  -- deletes
  INSERT [SQLCfg].[tChange]
   ( [Node]
   , [Version]
   , [Action] 
   , [Definition]
   , [DefinitionDt] )
  SELECT
     @NodeBase + [Name]
   , [SQLCfg].[fLastVersion](@Nodebase + [Name]) + 1
   , 'Remove'
   , 'DELETE [SQLCfg].[tInstance]
WHERE [Name] = ''' + [Name] + '''
AND [ActiveDirectory] = ' + CAST([ActiveDirectory] AS [CHAR] (1)) + ' 
AND [Audits] = ' + CAST([Audits] AS [CHAR] (1)) + ' 
AND [BackupDevices] = ' + CAST([BackupDevices] AS [CHAR] (1)) + ' 
AND [Configuration] = ' + CAST([Configuration] AS [CHAR] (1)) + ' 
AND [Credentials] = ' + CAST([Credentials] AS [CHAR] (1)) + ' 
AND [CryptographicProviders] = ' + CAST([CryptographicProviders] AS [CHAR] (1)) + ' 
AND [Databases] = ' + CAST([Databases] AS [CHAR] (1)) + ' 
AND [EndPoints] = ' + CAST([EndPoints] AS [CHAR] (1)) + '
AND [FullTextService] = ' + CAST([FullTextService] AS [CHAR] (1)) + '
AND [Information] = ' + CAST([Information] AS [CHAR] (1)) + '
AND [JobServer] = ' + CAST([JobServer] AS [CHAR] (1)) + ' 
AND [Logins] = ' + CAST([Logins] AS [CHAR] (1)) + '
AND [LinkedServers] = ' + CAST([LinkedServers] AS [CHAR] (1)) + '
AND [Mail] = ' + CAST([Mail] AS [CHAR] (1)) + ' 
AND [ProxyAccount] = ' + CAST([ProxyAccount] AS [CHAR] (1)) + '
AND [ResourceGovernor] = ' + CAST([ResourceGovernor] AS [CHAR] (1)) + '
AND [Roles] = ' + CAST([Roles] AS [CHAR] (1)) + '
AND [ServerAuditSpecifications] = ' + CAST([ServerAuditSpecifications] AS [CHAR] (1)) + '
AND [Settings] = ' + CAST([Settings] AS [CHAR] (1)) + '
AND [Triggers] = ' + CAST([Triggers] AS [CHAR] (1)) + '
AND [UserDefinedMessages] = ' + CAST([UserDefinedMessages] AS [CHAR] (1)) + '
AND [RecCreatedDt] = ''' + CAST([RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + [RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST([RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + [RecUpdatedUser] + ''''
   , CURRENT_TIMESTAMP 
  FROM [deleted] 
  WHERE Name NOT IN (SELECT Name FROM [inserted]);
  
  -- disable any schedules that belong to a deleted instance
  Update s
  SET [IsActive] = 0
  FROM [SQLCfg].[tSchedule] s
  JOIN [deleted] d
  on s.[InstanceName] = d.[Name]
  WHERE Name NOT IN (SELECT Name from [inserted]);
    
  -- updates
  --- add audit info
  UPDATE s
  SET [RecUpdatedDt] = CURRENT_TIMESTAMP
   , [RecUpdatedUser] = ORIGINAL_LOGIN()
  FROM [SQLCfg].[tInstance] s
  JOIN [inserted] i 
  ON s.[Name] = i.[Name]
  JOIN [deleted] d
  ON i.[Name] = d.[Name];

  -- record the change
  INSERT [SQLCfg].[tChange]
   ( [Node]
   , [Version]
   , [Action] 
   , [Definition]
   , [DefinitionDt] )
  SELECT
     @NodeBase + i.[Name]
   , [SQLCfg].[fLastVersion](@Nodebase + i.[Name]) + 1
   , 'Modify'
   , 'UPDATE [SQLCfg].[tInstance]
SET [Name] = ''' + i.[Name] + '''
 , [ActiveDirectory] = ' + CAST(i.[ActiveDirectory] AS [CHAR] (1)) + ' 
 , [Audits] = ' + CAST(i.[Audits] AS [CHAR] (1)) + ' 
 , [BackupDevices] = ' + CAST(i.[BackupDevices] AS [CHAR] (1)) + ' 
 , [Configuration] = ' + CAST(i.[Configuration] AS [CHAR] (1)) + ' 
 , [Credentials] = ' + CAST(i.[Credentials] AS [CHAR] (1)) + ' 
 , [CryptographicProviders] = ' + CAST(i.[CryptographicProviders] AS [CHAR] (1)) + ' 
 , [Databases] = ' + CAST(i.[Databases] AS [CHAR] (1)) + ' 
 , [EndPoints] = ' + CAST(i.[EndPoints] AS [CHAR] (1)) + '
 , [FullTextService] = ' + CAST(i.[FullTextService] AS [CHAR] (1)) + '
 , [Information] = ' + CAST(i.[Information] AS [CHAR] (1)) + '
 , [JobServer] = ' + CAST(i.[JobServer] AS [CHAR] (1)) + ' 
 , [Logins] = ' + CAST(i.[Logins] AS [CHAR] (1)) + '
 , [LinkedServers] = ' + CAST(i.[LinkedServers] AS [CHAR] (1)) + '
 , [Mail] = ' + CAST(i.[Mail] AS [CHAR] (1)) + ' 
 , [ProxyAccount] = ' + CAST(i.[ProxyAccount] AS [CHAR] (1)) + '
 , [ResourceGovernor] = ' + CAST(i.[ResourceGovernor] AS [CHAR] (1)) + '
 , [Roles] = ' + CAST(i.[Roles] AS [CHAR] (1)) + '
 , [ServerAuditSpecifications] = ' + CAST(i.[ServerAuditSpecifications] AS [CHAR] (1)) + '
 , [Settings] = ' + CAST(i.[Settings] AS [CHAR] (1)) + '
 , [Triggers] = ' + CAST(i.[Triggers] AS [CHAR] (1)) + '
 , [UserDefinedMessages] = ' + CAST(i.[UserDefinedMessages] AS [CHAR] (1)) + '
 , [RecCreatedDt] = ''' + CAST(i.[RecCreatedDt] AS [VARCHAR] (20)) + '''
 , [RecCreatedUser] = ''' + i.[RecCreatedUser] + '''
 , [RecUpdatedDt] = ''' + CAST(i.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
 , [RecUpdatedUser] = ''' + i.[RecUpdatedUser] + '''
WHERE [Name] = ''' + d.[Name] + '''
AND [ActiveDirectory] = ' + CAST(d.[ActiveDirectory] AS [CHAR] (1)) + ' 
AND [Audits] = ' + CAST(d.[Audits] AS [CHAR] (1)) + ' 
AND [BackupDevices] = ' + CAST(d.[BackupDevices] AS [CHAR] (1)) + ' 
AND [Configuration] = ' + CAST(d.[Configuration] AS [CHAR] (1)) + ' 
AND [Credentials] = ' + CAST(d.[Credentials] AS [CHAR] (1)) + ' 
AND [CryptographicProviders] = ' + CAST(d.[CryptographicProviders] AS [CHAR] (1)) + ' 
AND [Databases] = ' + CAST(d.[Databases] AS [CHAR] (1)) + ' 
AND [EndPoints] = ' + CAST(d.[EndPoints] AS [CHAR] (1)) + '
AND [FullTextService] = ' + CAST(d.[FullTextService] AS [CHAR] (1)) + '
AND [Information] = ' + CAST(d.[Information] AS [CHAR] (1)) + '
AND [JobServer] = ' + CAST(d.[JobServer] AS [CHAR] (1)) + ' 
AND [Logins] = ' + CAST(d.[Logins] AS [CHAR] (1)) + '
AND [LinkedServers] = ' + CAST(d.[LinkedServers] AS [CHAR] (1)) + '
AND [Mail] = ' + CAST(d.[Mail] AS [CHAR] (1)) + ' 
AND [ProxyAccount] = ' + CAST(d.[ProxyAccount] AS [CHAR] (1)) + '
AND [ResourceGovernor] = ' + CAST(d.[ResourceGovernor] AS [CHAR] (1)) + '
AND [Roles] = ' + CAST(d.[Roles] AS [CHAR] (1)) + '
AND [ServerAuditSpecifications] = ' + CAST(d.[ServerAuditSpecifications] AS [CHAR] (1)) + '
AND [Settings] = ' + CAST(d.[Settings] AS [CHAR] (1)) + '
AND [Triggers] = ' + CAST(d.[Triggers] AS [CHAR] (1)) + '
AND [UserDefinedMessages] = ' + CAST(d.[UserDefinedMessages] AS [CHAR] (1)) + '
AND [RecCreatedDt] = ''' + CAST(d.[RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + d.[RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST(d.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + d.[RecUpdatedUser] + ''''
   , CURRENT_TIMESTAMP
  FROM [inserted] i 
  JOIN [deleted] d
  ON i.[Name] = d.[Name];

  -- inserts
  INSERT [SQLCfg].[tChange]
   ( [Node]
   , [Version]
   , [Action] 
   , [Definition]
   , [DefinitionDt] )
  SELECT
     @NodeBase + [Name]
   , [SQLCfg].[fLastVersion](@Nodebase + [Name]) + 1
   , 'Include'
   , 'INSERT [SQLCfg].[tInstance]
 ( [Name]
 , [ActiveDirectory]
 , [Audits]
 , [BackupDevices]
 , [Configuration]
 , [Credentials]
 , [CryptographicProviders]
 , [Databases]
 , [EndPoints]
 , [FullTextService]
 , [Information]
 , [JobServer]
 , [Logins]
 , [LinkedServers]
 , [Mail]
 , [ProxyAccount]
 , [ResourceGovernor]
 , [Roles]
 , [ServerAuditSpecifications]
 , [Settings]
 , [Triggers]
 , [UserDefinedMessages]
 , [RecCreatedDt] 
 , [RecCreatedUser]
 , [RecUpdatedDt]
 , [RecUpdatedUser] )
SELECT [Name] = ''' + [Name] + '''
AND [ActiveDirectory] = ' + CAST([ActiveDirectory] AS [CHAR] (1)) + ' 
AND [Audits] = ' + CAST([Audits] AS [CHAR] (1)) + ' 
AND [BackupDevices] = ' + CAST([BackupDevices] AS [CHAR] (1)) + ' 
AND [Configuration] = ' + CAST([Configuration] AS [CHAR] (1)) + ' 
AND [Credentials] = ' + CAST([Credentials] AS [CHAR] (1)) + ' 
AND [CryptographicProviders] = ' + CAST([CryptographicProviders] AS [CHAR] (1)) + ' 
AND [Databases] = ' + CAST([Databases] AS [CHAR] (1)) + ' 
AND [EndPoints] = ' + CAST([EndPoints] AS [CHAR] (1)) + '
AND [FullTextService] = ' + CAST([FullTextService] AS [CHAR] (1)) + '
AND [Information] = ' + CAST([Information] AS [CHAR] (1)) + '
AND [JobServer] = ' + CAST([JobServer] AS [CHAR] (1)) + ' 
AND [Logins] = ' + CAST([Logins] AS [CHAR] (1)) + '
AND [LinkedServers] = ' + CAST([LinkedServers] AS [CHAR] (1)) + '
AND [Mail] = ' + CAST([Mail] AS [CHAR] (1)) + ' 
AND [ProxyAccount] = ' + CAST([ProxyAccount] AS [CHAR] (1)) + '
AND [ResourceGovernor] = ' + CAST([ResourceGovernor] AS [CHAR] (1)) + '
AND [Roles] = ' + CAST([Roles] AS [CHAR] (1)) + '
AND [ServerAuditSpecifications] = ' + CAST([ServerAuditSpecifications] AS [CHAR] (1)) + '
AND [Settings] = ' + CAST([Settings] AS [CHAR] (1)) + '
AND [Triggers] = ' + CAST([Triggers] AS [CHAR] (1)) + '
AND [UserDefinedMessages] = ' + CAST([UserDefinedMessages] AS [CHAR] (1)) + '
AND [RecCreatedDt] = ''' + CAST([RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + [RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST([RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + [RecUpdatedUser] + ''''
   , CURRENT_TIMESTAMP
  FROM [inserted] 
  WHERE [Name] NOT IN (SELECT [Name] FROM [deleted]);

 END TRY

 BEGIN CATCH

  EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH 

END;

GO 

/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: get the history for an archive Schedule
**       
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/10/2009     bw                 remove QueryBaseline add ArchiveError 
**              
*******************************************************************************/

ALTER Procedure [SQLCfg].[pArchiveLogSelectScheduleHistoryByScheduleId]
 ( @ScheduleId [INT]
 , @BeginDt [DATETIME]
 , @EndDt [DATETIME])
AS
BEGIN

 SET NOCOUNT ON;
 
    SELECT l.[Id] AS [ArchiveLogId]
    , l.[ScheduleId]
    , l.[InstanceName]
    , l.[NbrDDLEventsProcessed]
    , l.[NbrItemsProcessed]
    , l.[NbrItemsAdded]
    , l.[NbrItemsChanged]
    , l.[NbrItemsDeleted]
    , l.[ScheduledStartDt]
    , l.[ActualStartDt]
    , l.[ActualEndDt] 
    , l.[RecCreatedUser]
    , l.[ArchiveError]
    , s1.[Interval]
    , s1.[IntervalType]
    , s1.[IntervalBaseDt]
    , s1.[UseEventNotifications]
    , s1.[IsActive]
   FROM [SQLCfg].[tArchiveLog] l
   JOIN [SQLCfg].[tSchedule] s1
   ON l.[ScheduleId] = s1.[Id] 
   WHERE s1.[Id] = @ScheduleId
   AND (   l.[ScheduledStartDt] BETWEEN @BeginDt AND @EndDt
        OR l.[ActualStartDt]    BETWEEN @BeginDt AND @EndDt); 

END;

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: get all history for an instance based on archive ScheduleId
**       
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/10/2009     bw                 remove QueryBaseline add ArchiveError 
**              
*******************************************************************************/

ALTER Procedure [SQLCfg].[pArchiveLogSelectSQLInstanceHistoryByScheduleId]
 ( @ScheduleId [INT]
 , @BeginDt [DATETIME]
 , @EndDt [DATETIME])
AS
BEGIN

 SET NOCOUNT ON;
 
    SELECT l.[Id] AS [ArchiveLogId]
    , l.[ScheduleId]
    , l.[InstanceName]
    , l.[NbrDDLEventsProcessed]
    , l.[NbrItemsProcessed]
    , l.[NbrItemsAdded]
    , l.[NbrItemsChanged]
    , l.[NbrItemsDeleted]
    , l.[ScheduledStartDt]
    , l.[ActualStartDt]
    , l.[ActualEndDt] 
    , l.[RecCreatedUser]
    , l.[ArchiveError]
    , s2.[Interval]
    , s2.[IntervalType]
    , s2.[IntervalBaseDt]
    , s2.[UseEventNotifications]
    , s2.[IsActive]
   FROM [SQLCfg].[tArchiveLog] l
   JOIN [SQLCfg].[tSchedule] s1
   ON l.[InstanceName] = s1.[InstanceName] 
   JOIN [SQLCfg].[tSchedule] s2
   ON s2.[Id] = l.[ScheduleId]
   WHERE s1.[Id] = @ScheduleId
   AND (   l.[ScheduledStartDt] BETWEEN @BeginDt AND @EndDt
        OR l.[ActualStartDt]    BETWEEN @BeginDt AND @EndDt); 

END;

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Add a summary record for an archive
**       
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/10/2009     bw                 add ArchiveError and alert message          
**
*******************************************************************************/

ALTER Procedure [SQLCfg].[pArchiveLogInsert]
 ( @ScheduleId [INT]
  , @InstanceName [NVARCHAR] (128)
  , @NbrDDLEventsProcessed [INT]
  , @NbrItemsProcessed [INT]
  , @NbrItemsAdded [INT]
  , @NbrItemsChanged [INT]
  , @NbrItemsDeleted [INT]
  , @ScheduledStartDt [DATETIME]   
  , @ActualStartDt [DATETIME]  
  , @ActualEndDt [DATETIME] 
  , @ArchiveError [VARCHAR] (MAX))
AS
BEGIN

 DECLARE @TextData [NVARCHAR] (MAX)
       , @LogId [INT];

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

  BEGIN TRY

   INSERT [SQLCfg].[tArchiveLog]
    ( [ScheduleId]
    , [InstanceName]
    , [NbrDDLEventsProcessed]
    , [NbrItemsProcessed]
    , [NbrItemsAdded]
    , [NbrItemsChanged]
    , [NbrItemsDeleted]
    , [ScheduledStartDt]
    , [ActualStartDt]
    , [ActualEndDt] 
    , [ArchiveError])
   VALUES
    ( @ScheduleId 
    , UPPER(@InstanceName) 
    , @NbrDDLEventsProcessed
    , @NbrItemsProcessed
    , @NbrItemsAdded
    , @NbrItemsChanged
    , @NbrItemsDeleted
    , @ScheduledStartDt
    , @ActualStartDt
    , @ActualEndDt 
    , NULLIF(@ArchiveError, '')); -- does no good use a sparse column if empty string is always inserted

    SET @LogId = SCOPE_IDENTITY()
    
    /*
      the message text must match the keyword of the alert   
      the user can create alerts for individual schedules by specifying enough of
      the message text to identify the schedule in the alert @event_description_keyword 
      example: 'SQLClue SQL Configuration Archive Exception: Schedule Id 18'
      Only configuration of 2 general alerts on archive success or failure are supported
      by the SQLClue Console's Archive Alert Notification dialog. All other Archive alerts 
      must be configured by the user.  
     */ 
    If NULLIF(@ArchiveError, '') IS NULL 
     RAISERROR ('SQLClue SQL Configuration Archive Complete: Schedule Id %d, Archive Log Id %d',1,1,@ScheduleId, @LogId) WITH LOG
    ELSE
     RAISERROR ('SQLClue SQL Configuration Archive Exception: Schedule Id %d, Archive Log Id %d',9,1,@ScheduleId, @LogId) WITH LOG
    
  END TRY

  BEGIN CATCH

   SET @TextData = '   @ScheduleId = ' + ISNULL(CAST(@ScheduleId AS [VARCHAR] (10)),'NULL') + CHAR(13) + CHAR(10)
                 + ' , @InstanceName = ' + ISNULL(CHAR(39) + @InstanceName + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                 + ' , @NbrDDLEventsProcessed = ' + ISNULL(CAST(@NbrDDLEventsProcessed AS [VARCHAR] (10)),'NULL') + CHAR(13) + CHAR(10)
                 + ' , @NbrItemsProcessed = ' + ISNULL(CAST(@NbrItemsProcessed AS [VARCHAR] (10)),'NULL') + CHAR(13) + CHAR(10)
                 + ' , @NbrItemsAdded = ' + ISNULL(CAST(@NbrItemsAdded AS [VARCHAR] (10)),'NULL') + CHAR(13) + CHAR(10)
                 + ' , @NbrItemsChanged = ' + ISNULL(CAST(@NbrItemsChanged AS [VARCHAR] (10)),'NULL') + CHAR(13) + CHAR(10)
                 + ' , @NbrItemsDeleted = ' + ISNULL(CAST(@NbrItemsDeleted AS [VARCHAR] (10)),'NULL') + CHAR(13) + CHAR(10)
                 + ' , @ScheduledStartDt = ' + ISNULL(CHAR(39) + CAST(@ScheduledStartDt AS [VARCHAR] (21)),'NULL') + CHAR(13) + CHAR(10)
                 + ' , @ActualStartDt = ' + ISNULL(CHAR(39) + CAST(@ActualStartDt AS [VARCHAR] (21)) + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                 + ' , @ActualEndDt = ' + ISNULL(CHAR(39) + CAST(@ActualEndDt AS [VARCHAR] (21)) + CHAR(39),'NULL')
                 + ' , @ArchiveError = ' + ISNULL(CHAR(39) + @ArchiveError  + CHAR(39),'NULL');
    EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH;

END;

GO

GRANT EXECUTE ON [SQLCfg].[pArchiveLogInsert] TO [SQLCfgServiceRole];

GO

If EXISTS (SELECT *
           FROM msdb.dbo.sysalerts
           WHERE name = 'SQLClue: SQL Configuration Archive Succeeded')
 EXEC msdb.dbo.sp_delete_alert @name = 'SQLClue: SQL Configuration Archive Succeeded'             
GO

-- notification requires additional configuration - can use SQLClue UI for simple notification
EXEC msdb.dbo.sp_add_alert @name = 'SQLClue: SQL Configuration Archive Succeeded' 
     , @message_id = 0 
     , @severity = 1 
     , @enabled = 1
     , @notification_message = 'Archive notifications can be enabled/disabled from the SQLClue Console'  
     , @event_description_keyword = 'SQLClue SQL Configuration Archive Complete:' 

GO

If EXISTS (SELECT *
           FROM msdb.dbo.sysalerts
           WHERE name = 'SQLClue: SQL Configuration Archive Failed')
 EXEC msdb.dbo.sp_delete_alert @name = 'SQLClue: SQL Configuration Archive Failed'             
GO

-- by default the alert is active, use UI or SSMS to disable  
-- notification must be configured - can use SQLClue UI for simple notification only
EXEC msdb.dbo.sp_add_alert @name = 'SQLClue: SQL Configuration Archive Failed' 
     , @message_id = 0 
     , @severity = 9  
     , @enabled = 1
     , @notification_message = 'See the Application Event Log and the ArchiveLog table for additional details.'  
     , @event_description_keyword = 'SQLClue SQL Configuration Archive Exception:' 

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Fetch the specified service settings 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/10/2009     bw                 remove QueryBaseline references 
**              
*******************************************************************************/

ALTER PROCEDURE [SQLCfg].[pScheduleGet] 
 ( @Id [INT]
 , @InstanceName [NVARCHAR] (128) OUTPUT 
 , @Interval [INT] OUTPUT
 , @IntervalType [NVARCHAR] (10) OUTPUT
 , @IntervalBaseDt [DATETIME] OUTPUT
 , @UseEventNotifications [BIT] OUTPUT
 , @IsActive [BIT] OUTPUT ) 
AS
BEGIN

 SET NOCOUNT ON;

 SELECT @InstanceName 
  , @Interval
  , @IntervalType
  , @IntervalBaseDt
  , @UseEventNotifications
  , @IsActive
 FROM [SQLCfg].[tSchedule]
 WHERE [Id] = @Id;

END
GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: the number of schedules set up for a SQL Instance 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/10/2009     bw                 remove QueryBaseline references 
**              
*******************************************************************************/

ALTER PROCEDURE [SQLCfg].[pScheduleGetCountForInstance] 
 ( @InstanceName [NVARCHAR] (128)  
 , @Count [INT] OUTPUT) 
AS
BEGIN

 SET NOCOUNT ON;

 SELECT @Count = Count(*) 
 FROM [SQLCfg].[tSchedule]
 WHERE [InstanceName] = @InstanceName;

END
GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Add the archive schedule for an SQL instance. 
** Note: encrypted password always added by update and requires symmetric key
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/10/2009     bw                 remove QueryBaseline references 
**              
*******************************************************************************/

ALTER PROCEDURE [SQLCfg].[pScheduleInsert] 
 ( @InstanceName [NVARCHAR] (128)
 , @Interval [INT] 
 , @IntervalType [NVARCHAR] (10) 
 , @IntervalBaseDt [DATETIME]
 , @UseEventNotifications [BIT]
 , @IsActive [BIT]
 , @Id [INT] OUTPUT )
AS
BEGIN
 DECLARE @TextData [NVARCHAR](800);

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

 BEGIN TRY

  INSERT [SQLCfg].[tSchedule]
   ( [InstanceName]
   , [Interval]
   , [IntervalType]
   , [IntervalBaseDt]
   , [UseEventNotifications]
   , [IsActive]) 
  VALUES 
   ( UPPER(@InstanceName) 
   , @Interval
   , @IntervalType
   , @IntervalBaseDt
   , @UseEventNotifications
   , @IsActive ); 

 SELECT @Id = SCOPE_IDENTITY();

 END TRY

  BEGIN CATCH
 
  SET @TextData = '   @InstanceName = ' + ISNULL(CHAR(39) + @InstanceName + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Interval = ' + ISNULL(CAST(@Interval AS [VARCHAR] (10)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @IntervalType = ' + ISNULL(CHAR(39) + @IntervalType + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @IntervalBaseDt = ' + ISNULL(CHAR(39) + CAST(@IntervalBaseDt AS VARCHAR(20)) + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @UseEventNotifications = ' + ISNULL(CAST(@UseEventNotifications AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @IsActive = ' + ISNULL(CAST(@IsActive AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Id = ' + ISNULL(CAST(@Id AS [VARCHAR] (10)),'NULL') + ' OUTPUT' + CHAR(13) + CHAR(10);
  EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH; 

END
GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Update the archive schedule for an SQL instance. 
** Note: encrypted password always added by update and requires symmetric key
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/10/2009     bw                 remove QueryBaseline references 
**              
*******************************************************************************/

ALTER PROCEDURE [SQLCfg].[pScheduleUpdate] 
 ( @Id [INT]
 , @InstanceName [NVARCHAR] (128) = NULL
 , @Interval [INT] = NULL
 , @IntervalType [NVARCHAR] (10) = NULL
 , @IntervalBaseDt [DATETIME] = NULL
 , @UseEventNotifications [BIT] = NULL 
 , @IsActive [BIT] = NULL )
AS
BEGIN
 DECLARE @TextData [NVARCHAR] (500);

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

 BEGIN TRY

  UPDATE [SQLCfg].[tSchedule]
  SET [InstanceName] = UPPER(ISNULL(@InstanceName, [InstanceName]))
   , [Interval] = ISNULL(@Interval, [Interval])
   , [IntervalType] = ISNULL(@IntervalType, [IntervalType])
   , [IntervalBaseDt] = ISNULL(@IntervalBaseDt, [IntervalBaseDt])
   , [UseEventNotifications] = ISNULL(@UseEventNotifications, [UseEventNotifications])
   , [IsActive] = ISNULL(@IsActive, [IsActive])
  WHERE [Id] = @Id;

 END TRY

 BEGIN CATCH

  SET @TextData = '   @InstanceName = ' + ISNULL(CHAR(39) + @InstanceName + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Interval = ' + ISNULL(CAST(@Interval AS [VARCHAR] (10)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @IntervalType = ' + ISNULL(CHAR(39) + @IntervalType + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @IntervalBaseDt = ' + ISNULL(CHAR(39) + CAST(@IntervalBaseDt AS VARCHAR(20)) + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @UseEventNotifications = ' + ISNULL(CAST(@UseEventNotifications AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @IsActive = ' + ISNULL(CAST(@IsActive AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Id = ' + ISNULL(CAST(@Id AS [VARCHAR] (10)),'NULL') + ' OUTPUT' + CHAR(13) + CHAR(10);
  EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH

END
GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Fetch the archive Schedules for all SQL Instances 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/10/2009     bw                 remove QueryBaseline references 
**              
*******************************************************************************/

ALTER PROCEDURE [SQLCfg].[pScheduleSelectAll] 
AS
BEGIN

 SET NOCOUNT ON;

 SELECT [Id] 
  , [InstanceName]
  , [Interval]
  , [IntervalType]
  , [IntervalBaseDt]
  , [UseEventNotifications]
  , [IsActive]
 FROM [SQLCfg].[tSchedule]
 ORDER BY [InstanceName]
  , [IntervalBaseDt]
  , [Id];

END
GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Fetch the archive Schedules for all SQL Instances
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/10/2009     bw                 remove QueryBaseline references 
**              
*******************************************************************************/

ALTER PROCEDURE [SQLCfg].[pScheduleSelectAllForInstance] 
 ( @InstanceName [NVARCHAR] (128) )
AS
BEGIN

 SET NOCOUNT ON;

 SELECT [Id] 
  , [InstanceName]
  , [Interval]
  , [IntervalType]
  , [IntervalBaseDt]
  , [UseEventNotifications]
  , [IsActive]
 FROM [SQLCfg].[tSchedule] 
 WHERE [InstanceName] = @InstanceName;

END
GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Fetch the archive Schedules for all SQL Instances include the
**          NbrItemsProcessed from the last execution for the schedule or
**          -1 if no history found. 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/10/2009     bw                 remove QueryBaseline references 
**              
*******************************************************************************/

ALTER PROCEDURE [SQLCfg].[pScheduleSelectAllWithLastNbrItemsProcessed] 
AS
BEGIN

 SET NOCOUNT ON;
--what if plandomized?
 SELECT s.[Id] 
  , s.[InstanceName]
  , s.[Interval]
  , s.[IntervalType]
  , s.[IntervalBaseDt]
  , s.[UseEventNotifications]
  , s.[IsActive]
  , ISNULL((SELECT  Top 1 [NbrItemsProcessed]             
            FROM [SQLCfg].[tArchiveLog]
            WHERE [ScheduleId] = s.[Id]
            ORDER BY [ActualStartDt] Desc), -1) AS [LastNbrItemsProcessed]
 FROM [SQLCfg].[tSchedule] s
 ORDER BY [InstanceName]
  , [IntervalBaseDt]
  , [Id];

END

GO
IF EXISTS (SELECT * 
           FROM sys.default_constraints
           WHERE [name] ='dft_tSchedule_BaselinePlanId')
 ALTER TABLE [SQLCfg].[tSchedule]
 DROP CONSTRAINT [dft_tSchedule_BaselinePlanId]

If EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.COLUMNS
           WHERE TABLE_SCHEMA = 'SQLCfg'
           AND TABLE_NAME = 'tSchedule'
           AND COLUMN_NAME = 'BaselinePlanId')
 ALTER TABLE [SQLCfg].[tSchedule]
 DROP COLUMN [BaselinePlanId]

GO

/*************************************************************************************
DATE FIX
**************************************************************************************/
ALTER TABLE [SQLCfg].[tSQLCfg] 
DROP  CONSTRAINT [dft_tSQLCfg_LicenseDate] 
GO
ALTER TABLE [SQLCfg].[tSQLCfg] 
ADD CONSTRAINT [dft_tSQLCfg_LicenseDate] 
DEFAULT (CAST(CAST(CURRENT_TIMESTAMP AS [DATE]) AS [VARCHAR] (30)))
FOR [LicenseDate] 
GO
UPDATE [SQLCfg].[tSQLCfg]
SET [LicenseDate] = CAST(CAST([LicenseDate] AS [DATE]) AS [VARCHAR] (30))
GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Note: changes need to be applied to assy refresh too
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/28/2008     bw                 added validation of LicenseDate               
**              
*******************************************************************************/

ALTER TRIGGER [SQLCfg].[trgtSQLCfg_Insert_Update_Delete]
ON [SQLCfg].[tSQLCfg]
FOR INSERT, UPDATE, DELETE
AS
BEGIN

 DECLARE @icount [INT]
  , @dcount [INT]
  , @ucount [INT]
  , @Node  [SQLCfgNode] 
  , @TextData [VARCHAR] (2048);

 SET NOCOUNT ON;

 BEGIN TRY

  SELECT @icount = COUNT(*) FROM [inserted];
  SELECT @dcount = COUNT(*) FROM [deleted];
  SELECT @ucount = COUNT(*) FROM [SQLCfg].[tSQLCfg];

  -- no multi row
  IF @icount > 1 OR @dcount > 1
   BEGIN
    SET @TextData = 'Multi-row [SQLCfg].[tSQLCfg] operations are not permitted';
    RAISERROR (@TextData, 16,1);
   END

  -- only one row in table
  IF @ucount > 1
   BEGIN
    SET @TextData = 'Cannot add multiple [SQLCfg].[tSQLCfg] configurations';
    RAISERROR (@TextData, 16,1);
   END

  -- no delete
  IF @dcount = 1 and @icount = 0 
   BEGIN
    SET @TextData = 'Cannot remove the [SQLCfg].[tSQLCfg] configuration';
    RAISERROR (@TextData, 16,1);
   END

  -- LicenseDate must evaluate to a date
  IF (SELECT ISDATE(CAST([LicenseDate] AS [DATETIME])) FROM inserted) = 0
   BEGIN
    SET @TextData = '[SQLCfg].[tSQLCfg].[LicenseDate] is not a valid date at this locale';
    RAISERROR (@TextData, 16,1);
   END

  SET @Node = 'SQLCfgMetadata|SQLCfg.tSQLCfg';

  -- update
  IF @dcount = 1 and @icount = 1
   BEGIN

    -- add audit info
    UPDATE [SQLCfg].[tSQLCfg]
    SET [RecUpdatedDt] = CURRENT_TIMESTAMP
     , [RecUpdatedUser] = ORIGINAL_LOGIN();

    -- record the update to change
    INSERT [SQLCfg].[tChange]
     ( [Node]  
     , [Version]
     , [Action] 
     , [Definition]
     , [DefinitionDt] )
    SELECT 
       @Node
     , [SQLCfg].[fLastVersion](@Node) + 1
     , 'Modify'
     , 'UPDATE [SQLCfg].[tSQLCfg]
SET [LicensedCompany] = ''' + i.[LicensedCompany] + '''
 , [LicensedUser] = ''' + i.[LicensedUser] + '''
 , [LicenseCode] = ''' + i.[LicenseCode] + '''
 , [LicensedInstanceCount] = ' + CAST(i.[LicensedInstanceCount] AS [VARCHAR] (10)) + '
 , [LicenseDate] = ''' + i.[LicenseDate] + '''
 , [RecCreatedDt] = ''' + CAST(i.[RecCreatedDt] AS [VARCHAR] (20)) + '''
 , [RecCreatedUser] = ''' + i.[RecCreatedUser] + '''
 , [RecUpdatedDt] = ''' + CAST(i.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
 , [RecUpdatedUser] = ''' + i.[RecUpdatedUser] + '''
WHERE [LicensedCompany] = ''' + d.[LicensedCompany] + '''
AND [LicensedUser] = ''' + d.[LicensedUser] + '''
AND [LicenseCode] = ''' + d.[LicenseCode] + '''
AND [LicensedInstanceCount] = ' + CAST(d.[LicensedInstanceCount] AS [VARCHAR] (10)) + '
AND [LicenseDate] = ''' + d.[LicenseDate] + '''
AND [RecCreatedDt] = ''' + CAST(d.[RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + d.[RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST(d.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + d.[RecUpdatedUser] + '''
AND ORIGINAL_LOGIN() = ''' + ORIGINAL_LOGIN() + ''''
     , CURRENT_TIMESTAMP
    FROM [inserted] i
    CROSS JOIN [deleted] d;

   END;      

  -- insert
  IF @dcount = 0 and @icount = 1
   BEGIN
    -- log the insert to change
    INSERT [SQLCfg].[tChange]
     ( [Node]  
     , [Version]
     , [Action] 
     , [Definition]
     , [DefinitionDt] )
    SELECT 
       @Node
     , [SQLCfg].[fLastVersion](@Node) + 1
     , 'Include'
     , 'INSERT [SQLCfg].[tSQLCfg]
 ( [LicensedCompany] 
 , [LicensedUser] 
 , [LicenseCode]
 , [LicensedInstanceCount]
 , [LicenseDate] 
 , [RecCreatedDt] 
 , [RecCreatedUser] 
 , [RecUpdatedDt] 
 , [RecUpdatedUser] )
SELECT ''' + i.[LicensedCompany] + '''
 , ''' + i.[LicensedUser] + '''
 , ''' + i.[LicenseCode] + '''
 , ' + CAST(i.[LicensedInstanceCount] AS [VARCHAR] (10)) + '
 , ''' + i.[LicenseDate] + '''
 , ''' + CAST(i.[RecCreatedDt] AS [VARCHAR] (20)) + '''
 , ''' + i.[RecCreatedUser] + '''
 , ''' + CAST(i.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
 , ''' + i.[RecUpdatedUser] + ''''
     , CURRENT_TIMESTAMP
    FROM [inserted] i;

   END;

 END TRY 

 BEGIN CATCH

  EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH 

END;

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: List items changed for a date
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/28/2009     bw                 remove locale specific date conversion          
**                                      include change type and action filters 
*******************************************************************************/
ALTER Procedure [SQLCfg].[pChangesForDate]
 ( @ChangeDate [DATETIME]
 , @SQLInstance [NVARCHAR] (786)
 , @NodeType [NVARCHAR] (30)
 , @Action [NVARCHAR] (30))
AS
BEGIN

SET NOCOUNT ON;

SELECT Id 
 , [Node].ToString() AS [Node]
 , [Node].[Database] AS [Database]
 , [Node].[Collection] AS [Collection]
 , [Node].[Item] AS [ChangeItem]
 , [Version]
 , [Action]
 , [RecCreatedDt]
FROM [SQLCfg].[tChange]
WHERE Node.SQLInstance = @SQLInstance
AND [Node].[Type] = CASE WHEN @NodeType = 'All' THEN [Node].[Type] ELSE @NodeType END
AND [Action] = CASE WHEN @Action = 'All' THEN [Action] ELSE @Action END
AND CAST([RecCreatedDt] AS [DATE]) = CAST(ISNULL(@ChangeDate, CURRENT_TIMESTAMP) AS [DATE])
ORDER BY [Database] DESC, [Collection] DESC, [ChangeItem] DESC; 

END
GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: List changes on server for an item, most recent changes first
**       Business rule, any thing older than @DaystoShow will not be 
**       considered as candididate for the 'revert' status. Instead a 
**       new - and possibly duplicated version - will be added.
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/28/2009     bw                 remove locale specific date conversion          
**
*******************************************************************************/

ALTER Procedure [SQLCfg].[pChangeHistoryByItem]
 ( @Node [NVARCHAR] (786)
 , @DaysToShow [INT] = 10000 )
AS
BEGIN

SET NOCOUNT ON;

SELECT [Id] 
 , [Version]
 , [Action]
 , CAST([RecCreatedDt] AS [DATE]) AS [Date]
FROM [SQLCfg].[tChange]
WHERE [Node] = @Node
AND [RecCreatedDt] > CAST(CURRENT_TIMESTAMP - @DaysToShow AS [DATE])
ORDER BY [Id] DESC; 

END
GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Get the SQL errors for the the last n days  
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/28/2009     bw                 add date conversion          
**              
*******************************************************************************/

ALTER PROCEDURE [SQLCfg].[pSQLErrorLogSelectMostRecent] 
 ( @DaysToGet [INT] = 30 )
AS
BEGIN

 SELECT [UserName]
  , [DBName]
  , [ErrorNumber]
  , [ErrorSeverity]
  , [ErrorState]
  , [ErrorProcedure]
  , [ErrorLine]
  , [ErrorMessage]
  , [TextData]
  , [Notes]
  , [RecCreatedDt] 
 FROM [SQLCfg].[tSQLErrorLog]  
 WHERE [RecCreatedDt] > CAST(CURRENT_TIMESTAMP - @DaysToGet AS DATE);
 
END
GO

/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Get the number of changes for the last @DaysToShow days
**       optionally filter by Instance, Database, Schema, ItemType and/or Name
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/28/2009     bw                 remove locale specific date conversion          
**              
*******************************************************************************/

ALTER Procedure [SQLCfg].[pChangeActionSummaryByNodeForDays]
 ( @DaysToShow [INT] = 30 
 , @Node [NVARCHAR] (786) = 'All' )
AS
BEGIN

SET NOCOUNT ON;

SELECT [Node].[SQLInstance] As [SQLInstance] 
 , [Node].[Type] As [Type]
 , CAST([RecCreatedDt] AS [DATE]) AS [Date]
 , CASE WHEN @Node = 'All' THEN 'All Nodes' ELSE @Node END AS [Node]
    , Count(*) AS [TotalChangeCount] 
 , SUM(CASE WHEN Action = 'Include' THEN 1 ELSE 0 END) AS [MetadataRowInserts] 
 , SUM(CASE WHEN Action = 'Modify' THEN 1 ELSE 0 END) AS [MetadataRowUpdates] 
 , SUM(CASE WHEN Action = 'Remove' THEN 1 ELSE 0 END) AS [MetadataRowDeletes] 
 , SUM(CASE WHEN Action = 'Add' THEN 1 ELSE 0 END) AS [SQLConfigurationAdded] 
 , SUM(CASE WHEN Action = 'Change' THEN 1 ELSE 0 END) AS [SQLConfigurationChanged] 
 , SUM(CASE WHEN Action = 'Delete' THEN 1 ELSE 0 END) AS [SQLConfigurationRemoved] 
FROM [SQLCfg].[tChange]
WHERE [RecCreatedDt] > CAST(CURRENT_TIMESTAMP - @DaysToShow AS [DATE])
AND [Node] = CASE WHEN @Node = 'All' THEN [Node] ELSE @Node END
GROUP BY [Node].[SQLInstance], [Node].[Type]
 , CAST([RecCreatedDt] AS [DATE])
ORDER BY [Date]
 , [SQLInstance]
 , [Type];

END
GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Get the list of changes for the last @DaysToShow days
**       optionally filter by Instance, Database, Schema, ItemType and/or Name
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/28/2009     bw                 remove locale specific date conversion          
**              
*******************************************************************************/
ALTER Procedure [SQLCfg].[pChangeActionByNodeForDays]
 ( @DaysToShow [INT] = 30 
 , @Node [NVARCHAR] (786) = 'All' )
AS
BEGIN

SET NOCOUNT ON;

SELECT [Node].[SQLInstance] As [SQLInstance] 
 , [Node].[Type] As [Type]
 , CAST([RecCreatedDt] AS [DATE]) AS [Date]
 , CASE WHEN @Node = 'All' THEN 'All Nodes' ELSE @Node END AS [Node]
 , Action 
FROM [SQLCfg].[tChange]
WHERE [RecCreatedDt] > CAST(CURRENT_TIMESTAMP - @DaysToShow AS [DATE])
AND [Node] = CASE WHEN @Node = 'All' THEN [Node] ELSE @Node END
ORDER BY [Date], [SQLInstance], [Type];

END
GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11-5-2009      bw                 no null definition if protocol, login,
**                                      or pwd is null         
*******************************************************************************/

ALTER TRIGGER [SQLCfg].[trgtConnection_Insert_Update_Delete]
ON [SQLCfg].[tConnection]
FOR INSERT, UPDATE, DELETE
AS
BEGIN
 DECLARE @icount [INT]
  , @dcount [INT] 
  , @NodeBase [NVARCHAR](50)
  , @TextData [VARCHAR] (2048)
  , @InstanceName [NVARCHAR] (128);

 SET NOCOUNT ON;

 BEGIN TRY
  SELECT @icount = COUNT(*) FROM [inserted];
  SELECT @dcount = COUNT(*) FROM [deleted];

  -- no multi-row
  IF @icount > 1 OR @dcount > 1
   BEGIN
    SET @TextData = 'Multi-row [SQLCfg].[tConnection] operations are not permitted';
    RAISERROR (@TextData,16,1)
   END

  SET @NodeBase = 'SQLCfgMetadata|SQLCfg.tConnection|';
  SELECT @InstanceName = UPPER([InstanceName]) from deleted

  -- deletes
  IF @icount = 0 AND @dcount = 1
   BEGIN
    IF (SELECT [EncryptedConnection] FROM deleted) = 1
      RAISERROR('Remove encrypted connection configuration on Instance [%s] before deleting the connection''s metadata.', 16, 1, @InstanceName);  
 
    -- There can be no configuration left when the connection is deleted
    -- the approach here will leave a change row for each removed row
    SET ROWCOUNT 1

		WHILE EXISTS (SELECT * FROM [SQLCfg].[tServiceBroker] 
					  WHERE [InstanceName] = @InstanceName) 
		 DELETE [SQLCfg].[tServiceBroker]
		 WHERE [InstanceName] = @InstanceName
		 AND [DatabaseName] = (SELECT MIN([DatabaseName])
							   FROM [SQLCfg].[tServiceBroker]
							   WHERE [InstanceName] = @InstanceName);
	                          

		WHILE EXISTS (SELECT * FROM [SQLCfg].[tDb] 
					  WHERE [InstanceName] = @InstanceName)
		 DELETE [SQLCfg].[tDb] 
		 WHERE [InstanceName] = @InstanceName
		 AND [Name] = (SELECT MIN([Name])
					 FROM [SQLCfg].[tDb]
					 WHERE [InstanceName] = @InstanceName);


		DELETE [SQLCfg].[tJobServer]
		WHERE [InstanceName] = @InstanceName;

		DELETE [SQLCfg].[tInstance]
		WHERE [Name] = @InstanceName;

		-- fkey cascades deletes to tSchedule rows but will violate the 'operate on one row at a time' rule
		WHILE EXISTS (SELECT * FROM [SQLCfg].[tSchedule] 
					  WHERE [InstanceName] = @InstanceName)
		 DELETE [SQLCfg].[tSchedule]
		 WHERE [InstanceName] = @InstanceName
		 AND [Id] = (SELECT MIN([Id])
				   FROM [SQLCfg].[tSchedule]
				   WHERE [InstanceName] = @InstanceName);

    SET ROWCOUNT 1

    INSERT [SQLCfg].[tChange]
     ( [Node]
     , [Version]
     , [Action] 
     , [Definition]
     , [DefinitionDt] )
    SELECT
       @NodeBase + [InstanceName]
     , [SQLCfg].[fLastVersion](@Nodebase + [InstanceName]) + 1
     , 'Remove'
     , 'DELETE [SQLCfg].[tConnection]
WHERE [InstanceName] = ''' + [InstanceName] + '''
AND [EncryptedConnection] = ' + CAST([EncryptedConnection] AS [CHAR] (1)) + ' 
AND [TrustServerCertificate] = ' + CAST([TrustServerCertificate] AS [CHAR] (1)) + ' 
AND [NetworkProtocol] = ''' + ISNULL([NetworkProtocol],'NULL') + ''' 
AND [ConnectionTimeout] = ' + CAST([ConnectionTimeout] AS [CHAR] (10)) + ' 
AND [LoginSecure] = ' + CAST([LoginSecure] AS [CHAR] (1)) + ' 
AND [LoginName] = ''' + ISNULL([LoginName],'NULL') + ''' 
AND [EncryptedPassword] = ' + ISNULL(sys.fn_varbintohexstr([EncryptedPassword]), 'NULL') + '
AND [IsDeleted] = ' + CAST([IsDeleted] AS [CHAR] (1)) + ' 
AND [RecCreatedDt] = ''' + CAST([RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + [RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST([RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + [RecUpdatedUser] + ''''
     , CURRENT_TIMESTAMP
    FROM [deleted] 
    WHERE [InstanceName] NOT IN (SELECT [InstanceName] FROM [inserted]);
   END

  -- updates
  IF @icount = 1 AND @dcount = 1
   BEGIN
    -- if LoginSecure, set login and password to null  
    UPDATE s
    SET [Loginname] = NULL
     , [EncryptedPassword] = NULL 
    FROM [inserted] i
    JOIN [SQLCfg].[tConnection] s
    ON i.[InstanceName] = s.[InstanceName]
    WHERE i.[LoginSecure] = 1 
    AND (   s.[LoginName] IS NOT NULL
         OR s.[EncryptedPassword] IS NOT NULL);

    --- add audit info
    UPDATE c
    SET [RecUpdatedDt] = CURRENT_TIMESTAMP
     , [RecUpdatedUser] = ORIGINAL_LOGIN()
     , [InstanceName] = c.InstanceName 
    FROM [SQLCfg].[tConnection] c
    JOIN [inserted] i 
    ON c.[InstanceName] = i.[InstanceName]
    JOIN [deleted] d
    ON i.[InstanceName] = d.[InstanceName];

    -- record the change
    INSERT [SQLCfg].[tChange]
     ( [Node]
     , [Version]
     , [Action] 
     , [Definition]
     , [DefinitionDt] )
    SELECT
       @NodeBase + i.[InstanceName]
     , [SQLCfg].[fLastVersion](@Nodebase + i.[InstanceName]) + 1
     , 'Modify'
     , 'UPDATE [SQLCfg].[tConnection]
SET [InstanceName] = ''' + i.[InstanceName] + '''
 , [EncryptedConnection] = ' + CAST(i.[EncryptedConnection] AS [CHAR] (1)) + ' 
 , [TrustServerCertificate] = ' + CAST(i.[TrustServerCertificate] AS [CHAR] (1)) + ' 
 , [NetworkProtocol] = ''' + ISNULL(i.[NetworkProtocol],'NULL') + ''' 
 , [ConnectionTimeout] = ' + CAST(i.[ConnectionTimeout] AS [CHAR] (10)) + ' 
 , [LoginSecure] = ' + CAST(i.[LoginSecure] AS [CHAR] (1)) + ' 
 , [LoginName] = ' + ISNULL(i.[LoginName], 'NULL') + ' 
 , [EncryptedPassword] = ' + ISNULL(sys.fn_varbintohexstr(i.[EncryptedPassword]),'NULL') + '
 , [IsDeleted] = ' + CAST(i.[IsDeleted] AS [CHAR] (1)) + ' 
 , [RecCreatedDt] = ''' + CAST(i.[RecCreatedDt] AS [VARCHAR] (20)) + '''
 , [RecCreatedUser] = ''' + i.[RecCreatedUser] + '''
 , [RecUpdatedDt] = ''' + CAST(i.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
 , [RecUpdatedUser] = ''' + i.[RecUpdatedUser] + '''
WHERE [InstanceName] = ''' + d.[InstanceName] + '''
AND [EncryptedConnection] = ' + CAST(d.[EncryptedConnection] AS [CHAR] (1)) + ' 
AND [TrustServerCertificate] = ' + CAST(d.[TrustServerCertificate] AS [CHAR] (1)) + ' 
AND [NetworkProtocol] = ''' + ISNULL(d.[NetworkProtocol],'NULL') + ''' 
AND [ConnectionTimeout] = ' + CAST(d.[ConnectionTimeout] AS [CHAR] (10)) + ' 
AND [LoginSecure] = ' + CAST(d.[LoginSecure] AS [CHAR] (1)) + ' 
AND [LoginName] = ''' + ISNULL(d.[LoginName],'NULL') + ''' 
AND [EncryptedPassword] = ' + ISNULL(sys.fn_varbintohexstr(d.[EncryptedPassword]),'NULL') + ' 
AND [IsDeleted] = ' + CAST(d.[IsDeleted] AS [CHAR] (1)) + ' 
AND [RecCreatedDt] = ''' + CAST(d.[RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + d.[RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST(d.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + d.[RecUpdatedUser] + ''''
     , CURRENT_TIMESTAMP
    FROM [inserted] i 
    JOIN [deleted] d
    ON i.[InstanceName] = d.[InstanceName];
   END

  -- inserts
  IF @icount = 1 AND @dcount = 0
   BEGIN

    UPDATE c
    SET [InstanceName] = c.InstanceName 
    FROM [SQLCfg].[tConnection] c
    JOIN [inserted] i 
    ON c.[InstanceName] = i.[InstanceName];
       
    INSERT [SQLCfg].[tChange]
     ( [Node]
     , [Version]
     , [Action] 
     , [Definition]
     , [DefinitionDt] )
    SELECT
       @NodeBase + [InstanceName]
     , [SQLCfg].[fLastVersion](@Nodebase + [InstanceName]) + 1
     , 'Include'
     , 'INSERT [SQLCfg].[tConnection]
 ( [InstanceName]
 , [EncryptedConnection]
 , [TrustServercertificate]
 , [NetworkProtocol]
 , [ConnectionTimeout]
 , [LoginSecure]
 , [LoginName]
 , [EncryptedPassword]
 , [IsDeleted]  
 , [RecCreatedDt] 
 , [RecCreatedUser]
 , [RecUpdatedDt]
 , [RecUpdatedUser])
SELECT [InstanceName] = ''' + [InstanceName] + '''
AND [EncryptedConnection] = ' + CAST([EncryptedConnection] AS [CHAR] (1)) + ' 
AND [TrustServerCertificate] = ' + CAST([TrustServerCertificate] AS [CHAR] (1)) + ' 
AND [NetworkProtocol] = ''' + ISNULL([NetworkProtocol],'NULL') + ''' 
AND [ConnectionTimeout] = ' + CAST([ConnectionTimeout] AS [CHAR] (10)) + ' 
AND [LoginSecure] = ' + CAST([LoginSecure] AS [CHAR] (1)) + ' 
AND [LoginName] = ''' + ISNULL([LoginName],'NULL') + ''' 
AND [EncryptedPassword] = ' + ISNULL(sys.fn_varbintohexstr([EncryptedPassword]),'NULL') + ' 
AND [IsDeleted] = ' + CAST([IsDeleted] AS [CHAR] (1)) + ' 
AND [RecCreatedDt] = ''' + CAST([RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + [RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST([RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + [RecUpdatedUser] + ''''
     , CURRENT_TIMESTAMP
    FROM [inserted] 
    WHERE [InstanceName] NOT IN (SELECT [InstanceName] FROM [deleted]);
   END

 END TRY

 BEGIN CATCH

   EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH 

END;

GO

/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2009
**
**    Desc: all databases containing archive records on an SQL Server instance    
**       
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/
ALTER PROCEDURE [SQLCfg].[pChangeSelectDatabaseListForInstance] 
 ( @SQLInstance [NVARCHAR] (128) )
AS
BEGIN

SELECT DISTINCT [Node].[Database] AS [DatabaseName]
FROM [SQLCfg].[tChange]
WHERE [Node].[SQLInstance] = @SQLInstance
ORDER BY [Node].[Database]

END
GO

/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    Dec 23,2009    bw                 cascade db delete to all db items
*******************************************************************************/

ALTER TRIGGER [SQLCfg].[trgtChange_Insert_Update_Delete]
ON [SQLCfg].[tChange]
INSTEAD OF INSERT, UPDATE, DELETE
AS
BEGIN
 DECLARE @icount [INT]
  , @dcount [INT]
  , @TextData [VARCHAR] (2048)
  , @ConcatEventData [XML];

 SET NOCOUNT ON;

 BEGIN TRY

  SELECT @icount = COUNT(*) FROM [inserted];
  SELECT @dcount = COUNT(*) FROM [deleted];

  IF (@icount) > 1
  OR (@dcount) > 1
   BEGIN
    SET @TextData = 'Multi-row [SQLCfg].[tChange] operations are not supported. icount=%d; dcount= %d';
    RAISERROR (@TextData, 16,1, @icount, @dcount)
   END;

  IF @icount = 1 AND @dcount = 0
   BEGIN
     -- the application determines if current is duplicate of previous
     -- and also serializes changes
     -- here we just add the definition provided
     INSERT [SQLCfg].[tChange]
      (  [Node]
       , [Version]
       , [Action]
       , [EventData]
       , [Definition]
       , [DefinitionDt] ) 
     SELECT [Node] = ISNULL(i.[Node], 0x0)
       , [Version] = [SQLCfg].[fLastVersion](i.[Node]) + 1 
       , [Action] = i.[Action]
       , [EventData] = i.[EventData]
       , [Defintion] = i.[Definition]
       , [DefinitionDt] = i.[EVENTDATA].value('(/ROOT/EVENT_INSTANCE/PostTime)[1]', 'DATETIME') 
     FROM [inserted] i;     

     -- cascade delete to all items in a db if db is deleted
     IF EXISTS (SELECT * 
                FROM [inserted]
                WHERE [Node].[Collection] = 'Databases'
                AND [Action] = 'Delete') 
       INSERT [SQLCfg].[tChange]
        (  [Node]
         , [Version]
         , [Action]
         , [EventData]
         , [Definition]
         , [DefinitionDt] ) 
       SELECT [Node] = c.[Node]
         , [Version] = c.[Version] + 1 
         , [Action] = i.[Action]
         , [EventData] = ISNULL( i.[EventData]
                               , CAST('<ROOT><EVENT_INSTANCE>Database Dropped</EVENT_INSTANCE></ROOT>' AS XML))
         , [Defintion] = ''
         , [DefinitionDt] = i.[EVENTDATA].value('(/ROOT/EVENT_INSTANCE/PostTime)[1]', 'DATETIME') 
       FROM [SQLCfg].[tChange] c
       JOIN [inserted] i
       ON c.[Node].[Database] = i.[Node].Item
       WHERE c.[Node].[Type] = 'SQLInstance' 
       AND c.[Version] = [SQLCfg].[fLastVersion](c.[Node]);     

   END;  

  -- only update allowed is append to EventData when an event based compare does not detect differences 
  IF @icount = 1 and @dcount = 1
   BEGIN
       -- this is a little loose but better than parsing xml
       -- can't compare 
   	   UPDATE c
	   SET [EventData] = i.[EventData]
		, [Action] = i.[Action]
		, [DefinitionDt] = ISNULL(i.[DefinitionDt], CURRENT_TIMESTAMP) 
	   FROM [SQLCfg].[tChange] c
	   JOIN inserted i
	   ON c.[Id] = i.[Id]
	   WHERE i.[EventData] IS NOT NULL
	   AND (   c.[EventData] IS NULL 
			OR (i.[EventData].value('count(/ROOT/EVENT_INSTANCE)', 'INT') > c.[EventData].value('count(/ROOT/EVENT_INSTANCE)', 'INT')
			    AND i.[EventData].value('count(/ROOT/EVENT_INSTANCE/EVENT_TYPE)[1]', 'NVARCHAR(50)') = c.[EventData].value('count(/ROOT/EVENT_INSTANCE/EVENT_TYPE)[1]', 'INT')))
  END 

  -- no delete
  IF @icount = 0 and @dcount > 0  
   BEGIN
    SET @TextData = '[SQLCfg].[tChange] delete operations are not permitted.';
    RAISERROR (@TextData, 16,1);
   END;

 END TRY 

 BEGIN CATCH

  EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH 

END;

GO

IF EXISTS ( SELECT * 
            FROM INFORMATION_SCHEMA.ROUTINES 
            WHERE SPECIFIC_SCHEMA = N'SQLCfg'
            AND SPECIFIC_NAME = N'pArchiveLogSelectScheduleHistory' )
 DROP PROCEDURE [SQLCfg].[pArchiveLogSelectScheduleHistory];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: get the history for a SQL Server
**       
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE Procedure [SQLCfg].[pArchiveLogSelectScheduleHistory]
 ( @SQLInstance [NVARCHAR] (128)
 , @BeginDt [DATETIME]
 , @EndDt [DATETIME])
AS
BEGIN

 SET NOCOUNT ON;
 
    SELECT l.[Id] AS [ArchiveLogId]
    , l.[ScheduleId]
    , l.[InstanceName]
    , l.[NbrDDLEventsProcessed]
    , l.[NbrItemsProcessed]
    , l.[NbrItemsAdded]
    , l.[NbrItemsChanged]
    , l.[NbrItemsDeleted]
    , l.[ScheduledStartDt]
    , l.[ActualStartDt]
    , l.[ActualEndDt] 
    , l.[RecCreatedUser]
    , l.[ArchiveError]
    , s1.[Interval]
    , s1.[IntervalType]
    , s1.[IntervalBaseDt]
    , s1.[UseEventNotifications]
    , s1.[IsActive]
   FROM [SQLCfg].[tArchiveLog] l
   JOIN [SQLCfg].[tSchedule] s1
   ON l.[ScheduleId] = s1.[Id] 
   WHERE s1.[InstanceName] = @SQLInstance
   AND (   l.[ScheduledStartDt] BETWEEN @BeginDt AND @EndDt
        OR l.[ActualStartDt]    BETWEEN @BeginDt AND @EndDt); 

END;

GO

GRANT EXECUTE ON [SQLCfg].[pArchiveLogSelectScheduleHistory] TO [SQLCfgReportingRole];

GO

