/*******************************************************************************
 Creates the SQLClue Configuration Archive data store.
  
 The self deleting stored proc SQLCfg.pRepositoryInit is executed after this 
 script to prepare the host SQL Server for monitoring. 

 Do not run this script using SSMS, use the SQLClue Console's 
  'Tools|SQL Configuration|Install' menu option to create the SQL Configuration 
 repository data store. The application verifies and completes all configuration 
 and security steps that must otherwise be done manually. The application also 
 maintains user settings that support the data store's state of deployment.

 The data store can be created in any database. An existing database can be 
 selected at the beginning of the installation's SQL connection dialog. Note 
 in the script the changes that will be made to the database. Compression, 
 partitioning and Transparent Data Encryption can be used if desired. 
*******************************************************************************/

EXEC sp_changedbowner 'sa';

GO

IF (SELECT [is_read_committed_snapshot_on] 
    FROM sys.databases
    WHERE [name] = DB_NAME()) = 0
 BEGIN 
  BEGIN TRY
   DECLARE @SET_READ_COMMITED_SNAPSHOT [NVARCHAR](400), @rc [INT];
   SET @SET_READ_COMMITED_SNAPSHOT = 'ALTER DATABASE [' + DB_NAME() + '] SET ALLOW_SNAPSHOT_ISOLATION ON; 
     ALTER DATABASE [' + DB_NAME() + '] SET READ_COMMITTED_SNAPSHOT ON;'
   EXEC @rc = sp_executesql @SET_READ_COMMITED_SNAPSHOT;
  END TRY
  BEGIN CATCH
    DECLARE @Msg [NVARCHAR](1024);  
    SET @Msg = ERROR_MESSAGE();
    RAISERROR('instSQLClueRepository.sql failed at SET READ_COMITTED_SNAPSHOT. Error Message: %s @rc:%d',20,1, @Msg, @rc) WITH LOG;
  END CATCH
 END
GO

IF NOT EXISTS (SELECT * FROM [sys].[schemas] WHERE [name] = 'SQLCfg')
 EXEC('CREATE SCHEMA [SQLCfg] AUTHORIZATION [dbo]')

GO           

IF IS_MEMBER('SQLCfgReportingRole') IS NULL
 CREATE ROLE [SQLCfgReportingRole] AUTHORIZATION [db_owner];

GO 

IF IS_MEMBER('SQLCfgServiceRole') IS NULL
 CREATE ROLE [SQLCfgServiceRole] AUTHORIZATION [db_owner];

EXEC [sys].[sp_addrolemember] 'SQLCfgReportingRole', 'SQLCfgServiceRole';

GO

IF IS_MEMBER('SQLCfgAdminRole') IS NULL
 CREATE ROLE [SQLCfgAdminRole] AUTHORIZATION [db_owner];
EXEC [sys].[sp_addrolemember] 'SQLCfgServiceRole', 'SQLCfgAdminRole';

GO

IF IS_MEMBER('SQLClueAdminRole') IS NULL
 CREATE ROLE [SQLClueAdminRole] AUTHORIZATION [db_owner];
EXEC [sys].[sp_addrolemember] 'SQLCfgAdminRole', 'SQLClueAdminRole';
EXEC [sys].[sp_addrolemember] 'db_datareader', 'SQLClueAdminRole';

GO

DECLARE @Login [NVARCHAR](128);
SET @Login = ORIGINAL_LOGIN();
IF IS_MEMBER('Public')=0
 EXEC [sys].[sp_grantdbaccess] @Login;
EXEC [sys].[sp_addrolemember] 'SQLClueAdminRole', @Login;

GO

If NOT EXISTS (SELECT * FROM [sys].[fulltext_catalogs] WHERE name = 'ftSQLConfigurationRepositoryCatalog')
 CREATE FULLTEXT CATALOG [ftSQLConfigurationRepositoryCatalog];

GO

If (SELECT [value] AS [IsCLREnabled] 
    FROM [sys].[configurations]
    WHERE [name] = 'clr enabled') = 0
 BEGIN
  EXEC [dbo].[sp_configure] 'clr enabled', 1;
  RECONFIGURE;
  -- no restart needed for SQL 2008, SQLClue not suppoted on 2005 anyway 
  IF ISNULL(PARSENAME ( CONVERT(NVARCHAR(128), SERVERPROPERTY('ProductVersion')) , 4 ), 0) < 10
  BEGIN
   RAISERROR('CLR Integration has been enabled on SQL instance [%s]. SQL Server 2005 requires a restart of the SQLClue host SQL Server service to active the configuration change.',20,1,@@SERVERNAME) WITH LOG; 
  END 
 END

GO
IF  NOT EXISTS (SELECT * FROM [sys].[assemblies] WHERE [name] = N'SQLClueCLR')
  EXEC sp_executesql N'CREATE ASSEMBLY [SQLClueCLR]
AUTHORIZATION [dbo]
FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C010400AAA2074F0000000000000000E00002210B0108000026000000080000000000007E45000000200000006000000000400000200000000200000400000000000000040000000000000000C0000000040000B4400000020040850000100000100000000010000010000000000000100000000000000000000000304500004B00000000800000A80300000000000000000000000000000000000000A000000C000000006000001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E7465787400000084250000002000000026000000040000000000000000000000000000200000602E73646174610000910000000060000000020000002A0000000000000000000000000000400000C02E72737263000000A80300000080000000040000002C0000000000000000000000000000400000402E72656C6F6300000C00000000A00000000200000030000000000000000000000000000040000042000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060450000000000004800000002000500DC2B000054190000090000000000000000000000000000005A2B0000800000000000000000000000000000000000000000000000000000000000000000000000133001002500000001000011000228020000062C0A72010000700A2B122B0F00027B030000046F0400000A0A2B0100062A000000133001000C0000000200001100027B020000040A2B00062A133002001700000003000011001200FE15020000021200177D02000004060B2B00072A0013300500B807000004000011000F00280500000A2C0B28030000060A38A1070000001201FE150200000212010F00FE16040000016F0600000A7D03000004120112017B03000004178D0A0000010C08161F7C9D086F0700000A7D04000004120112017B040000048EB77D070000040012017B04000004169A0D0009720B00007016280800000A16404E02000000120172290000707D05000004120112017B04000004179A7D0A0000040012017B0A0000041304001104723B00007016280800000A16333600120172590000707D08000004120172590000707D090000041201725B0000707D060000041201725B0000707D0C00000438DA010000001104726B00007016280800000A16334200120172970000707D06000004120112017B04000004189A7D08000004120112017B04000004199A7D09000004120112017B04000004199A7D0C000004388701000000110472B300007016280800000A16334200120172C90000707D06000004120112017B04000004189A7D08000004120112017B04000004199A7D09000004120112017B04000004199A7D0C000004383401000000110472DB00007016280800000A16333E00120172FF0000707D06000004120112017B04000004189A7D08000004120172590000707D09000004120112017B04000004189A7D0C00000438E5000000001104721301007016280800000A16333E00120172350100707D06000004120112017B04000004189A7D08000004120172590000707D09000004120112017B04000004189A7D0C0000043896000000001104724301007016280800000A16333B00120172690100707D06000004120112017B04000004189A7D08000004120172590000707D09000004120112017B04000004189A7D0C0000042B4A001104727F01007016280800000A16333900120172A10100707D06000004120112017B04000004189A7D08000004120172590000707D09000004120112017B04000004189A7D0C0000040038BA04000000120172B30100707D05000004120112017B04000004169A7D08000004120172350100707D06000004120172590000707D09000004120172590000707D0A000004120172590000707D0B000004120172590000707D0C00000412017B040000048EB7173315120112017B04000004169A7D0C000004383F0400000012017B04000004179A72CB01007016280800000A16FE0112017B04000004179A72EB01007016280800000A16FE016012017B04000004179A720702007016280800000A16FE016012017B04000004179A722702007016280800000A16FE016012017B04000004179A723F02007016280800000A16FE016012017B04000004179A724902007016280800000A16FE016012017B04000004179A726302007016280800000A16FE016012017B04000004179A728502007016280800000A16FE016012017B04000004179A729702007016280800000A16FE01602C15120112017B04000004179A7D0C000004384F03000012017B04000004179A72B302007016280800000A16FE0112017B04000004179A72CF02007016280800000A16FE016012017B04000004179A72DD02007016280800000A16FE016012017B04000004179A72F502007016280800000A16FE016012017B04000004179A722303007016280800000A16FE016012017B04000004179A723703007016280800000A16FE016012017B04000004179A725303007016280800000A16FE016012017B04000004179A726103007016280800000A16FE016012017B04000004179A726D03007016280800000A16FE016012017B04000004179A72A103007016280800000A16FE016012017B04000004179A72B303007016280800000A16FE01602C32120112017B04000004179A7D0A00000412017B040000048EB7193310120112017B04000004189A7D0C00000400381402000012017B04000004179A72FF00007016280800000A16408900000012017B040000048EB7183312120112017B04000004179A7D0C0000042B6500120172FF0000707D0600000412017B04000004189A72DB03007016280800000A163312120112017B04000004189A7D0C0000042B1100120112017B04000004189A7D0A0000040012017B040000048EB71A3310120112017B04000004199A7D0C0000040000387101000012017B04000004179A72F303007016280800000A16405701000012017B040000048EB7183315120112017B04000004179A7D0A000004383501000012017B040000048EB7193325120112017B04000004179A7D0A000004120112017B04000004189A7D0C000004380401000000120172C90000707D06000004120112017B04000004189A7D0900000412017B04000004199A72CB01007016280800000A16FE0112017B04000004199A720704007016280800000A16FE01602C15120112017B04000004199A7D0C00000438A000000012017B04000004199A729700007016280800000A16335B12017B040000048EB71A3312120112017B04000004199A7D0C0000042B3A00120172970000707D06000004120112017B040000041A9A7D0A00000412017B040000048EB71C3310120112017B040000041B9A7D0C00000400002B2E00120112017B04000004199A7D0A00000412017B040000048EB71B3310120112017B040000041A9A7D0C000004000000000000120112017B03000004722704007012017B0C000004280900000A72590000706F0A00000A7D0B000004070A2B00062A3E0002036F0B00000A7D03000004002A420003027B030000046F0C00000A00002A000000133001001E0000000500001100027B03000004280D00000A28040000060B12017B070000040A2B00062A0000133001001E0000000600001100027B03000004280D00000A28040000060B12017B050000040A2B00062A0000133001001E0000000700001100027B03000004280D00000A28040000060B12017B060000040A2B00062A0000133001001E0000000800001100027B03000004280D00000A28040000060B12017B080000040A2B00062A0000133001001E0000000900001100027B03000004280D00000A28040000060B12017B090000040A2B00062A0000133001001E0000000A00001100027B03000004280D00000A28040000060B12017B0A0000040A2B00062A0000133004005C0000000B00001100027B03000004280D00000A28040000060B12017B0A000004725900007016280800000A16FE0116FE01027B03000004280D00000A28040000060C12027B0C000004725900007016280800000A16FE015F2D03162B01170A2B00062A133001001E0000000C00001100027B03000004280D00000A28040000060B12017B0B0000040A2B00062A0000133001001E0000000D00001100027B03000004280D00000A28040000060B12017B0C0000040A2B00062A00002602281100000A00002A000013300100120000000E000011000F00280C000006280D00000A0A2B00062A000013300100120000000F000011000F00280B000006280D00000A0A2B00062A0000133001001200000010000011000F00280F000006280D00000A0A2B00062A0000133001001200000011000011000F00280E000006280D00000A0A2B00062A0000133001001200000012000011000F00280A000006280D00000A0A2B00062A0000133001001200000013000011000F002809000006280D00000A0A2B00062A0000133001001200000014000011000F002807000006281200000A0A2B00062A419DECF2E9D470EF45890E0235189DCCBBA246E78003A78171B20D22807F2793EBAF42D8F48F51947D4E0EFFECCFCD5C3D06E310D367C70938DCD1D40CA77E1C9B9C20C35631347AF27EEE0D22EA27F157AD1589428D73DA1E715264F6B98038E7A5DDC861FB21D49BA47B5F891793F86C416F4B176D065DDAA8F063C7A11A8C000042534A4201000100000000000C00000076342E302E33303331390000000005006C0000009C050000237E000008060000B005000023537472696E677300000000B80B00002C04000023555300E40F0000100000002347554944000000F40F00006009000023426C6F620000000000000002000001571FA2030900000000FA2533001600000100000020000000030000000C000000170000000A0000000200000022000000010000001900000014000000010000000B0000000B00000003000000010000000300000000009F0501000000000006005B0054000E00860071000E00AB0090000E00450171000600610157010600750157010600500254000E00A30271000600B60254000600BD0254000A00EF02C8020E002D0390000E00490390000600500354000E00660390000E00790390000600A1038E030600BE038E034B00D203000006000104E10306002104E103060051043F04060068043F040600960485040600D704B8040600E504B8040600F904540006000F053F0406002A053F04060045053F0406005E053F04060077053F0400000000010000000000010001000921000029003400050001000100010000003F0034001D000D0010005180BC0013000100C2001F000100C90013000100D00022000100DA0013000100E10013000100EB0026000100F400130001000201130001000D01130001001A0113000100210113005020000000004602280129000100842000000000660B31012D0001009C200000000016083C0131000100C0200000000016004F013600010084280000000066036E013D0002009428000000006603820143000300A8280000000006088A0149000400D42800000000060895012900040000290000000006089E01290004002C29000000000608AA01290004005829000000000608BA01290004008429000000000608C70129000400B029000000000608D6012D000400182A000000000608E70129000400442A000000000608F00129000400702A00000000061857025E0004007C2A0000000016005D02620004009C2A000000001600700262000500BC2A0000000016007C0262000600DC2A000000001600840262000700FC2A0000000016008C02620008001C2B0000000016009802620009003C2B000000001600AC0269000A00000001005501000001007301000001008801000001006B02000001006B02000001006B02000001006B02000001006B02000001006B02000001006B020200090002000D00110031012D0019006E013D00190082014300490028012900210031012D003900280129004900C2027F005900F9028600490007038D0049000E03930029001603290031008201A40021002103A90061005702C300710057025E00790057025E00390057025E00410021036502810057025E00890057025E0091005702C807A1005702CE07A90057025E00B1005702A400B9005702A400C1005702A400C9005702A400D1005702D307D9005702D307E1005702A400E9005702A400F1005702A400F9005702A40001015702A4000E00040016002000830018012E00B30083082E00BB008C082E00130144092E00AB007A082E00E300C8082E000B0133092E00CB00BB082E00D300C8082E00DB00CE082E00C300AB082E00EB00F8082E00F300C8082E00FB00FE082E000301260943007300C9008000830018010002A300F50320029B00FA0340029B00C00460029B00840580029B004406A0029B000407C0029B007002E0029B0033037000740078009900AF00B500B500B500B500B500BB00B500B5006002600260026002600260026B02020001000000F9014D0000000002510000000502560000000C025A00000011025A00000019025A00000025025A0000002E025A00000039024D00000046025A0000004B025A00020002000300020003000500020007000700020008000900020009000B0002000A000D0002000B000F0002000C00110002000D00130002000E00150002000F00170002000400030002000A00050002000C00070004800000010005000100010001000000D8079405000004000000000000000000000001000A00000000000A00000000000000000000000A0013000000000004000000000000000000000001006500000000000000003C4D6F64756C653E006D73636F726C6962004D6963726F736F66742E56697375616C42617369630053514C4366674E6F64650053514C4367664E6F64650055736572446566696E656446756E6374696F6E730053797374656D0056616C7565547970650053797374656D2E446174610053797374656D2E446174612E53716C547970657300494E756C6C61626C65004D6963726F736F66742E53716C5365727665722E536572766572004942696E61727953657269616C697A65005F4E554C4C006D5F4E756C6C006D5F4E6F6465006D5F537472696E6773006D5F54797065006D5F53756254797065006D5F4C656E677468006D5F53514C496E7374616E6365006D5F4461746162617365006D5F436F6C6C656374696F6E006D5F50617468006D5F4974656D00546F537472696E67006765745F49734E756C6C006765745F4E756C6C0053716C537472696E6700506172736500730053797374656D2E494F0042696E617279526561646572005265616400720042696E6172795772697465720057726974650077006765745F4C656E677468006765745F54797065006765745F53756254797065006765745F53514C496E7374616E6365006765745F4461746162617365006765745F436F6C6C656374696F6E006765745F4973436F6C6C656374696F6E006765745F50617468006765745F4974656D0049734E756C6C004E756C6C004C656E677468005479706500537562547970650053514C496E7374616E636500446174616261736500436F6C6C656374696F6E004973436F6C6C656374696F6E0050617468004974656D004F626A656374002E63746F7200476574436F6C6C656374696F6E004E6F6465004765744461746162617365004765744974656D004765745061746800476574496E7374616E636500476574537562547970650053716C496E743332004765744C656E67746800537472696E6700436861720053706C6974004D6963726F736F66742E56697375616C42617369632E436F6D70696C65725365727669636573004F70657261746F727300436F6D70617265537472696E6700436F6E636174005265706C6163650052656164537472696E67006F705F496D706C696369740053716C55736572446566696E65645479706541747472696275746500466F726D61740053657269616C697A61626C654174747269627574650053716C4D6574686F644174747269627574650053716C46756E6374696F6E4174747269627574650053797374656D2E446961676E6F73746963730044656275676765724E6F6E55736572436F64654174747269627574650044656275676761626C6541747472696275746500446562756767696E674D6F6465730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C6974794174747269627574650053797374656D2E5265666C656374696F6E00417373656D626C795469746C6541747472696275746500417373656D626C7946696C6556657273696F6E4174747269627574650053797374656D2E5265736F7572636573004E65757472616C5265736F75726365734C616E67756167654174747269627574650053797374656D2E52756E74696D652E496E7465726F705365727669636573004775696441747472696275746500436F6D56697369626C6541747472696275746500434C53436F6D706C69616E7441747472696275746500417373656D626C7954726164656D61726B41747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F6D70616E7941747472696275746500417373656D626C794465736372697074696F6E4174747269627574650053514C436C7565434C520053514C436C7565434C522E646C6C00000000094E0055004C004C00001D530051004C004300660067004D00650074006100640061007400610000114D006500740061006400610074006100001D530051004C004300660067002E007400530051004C004300660067000001000F4C006900630065006E0073006500002B530051004C004300660067002E0074005300650072007600690063006500420072006F006B0065007200001B5300650072007600690063006500420072006F006B00650072000015530051004C004300660067002E007400440062000011440061007400610062006100730065000023530051004C004300660067002E0074004A006F00620053006500720076006500720000134A006F0062005300650072007600650072000021530051004C004300660067002E00740049006E007300740061006E0063006500000D5300650072007600650072000025530051004C004300660067002E00740043006F006E006E0065006300740069006F006E00001543006F006E006E0065006300740069006F006E000021530051004C004300660067002E0074005300630068006500640075006C00650000115300630068006500640075006C0065000017530051004C0049006E007300740061006E0063006500001F4100630074006900760065004400690072006500630074006F0072007900001B43006F006E00660069006700750072006100740069006F006E00001F460075006C006C0054006500780074005300650072007600690063006500001749006E0066006F0072006D006100740069006F006E0000094D00610069006C000019500072006F00780079004100630063006F0075006E00740000215200650073006F00750072006300650047006F007600650072006E006F0072000011530065007400740069006E0067007300001B5400610072006700650074005300650072007600650072007300001B4200610063006B00750070004400650076006900630065007300000D4100750064006900740073000017430072006500640065006E007400690061006C007300002D430072007900700074006F006700720061007000680069006300500072006F00760069006400650072007300001345006E00640070006F0069006E0074007300001B4C0069006E006B00650064005300650072007600650072007300000D4C006F00670069006E007300000B52006F006C0065007300003353006500720076006500720041007500640069007400530070006500630069006600690063006100740069006F006E0073000011540072006900670067006500720073000027550073006500720044006500660069006E00650064004D006500730073006100670065007300001741006C00650072007400530079007300740065006D000013440061007400610062006100730065007300001F440061007400610062006100730065004F007000740069006F006E00730000037C0000001269A94903545145AC422FF902E3765F0008B77A5C561934E08908B03F5F7F11D50A3A02060E084E0055004C004C0002060203061D0E0206080320000E0320000204000011080600011108111105200101121505200101121903200008032800020408001108032800080328000E0320000106000111111108060001112111080307010E03070102060702110811080620011D0E1D03060003080E0E020500020E0E0E0520020E0E0E0A0705110811081D030E0E042001010E05000111110E0507020811080507020E110807070302110811080520010111354E010002000000040054020D4973427974654F7264657265640154020D497346697865644C656E6774680054080B4D61784279746553697A6500030000540E044E616D650A53514C4366674E6F646581460100040054020F497344657465726D696E697374696301540209497350726563697365015455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D342E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054557F4D6963726F736F66742E53716C5365727665722E5365727665722E53797374656D446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D342E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038391053797374656D44617461416363657373000000000407011111050001112108040701112180C1010004005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D342E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E69737469630154020949735072656369736501540E044E616D650A4765745375625479706580C0010004005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D342E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E69737469630154020949735072656369736501540E044E616D65094765744C656E677468040100000080C4010004005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D342E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E69737469630154020949735072656369736501540E044E616D650D476574436F6C6C656374696F6E80C2010004005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D342E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E69737469630154020949735072656369736501540E044E616D650B476574446174616261736580BE010004005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D342E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E69737469630154020949735072656369736501540E044E616D65074765744974656D80BE010004005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D342E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E69737469630154020949735072656369736501540E044E616D65074765745061746880C2010004005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D342E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E69737469630154020949735072656369736501540E044E616D650B476574496E7374616E636505200101114D0420010108042001010280A00024000004800000940000000602000000240000525341310004000001000100399F902A59B25D05A2415FEF2B54121D451200DA894C0265DC6EE75DA7E618C25B36A056E6E52EAF4C076E32497F4C3173C0E661AD4F90A9EBFE1849BB3C02FBBD3096098DEF03636CEF6DADDF9DFA290D810BA87F26A4C71DAD19921FD902F3462B084DAA51E763697B5B7094DA2FC4BA4B8A42E61A1D7CC8FD51834B21F1BB0801000301000000000801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010F01000A53514C436C7565434C5200000C010007312E352E312E3100000501000000002901002462343736313261632D666636662D343034652D623536362D316132396533623733643236000005010001000027010022436F7079726967687420C2A92042696C6C2057756E64657220323030372D3230313200000C01000753514C436C756500001001000B42696C6C2057756E64657200001801001361207573657220646566696E6564207479706500000000005845000000000000000000006E450000002000000000000000000000000000000000000000000000604500000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF25002040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000AAA2074F0000000002000000750000001C6000001C2A0000525344535C8DA454183B9645913A2BCA3689156701000000433A5C55736572735C6277756E6465725C446F63756D656E74735C56697375616C2053747564696F20323031305C50726F6A656374735C53514C436C75655C4E6F64655C6F626A5C44656275675C53514C436C7565434C522E706462000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058800000500300000000000000000000500334000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100050001000100010005000100010001003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004B0020000010053007400720069006E006700460069006C00650049006E0066006F0000008C020000010030003000300030003000340062003000000040001400010043006F006D006D0065006E00740073000000610020007500730065007200200064006500660069006E006500640020007400790070006500000038000C00010043006F006D00700061006E0079004E0061006D00650000000000420069006C006C002000570075006E00640065007200000040000B000100460069006C0065004400650073006300720069007000740069006F006E0000000000530051004C0043006C007500650043004C00520000000000300008000100460069006C006500560065007200730069006F006E000000000031002E0035002E0031002E003100000040000F00010049006E007400650072006E0061006C004E0061006D0065000000530051004C0043006C007500650043004C0052002E0064006C006C00000000006800220001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A9002000420069006C006C002000570075006E00640065007200200032003000300037002D003200300031003200000048000F0001004F0072006900670069006E0061006C00460069006C0065006E0061006D0065000000530051004C0043006C007500650043004C0052002E0064006C006C0000000000300008000100500072006F0064007500630074004E0061006D00650000000000530051004C0043006C00750065000000340008000100500072006F006400750063007400560065007200730069006F006E00000031002E0035002E0031002E003100000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0035002E0031002E003100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000C000000803500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000;
WITH PERMISSION_SET = SAFE';

GO
IF  NOT EXISTS (SELECT * FROM [sys].[assemblY_files] WHERE [name] = N'SQLClueCLR')
  EXEC sp_executesql N'ALTER ASSEMBLY [SQLClueCLR]
    DROP FILE ALL
    ADD FILE FROM 0x4D6963726F736F667420432F432B2B204D534620372E30300D0A1A445300000000020000020000002F000000E4000000000000002C000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000C0FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF3800000000E0FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0BCA3101380000000010000000100000000000001200FFFF04000000038000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000942E310133CA044F01000000B88A4760E6B0174CA0F8E03ED6AC7471000000000000000001000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000BCA310138000000001000000010000000000000FFFFFFFF040000000380000000000000FFFFFFFF00000000FFFFFFFF00000000FFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B8D0123A6CC2D011B44200A0244A1DD2C4454B99E9E6D211903F00C04FA302A10B9D865A1166D311BD2A0000F80849BD60A66E40CF64824CB6F042D48172A799100000000000000014DC064DFC63F0F20CE8F6D0F1F7B88C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B8D0123A6CC2D011B44200A0244A1DD2C4454B99E9E6D211903F00C04FA302A10B9D865A1166D311BD2A0000F80849BD60A66E40CF64824CB6F042D48172A7991000000000000000EC52FAA32691E745566122B37FB4CE0C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B8D0123A6CC2D011B44200A0244A1DD2C4454B99E9E6D211903F00C04FA302A10B9D865A1166D311BD2A0000F80849BD60A66E40CF64824CB6F042D48172A7991000000000000000C71C862F185E76A4F8E4FFDC9A092BD900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B8D0123A6CC2D011B44200A0244A1DD2C4454B99E9E6D211903F00C04FA302A10B9D865A1166D311BD2A0000F80849BD60A66E40CF64824CB6F042D48172A7991000000000000000D32E3D5F9F6E1DF5BE60DBE9D242CB2200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B8D0123A6CC2D011B44200A0244A1DD2C4454B99E9E6D211903F00C04FA302A10B9D865A1166D311BD2A0000F80849BD60A66E40CF64824CB6F042D48172A79910000000000000003B85414835B83BE89E5616C1B4E19657000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E909000000000000E9090000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FEEFFEEF01000000E90200000031376431346635632D613333372D343937382D383238312D353334393333373863313037312E76620000433A5C55736572735C6277756E6465725C417070446174615C4C6F63616C5C54656D705C2E4E45544672616D65776F726B2C56657273696F6E3D76342E302E53716C436C72417474726962757465732E766200633A5C75736572735C6277756E6465725C617070646174615C6C6F63616C5C74656D705C2E6E65746672616D65776F726B2C76657273696F6E3D76342E302E73716C636C72617474726962757465732E766200433A5C55736572735C6277756E6465725C446F63756D656E74735C56697375616C2053747564696F20323031305C50726F6A656374735C53514C436C75655C4E6F64655C50726F706572746965735C417373656D626C79496E666F2E766200633A5C75736572735C6277756E6465725C646F63756D656E74735C76697375616C2073747564696F20323031305C70726F6A656374735C73716C636C75655C6E6F64655C70726F706572746965735C617373656D626C79696E666F2E766200433A5C55736572735C6277756E6465725C446F63756D656E74735C56697375616C2053747564696F20323031305C50726F6A656374735C53514C436C75655C4E6F64655C53514C4366674E6F64652E766200633A5C75736572735C6277756E6465725C646F63756D656E74735C76697375616C2073747564696F20323031305C70726F6A656374735C73716C636C75655C6E6F64655C73716C6366676E6F64652E766200433A5C55736572735C6277756E6465725C446F63756D656E74735C56697375616C2053747564696F20323031305C50726F6A656374735C53514C436C75655C4E6F64655C53514C4366674E6F646546756E6374696F6E732E766200633A5C75736572735C6277756E6465725C646F63756D656E74735C76697375616C2073747564696F20323031305C70726F6A656374735C73716C636C75655C6E6F64655C73716C6366676E6F646566756E6374696F6E732E76620011000000000000000000000000000000000000002A000000D100000033020000300100008E0200007E0000002B0000008F010000E1010000000000000000000001000000000000000A00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001BE23001300100008D159F342BCBCC01010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000050000000A00000001000000760000000000000001000000280000001BE2300128A3AB0658000000010000002A00000001000000650000000000000000000000E1010000280000001BE230014B8E5B17580000008F0100002A000000E10100006500000000000000000000008E020000280000001BE23001AB4540FE58000000330200002A0000008E02000065000000000000000000000030010000280000001BE230013AD837DC58000000D10000002A000000300100006500000000000000000000007E000000280000001BE23001983CC0A9580000002B0000002A0000007E000000650000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000032002A1100000000640100000000000025000000000000000000000001000006000000000100000000546F537472696E670000001600031104000000600100002500000000000000010000001200241140463A53797374656D2E5465787400002200241140463A4D6963726F736F66742E53716C5365727665722E5365727665720000001A00241140463A53797374656D2E446174612E53716C5479706573000E00241140463A53797374656D0000000E0024112A53514C4367664E6F646500320024114050583A786D6C3D687474703A2F2F7777772E77332E6F72672F584D4C2F313939382F6E616D657370616365000000002A0024114050583A786D6C6E733D687474703A2F2F7777772E77332E6F72672F323030302F786D6C6E732F000A0024114050583A3D0000000E00241153514C4367664E6F646500001E00201100000000010000110000000000000000546F537472696E6700000000020006000200060032002A1100000000E4010000000000000C0000000000000000000000020000062500000001000000006765745F49734E756C6C001600031168010000E00100000C00000025000000010000000E0024114031303036363332393700001A0020110000000002000011000000000000000049734E756C6C0000020006000200060032002A11000000007C02000000000000170000000000000000000000030000063100000001000000006765745F4E756C6C00000016000311E8010000780200001700000031000000010000000E0024114031303036363332393700001600201100000000030000110000000000000000680000001A002011010000000300001100000000000000004E756C6C0000000002000600020006002E002A11000000007C03000000000000B807000000000000000000000400000648000000010000000050617273650000160003118002000078030000B807000048000000010000000E0024114031303036363332393700001A0020110000000004000011000000000000000050617273650000001600201101000000040000110000000000000000750000002200201102000000040000110000000000000400564224745F61727261792453300000002200201103000000040000110000000000000400564224745F737472696E67244C3000002200201104000000040000110000000000000400564224745F737472696E67244C31000002000600020006002E002A1100000000DC030000000000000F000000000000000000000005000006000800000100000000526561640000001600031180030000D80300000F00000000080000010000000E00241140313030363633323937000002000600020006002E002A11000000003C04000000000000100000000000000000000000060000060F08000001000000005772697465000016000311E003000038040000100000000F080000010000000E002411403130303636333239370000020006000200060032002A1100000000E0040000000000001E0000000000000000000000070000061F08000001000000006765745F4C656E677468001600031140040000DC0400001E0000001F080000010000000E0024114031303036363332393700001A002011000000000500001100000000000000004C656E67746800002200201101000000050000110000000000000400564224745F7374727563742453300000020006000200060032002A110000000084050000000000001E0000000000000000000000080000063D08000001000000006765745F5479706500000016000311E4040000800500001E0000003D080000010000000E0024114031303036363332393700001A0020110000000006000011000000000000000054797065000000002200201101000000060000110000000000000400564224745F7374727563742453300000020006000200060036002A11000000002C060000000000001E0000000000000000000000090000065B08000001000000006765745F53756254797065000000001600031188050000280600001E0000005B080000010000000E0024114031303036363332393700001A0020110000000007000011000000000000000053756254797065002200201101000000070000110000000000000400564224745F737472756374245330000002000600020006003A002A1100000000DC060000000000001E00000000000000000000000A0000067908000001000000006765745F53514C496E7374616E6365000000001600031130060000D80600001E00000079080000010000000E0024114031303036363332393700001E0020110000000008000011000000000000000053514C496E7374616E6365002200201101000000080000110000000000000400564224745F7374727563742453300000020006000200060036002A110000000088070000000000001E00000000000000000000000B0000069708000001000000006765745F446174616261736500000016000311E0060000840700001E00000097080000010000000E0024114031303036363332393700001E002011000000000900001100000000000000004461746162617365000000002200201101000000090000110000000000000400564224745F7374727563742453300000020006000200060036002A110000000034080000000000001E00000000000000000000000C000006B508000001000000006765745F436F6C6C656374696F6E00160003118C070000300800001E000000B5080000010000000E0024114031303036363332393700001E002011000000000A0000110000000000000000436F6C6C656374696F6E000022002011010000000A0000110000000000000400564224745F737472756374245330000002000600020006003A002A11000000000C090000000000005C00000000000000000000000D000006D308000001000000006765745F4973436F6C6C656374696F6E0000001600031138080000080900005C000000D3080000010000000E00241140313030363633323937000022002011000000000B00001100000000000000004973436F6C6C656374696F6E0000000022002011010000000B0000110000000000000400564224745F737472756374245330000022002011020000000B0000110000000000000400564224745F7374727563742453310000020006000200060032002A1100000000B0090000000000001E00000000000000000000000E0000062F09000001000000006765745F506174680000001600031110090000AC0900001E0000002F090000010000000E0024114031303036363332393700001A002011000000000C0000110000000000000000506174680000000022002011010000000C0000110000000000000400564224745F7374727563742453300000020006000200060032002A1100000000540A0000000000001E00000000000000000000000F0000064D09000001000000006765745F4974656D00000016000311B4090000500A00001E0000004D090000010000000E0024114031303036363332393700001A002011000000000D00001100000000000000004974656D0000000022002011010000000D0000110000000000000400564224745F73747275637424533000000200060002000600F20000006C0000000000000001000100250000000000000007000000600000000000000026000080010000002700008009000000280000801300000029000080140000002A000080220000002B000080230000002C0000800500330009001A000D00190009000D000D00260009000F0005001100F20000003C00000025000000010001000C000000000000000300000030000000000000002F00008001000000300000800A0000003100008009000C000D001A0009001000F2000000540000003100000001000100170000000000000005000000480000000000000035000080010000003600008009000000370000801100000038000080150000003900008009000C00110031000D001C000D00150009001000F2000000DC0500004800000001000100B8070000000000007B000000D0050000000000004000008001000000410000800A00000042000080150000004300008016000000440000801E000000450000803200000046000080520000004700008062000000480000806D000000EEEFFE808000000049000080810000004B0000808D0000004C0000809D0000004D000080A7000000EEEFFE80B80000004E000080B90000004F000080C500000050000080D100000051000080DD00000052000080EE000000EEEFFE80FF0000005300008000010000540000800C010000550000801C010000560000802C0100005700008041010000EEEFFE80520100005800008053010000590000805F0100005A0000806F0100005B0000807F0100005C00008094010000EEEFFE80A50100005D000080A60100005E000080B20100005F000080C201000060000080CE01000061000080E3010000EEEFFE80F401000062000080F501000063000080010200006400008011020000650000801D0200006600008032020000EEEFFE80430200006700008044020000680000805002000069000080600200006A0000806C0200006B0000807E020000EEEFFE808F0200006C000080900200006D0000809C0200006E000080AC0200006F000080B802000070000080C802000071000080CE02000072000080CF02000073000080DB02000074000080EB02000076000080F70200007700008003030000780000800F030000790000801B0300007A000080270300007B000080330300007C000080480300007D000080490300007F0000882204000089000080370400008A00008A400500009600008050050000970000805C050000980000806C05000099000080720500009A0000808C0500009C000080980500009D000080AA0500009E000080AB050000A0000080B7050000A1000080CE050000A2000080E0050000A3000080E1050000A4000080F1050000A5000080F2050000A6000080FE050000A70000800E060000A80000800F060000A900008015060000AA0000802F060000AC0000803B060000AD00008050060000AE0000805C060000B00000806C060000B100008081060000B200008082060000B40000808E060000B50000809E060000B7000081CF060000B9000080E4060000BA000080FB060000BD00008007070000BE00008019070000BF0000801A070000C100008026070000C200008036070000C300008042070000C400008052070000C500008053070000C600008056070000C700008057070000C900008067070000CA00008073070000CB00008083070000CC00008084070000CD00008085070000CE00008086070000CF00008087070000D000008088070000D100008089070000D2000080B2070000D3000080B6070000D400008005004500090019000D00180009000F000D002D0009001E00090031000900280009002300010002000D002700110026001100300011002B000100020015002A0019002D0019002A001900300019002D000100020015003100190036001900390019003600190032000100020015002600190031001900390019003600190032000100020015002D00190032001900390019002A00190032000100020015002C0019002F001900390019002A00190032000100020015002E00190033001900390019002A00190032000100020015002C00190031001900390019002A001900320011001B000D001600110029001100310011002700110022001100240011001E0011001E0011002F0015002E001100150015003D00190032001500430019003800190037001D00360019001F0015003D00190037001D00360019001D001D0036001D00430021003A001D002100210040001D0023001D003B0021003A001D00230019001F0015003D00190037001D003C0019003B001D003C001D00360019001D001D0035001D003A001D00470021003A001D00490021003F0025003E00210025002500420025004400250043002900420025002B00210027001D0021002100400021003F0025003E00210027001D00230019001F0015001B001100170009001300090038000900110005001100F20000003C00000000080000010001000F00000000000000030000003000000000000000D600008001000000D80000800D000000D90000800500370009001E0005000C00F20000003C0000000F080000010001001000000000000000030000003000000000000000DB00008001000000DD0000800E000000DE000080050038000900180005000C00F20000003C0000001F080000010001001E00000000000000030000003000000000000000E100008001000000E20000801C000000E300008009000C000D002C0009001000F20000003C0000003D080000010001001E00000000000000030000003000000000000000E700008001000000E80000801C000000E900008009000C000D002A0009001000F20000003C0000005B080000010001001E00000000000000030000003000000000000000ED00008001000000EF0000801C000000F000008009000C000D002D0009001000F20000003C00000079080000010001001E00000000000000030000003000000000000000F400008001000000F50000801C000000F600008009000C000D00310009001000F20000003C00000097080000010001001E00000000000000030000003000000000000000FA00008001000000FB0000801C000000FC00008009000C000D002E0009001000F20000003C000000B5080000010001001E000000000000000300000030000000000000000001008001000000010100801C0000000201008009000C000D00300009001000F20000003C000000D3080000010001005C000000000000000300000030000000000000000601008001000000070100805A0000000801008009000C000D006C0009001000F20000003C0000002F090000010001001E000000000000000300000030000000000000000C010080010000000D0100801C0000000E01008009000C000D002A0009001000F20000003C0000004D090000010001001E000000000000000300000030000000000000001201008001000000130100801C0000001401008009000C000D002A0009001000F4000000080000008F01000000000000780000000000000018000000300000004C000000640000007C00000094000000A8000000C0000000D4000000EC0000000001000018010000340100004C010000640100007C01000098010000B0010000D0010000E8010000040200001C0200003C02000054020000740200008C020000A4020000BC020000D40200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000036002A11000000008C01000000000000120000000000000000000000110000066B0900000100000000476574436F6C6C656374696F6E0000160003110400000088010000120000006B090000010000002200241140463A4D6963726F736F66742E53716C5365727665722E5365727665720000001A00241140463A53797374656D2E446174612E53716C5479706573001E00241140463A53797374656D2E446174612E53716C436C69656E74000000001200241140463A53797374656D2E4461746100000E00241140463A53797374656D0000000E0024112A53514C4367664E6F646500320024114050583A786D6C3D687474703A2F2F7777772E77332E6F72672F584D4C2F313939382F6E616D657370616365000000002A0024114050583A786D6C6E733D687474703A2F2F7777772E77332E6F72672F323030302F786D6C6E732F000A0024114050583A3D0000000E00241153514C4367664E6F6465000022002011000000000E0000110000000000000000476574436F6C6C656374696F6E000000020006000200060036002A11000000001402000000000000120000000000000000000000120000067D0900000100000000476574446174616261736500000000160003119001000010020000120000007D090000010000000E0024114031303036363333313300001E002011000000000F0000110000000000000000476574446174616261736500020006000200060032002A11000000009402000000000000120000000000000000000000130000068F09000001000000004765744974656D00000000160003111802000090020000120000008F090000010000000E0024114031303036363333313300001A002011000000001000001100000000000000004765744974656D00020006000200060032002A1100000000140300000000000012000000000000000000000014000006A10900000100000000476574506174680000000016000311980200001003000012000000A1090000010000000E0024114031303036363333313300001A002011000000001100001100000000000000004765745061746800020006000200060036002A11000000009C0300000000000012000000000000000000000015000006B30900000100000000476574496E7374616E63650000000016000311180300009803000012000000B3090000010000000E0024114031303036363333313300001E00201100000000120000110000000000000000476574496E7374616E636500020006000200060032002A1100000000200400000000000012000000000000000000000016000006C50900000100000000476574537562547970650016000311A00300001C04000012000000C5090000010000000E0024114031303036363333313300001E00201100000000130000110000000000000000476574537562547970650000020006000200060032002A1100000000A40400000000000012000000000000000000000017000006D709000001000000004765744C656E67746800001600031124040000A004000012000000D7090000010000000E0024114031303036363333313300001E002011000000001400001100000000000000004765744C656E6774680000000200060002000600F20000003C0000006B09000001000100120000000000000003000000300000000000000012000080010000001400008010000000150000800500500009001F0005001100F20000003C0000007D0900000100010012000000000000000300000030000000000000001B000080010000001D000080100000001E00008005004E0009001D0005001100F20000003C0000008F090000010001001200000000000000030000003000000000000000240000800100000026000080100000002700008005004A000900190005001100F20000003C000000A10900000100010012000000000000000300000030000000000000002D000080010000002F000080100000003000008005004A000900190005001100F20000003C000000B3090000010001001200000000000000030000003000000000000000360000800100000038000080100000003900008005004E000900200005001100F20000003C000000C50900000100010012000000000000000300000030000000000000003F0000800100000041000080100000004200008005004D0009001C0005001100F20000003C000000D709000001000100120000000000000003000000300000000000000048000080010000004A000080100000004B00008005004B0009001B0005001100F400000008000000330200000000000038000000EC02000008030000200300003C030000540300006C030000840300009C030000B4030000D0030000E8030000040400001C0400003404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFF1A092FF160010000B40200004D0000000100000005020000010000003D03000001000000E9010000010000001D020000010000007D000000010000003D020000010000006D030000010000004D01000001000000010000000100000021030000010000001900000001000000D10100000100000009030000010000000101000001000000D50200000100000065000000010000000504000001000000350100000100000035040000010000001D04000001000000BD02000001000000A90000000100000075020000010000009D03000001000000D500000001000000A502000001000000190100000100000031000000010000008D02000001000000D1030000010000005503000001000000B50300000100000055020000010000006501000001000000ED020000010000009901000001000000ED000000010000009500000001000000E903000001000000C1000000010000007D01000001000000B1010000010000008503000001000000010400000200000000000000000002000000000000000000000200000000000001040000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000820000000000000000010400000200000000000000000000000000000000000000000000000000000001040200020000000000000000000000000000000000000000000000000000000100000002000088000000000000000000000000000000000000000000000000010400000200000000000000000000000000000000000000000000000000000001842400020000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000040000000000000000000002000000000000000000000000004000000000000000000000000000000000000200000000000000000000000000000800000000000000000000000000000000200000000000000000080000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000008000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000C0000001800000024000000300000003C0000004800000054000000600000006C0000007800000084000000900000009C000000A8000000B4000000C0000000CC000000D8000000E4000000F0000000FC0000000801000014010000200100002C0100003801000044010000500100005C0100006801000074010000800100008C01000098010000A4010000B0010000BC010000C8010000D4010000E0010000EC010000F80100000402000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001600251100000000040000000100546F537472696E6700001600291100000000040000000100303630303030303100001A002511000000006801000001006765745F49734E756C6C000000001600291100000000680100000100303630303030303200001600251100000000E801000001006765745F4E756C6C00001600291100000000E8010000010030363030303030330000120025110000000080020000010050617273650016002911000000008002000001003036303030303034000012002511000000008003000001005265616400001600291100000000800300000100303630303030303500001200251100000000E003000001005772697465001600291100000000E00300000100303630303030303600001A002511000000004004000001006765745F4C656E677468000000001600291100000000400400000100303630303030303700001600251100000000E404000001006765745F5479706500001600291100000000E40400000100303630303030303800001A002511000000008805000001006765745F537562547970650000001600291100000000880500000100303630303030303900001E002511000000003006000001006765745F53514C496E7374616E63650000001600291100000000300600000100303630303030306100001A00251100000000E006000001006765745F44617461626110000000000000000000000000000000000000000000000000000000FFFFFFFF1A092FF10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000736500001600291100000000E00600000100303630303030306200001E002511000000008C07000001006765745F436F6C6C656374696F6E0000000016002911000000008C0700000100303630303030306300001E002511000000003808000001006765745F4973436F6C6C656374696F6E000016002911000000003808000001003036303030303064000016002511000000001009000001006765745F5061746800001600291100000000100900000100303630303030306500001600251100000000B409000001006765745F4974656D00001600291100000000B40900000100303630303030306600001A00251100000000040000000200476574436F6C6C656374696F6E001600291100000000040000000200303630303030313100001A00251100000000900100000200476574446174616261736500000016002911000000009001000002003036303030303132000016002511000000001802000002004765744974656D0000001600291100000000180200000200303630303030313300001600251100000000980200000200476574506174680000001600291100000000980200000200303630303030313400001A00251100000000180300000200476574496E7374616E63650000001600291100000000180300000200303630303030313500001A00251100000000A0030000020047657453756254797065000000001600291100000000A003000002003036303030303136000016002511000000002404000002004765744C656E6774680016002911000000002404000002003036303030303137000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFF77093101010000000F00008A10006F7611000100CC0000006C0200002C000000C4000000000000000000000016000000190000000000EEC00000000000000000FFFF000000000000FFFFFFFF00000000FFFF0000000000000000000000000D00580A000000000000F409000001000000E0354703000000000000000053514C4367664E6F64652E53514C4366674E6F6465004243363831413235000000000000FFFF000000000000FFFFFFFF00000000FFFF0000000000000000000000000E00A804000000000000EC0100000100000050354703000000000000000053514C4367664E6F64652E55736572446566696E656446756E6374696F6E73003231303734413046000000002DBA2EF101001D0000000000250000000000000000000000000000000000000001000000250000000C00000000000000000000000000000000000000010000003100000017000000000000000000000000000000000000000100000048000000B80700000000000000000000000000000000000001000000000800000F00000000000000000000000000000000000000010000000F0800001000000000000000000000000000000000000000010000001F0800001E00000000000000000000000000000000000000010000003D0800001E00000000000000000000000000000000000000010000005B0800001E0000000000000000000000000000000000000001000000790800001E0000000000000000000000000000000000000001000000970800001E0000000000000000000000000000000000000001000000B50800001E0000000000000000000000000000000000000001000000D30800005C00000000000000000000000000000000000000010000002F0900001E00000000000000000000000000000000000000010000004D0900001E00000000000000000000000000000000000000010000006B0900001200000000000000010000000000000000000000010000007D0900001200000000000000010000000000000000000000010000008F090000120000000000000001000000000000000000000001000000A1090000120000000000000001000000000000000000000001000000B3090000120000000000000001000000000000000000000001000000C5090000120000000000000001000000000000000000000001000000D70900001200000000000000010000000000000000000000020002000D01000000000100FFFFFFFF00000000E90900000802000000000000FFFFFFFF00000000FFFFFFFF0200020000000100010001000000000052000000433A5C55736572735C6277756E6465725C446F63756D656E74735C56697375616C2053747564696F20323031305C50726F6A656374735C53514C436C75655C4E6F64655C53514C4366674E6F64652E766200433A5C55736572735C6277756E6465725C446F63756D656E74735C56697375616C2053747564696F20323031305C50726F6A656374735C53514C436C75655C4E6F64655C53514C4366674E6F646546756E6374696F6E732E766200000000FEEFFEEF010000000100000000010000000000000000000000FFFFFFFFFFFFFFFFFFFF0C00FFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000942E310133CA044F01000000B88A4760E6B0174CA0F8E03ED6AC7471E10100002F4C696E6B496E666F002F6E616D6573002F7372632F686561646572626C6F636B002F7372632F66696C65732F31376431346635632D613333372D343937382D383238312D353334393333373863313037312E7662002F7372632F66696C65732F633A5C75736572735C6277756E6465725C617070646174615C6C6F63616C5C74656D705C2E6E65746672616D65776F726B2C76657273696F6E3D76342E302E73716C636C72617474726962757465732E7662002F7372632F66696C65732F633A5C75736572735C6277756E6465725C646F63756D656E74735C76697375616C2073747564696F20323031305C70726F6A656374735C73716C636C75655C6E6F64655C70726F706572746965735C617373656D626C79696E666F2E7662002F7372632F66696C65732F633A5C75736572735C6277756E6465725C646F63756D656E74735C76697375616C2073747564696F20323031305C70726F6A656374735C73716C636C75655C6E6F64655C73716C6366676E6F64652E7662002F7372632F66696C65732F633A5C75736572735C6277756E6465725C646F63756D656E74735C76697375616C2073747564696F20323031305C70726F6A656374735C73716C636C75655C6E6F64655C73716C6366676E6F646566756E6374696F6E732E766200080000000E00000001000000A53A0000000000007B0100000B00000056000000080000000A000000050000000000000004000000110000000600000022000000070000001E0100000A000000B400000009000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001200000018000000590200003800000097040000000000004103000030010000580000005800000058000000580000005800000028000000C8140000D0060000240400002C0000004C04000003000000290000002A000000060000002600000027000000280000000D0000000E0000000F0000000700000008000000090000000A0000000B0000000C000000100000001100000012000000130000001400000015000000160000001700000018000000190000001A0000001B0000001C0000001D0000001E0000001F00000020000000210000002300000022000000240000002500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002B0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 
	AS N''SQLClueCLR.pdb''';

GO

IF NOT EXISTS(SELECT * FROM [sys].[types] WHERE [name] = N'SQLCfgNode' And SCHEMA_NAME(schema_id) = 'SQLCfg')
 BEGIN
  EXEC sp_executesql N'CREATE TYPE [SQLCfg].[SQLCfgNode] EXTERNAL NAME [SQLClueCLR].[SQLCgfNode.SQLCfgNode]'

  EXEC sys.sp_addextendedproperty 
      @name=N'version'
    , @value=N'v1.5.1.1' 
    , @level0type=N'SCHEMA'
    , @level0name=N'SQLCfg'
    , @level1type=N'TYPE'
    , @level1name=N'SQLCfgNode';

  EXEC sys.sp_addextendedproperty 
      @name=N'AutoDeployed'
    , @value=N'no' 
    , @level0type=N'SCHEMA'
    , @level0name=N'SQLCfg'
    , @level1type=N'TYPE'
    , @level1name=N'SQLCfgNode';

  EXEC sys.sp_addextendedproperty 
      @name=N'SqlAssemblyFile'
    , @value=N'SQLCfgNode.vb' 
    , @level0type=N'SCHEMA'
    , @level0name=N'SQLCfg'
    , @level1type=N'TYPE'
    , @level1name=N'SQLCfgNode';

  EXEC sys.sp_addextendedproperty 
      @name=N'SqlAssemblyFileLine'
    , @value=13 
    , @level0type=N'SCHEMA'
    , @level0name=N'SQLCfg'
    , @level1type=N'TYPE'
    , @level1name=N'SQLCfgNode';
 
 END

GO

/*
Functions all work, but unless a property needs to be materialized in an index, they are not needed 
they are not fancy, most of the code is the <SQLFunction custom attribute decoration>.
all return the indicted property from the current node marked deterministic and precise
you cannot mark a computed column as PERSISTED if it simply references a property, instead use the result of the function 
*/

--IF  NOT EXISTS (SELECT * FROM [sys].[objects] 
--                WHERE [object_id] = OBJECT_ID(N'[SQLCfg].[GetCollection]') 
--                AND [type] in (N'FN', N'IF', N'TF', N'FS', N'FT'))
-- BEGIN
--  EXEC sp_executesql 
--N'CREATE FUNCTION [SQLCfg].[GetCollection](@Node [SQLCfg].[SQLCfgNode])
--RETURNS [nvarchar](128) WITH EXECUTE AS CALLER
--AS 
--EXTERNAL NAME [SQLClueCLR].[SQLCgfNode.UserDefinedFunctions].[GetCollection]'

--  EXEC sys.sp_addextendedproperty 
--     @name=N'AutoDeployed'
--   , @value=N'no' 
--   , @level0type=N'SCHEMA'
--   , @level0name=N'SQLCfg'
--   , @level1type=N'FUNCTION'
--   , @level1name=N'GetCollection'
 
--  EXEC sys.sp_addextendedproperty 
--     @name=N'SqlAssemblyFile'
--   , @value=N'SQLCfgNodeFunctions.vb' 
--   , @level0type=N'SCHEMA'
--   , @level0name=N'SQLCfg'
--   , @level1type=N'FUNCTION'
--   , @level1name=N'GetCollection'

--  EXEC sys.sp_addextendedproperty 
--     @name=N'SqlAssemblyFileLine'
--   , @value=18 
--   , @level0type=N'SCHEMA'
--   , @level0name=N'SQLCfg'
--   , @level1type=N'FUNCTION'
--   , @level1name=N'GetCollection'
-- END

GO

--IF NOT EXISTS (SELECT * FROM [sys].[objects] 
--               WHERE [object_id] = OBJECT_ID(N'[SQLCfg].[GetDatabase]') 
--               AND [type] in (N'FN', N'IF', N'TF', N'FS', N'FT'))
-- BEGIN
--  EXEC sp_executesql 
--N'CREATE FUNCTION [SQLCfg].[GetDatabase](@Node [SQLCfg].[SQLCfgNode])
--RETURNS [nvarchar](128) WITH EXECUTE AS CALLER
--AS 
--EXTERNAL NAME [SQLClueCLR].[SQLCgfNode.UserDefinedFunctions].[GetDatabase]'

--  EXEC sys.sp_addextendedproperty 
--     @name=N'AutoDeployed'
--   , @value=N'no' 
--   , @level0type=N'SCHEMA'
--   , @level0name=N'SQLCfg'
--   , @level1type=N'FUNCTION'
--   , @level1name=N'GetDatabase'

--  EXEC sys.sp_addextendedproperty 
--     @name=N'SqlAssemblyFile'
--   , @value=N'SQLCfgNodeFunctions.vb' 
--   , @level0type=N'SCHEMA'
--   , @level0name=N'SQLCfg'
--   , @level1type=N'FUNCTION'
--   , @level1name=N'GetDatabase'

--  EXEC sys.sp_addextendedproperty 
--     @name=N'SqlAssemblyFileLine'
--   , @value=18 
--   , @level0type=N'SCHEMA'
--   , @level0name=N'SQLCfg'
--   , @level1type=N'FUNCTION'
--   , @level1name=N'GetDatabase'

-- END

GO
--IF NOT EXISTS (SELECT * FROM [sys].[objects] 
--               WHERE [object_id] = OBJECT_ID(N'[SQLCfg].[GetInstance]') 
--               AND [type] in (N'FN', N'IF', N'TF', N'FS', N'FT'))
-- BEGIN
--  EXEC sp_executesql 
--N'CREATE FUNCTION [SQLCfg].[GetInstance](@Node [SQLCfg].[SQLCfgNode])
--RETURNS [nvarchar](128) WITH EXECUTE AS CALLER
--AS 
--EXTERNAL NAME [SQLClueCLR].[SQLCgfNode.UserDefinedFunctions].[GetInstance]'

--  EXEC sys.sp_addextendedproperty 
--     @name=N'AutoDeployed'
--   , @value=N'no' 
--   , @level0type=N'SCHEMA'
--   , @level0name=N'SQLCfg'
--   , @level1type=N'FUNCTION'
--   , @level1name=N'GetInstance'

--  EXEC sys.sp_addextendedproperty 
--     @name=N'SqlAssemblyFile'
--   , @value=N'SQLCfgNodeFunctions.vb' 
--   , @level0type=N'SCHEMA'
--   , @level0name=N'SQLCfg'
--   , @level1type=N'FUNCTION'
--   , @level1name=N'GetInstance'

--  EXEC sys.sp_addextendedproperty 
--     @name=N'SqlAssemblyFileLine'
--   , @value=18 
--   , @level0type=N'SCHEMA'
--   , @level0name=N'SQLCfg'
--   , @level1type=N'FUNCTION'
--   , @level1name=N'GetInstance'

-- END

GO

--IF NOT EXISTS (SELECT * FROM [sys].[objects] 
--               WHERE [object_id] = OBJECT_ID(N'[SQLCfg].[GetItem]') 
--               AND [type] in (N'FN', N'IF', N'TF', N'FS', N'FT'))
-- BEGIN
--  EXEC sp_executesql 
--N'CREATE FUNCTION [SQLCfg].[GetItem](@Node [SQLCfg].[SQLCfgNode])
--RETURNS [nvarchar](4000) WITH EXECUTE AS CALLER
--AS 
--EXTERNAL NAME [SQLClueCLR].[SQLCgfNode.UserDefinedFunctions].[GetItem]'

--  EXEC sys.sp_addextendedproperty 
--     @name=N'AutoDeployed'
--   , @value=N'no' 
--   , @level0type=N'SCHEMA'
--   , @level0name=N'SQLCfg'
--   , @level1type=N'FUNCTION'
--   , @level1name=N'GetItem'

--  EXEC sys.sp_addextendedproperty 
--     @name=N'SqlAssemblyFile'
--   , @value=N'SQLCfgNodeFunctions.vb' 
--   , @level0type=N'SCHEMA'
--   , @level0name=N'SQLCfg'
--   , @level1type=N'FUNCTION'
--   , @level1name=N'GetItem'

--  EXEC sys.sp_addextendedproperty 
--     @name=N'SqlAssemblyFileLine'
--   , @value=18 
--   , @level0type=N'SCHEMA'
--   , @level0name=N'SQLCfg'
--   , @level1type=N'FUNCTION'
--   , @level1name=N'GetItem'

-- END
 
GO

--IF NOT EXISTS (SELECT * FROM [sys].[objects] 
--               WHERE [object_id] = OBJECT_ID(N'[SQLCfg].[GetLength]') 
--               AND [type] in (N'FN', N'IF', N'TF', N'FS', N'FT'))
-- BEGIN
--  EXEC sp_executesql 
--N'CREATE FUNCTION [SQLCfg].[GetLength](@Node [SQLCfg].[SQLCfgNode])
--RETURNS [int] WITH EXECUTE AS CALLER
--AS 
--EXTERNAL NAME [SQLClueCLR].[SQLCgfNode.UserDefinedFunctions].[GetLength]'

--  EXEC sys.sp_addextendedproperty 
--     @name=N'AutoDeployed'
--   , @value=N'no' 
--   , @level0type=N'SCHEMA'
--   , @level0name=N'SQLCfg'
--   , @level1type=N'FUNCTION'
--   , @level1name=N'GetLength'

--  EXEC sys.sp_addextendedproperty 
--     @name=N'SqlAssemblyFile'
--   , @value=N'SQLCfgNodeFunctions.vb' 
--   , @level0type=N'SCHEMA'
--   , @level0name=N'SQLCfg'
--   , @level1type=N'FUNCTION'
--   , @level1name=N'GetLength'

--  EXEC sys.sp_addextendedproperty 
--     @name=N'SqlAssemblyFileLine'
--   , @value=18 
--   , @level0type=N'SCHEMA'
--   , @level0name=N'SQLCfg'
--   , @level1type=N'FUNCTION'
--   , @level1name=N'GetLength'

-- END

GO

--IF NOT EXISTS (SELECT * FROM [sys].[objects] 
--               WHERE [object_id] = OBJECT_ID(N'[SQLCfg].[GetPath]') 
--               AND [type] in (N'FN', N'IF', N'TF', N'FS', N'FT'))
-- BEGIN
--  EXEC sp_executesql 
--N'CREATE FUNCTION [SQLCfg].[GetPath](@Node [SQLCfg].[SQLCfgNode])
--RETURNS [nvarchar](128) WITH EXECUTE AS CALLER
--AS 
--EXTERNAL NAME [SQLClueCLR].[SQLCgfNode.UserDefinedFunctions].[GetPath]'

--  EXEC sys.sp_addextendedproperty 
--     @name=N'AutoDeployed'
--   , @value=N'no' 
--   , @level0type=N'SCHEMA'
--   , @level0name=N'SQLCfg'
--   , @level1type=N'FUNCTION'
--   , @level1name=N'GetPath'

--  EXEC sys.sp_addextendedproperty 
--     @name=N'SqlAssemblyFile'
--   , @value=N'SQLCfgNodeFunctions.vb' 
--   , @level0type=N'SCHEMA'
--   , @level0name=N'SQLCfg'
--   , @level1type=N'FUNCTION'
--   , @level1name=N'GetPath'

--  EXEC sys.sp_addextendedproperty 
--     @name=N'SqlAssemblyFileLine'
--   , @value=18 
--   , @level0type=N'SCHEMA'
--   , @level0name=N'SQLCfg'
--   , @level1type=N'FUNCTION'
--   , @level1name=N'GetPath'

-- END

GO

--IF NOT EXISTS (SELECT * FROM [sys].[objects] 
--               WHERE [object_id] = OBJECT_ID(N'[SQLCfg].[GetSubType]') 
--               AND [type] in (N'FN', N'IF', N'TF', N'FS', N'FT'))
-- BEGIN
--  EXEC sp_executesql 
--N'CREATE FUNCTION [SQLCfg].[GetSubType](@Node [SQLCfg].[SQLCfgNode])
--RETURNS [nvarchar](128) WITH EXECUTE AS CALLER
--AS 
--EXTERNAL NAME [SQLClueCLR].[SQLCgfNode.UserDefinedFunctions].[GetSubType]'

--  EXEC sys.sp_addextendedproperty 
--     @name=N'AutoDeployed'
--   , @value=N'no' 
--   , @level0type=N'SCHEMA'
--   , @level0name=N'SQLCfg'
--   , @level1type=N'FUNCTION'
--   , @level1name=N'GetSubType'

--  EXEC sys.sp_addextendedproperty 
--     @name=N'SqlAssemblyFile'
--   , @value=N'SQLCfgNodeFunctions.vb' 
--   , @level0type=N'SCHEMA'
--   , @level0name=N'SQLCfg'
--   , @level1type=N'FUNCTION'
--   , @level1name=N'GetSubType'

--  EXEC sys.sp_addextendedproperty 
--     @name=N'SqlAssemblyFileLine'
--   , @value=18 
--   , @level0type=N'SCHEMA'
--   , @level0name=N'SQLCfg'
--   , @level1type=N'FUNCTION'
--   , @level1name=N'GetSubType'

-- END

GO

IF OBJECT_ID('[SQLCfg].[tSQLCfg]','U') IS NULL
 CREATE TABLE [SQLCfg].[tSQLCfg] (
    [LicensedCompany] [NVARCHAR] (128) NOT NULL 
    CONSTRAINT [dft_tSQLCfg__LicensedCompany] 
    DEFAULT ('')
  , [LicensedUser] [NVARCHAR] (128) NOT NULL 
    CONSTRAINT [dft_tSQLCfg__LicensedUser] 
    DEFAULT ('')
  , [LicenseCode] [NVARCHAR] (128) NOT NULL 
    CONSTRAINT [dft_tSQLCfg__LicenseCode] 
    DEFAULT ('Unlicensed Trial Software')
  , [LicensedInstanceCount] [INT] NOT NULL 
    CONSTRAINT [dft_tSQLCfg__LicensedInstanceCount] 
    DEFAULT (3)
  , [LicenseDate] [NVARCHAR] (30) NOT NULL
    CONSTRAINT [dft_tSQLCfg_LicenseDate] 
    DEFAULT (CAST(CAST(CURRENT_TIMESTAMP AS [DATE]) AS [VARCHAR] (30)))
  , [RecCreatedDt] [DATETIME] NOT NULL 
    CONSTRAINT [dft_tSQLCfg_RecCreatedDt] 
    DEFAULT (CURRENT_TIMESTAMP)
  , [RecCreatedUser] [NVARCHAR] (128) NOT NULL 
    CONSTRAINT [dft_tSQLCfg_RecCreatedUser] 
    DEFAULT (ORIGINAL_LOGIN())
  , [RecUpdatedDt] [DATETIME] NOT NULL 
    CONSTRAINT [dft_tSQLCfg_RecUpdatedDt] 
    DEFAULT (CURRENT_TIMESTAMP)
  , [RecUpdatedUser] [NVARCHAR] (128) NOT NULL 
    CONSTRAINT [dft_tSQLCfg_RecUpdatedUser] 
    DEFAULT (ORIGINAL_LOGIN())
  , CONSTRAINT [pkc_tSQLCfg]
    PRIMARY KEY ([LicensedCompany], [LicensedUser], [LicenseCode]) );

GO

-- tSQLCfgConnection/tInstance is a horizontal partion (1:1)  
-- the entity context for tSQLCfgConnection is the connection 
-- for tInstance the context is the archive settings 
IF OBJECT_ID('[SQLCfg].[tConnection]','U') IS NULL
 CREATE TABLE [SQLCfg].[tConnection] (
    [InstanceName] [NVARCHAR] (128) NOT NULL 
  , [EncryptedConnection] [BIT] NOT NULL
    CONSTRAINT [dft_tConnection__EncryptedConnection] 
    DEFAULT (0)
  , [TrustServerCertificate] [BIT] NOT NULL
    CONSTRAINT [dft_tConnection__TrustServerCertificate] 
    DEFAULT (0)
  , [NetworkProtocol] [NVARCHAR] (128) NULL
  , [ConnectionTimeout] [INT] NOT NULL
    CONSTRAINT [dft_tConnection__ConnectionTimeout] 
    DEFAULT (10)
  , [LoginSecure] [BIT] NOT NULL
    CONSTRAINT [dft_tConnection__LoginSecure] 
    DEFAULT (1)
  , [LoginName] [NVARCHAR] (128) NULL
  , [EncryptedPassword] [VARBINARY] (256) NULL
  , [IsDeleted] [BIT] NOT NULL
    CONSTRAINT [dft_tConnection__IsDeleted] 
    DEFAULT (0)
  , [RecCreatedDt] [DATETIME] NOT NULL 
    CONSTRAINT [dft_tConnection_RecCreatedDt] 
    DEFAULT (CURRENT_TIMESTAMP)
  , [RecCreatedUser] [NVARCHAR] (128) NOT NULL 
    CONSTRAINT [dft_tConnection_RecCreatedUser] 
    DEFAULT (ORIGINAL_LOGIN())
  , [RecUpdatedDt] [DATETIME] NOT NULL 
    CONSTRAINT [dft_tConnection_RecUpdatedDt] 
    DEFAULT (CURRENT_TIMESTAMP)
  , [RecUpdatedUser] [NVARCHAR] (128) NOT NULL 
    CONSTRAINT [dft_tConnection_RecUpdatedUser] 
    DEFAULT (ORIGINAL_LOGIN())
  , CONSTRAINT [pkn_tConnection__Name] 
    PRIMARY KEY CLUSTERED ([InstanceName]) );

GO

IF OBJECT_ID('[SQLCfg].[tInstance]','U') IS NULL
 CREATE TABLE [SQLCfg].[tInstance] (
    [Name] [NVARCHAR] (128) NOT NULL 
  , [ActiveDirectory] [BIT] NOT NULL 
    CONSTRAINT [dft_tInstance_ActiveDirectory] 
    DEFAULT (1)
  , [Audits] [BIT] NOT NULL 
    CONSTRAINT [dft_tInstance_Audits] 
    DEFAULT (1)
  , [BackupDevices] [BIT] NOT NULL 
    CONSTRAINT [dft_tInstance_BackupDevices] 
    DEFAULT (1)
  , [Configuration] [BIT] NOT NULL 
    CONSTRAINT [dft_tInstance_Configuration] 
    DEFAULT (1)
  , [Credentials] [BIT] NOT NULL 
    CONSTRAINT [dft_tInstance_Credentials] 
    DEFAULT (1)
  , [CryptographicProviders] [BIT] NOT NULL 
    CONSTRAINT [dft_tInstance_CryptographicProviders] 
    DEFAULT (1)
  , [Databases] [BIT] NOT NULL 
    CONSTRAINT [dft_tInstance_Databases] 
    DEFAULT (1)   
  , [EndPoints] [BIT] NOT NULL 
    CONSTRAINT [dft_tInstance_EndPoints] 
    DEFAULT (1)
  , [FullTextService] [BIT] NOT NULL 
    CONSTRAINT [dft_tInstance_FullTextService] 
    DEFAULT (1)
  , [Information] [BIT] NOT NULL 
    CONSTRAINT [dft_tInstance_Information] 
    DEFAULT (1)
  , [JobServer] [BIT] NOT NULL 
    CONSTRAINT [dft_tInstance_JobServer] 
    DEFAULT (1)
  , [LinkedServers] [BIT] NOT NULL 
    CONSTRAINT [dft_tInstance_LinkedServers] 
    DEFAULT (1)
  , [Logins] [BIT] NOT NULL 
    CONSTRAINT [dft_tInstance_Logins] 
    DEFAULT (1)
  , [Mail] [BIT] NOT NULL 
    CONSTRAINT [dft_tInstance_Mail] 
    DEFAULT (1)
  , [ProxyAccount] [BIT] NOT NULL 
    CONSTRAINT [dft_tInstance_ProxyAccount] 
    DEFAULT (1)
  , [ResourceGovernor] [BIT] NOT NULL 
    CONSTRAINT [dft_tInstance_ResourceGovernor] 
    DEFAULT (1)
  , [Roles] [BIT] NOT NULL 
    CONSTRAINT [dft_tInstance_Roles] 
    DEFAULT (1)
  , [ServerAuditSpecifications] [BIT] NOT NULL 
    CONSTRAINT [dft_tInstance_ServerAuditSpecifications] 
    DEFAULT (1)
  , [Settings] [BIT] NOT NULL 
    CONSTRAINT [dft_tInstance_Settings] 
    DEFAULT (1)
  , [Triggers] [BIT] NOT NULL 
    CONSTRAINT [dft_tInstance_Triggers] 
    DEFAULT (1)
  , [UserDefinedMessages] [BIT] NOT NULL 
    CONSTRAINT [dft_tInstance_UserDefinedMessages] 
    DEFAULT (1)
  , [RecCreatedDt] [DATETIME] NOT NULL 
    CONSTRAINT [dft_tInstance_RecCreatedDt] 
    DEFAULT (CURRENT_TIMESTAMP)
  , [RecCreatedUser] [NVARCHAR] (128) NOT NULL 
    CONSTRAINT [dft_tInstance_RecCreatedUser] 
    DEFAULT (ORIGINAL_LOGIN())
  , [RecUpdatedDt] [DATETIME] NOT NULL
    CONSTRAINT [dft_tInstance_RecUpdatedDt] 
    DEFAULT (CURRENT_TIMESTAMP)
  , [RecUpdatedUser] [NVARCHAR] (128) NOT NULL 
    CONSTRAINT [dft_tInstance_RecUpdatedUser] 
    DEFAULT (ORIGINAL_LOGIN())
  , CONSTRAINT [pk_tInstance__Name] 
    PRIMARY KEY  CLUSTERED ([Name]) 
  , CONSTRAINT [fk_tInstance__Name__to__tConnection__InstanceName] 
    FOREIGN KEY    ([Name]) 
    REFERENCES [SQLCfg].[tConnection] ([InstanceName]) 
    ON DELETE NO ACTION );

GO

IF OBJECT_ID('[SQLCfg].[tJobServer]','U') IS NULL
 CREATE TABLE [SQLCfg].[tJobServer] (
    [InstanceName] [NVARCHAR] (128) NOT NULL 
  , [Alerts] [BIT] NOT NULL 
    CONSTRAINT [dft_tJobServer_Alerts] 
    DEFAULT (1)
  , [AlertSystem] [BIT] NOT NULL 
    CONSTRAINT [dft_tJobServer_AlertSystem] 
    DEFAULT (1)
  , [Jobs] [BIT] NOT NULL 
    CONSTRAINT [dft_tJobServer_Jobs] 
    DEFAULT (1)
  , [Operators] [BIT] NOT NULL 
    CONSTRAINT [dft_tJobServer_Operators] 
    DEFAULT (1)
  , [ProxyAccounts] [BIT] NOT NULL 
    CONSTRAINT [dft_tJobServer_ProxyAccounts] 
    DEFAULT (1)
  , [TargetServers] [BIT] NOT NULL 
    CONSTRAINT [dft_tJobServer_TargetServers] 
    DEFAULT (1)
  , [RecCreatedDt] [DATETIME] NOT NULL 
    CONSTRAINT [dft_tJobServer_RecCreatedDt] 
    DEFAULT (CURRENT_TIMESTAMP)
  , [RecCreatedUser] [NVARCHAR] (128) NOT NULL 
    CONSTRAINT [dft_tJobServer_RecCreatedUser] 
    DEFAULT (ORIGINAL_LOGIN())
  , [RecUpdatedDt] [DATETIME] NOT NULL 
    CONSTRAINT [dft_tJobServer_RecUpdatedDt] 
    DEFAULT (CURRENT_TIMESTAMP)
  , [RecUpdatedUser] [NVARCHAR] (128) NOT NULL 
    CONSTRAINT [dft_tJobServer_RecUpdatedUser] 
    DEFAULT (ORIGINAL_LOGIN())
  , CONSTRAINT [pk_tJobServer__Name] 
    PRIMARY KEY  CLUSTERED ([InstanceName]) 
  , CONSTRAINT [fk_tJobServer__to__tInstance__Name] 
    FOREIGN KEY ([InstanceName]) 
    REFERENCES [SQLCfg].[tInstance] ([Name]) 
    ON DELETE NO ACTION );

GO

IF OBJECT_ID('[SQLCfg].[tDb]','U') IS NULL
 CREATE TABLE [SQLCfg].[tDb] (
    [Name] [NVARCHAR] (128) NOT NULL
  , [InstanceName] [NVARCHAR] (128) NOT NULL 
  , [ActiveDirectory] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_ActiveDiretory] 
    DEFAULT (1)
  , [ApplicationRoles] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_ApplicationRoles] 
    DEFAULT (1)
  , [Assemblies] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_Assemblies] 
    DEFAULT (1)
  , [AsymmetricKeys] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_AsymmetricKeys] 
    DEFAULT (1)
  , [Certificates] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_Certificates] 
    DEFAULT (1)
  , [DatabaseAuditSpecifications] [BIT] NOT NULL 
    CONSTRAINT [dft_tInstance_DatabaseAuditSpecifications] 
    DEFAULT (1)
  , [DatabaseOptions] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_DatabaseOptions] 
    DEFAULT (1)
  , [Defaults] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_Defaults] 
    DEFAULT (1)
  , [FullTextCatalogs] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_FullTextCatalogs] 
    DEFAULT (1)
  , [FullTextStopLists] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_FullTextStopLists] 
    DEFAULT (1)
  , [PartitionFunctions] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_PartitionFunctions] 
    DEFAULT (1)
  , [PartitionSchemes] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_PartitionSchemes] 
    DEFAULT (1)
  , [PlanGuides] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_PlanGuides] 
    DEFAULT (1)
  , [Roles] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_Roles] 
    DEFAULT (1)
  , [Rules] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_Rules] 
    DEFAULT (1)
  , [Schemas] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_Schemas] 
    DEFAULT (1)
  , [ServiceBroker] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_ServiceBroker] 
    DEFAULT (1)
  , [StoredProcedures] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_StoredProcedures] 
    DEFAULT (1)
  , [SymmetricKeys] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_SymmetricKeys] 
    DEFAULT (1)
  , [Synonyms] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_Synonyms] 
    DEFAULT (1)
  , [Tables] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_Tables] 
    DEFAULT (1)
  , [Triggers] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_Triggers] 
    DEFAULT (1)
  , [UserDefinedAggregates] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_UserDefinedAggregates] 
    DEFAULT (1)
  , [UserDefinedDataTypes] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_UserDefinedDataTypes] 
    DEFAULT (1)
  , [UserDefinedFunctions] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_UserDefinedFunctions] 
    DEFAULT (1)
  , [UserDefinedTableTypes] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_UserDefinedTableTypes] 
    DEFAULT (1)
  , [UserDefinedTypes] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_UserDefinedTypes] 
    DEFAULT (1)
  , [Users] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_Users] 
    DEFAULT (1)
  , [Views] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_Views] 
    DEFAULT (1)
  , [XMLSchemaCollections] [BIT] NOT NULL 
    CONSTRAINT [dft_tDb_XMLSchemaCollections] 
    DEFAULT (1)
  , [RecCreatedDt] [DATETIME] NOT NULL 
    CONSTRAINT [dft_tDb_RecCreatedDt] 
    DEFAULT (CURRENT_TIMESTAMP)
  , [RecCreatedUser] [NVARCHAR] (128) NOT NULL 
    CONSTRAINT [dft_tDb_RecCreatedUser] 
    DEFAULT (ORIGINAL_LOGIN())
  , [RecUpdatedDt] [DATETIME] NOT NULL 
    CONSTRAINT [dft_tDb_RecUpdatedDt] 
    DEFAULT (CURRENT_TIMESTAMP)
  , [RecUpdatedUser] [NVARCHAR] (128) NOT NULL 
    CONSTRAINT [dft_tDb_RecUpdatedUser] 
    DEFAULT (ORIGINAL_LOGIN())
  , CONSTRAINT [pk_tDb__InstanceName__Name] 
    PRIMARY KEY CLUSTERED ([InstanceName], [Name])
  , CONSTRAINT [fk_tDb__Instance__to__tInstance__Name] 
    FOREIGN KEY ([InstanceName]) 
    REFERENCES [SQLCfg].[tInstance] ([Name]) 
    ON DELETE NO ACTION );

GO

IF OBJECT_ID('[SQLCfg].[tServiceBroker]','U') IS NULL
 CREATE TABLE [SQLCfg].[tServiceBroker] (
    [DatabaseName] [NVARCHAR] (128) NOT NULL
  , [InstanceName] [NVARCHAR] (128) NOT NULL 
  , [MessageTypes] [BIT] NOT NULL 
    CONSTRAINT [dft_tServiceBroker_MessageTypes] 
    DEFAULT (1)
  , [Priorities] [BIT] NOT NULL 
    CONSTRAINT [dft_tServiceBroker_Priorities] 
    DEFAULT (1)
  , [Queues] [BIT] NOT NULL 
    CONSTRAINT [dft_tServiceBroker_Queues] 
    DEFAULT (1)
  , [RemoteServiceBindings] [BIT] NOT NULL 
    CONSTRAINT [dft_tServiceBroker_RemoteServiceBindings] 
    DEFAULT (1)
  , [Routes] [BIT] NOT NULL 
    CONSTRAINT [dft_tServiceBroker_Routes] 
    DEFAULT (1)
  , [ServiceContracts] [BIT] NOT NULL 
    CONSTRAINT [dft_tServiceBroker_ServiceContracts] 
    DEFAULT (1)
  , [Services] [BIT] NOT NULL 
    CONSTRAINT [dft_tServiceBroker_Services] 
    DEFAULT (1)
  , [RecCreatedDt] [DATETIME] NOT NULL 
    CONSTRAINT [dft_tServiceBroker_RecCreatedDt] 
    DEFAULT (CURRENT_TIMESTAMP)
  , [RecCreatedUser] [NVARCHAR] (128) NOT NULL 
    CONSTRAINT [dft_tServiceBroker_RecCreatedUser] 
    DEFAULT (ORIGINAL_LOGIN())
  , [RecUpdatedDt] [DATETIME] NOT NULL 
    CONSTRAINT [dft_tServiceBroker_RecUpdatedDt] 
    DEFAULT (CURRENT_TIMESTAMP)
  , [RecUpdatedUser] [NVARCHAR] (128) NOT NULL 
    CONSTRAINT [dft_tServiceBroker_RecUpdatedUser] 
    DEFAULT (ORIGINAL_LOGIN())
  , CONSTRAINT [pk_tServiceBroker__InstanceName__DatabaseName] 
    PRIMARY KEY  CLUSTERED ([InstanceName], [DatabaseName]) 
  , CONSTRAINT [fk_tServiceBroker__to__tDB__InstanceName__DBName] 
    FOREIGN KEY ([InstanceName], [DatabaseName]) 
    REFERENCES [SQLCfg].[tDb] ([InstanceName],[Name]) 
    ON DELETE NO ACTION );

GO
-- NO DRI here
-- will have to crack the node to verify that the entry has a valid reference
-- unclustered UKey will make last version lookup faster  
IF OBJECT_ID('[SQLCfg].[tChange]','U') IS NULL
 BEGIN
  CREATE TABLE [SQLCfg].[tChange] (
     [Id] [INT] IDENTITY (1, 1) NOT NULL 
   , [Node]  [SQLCfg].[SQLCfgNode] NOT NULL
   , [Version] [INT] NULL 
   , [Action] [NVARCHAR] (30) NOT NULL
   , [EventData] [XML] SPARSE NULL  
   , [Definition] [NVARCHAR] (MAX) NULL
   , [DefinitionDt] [DATETIME] SPARSE NULL
   , [RecCreatedDt] [DATETIME] NOT NULL 
     CONSTRAINT [dft_tChange__RecCreatedDt] 
     DEFAULT (CURRENT_TIMESTAMP)
   , CONSTRAINT [pkc_tChange__Id] 
     PRIMARY KEY CLUSTERED ([Id]));

  CREATE NONCLUSTERED INDEX [ixn_tChange_Node_i]
  ON [SQLCfg].[tChange] ([Node])
  INCLUDE ([Version], [Id])

  CREATE UNIQUE NONCLUSTERED INDEX [ixn_tChange_Version_i]  
  ON [SQLCfg].[tChange] ([Version], [Node])
  INCLUDE ([Id], [Action])
  
  CREATE NONCLUSTERED INDEX [ixn_tChange_RecCreatedDt_i]
  ON [SQLCfg].[tChange] ([RecCreatedDt])
  INCLUDE ([Node],[Action])
  
 END

GO

IF NOT EXISTS (SELECT * FROM [sys].[fulltext_indexes] 
               WHERE [object_id] = OBJECT_ID('[SQLCfg].[tChange]')) 
 BEGIN
  IF PARSENAME(CONVERT(NVARCHAR(20), SERVERPROPERTY('ProductVersion')),4) < 10
    EXEC sp_executesql N'CREATE FULLTEXT INDEX ON [SQLCfg].[tChange]
     ([EventData], [Definition] LANGUAGE 0X0 )
    KEY INDEX [pkc_tChange__Id] ON [ftSQLConfigurationRepositoryCatalog]
    WITH CHANGE_TRACKING AUTO;'                    
  ELSE
    EXEC sp_executesql N'CREATE FULLTEXT INDEX ON [SQLCfg].[tChange]
     ([EventData], [Definition] LANGUAGE 0X0 )
    KEY INDEX [pkc_tChange__Id] ON [ftSQLConfigurationRepositoryCatalog]
    WITH (CHANGE_TRACKING AUTO, STOPLIST = SYSTEM);'                    
 END
GO

IF (SELECT [value] FROM [sys].[configurations] WHERE [name] = 'show advanced options') = 0
 BEGIN
  EXEC [dbo].[sp_configure] 'show advanced options', 1;
  RECONFIGURE;
  PRINT 'RECONFIGURE has been run.';
 END

-- FREETEXT performance helper but rank can be outdated - if it matters
IF (SELECT value FROM [sys].[configurations] WHERE [name] = 'precompute rank') = 0
 BEGIN
  EXEC [dbo].[sp_configure] 'precompute rank', 1;
  RECONFIGURE;
  PRINT 'RECONFIGURE has been run.';
 END

-- CONTAINS optimization to prevent lots-0-nioseword warnings/errors 
IF (SELECT value FROM [sys].[configurations] WHERE [name] = 'transform noise words') = 0
 BEGIN
  EXEC [dbo].[sp_configure] 'transform noise words', 1;
  RECONFIGURE;
  PRINT 'RECONFIGURE has been run.';
 END

GO

/* 
   A connection is expected to have one schedule under normal conditions. Only 
   one schedule per instance can use event notifications (enforced by trigger). 
   May also be desirable to periodically verify that someone has not bypassed 
   the event notification mechanism but doing a full archive of the server.
*/
 
IF OBJECT_ID('[SQLCfg].[tSchedule]','U') IS NULL
 BEGIN
  CREATE TABLE [SQLCfg].[tSchedule] (
     [Id] [INT] IDENTITY (1, 1) NOT NULL 
   , [InstanceName] [NVARCHAR] (128) NOT NULL
   , [Interval] [INT] NOT NULL
   , [IntervalType] [NVARCHAR] (10) NOT NULL
   , [IntervalBaseDt] [DATETIME]
   , [UseEventNotifications] [BIT] NOT NULL 
     CONSTRAINT [dft_tInstance__UseEventNotifications] 
     DEFAULT (1)
   , [IsActive] [BIT] 
     CONSTRAINT [dft_tSchedule__IsActive]
     DEFAULT (1) 
   , [RecCreatedDt] [DATETIME] NOT NULL 
     CONSTRAINT [dft_tSchedule_RecCreatedDt] 
     DEFAULT (CURRENT_TIMESTAMP)
   , [RecCreatedUser] [NVARCHAR] (128) NOT NULL 
     CONSTRAINT [dft_tSchedule_RecCreatedUser] 
     DEFAULT (ORIGINAL_LOGIN())
   , [RecUpdatedDt] [DATETIME] NOT NULL 
     CONSTRAINT [dft_tSchedule_RecUpdatedDt] 
     DEFAULT (CURRENT_TIMESTAMP)
   , [RecUpdatedUser] [NVARCHAR] (128) NOT NULL 
     CONSTRAINT [dft_tSchedule_RecUpdatedUser] 
     DEFAULT (ORIGINAL_LOGIN())
   , CONSTRAINT [pkn_tSchedule__Id] 
     PRIMARY KEY NONCLUSTERED ([Id])  
   , CONSTRAINT [fk_tSchedule__InstanceName__to__tConnection__InstanceName] 
     FOREIGN KEY    ([InstanceName]) 
     REFERENCES [SQLCfg].[tConnection] ([InstanceName]) 
     ON DELETE NO ACTION );
  END 

GO 
IF OBJECT_ID('[SQLCfg].[tSchedule]','U') IS NOT NULL
AND OBJECT_ID('[SQLCfg].[vArchive]') IS NULL
 BEGIN
  DECLARE @str as [NVARCHAR] (4000) 
  SET @str = '/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
*******************************************************************************
**    Date           Author             Description of Change
**    11/10/2009     bw                 remove QueryBaseline references 
**              
*******************************************************************************/

CREATE VIEW [SQLCfg].[vArchive]
AS
SELECT [Id] AS [ArchiveId] 
 , [InstanceName] 
 , [Interval]
 , [IntervalType]
 , [IntervalBaseDt] AS [NextRunDt]
 , CASE WHEN [UseEventNotifications] = 1 THEN ''True''
        ELSE ''False'' END AS [UseEventNotifications] 
 , [IsActive] AS [IsScheduleActive] 
FROM [SQLCfg].[tSchedule]'
  EXEC sp_executesql @str   
 END
GO

IF OBJECT_ID('[SQLCfg].[tLabel]','U') IS NULL
 CREATE TABLE [SQLCfg].[tLabel] (
    [Id] [INT] IDENTITY (1, 1) NOT NULL 
  , [IncludeChildren] [BIT]
    CONSTRAINT [dft_tLabel__IncludeChildren] 
    DEFAULT (1)
  , [Label] [NVARCHAR] (128) NOT NULL  
  , [Notes] [NVARCHAR] (MAX) NULL  
  , [ExpiredDt] [DATETIME] NULL 
  , [RecCreatedDt] [DATETIME] NOT NULL 
    CONSTRAINT [dft_tLabel__RecCreatedDt] 
    DEFAULT (CURRENT_TIMESTAMP)
  , [RecCreatedUser] [NVARCHAR] (128) NOT NULL 
    CONSTRAINT [dft_tLabel_RecUpdatedUser] 
    DEFAULT (ORIGINAL_LOGIN())
  , CONSTRAINT [pkn_tLabel__Id] 
    PRIMARY KEY ([Id]) );

GO

IF OBJECT_ID('[SQLCfg].[tArchiveLog]','U') IS NULL
 BEGIN
  CREATE TABLE [SQLCfg].[tArchiveLog] (
     [Id] [INT] IDENTITY (1, 1) NOT NULL 
   , [ScheduleId] [INT] NOT NULL
   , [InstanceName] [NVARCHAR] (128) NOT NULL
   , [NbrDDLEventsProcessed] [INT] NULL
   , [NbrItemsProcessed] [INT] NULL
   , [NbrItemsAdded] [INT] NULL
   , [NbrItemsChanged] [INT] NULL
   , [NbrItemsDeleted] [INT] NULL
   , [ArchiveError] [VARCHAR] (MAX) SPARSE NULL
   , [ScheduledStartDt] [DATETIME]  NULL -- null likely means ran from UI  
   , [ActualStartDt] [DATETIME] NOT NULL 
   , [ActualEndDt] [DATETIME] NOT NULL 
     CONSTRAINT [dft_tArchiveLog__ActualEndDt] 
     DEFAULT (CURRENT_TIMESTAMP)
   , [RecCreatedUser] [NVARCHAR] (128) NOT NULL 
     CONSTRAINT [dft_tArchiveLog_RecCreatedUser] 
     DEFAULT (ORIGINAL_LOGIN())
   , CONSTRAINT [pkn_tArchiveLog__Id] 
     PRIMARY KEY ([Id]) );
    
  CREATE NONCLUSTERED INDEX ixn_tArchiveLog_ScheduledStartDt  
  ON [SQLCfg].[tArchiveLog] (ScheduledStartDt)
     
  CREATE NONCLUSTERED INDEX ixn_tArchiveLog_ActualStartDt  
  ON [SQLCfg].[tArchiveLog] (ActualStartDt)
     
 END     

GO

IF OBJECT_ID('[SQLCfg].[tChangeLabel]','U') IS NULL
 CREATE TABLE [SQLCfg].[tChangeLabel] (
    [LabelId] [INT] NOT NULL 
  , [ChangeId]  [INT] NOT NULL
  , CONSTRAINT pkc_tChangeLabel__LabelId__ChangeId
    PRIMARY KEY ([LabelId], [ChangeId])
  , CONSTRAINT [fk_tChangeLabel__LabelId__to__tLabel]
    FOREIGN KEY ([LabelId]) REFERENCES [SQLCfg].[tLabel](Id)
  , CONSTRAINT [fk_tChangeLabel__ChangeId__to__tChange]
    FOREIGN KEY ([ChangeId]) REFERENCES [SQLCfg].[tChange]([Id]) );
   
GO

IF OBJECT_ID('[SQLCfg].[tSQLErrorLog]','U') IS NULL
 CREATE TABLE [SQLCfg].[tSQLErrorLog] (
    [Id] [INT] IDENTITY (1, 1) NOT NULL 
  , [UserName] [NVARCHAR] (256)  NULL
  , [DBName] [NVARCHAR] (128)  NULL
  , [ErrorNumber] [INT]  NULL
  , [ErrorSeverity] [INT]  NULL
  , [ErrorState] [INT]  NULL
  , [ErrorProcedure] [NVARCHAR] (126) NULL
  , [ErrorLine] [INT]  NULL
  , [ErrorMessage] [NVARCHAR] (2048) NULL
  , [TextData] [NVARCHAR] (MAX) NULL 
  , [Notes] [NVARCHAR] (MAX) SPARSE NULL  
  , [RecCreatedDt] [DATETIME] NOT NULL 
    CONSTRAINT [dft_tSQLErrorLog__RecCreatedDt] 
    DEFAULT (CURRENT_TIMESTAMP)
  , CONSTRAINT [pkc_tSQLErrorLog__Id] 
    PRIMARY KEY ([Id]) );

GO
 
If NOT EXISTS (SELECT * FROM [sys].[fulltext_indexes] 
               WHERE object_name([object_id]) = 'tSQLErrorLog') 
 CREATE FULLTEXT INDEX ON [SQLCfg].[tSQLErrorLog]
  (ErrorMessage, [TextData] LANGUAGE 0X0, [Notes] LANGUAGE 0X0 )
 KEY INDEX [pkc_tSQLErrorLog__Id] ON [ftSQLConfigurationRepositoryCatalog]
 WITH CHANGE_TRACKING AUTO;                    

GO

-- column names in this table closely align to SQLClue app settings
-- what is here is needed to standardize the archive.
-- !!changing a setting will result in change versions with no real changes associated!! 
-- see insert at pRepositoryInit
IF OBJECT_ID('[SQLCfg].[tServiceSettings]','U') IS NULL
 CREATE TABLE [SQLCfg].[tServiceSettings] (
    [Name] [NVARCHAR] (128) NOT NULL
    CONSTRAINT dft_tServiceSettings__SQLInstance
    DEFAULT ('DEFAULT')
  , [AddDatabasesUponDiscovery] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__AddDatabasesUponDiscovery] 
    DEFAULT (1)
  , [TargetEventNotificationDatabase] [NVARCHAR] (128) NOT NULL
    CONSTRAINT [dft_tServiceSettings__TargetEventNotificationDatabase] 
    DEFAULT ('msdb')
  , [Scripting__Options_Batch__Separator] [NVARCHAR] (128) NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_Batch__Separator] 
    DEFAULT ('GO')
  , [Misc_Ignore__Blank__Lines] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Misc_Ignore__Blank__Lines] 
    DEFAULT (1)
  , [Misc_Display__Output_Show__Comparison__Details] [BIT] NOT NULL 
    CONSTRAINT [dft_tServiceSettings__Misc_Display__Output_Show__Comparison__Details] 
    DEFAULT (0)
  , [Scripting__Options_Include__DROP__In__Script] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_Include__DROP__In__Script] 
    DEFAULT (0)
  , [Scripting__Options_Include__IF__EXISTS__With__Drop] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_Include__IF__EXISTS__With__Drop] 
    DEFAULT (1)
  , [Misc_Display__Output_Show__Scripts__For__Unmatched__Items] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Misc_Display__Output_Show__Scripts__For__Unmatched__Items] 
    DEFAULT (0)
  , [Regular__Expressions_LineReplace__Regex__Options_IgnoreCase_5] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_LineReplace__Regex__Options_IgnoreCase_5] 
    DEFAULT (0)
  , [Regular__Expressions_LineReplace__Regex__Options_Multiline_7] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_LineReplace__Regex__Options_Multiline_7] 
    DEFAULT (0)
  , [Regular__Expressions_LineReplace__Regex__Options_ExplicitCapture_4] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_LineReplace__Regex__Options_ExplicitCapture_4] 
    DEFAULT (0)
  , [Regular__Expressions_LineReplace__Regex__Options_Compiled_1] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_LineReplace__Regex__Options_Compiled_1] 
    DEFAULT (1)
  , [Regular__Expressions_LineReplace__Regex__Options_SingleLine_9] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_LineReplace__Regex__Options_SingleLine_9] 
    DEFAULT (0)
  , [Regular__Expressions_LineReplace__Regex__Options_IgnorePatternWhiteSpace_6] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_LineReplace__Regex__Options_IgnorePatternWhiteSpace_6] 
    DEFAULT (0)
  , [Regular__Expressions_LineReplace__Regex__Options_RightToLeft_8] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_LineReplace__Regex__Options_RightToLeft_8] 
    DEFAULT (0)
  , [Regular__Expressions_LineReplace__Regex__Options_ECMAScript_3] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_LineReplace__Regex__Options_ECMAScript_3] 
    DEFAULT (0)
  , [Regular__Expressions_LineReplace__Regex__Options_CultureInvariant_2] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_LineReplace__Regex__Options_CultureInvariant_2] 
    DEFAULT (0)
  , [Regular__Expressions_LineReplace__Pattern_1] NVARCHAR(MAX) NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_LineReplace__Pattern_1] 
    DEFAULT ('')
  , [Regular__Expressions_LineReplace__Replacement_2] NVARCHAR(MAX) NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_LineReplace__Replacement_2] 
    DEFAULT ('')
  , [Regular__Expressions_LineSplit__Regex__Options_IgnoreCase_5] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_LineSplit__Regex__Options_IgnoreCase_5] 
    DEFAULT (0)
  , [Regular__Expressions_LineSplit__Regex__Options_Multiline_7] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_LineSplit__Regex__Options_Multiline_7] 
    DEFAULT (0)
  , [Regular__Expressions_LineSplit__Regex__Options_ExplicitCapture_4] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_LineSplit__Regex__Options_ExplicitCapture_4] 
    DEFAULT (0)
  , [Regular__Expressions_LineSplit__Regex__Options_Compiled_1] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_LineSplit__Regex__Options_Compiled_1] 
    DEFAULT (1)
  , [Regular__Expressions_LineSplit__Regex__Options_SingleLine_9] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_LineSplit__Regex__Options_SingleLine_9] 
    DEFAULT (0)
  , [Regular__Expressions_LineSplit__Regex__Options_IgnorePatternWhiteSpace_6] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_LineSplit__Regex__Options_IgnorePatternWhiteSpace_6] 
    DEFAULT (0)
  , [Regular__Expressions_LineSplit__Regex__Options_RightToLeft_8] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_LineSplit__Regex__Options_RightToLeft_8] 
    DEFAULT (0)
  , [Regular__Expressions_LineSplit__Regex__Options_ECMAScript_3] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_LineSplit__Regex__Options_ECMAScript_3] 
    DEFAULT (0)
  , [Regular__Expressions_LineSplit__Regex__Options_CultureInvariant_2] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_LineSplit__Regex__Options_CultureInvariant_2] 
    DEFAULT (0)
  , [Regular__Expressions_LineSplit__Pattern_3] [NVARCHAR] (MAX) NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_LineSplit__Pattern_3] 
    DEFAULT ('\r\n|\n')
  , [Regular__Expressions_NameMatch__Regex__Options_IgnoreCase_5] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_NameMatch__Regex__Options_IgnoreCase_5] 
    DEFAULT (0)
  , [Regular__Expressions_NameMatch__Regex__Options_Multiline_7] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_NameMatch__Regex__Options_Multiline_7] 
    DEFAULT (0)
  , [Regular__Expressions_NameMatch__Regex__Options_ExplicitCapture_4] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_NameMatch__Regex__Options_ExplicitCapture_4] 
    DEFAULT (0)
  , [Regular__Expressions_NameMatch__Regex__Options_Compiled_1] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_NameMatch__Regex__Options_Compiled_1] 
    DEFAULT (1)
  , [Regular__Expressions_NameMatch__Regex__Options_SingleLine_9] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_NameMatch__Regex__Options_SingleLine_9] 
    DEFAULT (0)
  , [Regular__Expressions_NameMatch__Regex__Options_IgnorePatternWhiteSpace_6] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_NameMatch__Regex__Options_IgnorePatternWhiteSpace_6] 
    DEFAULT (0)
  , [Regular__Expressions_NameMatch__Regex__Options_RightToLeft_8] [BIT] NOT NULL 
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_NameMatch__Regex__Options_RightToLeft_8] 
    DEFAULT (0)
  , [Regular__Expressions_NameMatch__Regex__Options_ECMAScript_3] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_NameMatch__Regex__Options_ECMAScript_3] 
    DEFAULT (0)
  , [Regular__Expressions_NameMatch__Regex__Options_CultureInvariant_2] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_NameMatch__Regex__Options_CultureInvariant_2] 
    DEFAULT (0)
  , [Regular__Expressions_NameMatch__Pattern_4] NVARCHAR(MAX) NOT NULL
    CONSTRAINT [dft_tServiceSettings__Regular__Expressions_NameMatch__Pattern_4] 
    DEFAULT ('')
  , [Scripting__Options_SMO_AgentAlertJob_1] [BIT] NOT NULL 
    CONSTRAINT [dft_tServiceSettings__[Scripting__Options_SMO_AgentAlertJob_1] 
    DEFAULT (0)
  , [Scripting__Options_SMO_AgentJobId_2] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_AgentJobId_2] 
    DEFAULT (0)
  , [Scripting__Options_SMO_AgentNotify_3] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_AgentNotify_3] 
    DEFAULT (0)
  , [Scripting__Options_SMO_AllowSystemObjects_10] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_AllowSystemObjects_10] 
    DEFAULT (0)
  , [Scripting__Options_SMO_AnsiFile_20] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_AnsiFile_20] 
    DEFAULT (0)
  , [Scripting__Options_SMO_AnsiPadding_30] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_AnsiPadding_30] 
    DEFAULT (1)
  , [Scripting__Options_SMO_BatchSize_35] [INT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_BatchSize_35] 
    DEFAULT (100)
  , [Scripting__Options_SMO_Bindings_40] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_Bindings_40] 
    DEFAULT (0)
  , [Scripting__Options_SMO_ChangeTracking_45] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_ChangeTracking_45] 
    DEFAULT (0)
  , [Scripting__Options_SMO_ClusteredIndexes_50] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_ClusteredIndexes_50] 
    DEFAULT (0)
  , [Scripting__Options_SMO_ContinueScriptingOnError_60] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_ContinueScriptingOnError_60] 
    DEFAULT (0)
  , [Scripting__Options_SMO_ConvertUserDefinedDataTypesToBaseType_70] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_ConvertUserDefinedDataTypesToBaseType_70] 
    DEFAULT (0)
  , [Scripting__Options_SMO_DdlBodyOnly_80] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_DdlBodyOnly_80] 
    DEFAULT (0)
  , [Scripting__Options_SMO_DdlHeaderOnly_90] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_DdlHeaderOnly_90] 
    DEFAULT (0)
  , [Scripting__Options_SMO_Default_100] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_Default_100] 
    DEFAULT (0)
  , [Scripting__Options_SMO_DriAll_110] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_DriAll_110] 
    DEFAULT (1)
  , [Scripting__Options_SMO_DriAllConstraints_120] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_DriAllConstraints_120] 
    DEFAULT (0)
  , [Scripting__Options_SMO_DriAllKeys_130] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_DriAllKeys_130] 
    DEFAULT (0)
  , [Scripting__Options_SMO_DriChecks_140] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_DriChecks_140] 
    DEFAULT (0)
  , [Scripting__Options_SMO_DriClustered_150] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_DriClustered_150] 
    DEFAULT (0)
  , [Scripting__Options_SMO_DriDefaults_160] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_DriDefaults_160] 
    DEFAULT (0)
  , [Scripting__Options_SMO_DriForeignKeys_170] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_DriForeignKeys_170] 
    DEFAULT (0)
  , [Scripting__Options_SMO_DriIncludeSystemNames_180] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_DriIncludeSystemNames_180] 
    DEFAULT (0)
  , [Scripting__Options_SMO_DriIndexes_190] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_DriIndexes_190] 
    DEFAULT (0)
  , [Scripting__Options_SMO_DriNonClustered_200] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_DriNonClustered_200] 
    DEFAULT (0)
  , [Scripting__Options_SMO_DriPrimaryKey_210] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_DriPrimaryKey_210] 
    DEFAULT (0)
  , [Scripting__Options_SMO_DriUniqueKeys_220] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_DriUniqueKeys_220] 
    DEFAULT (0)
  , [Scripting__Options_SMO_DriWithNoCheck_230] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_DriWithNoCheck_230] 
    DEFAULT (0)
  , [Scripting__Options_SMO_Encoding_240] [VARCHAR] (50) NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_Encoding_240] 
    DEFAULT ('')
  , [Scripting__Options_SMO_EnforceScriptingOptions_250] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_EnforceScriptingOptions_250] 
    DEFAULT (0)
  , [Scripting__Options_SMO_ExtendedProperties_260] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_ExtendedProperties_260] 
    DEFAULT (0)
  , [Scripting__Options_SMO_FullTextCatalogs_270] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_FullTextCatalogs_270] 
    DEFAULT (1)
  , [Scripting__Options_SMO_FullTextindexes_280] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_FullTextindexes_280] 
    DEFAULT (1)
  , [Scripting__Options_SMO_FullTextStopLists_285] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_FullTextStopLists_285] 
    DEFAULT (1)
  , [Scripting__Options_SMO_IncludeDatabaseContext_290] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_IncludeDatabaseContext_290] 
    DEFAULT (0)
  , [Scripting__Options_SMO_IncludeDatabaseRoleMemberships_291] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_IncludeDatabaseRoleMemberships_291] 
    DEFAULT (1)
  , [Scripting__Options_SMO_IncludeFullTextCatalogRootPath_295] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_IncludeFullTextCatalogRootPath_295] 
    DEFAULT (1)
  , [Scripting__Options_SMO_IncludeHeaders_300] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_IncludeHeaders_300] 
    DEFAULT (0)
  , [Scripting__Options_SMO_IncludeIfNotExists_301] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_IncludeIfNotExists_301] 
    DEFAULT (0)
  , [Scripting__Options_SMO_Indexes_310] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_Indexes_310] 
    DEFAULT (1)
  , [Scripting__Options_SMO_LoginSID_320] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_LoginSID_320] 
    DEFAULT (0)
  , [Scripting__Options_SMO_NoAssemblies_330] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_NoAssemblies_330] 
    DEFAULT (0)
  , [Scripting__Options_SMO_NoCollation_340] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_NoCollation_340] 
    DEFAULT (0)
  , [Scripting__Options_SMO_NoCommandTerminator_350] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_NoCommandTerminator_350] 
    DEFAULT (0)
  , [Scripting__Options_SMO_NoExecuteAs_360] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_NoExecuteAs_360] 
    DEFAULT (0)
  , [Scripting__Options_SMO_NoFilegroup_370] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_NoFilegroup_370] 
    DEFAULT (0)
  , [Scripting__Options_SMO_NoFileStream_373] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_NoFileStream_373] 
    DEFAULT (0)
  , [Scripting__Options_SMO_NoFileStreamColumn_376] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_NoFileStreamColumn_376] 
    DEFAULT (0)
  , [Scripting__Options_SMO_NoIdentities_380] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_NoIdentities_380] 
    DEFAULT (0)
  , [Scripting__Options_SMO_NoIndexPartitioningSchemes_390] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_NoIndexPartitioningSchemes_390] 
    DEFAULT (0)
  , [Scripting__Options_SMO_NoMailProfileAccounts_400] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_NoMailProfileAccounts_400] 
    DEFAULT (0)
  , [Scripting__Options_SMO_NoMailProfilePrincipals_410] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_NoMailProfilePrincipals_410] 
    DEFAULT (0)
  , [Scripting__Options_SMO_NonClusteredIndexes_420] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_NonClusteredIndexes_420] 
    DEFAULT (0)
  , [Scripting__Options_SMO_NoTablePartitioningSchemes_430] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_NoTablePartitioningSchemes_430] 
    DEFAULT (0)
  , [Scripting__Options_SMO_NoVarDecimal_431] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_NoVarDecimal_431] 
    DEFAULT (0)
  , [Scripting__Options_SMO_NoViewColumns_440] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_NoViewColumns_440] 
    DEFAULT (0)
  , [Scripting__Options_SMO_NoXMLNameSpaces_450] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_NoXMLNameSpaces_450] 
    DEFAULT (0)
  , [Scripting__Options_SMO_OptimizerData_460] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_OptimizerData_460] 
    DEFAULT (0)
  , [Scripting__Options_SMO_Permissions_470] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_Permissions_470] 
    DEFAULT (1)
  , [Scripting__Options_SMO_PrimaryObject_480] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_PrimaryObject_480] 
    DEFAULT (1)
  , [Scripting__Options_SMO_SchemaQualify_490] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_SchemaQualify_490] 
    DEFAULT (1)
  , [Scripting__Options_SMO_SchemaQualifyForeignKeysReferences_500] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_SchemaQualifyForeignKeysReferences_500] 
    DEFAULT (1)
  , [Scripting__Options_SMO_ScriptBatchTerminator_502] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_ScriptBatchTerminator_502] 
    DEFAULT (1)
  , [Scripting__Options_SMO_ScriptData_503] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_ScriptData_503] 
    DEFAULT (0)
  , [Scripting__Options_SMO_ScriptDataCompression_505] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_ScriptDataCompression_505] 
    DEFAULT (1)
  , [Scripting__Options_SMO_ScriptDrops_506] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_ScriptDrops_506] 
    DEFAULT (0)
  , [Scripting__Options_SMO_ScriptOwner_508] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_ScriptOwner_508] 
    DEFAULT (1)
  , [Scripting__Options_SMO_ScriptSchema_509] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_ScriptSchema_509] 
    DEFAULT (1)           
  , [Scripting__Options_SMO_Statistics_510] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_Statistics_510] 
    DEFAULT (0)
  , [Scripting__Options_SMO_TimestampToBinary_520] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_TimestampToBinary_520] 
    DEFAULT (0)
  , [Scripting__Options_SMO_TargetServerVersion_530] [INT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_TargetServerVersion_530] 
    DEFAULT (0)
  , [Scripting__Options_SMO_Triggers_540] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_Triggers_540] 
    DEFAULT (1)
  , [Scripting__Options_SMO_WithDependencies_550] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_WithDependencies_550] 
    DEFAULT (0)
  , [Scripting__Options_SMO_XMLIndexes_560] [BIT] NOT NULL
    CONSTRAINT [dft_tServiceSettings__Scripting__Options_SMO_XMLIndexes_560] 
    DEFAULT (1)
  , [Notes] [NVARCHAR] (MAX) NULL  
  , [RecCreatedDt] [DATETIME] NOT NULL 
    CONSTRAINT [dft_tServiceSettings__RecCreatedDt] 
    DEFAULT (CURRENT_TIMESTAMP)
  , CONSTRAINT pk_tServiceSettings__Name
    PRIMARY KEY (Name));

GO
     
IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pLogSQLError' )
 DROP PROCEDURE [SQLCfg].[pLogSQLError];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: log database errors 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pLogSQLError] 
 ( @ParmString [NVARCHAR] (MAX)
 , @ObjectId [INT])
AS
BEGIN
 DECLARE @ProcName [NVARCHAR] (128)
  , @TextData [NVARCHAR] (MAX)
  , @ErrorNumber [INT]
  , @RollBackMsg [NVARCHAR] (256)
  , @SQLErrorLogId [INT];
  
 SET NOCOUNT ON;

 -- IF Output is 0 then nothing happened here
 SET @TextData = ISNULL('[' + OBJECT_SCHEMA_NAME(@ObjectId) + '].', '') 
               + ISNULL('[' + OBJECT_NAME(@ObjectId) + ']', 'Query:') 
               + CHAR(13) + CHAR(10) 
               + ISNULL(@ParmString,'');
 SET @ErrorNumber = ERROR_NUMBER();
 SET @ProcName = ERROR_PROCEDURE();

 BEGIN TRY
  -- Return if there is no error information to log.
  IF ERROR_NUMBER() IS NULL
   RETURN;

  -- rollback open transaction(s) then log the error
  IF XACT_STATE() <> 0 OR @@TRANCOUNT > 0
   BEGIN
    SET @RollbackMsg = 'Rolling back %d transaction(s) encountered in SQL Configuration Repository database '
                     + DB_NAME()
                     + ' while handling error %d from [%s] when [SQLCfg].[pLogSQLError] called.';
    RAISERROR(@RollbackMsg,1,1,@@TRANCOUNT, @ErrorNumber, @ProcName);
    WHILE @@TRANCOUNT > 0 
     ROLLBACK TRAN;
   END;

  INSERT [SQLCfg].[tSQLErrorLog] 
   ( [UserName] 
   , [ErrorNumber] 
   , [ErrorSeverity]
   , [ErrorState]
   , [ErrorProcedure] 
   , [ErrorLine]
   , [ErrorMessage]
   , [TextData] ) 
  VALUES 
   ( ORIGINAL_LOGIN()
   , ERROR_NUMBER()
   , ERROR_SEVERITY()
   , ERROR_STATE()
   , ERROR_PROCEDURE()
   , ERROR_LINE()
   , ERROR_MESSAGE() 
   , @TextData );

  -- fetch the value of the row just inserted
  SELECT @SQLErrorLogID = SCOPE_IDENTITY();
 END TRY

 BEGIN CATCH
  RAISERROR('Configuration Repository error handler failed to log error: Object [%d]',19, 1, @ObjectId) WITH LOG;
  RETURN -1;
 END CATCH

 -- report an error to the caller but limit details revealed
 RAISERROR ('Data Operation Failure. See SQLClue Configuration Error Log entry [%d] for additional details.', 16,1, @SQLErrorLogId);         

END; 

GO

GRANT EXECUTE ON [SQLCfg].[pLogSQLError] TO [SQLCfgServiceRole];

GO

IF  OBJECT_ID('[SQLCfg].[trgtSQLCfg_Insert_Update_Delete]','TR') IS NOT NULL
 DROP TRIGGER [SQLCfg].[trgtSQLCfg_Insert_Update_Delete]

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Note: changes need to be applied to assy refresh too
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/28/2008     bw                 added validation of LicenseDate               
**    2-5-2010       bw                 add currentVersion
**              
*******************************************************************************/

CREATE TRIGGER [SQLCfg].[trgtSQLCfg_Insert_Update_Delete]
ON [SQLCfg].[tSQLCfg]
FOR INSERT, UPDATE, DELETE
AS
BEGIN

 DECLARE @icount [INT]
  , @dcount [INT]
  , @ucount [INT]
  , @Node  [SQLCfgNode] 
  , @TextData [VARCHAR] (2048);

 SET NOCOUNT ON;

 BEGIN TRY

  SELECT @icount = COUNT(*) FROM [inserted];
  SELECT @dcount = COUNT(*) FROM [deleted];
  SELECT @ucount = COUNT(*) FROM [SQLCfg].[tSQLCfg];

  -- no multi row
  IF @icount > 1 OR @dcount > 1
   BEGIN
    SET @TextData = 'Multi-row [SQLCfg].[tSQLCfg] operations are not permitted';
    RAISERROR (@TextData, 16,1);
   END

  -- only one row in table
  IF @ucount > 1
   BEGIN
    SET @TextData = 'Cannot add multiple [SQLCfg].[tSQLCfg] configurations';
    RAISERROR (@TextData, 16,1);
   END

  -- no delete
  IF @dcount = 1 and @icount = 0 
   BEGIN
    SET @TextData = 'Cannot remove the [SQLCfg].[tSQLCfg] configuration';
    RAISERROR (@TextData, 16,1);
   END

  -- LicenseDate must evaluate to a date
  IF (SELECT ISDATE(CAST([LicenseDate] AS [DATETIME])) FROM inserted) = 0
   BEGIN
    SET @TextData = '[SQLCfg].[tSQLCfg].[LicenseDate] is not a valid date at this locale';
    RAISERROR (@TextData, 16,1);
   END

  SET @Node = 'SQLCfgMetadata|SQLCfg.tSQLCfg';

  -- update
  IF @dcount = 1 and @icount = 1
   BEGIN

    -- add inrow audit info
    UPDATE [SQLCfg].[tSQLCfg]
    SET [RecUpdatedDt] = CURRENT_TIMESTAMP
     , [RecUpdatedUser] = ORIGINAL_LOGIN();

    -- record the update to change
    INSERT [SQLCfg].[tChange]
     ( [Node]  
     , [Version]
     , [Action] 
     , [Definition]
     , [DefinitionDt] )
    SELECT 
       @Node
     , [SQLCfg].[fLastVersion](@Node) + 1
     , 'Modify'
     , 'UPDATE [SQLCfg].[tSQLCfg]
SET [LicensedCompany] = ''' + i.[LicensedCompany] + '''
 , [LicensedUser] = ''' + i.[LicensedUser] + '''
 , [LicenseCode] = ''' + i.[LicenseCode] + '''
 , [LicensedInstanceCount] = ' + CAST(i.[LicensedInstanceCount] AS [VARCHAR] (10)) + '
 , [LicenseDate] = ''' + i.[LicenseDate] + '''
 , [CurrentVersion] = ''' + i.[CurrentVersion] + '''
 , [RecCreatedDt] = ''' + CAST(i.[RecCreatedDt] AS [VARCHAR] (20)) + '''
 , [RecCreatedUser] = ''' + i.[RecCreatedUser] + '''
 , [RecUpdatedDt] = ''' + CAST(i.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
 , [RecUpdatedUser] = ''' + i.[RecUpdatedUser] + '''
WHERE [LicensedCompany] = ''' + d.[LicensedCompany] + '''
AND [LicensedUser] = ''' + d.[LicensedUser] + '''
AND [LicenseCode] = ''' + d.[LicenseCode] + '''
AND [LicensedInstanceCount] = ' + CAST(d.[LicensedInstanceCount] AS [VARCHAR] (10)) + '
AND [LicenseDate] = ''' + d.[LicenseDate] + '''
AND [CurrentVersion] = ''' + d.[CurrentVersion] + '''
AND [RecCreatedDt] = ''' + CAST(d.[RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + d.[RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST(d.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + d.[RecUpdatedUser] + '''
AND ORIGINAL_LOGIN() = ''' + ORIGINAL_LOGIN() + ''''
     , CURRENT_TIMESTAMP
    FROM [inserted] i
    CROSS JOIN [deleted] d;

   END;      

  -- insert
  IF @dcount = 0 and @icount = 1
   BEGIN
    -- log the insert to change
    INSERT [SQLCfg].[tChange]
     ( [Node]  
     , [Version]
     , [Action] 
     , [Definition]
     , [DefinitionDt] )
    SELECT 
       @Node
     , [SQLCfg].[fLastVersion](@Node) + 1
     , 'Include'
     , 'INSERT [SQLCfg].[tSQLCfg]
 ( [LicensedCompany] 
 , [LicensedUser] 
 , [LicenseCode]
 , [LicensedInstanceCount]
 , [LicenseDate] 
 , [CurrentVersion]
 , [RecCreatedDt] 
 , [RecCreatedUser] 
 , [RecUpdatedDt] 
 , [RecUpdatedUser] )
SELECT ''' + i.[LicensedCompany] + '''
 , ''' + i.[LicensedUser] + '''
 , ''' + i.[LicenseCode] + '''
 , ' + CAST(i.[LicensedInstanceCount] AS [VARCHAR] (10)) + '
 , ''' + i.[LicenseDate] + '''
 , ''' + i.[CurrentVersion] + '''
 , ''' + CAST(i.[RecCreatedDt] AS [VARCHAR] (20)) + '''
 , ''' + i.[RecCreatedUser] + '''
 , ''' + CAST(i.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
 , ''' + i.[RecUpdatedUser] + ''''
     , CURRENT_TIMESTAMP
    FROM [inserted] i;

   END;

 END TRY 

 BEGIN CATCH

  EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH 

END;

GO 

IF  OBJECT_ID('[SQLCfg].[trgtInstance_Insert_Update_Delete]','TR') IS NOT NULL
 DROP TRIGGER [SQLCfg].[trgtInstance_Insert_Update_Delete]

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/10/2009     bw                 remove QueryBaseline references 
**              
*******************************************************************************/

CREATE TRIGGER [SQLCfg].[trgtInstance_Insert_Update_Delete]
ON [SQLCfg].[tInstance]
FOR INSERT, UPDATE, DELETE
AS
BEGIN

 DECLARE @NodeBase [NVARCHAR](50) 
  , @TextData [VARCHAR] (2048);

 SET NOCOUNT ON;

 BEGIN TRY

  SET @NodeBase = 'SQLCfgMetadata|SQLCfg.tInstance|';

  -- deletes
  INSERT [SQLCfg].[tChange]
   ( [Node]
   , [Version]
   , [Action] 
   , [Definition]
   , [DefinitionDt] )
  SELECT
     @NodeBase + [Name]
   , [SQLCfg].[fLastVersion](@Nodebase + [Name]) + 1
   , 'Remove'
   , 'DELETE [SQLCfg].[tInstance]
WHERE [Name] = ''' + [Name] + '''
AND [ActiveDirectory] = ' + CAST([ActiveDirectory] AS [CHAR] (1)) + ' 
AND [Audits] = ' + CAST([Audits] AS [CHAR] (1)) + ' 
AND [BackupDevices] = ' + CAST([BackupDevices] AS [CHAR] (1)) + ' 
AND [Configuration] = ' + CAST([Configuration] AS [CHAR] (1)) + ' 
AND [Credentials] = ' + CAST([Credentials] AS [CHAR] (1)) + ' 
AND [CryptographicProviders] = ' + CAST([CryptographicProviders] AS [CHAR] (1)) + ' 
AND [Databases] = ' + CAST([Databases] AS [CHAR] (1)) + ' 
AND [EndPoints] = ' + CAST([EndPoints] AS [CHAR] (1)) + '
AND [FullTextService] = ' + CAST([FullTextService] AS [CHAR] (1)) + '
AND [Information] = ' + CAST([Information] AS [CHAR] (1)) + '
AND [JobServer] = ' + CAST([JobServer] AS [CHAR] (1)) + ' 
AND [Logins] = ' + CAST([Logins] AS [CHAR] (1)) + '
AND [LinkedServers] = ' + CAST([LinkedServers] AS [CHAR] (1)) + '
AND [Mail] = ' + CAST([Mail] AS [CHAR] (1)) + ' 
AND [ProxyAccount] = ' + CAST([ProxyAccount] AS [CHAR] (1)) + '
AND [ResourceGovernor] = ' + CAST([ResourceGovernor] AS [CHAR] (1)) + '
AND [Roles] = ' + CAST([Roles] AS [CHAR] (1)) + '
AND [ServerAuditSpecifications] = ' + CAST([ServerAuditSpecifications] AS [CHAR] (1)) + '
AND [Settings] = ' + CAST([Settings] AS [CHAR] (1)) + '
AND [Triggers] = ' + CAST([Triggers] AS [CHAR] (1)) + '
AND [UserDefinedMessages] = ' + CAST([UserDefinedMessages] AS [CHAR] (1)) + '
AND [RecCreatedDt] = ''' + CAST([RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + [RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST([RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + [RecUpdatedUser] + ''''
   , CURRENT_TIMESTAMP 
  FROM [deleted] 
  WHERE Name NOT IN (SELECT Name FROM [inserted]);
  
  -- disable any schedules that belong to a deleted instance
  Update s
  SET [IsActive] = 0
  FROM [SQLCfg].[tSchedule] s
  JOIN [deleted] d
  on s.[InstanceName] = d.[Name]
  WHERE Name NOT IN (SELECT Name from [inserted]);
    
  -- updates
  --- add audit info
  UPDATE s
  SET [RecUpdatedDt] = CURRENT_TIMESTAMP
   , [RecUpdatedUser] = ORIGINAL_LOGIN()
  FROM [SQLCfg].[tInstance] s
  JOIN [inserted] i 
  ON s.[Name] = i.[Name]
  JOIN [deleted] d
  ON i.[Name] = d.[Name];

  -- record the change
  INSERT [SQLCfg].[tChange]
   ( [Node]
   , [Version]
   , [Action] 
   , [Definition]
   , [DefinitionDt] )
  SELECT
     @NodeBase + i.[Name]
   , [SQLCfg].[fLastVersion](@Nodebase + i.[Name]) + 1
   , 'Modify'
   , 'UPDATE [SQLCfg].[tInstance]
SET [Name] = ''' + i.[Name] + '''
 , [ActiveDirectory] = ' + CAST(i.[ActiveDirectory] AS [CHAR] (1)) + ' 
 , [Audits] = ' + CAST(i.[Audits] AS [CHAR] (1)) + ' 
 , [BackupDevices] = ' + CAST(i.[BackupDevices] AS [CHAR] (1)) + ' 
 , [Configuration] = ' + CAST(i.[Configuration] AS [CHAR] (1)) + ' 
 , [Credentials] = ' + CAST(i.[Credentials] AS [CHAR] (1)) + ' 
 , [CryptographicProviders] = ' + CAST(i.[CryptographicProviders] AS [CHAR] (1)) + ' 
 , [Databases] = ' + CAST(i.[Databases] AS [CHAR] (1)) + ' 
 , [EndPoints] = ' + CAST(i.[EndPoints] AS [CHAR] (1)) + '
 , [FullTextService] = ' + CAST(i.[FullTextService] AS [CHAR] (1)) + '
 , [Information] = ' + CAST(i.[Information] AS [CHAR] (1)) + '
 , [JobServer] = ' + CAST(i.[JobServer] AS [CHAR] (1)) + ' 
 , [Logins] = ' + CAST(i.[Logins] AS [CHAR] (1)) + '
 , [LinkedServers] = ' + CAST(i.[LinkedServers] AS [CHAR] (1)) + '
 , [Mail] = ' + CAST(i.[Mail] AS [CHAR] (1)) + ' 
 , [ProxyAccount] = ' + CAST(i.[ProxyAccount] AS [CHAR] (1)) + '
 , [ResourceGovernor] = ' + CAST(i.[ResourceGovernor] AS [CHAR] (1)) + '
 , [Roles] = ' + CAST(i.[Roles] AS [CHAR] (1)) + '
 , [ServerAuditSpecifications] = ' + CAST(i.[ServerAuditSpecifications] AS [CHAR] (1)) + '
 , [Settings] = ' + CAST(i.[Settings] AS [CHAR] (1)) + '
 , [Triggers] = ' + CAST(i.[Triggers] AS [CHAR] (1)) + '
 , [UserDefinedMessages] = ' + CAST(i.[UserDefinedMessages] AS [CHAR] (1)) + '
 , [RecCreatedDt] = ''' + CAST(i.[RecCreatedDt] AS [VARCHAR] (20)) + '''
 , [RecCreatedUser] = ''' + i.[RecCreatedUser] + '''
 , [RecUpdatedDt] = ''' + CAST(i.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
 , [RecUpdatedUser] = ''' + i.[RecUpdatedUser] + '''
WHERE [Name] = ''' + d.[Name] + '''
AND [ActiveDirectory] = ' + CAST(d.[ActiveDirectory] AS [CHAR] (1)) + ' 
AND [Audits] = ' + CAST(d.[Audits] AS [CHAR] (1)) + ' 
AND [BackupDevices] = ' + CAST(d.[BackupDevices] AS [CHAR] (1)) + ' 
AND [Configuration] = ' + CAST(d.[Configuration] AS [CHAR] (1)) + ' 
AND [Credentials] = ' + CAST(d.[Credentials] AS [CHAR] (1)) + ' 
AND [CryptographicProviders] = ' + CAST(d.[CryptographicProviders] AS [CHAR] (1)) + ' 
AND [Databases] = ' + CAST(d.[Databases] AS [CHAR] (1)) + ' 
AND [EndPoints] = ' + CAST(d.[EndPoints] AS [CHAR] (1)) + '
AND [FullTextService] = ' + CAST(d.[FullTextService] AS [CHAR] (1)) + '
AND [Information] = ' + CAST(d.[Information] AS [CHAR] (1)) + '
AND [JobServer] = ' + CAST(d.[JobServer] AS [CHAR] (1)) + ' 
AND [Logins] = ' + CAST(d.[Logins] AS [CHAR] (1)) + '
AND [LinkedServers] = ' + CAST(d.[LinkedServers] AS [CHAR] (1)) + '
AND [Mail] = ' + CAST(d.[Mail] AS [CHAR] (1)) + ' 
AND [ProxyAccount] = ' + CAST(d.[ProxyAccount] AS [CHAR] (1)) + '
AND [ResourceGovernor] = ' + CAST(d.[ResourceGovernor] AS [CHAR] (1)) + '
AND [Roles] = ' + CAST(d.[Roles] AS [CHAR] (1)) + '
AND [ServerAuditSpecifications] = ' + CAST(d.[ServerAuditSpecifications] AS [CHAR] (1)) + '
AND [Settings] = ' + CAST(d.[Settings] AS [CHAR] (1)) + '
AND [Triggers] = ' + CAST(d.[Triggers] AS [CHAR] (1)) + '
AND [UserDefinedMessages] = ' + CAST(d.[UserDefinedMessages] AS [CHAR] (1)) + '
AND [RecCreatedDt] = ''' + CAST(d.[RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + d.[RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST(d.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + d.[RecUpdatedUser] + ''''
   , CURRENT_TIMESTAMP
  FROM [inserted] i 
  JOIN [deleted] d
  ON i.[Name] = d.[Name];

  -- inserts
  INSERT [SQLCfg].[tChange]
   ( [Node]
   , [Version]
   , [Action] 
   , [Definition]
   , [DefinitionDt] )
  SELECT
     @NodeBase + [Name]
   , [SQLCfg].[fLastVersion](@Nodebase + [Name]) + 1
   , 'Include'
   , 'INSERT [SQLCfg].[tInstance]
 ( [Name]
 , [ActiveDirectory]
 , [Audits]
 , [BackupDevices]
 , [Configuration]
 , [Credentials]
 , [CryptographicProviders]
 , [Databases]
 , [EndPoints]
 , [FullTextService]
 , [Information]
 , [JobServer]
 , [Logins]
 , [LinkedServers]
 , [Mail]
 , [ProxyAccount]
 , [ResourceGovernor]
 , [Roles]
 , [ServerAuditSpecifications]
 , [Settings]
 , [Triggers]
 , [UserDefinedMessages]
 , [RecCreatedDt] 
 , [RecCreatedUser]
 , [RecUpdatedDt]
 , [RecUpdatedUser] )
SELECT [Name] = ''' + [Name] + '''
AND [ActiveDirectory] = ' + CAST([ActiveDirectory] AS [CHAR] (1)) + ' 
AND [Audits] = ' + CAST([Audits] AS [CHAR] (1)) + ' 
AND [BackupDevices] = ' + CAST([BackupDevices] AS [CHAR] (1)) + ' 
AND [Configuration] = ' + CAST([Configuration] AS [CHAR] (1)) + ' 
AND [Credentials] = ' + CAST([Credentials] AS [CHAR] (1)) + ' 
AND [CryptographicProviders] = ' + CAST([CryptographicProviders] AS [CHAR] (1)) + ' 
AND [Databases] = ' + CAST([Databases] AS [CHAR] (1)) + ' 
AND [EndPoints] = ' + CAST([EndPoints] AS [CHAR] (1)) + '
AND [FullTextService] = ' + CAST([FullTextService] AS [CHAR] (1)) + '
AND [Information] = ' + CAST([Information] AS [CHAR] (1)) + '
AND [JobServer] = ' + CAST([JobServer] AS [CHAR] (1)) + ' 
AND [Logins] = ' + CAST([Logins] AS [CHAR] (1)) + '
AND [LinkedServers] = ' + CAST([LinkedServers] AS [CHAR] (1)) + '
AND [Mail] = ' + CAST([Mail] AS [CHAR] (1)) + ' 
AND [ProxyAccount] = ' + CAST([ProxyAccount] AS [CHAR] (1)) + '
AND [ResourceGovernor] = ' + CAST([ResourceGovernor] AS [CHAR] (1)) + '
AND [Roles] = ' + CAST([Roles] AS [CHAR] (1)) + '
AND [ServerAuditSpecifications] = ' + CAST([ServerAuditSpecifications] AS [CHAR] (1)) + '
AND [Settings] = ' + CAST([Settings] AS [CHAR] (1)) + '
AND [Triggers] = ' + CAST([Triggers] AS [CHAR] (1)) + '
AND [UserDefinedMessages] = ' + CAST([UserDefinedMessages] AS [CHAR] (1)) + '
AND [RecCreatedDt] = ''' + CAST([RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + [RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST([RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + [RecUpdatedUser] + ''''
   , CURRENT_TIMESTAMP
  FROM [inserted] 
  WHERE [Name] NOT IN (SELECT [Name] FROM [deleted]);

 END TRY

 BEGIN CATCH

  EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH 

END;

GO 

IF  OBJECT_ID('[SQLCfg].[trgtJobServer_Insert_Update_Delete]','TR') IS NOT NULL
 DROP TRIGGER [SQLCfg].[trgtJobServer_Insert_Update_Delete];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE TRIGGER [SQLCfg].[trgtJobServer_Insert_Update_Delete]
ON [SQLCfg].[tJobServer]
FOR INSERT, UPDATE, DELETE
AS
BEGIN

 DECLARE @NodeBase [NVARCHAR](50) 
  , @TextData [VARCHAR] (2048);

 SET NOCOUNT ON;

 BEGIN TRY

  SET @NodeBase = 'SQLCfgMetadata|SQLCfg.tJobServer|';

  -- deletes
  INSERT [SQLCfg].[tChange]
   ( [Node]
   , [Version]
   , [Action] 
   , [Definition]
   , [DefinitionDt] )
  SELECT
     @NodeBase + [InstanceName]
   , [SQLCfg].[fLastVersion](@Nodebase + [InstanceName]) + 1
   , 'Remove'
   , 'DELETE [SQLCfg].[tJobServer]
WHERE [InstanceName] = ''' + [InstanceName] + '''
AND [Alerts] = ' + CAST([Alerts] AS [CHAR] (1)) + ' 
AND [AlertSystem] = ' + CAST([AlertSystem] AS [CHAR] (1)) + ' 
AND [Jobs] = ' + CAST([Jobs] AS [CHAR] (1)) + ' 
AND [Operators] = ' + CAST([Operators] AS [CHAR] (1)) + ' 
AND [ProxyAccounts] = ' + CAST([ProxyAccounts] AS [CHAR] (1)) + ' 
AND [TargetServers] = ' + CAST([TargetServers] AS [CHAR] (1)) + '
AND [RecCreatedDt] = ''' + CAST([RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + [RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST([RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + [RecUpdatedUser] + ''''
   , CURRENT_TIMESTAMP
  FROM [deleted] 
  WHERE [InstanceName] NOT IN (SELECT [InstanceName] FROM [inserted]);

  -- updates
  --- add audit info
  UPDATE s
  SET [RecUpdatedDt] = CURRENT_TIMESTAMP
   , [RecUpdatedUser] = ORIGINAL_LOGIN()
  FROM [SQLCfg].[tJobServer] s
  JOIN [inserted] i 
  ON s.[InstanceName] = i.[InstanceName]
  JOIN [deleted] d
  ON i.[InstanceName] = d.[InstanceName];

  -- record the change
  INSERT [SQLCfg].[tChange]
   ( [Node]
   , [Version]
   , [Action] 
   , [Definition]
   , [DefinitionDt] )
  SELECT
     @NodeBase + i.[InstanceName]
   , [SQLCfg].[fLastVersion](@Nodebase + i.[InstanceName]) + 1
   , 'Modify'
   , 'UPDATE [SQLCfg].[tJobServer]
SET [InstanceName] = ''' + i.[InstanceName] + '''
 , [Alerts] = ' + CAST(i.[Alerts] AS [CHAR] (1)) + ' 
 , [AlertSystem] = ' + CAST(i.[AlertSystem] AS [CHAR] (1)) + ' 
 , [Jobs] = ' + CAST(i.[Jobs] AS [CHAR] (1)) + ' 
 , [Operators] = ' + CAST(i.[Operators] AS [CHAR] (1)) + ' 
 , [ProxyAccounts] = ' + CAST(i.[ProxyAccounts] AS [CHAR] (1)) + ' 
 , [TargetServers] = ' + CAST(i.[TargetServers] AS [CHAR] (1)) + '
 , [RecCreatedDt] = ''' + CAST(i.[RecCreatedDt] AS [VARCHAR] (20)) + '''
 , [RecCreatedUser] = ''' + i.[RecCreatedUser] + '''
 , [RecUpdatedDt] = ''' + CAST(i.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
 , [RecUpdatedUser] = ''' + i.[RecUpdatedUser] + '''
WHERE [InstanceName] = ''' + d.[InstanceName] + '''
AND [Alerts] = ' + CAST(d.[Alerts] AS [CHAR] (1)) + ' 
AND [AlertSystem] = ' + CAST(d.[AlertSystem] AS [CHAR] (1)) + ' 
AND [Jobs] = ' + CAST(d.[Jobs] AS [CHAR] (1)) + ' 
AND [Operators] = ' + CAST(d.[Operators] AS [CHAR] (1)) + ' 
AND [ProxyAccounts] = ' + CAST(d.[ProxyAccounts] AS [CHAR] (1)) + ' 
AND [TargetServers] = ' + CAST(d.[TargetServers] AS [CHAR] (1)) + '
AND [RecCreatedDt] = ''' + CAST(d.[RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + d.[RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST(d.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + d.[RecUpdatedUser] + ''''
   , CURRENT_TIMESTAMP
  FROM [inserted] i 
  JOIN [deleted] d
  ON i.[InstanceName] = d.[InstanceName];

  -- inserts

  INSERT [SQLCfg].[tChange]
   ( [Node]
   , [Version]
   , [Action] 
   , [Definition]
   , [DefinitionDt] )
  SELECT
     @NodeBase + [InstanceName]
   , [SQLCfg].[fLastVersion](@Nodebase + [InstanceName]) + 1
   , 'Include'
   , 'INSERT [SQLCfg].[tJobServer]
 ( [InstanceName]
 , [Alerts]
 , [AlertSystem]
 , [Jobs]
 , [ProxyAccounts]
 , [TargetServers]
 , [RecCreatedDt] 
 , [RecCreatedUser]
 , [RecUpdatedDt]
 , [RecUpdatedUser] )
SELECT [InstanceName] = ''' + [InstanceName] + '''
AND [Alerts] = ' + CAST([Alerts] AS [CHAR] (1)) + ' 
AND [AlertSystem] = ' + CAST([AlertSystem] AS [CHAR] (1)) + ' 
AND [Jobs] = ' + CAST([Jobs] AS [CHAR] (1)) + ' 
AND [Operators] = ' + CAST([Operators] AS [CHAR] (1)) + ' 
AND [ProxyAccounts] = ' + CAST([ProxyAccounts] AS [CHAR] (1)) + ' 
AND [TargetServers] = ' + CAST([TargetServers] AS [CHAR] (1)) + '
AND [RecCreatedDt] = ''' + CAST([RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + [RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST([RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + [RecUpdatedUser] + ''''
   , CURRENT_TIMESTAMP
  FROM [inserted] 
  WHERE [InstanceName] NOT IN (SELECT [InstanceName] FROM [deleted]);

 END TRY 

 BEGIN CATCH

  EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH 

END;

GO 

IF  OBJECT_ID('[SQLCfg].[trgtDb_Insert_Update_Delete]','TR') IS NOT NULL
 DROP TRIGGER [SQLCfg].[trgtDb_Insert_Update_Delete];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE TRIGGER [SQLCfg].[trgtDb_Insert_Update_Delete]
ON [SQLCfg].[tDb]
FOR INSERT, UPDATE, DELETE
AS
BEGIN

 DECLARE @NodeBase [NVARCHAR] (50) 
  , @TextData [VARCHAR] (2048);

 SET NOCOUNT ON;

 BEGIN TRY

  SET @NodeBase =  'SQLCfgMetadata|SQLCfg.tDb|';

  -- deletes
  INSERT [SQLCfg].[tChange]
   ( [Node]  
   , [Version]
   , [Action]
   , [Definition]
   , [DefinitionDt] )
  SELECT 
     @NodeBase + d.[InstanceName] + '|' + d.[Name]
   , [SQLCfg].[fLastVersion](@NodeBase + d.[InstanceName] + '|' + d.[Name]) + 1
   , 'Remove'
   , 'DELETE [SQLCfg].[tDb]
WHERE [Name] = ''' + d.[Name] + '''
AND [InstanceName] = ''' + d.[InstanceName] + ''' 
AND [ActiveDirectory] = ' + CAST(d.[ActiveDirectory] AS [CHAR] (1)) + ' 
AND [ApplicationRoles] = ' + CAST(d.[ApplicationRoles] AS [CHAR] (1)) + ' 
AND [Assemblies] = ' + CAST(d.[Assemblies] AS [CHAR] (1)) + ' 
AND [AsymmetricKeys] = ' + CAST(d.[AsymmetricKeys] AS [CHAR] (1)) + ' 
AND [Certificates] = ' + CAST(d.[Certificates] AS [CHAR] (1)) + '
AND [DatabaseAuditSpecifications] = ' + CAST(d.[DatabaseAuditSpecifications] AS [CHAR] (1)) + ' 
AND [DatabaseOptions] = ' + CAST(d.[DatabaseOptions] AS [CHAR] (1)) + ' 
AND [Defaults] = ' + CAST(d.[Defaults] AS [CHAR] (1)) + '
AND [FullTextCatalogs] = ' + CAST(d.[FullTextCatalogs] AS [CHAR] (1)) + '
AND [FullTextStopLists] = ' + CAST(d.[FullTextStopLists] AS [CHAR] (1)) + '
AND [PartitionFunctions] = ' + CAST(d.[PartitionFunctions] AS [CHAR] (1)) + ' 
AND [PartitionSchemes] = ' + CAST(d.[PartitionSchemes] AS [CHAR] (1)) + '
AND [PlanGuides] = ' + CAST(d.[PlanGuides] AS [CHAR] (1)) + '
AND [Roles] = ' + CAST(d.[Roles] AS [CHAR] (1)) + '
AND [Rules] = ' + CAST(d.[Rules] AS [CHAR] (1)) + '
AND [Schemas] = ' + CAST(d.[Schemas] AS [CHAR] (1)) + '
AND [ServiceBroker] = ' + CAST(d.[ServiceBroker] AS [CHAR] (1)) + '
AND [StoredProcedures] = ' + CAST(d.[StoredProcedures] AS [CHAR] (1)) + '
AND [SymmetricKeys] = ' + CAST(d.[SymmetricKeys] AS [CHAR] (1)) + '
AND [Synonyms] = ' + CAST(d.[Synonyms] AS [CHAR] (1)) + '
AND [Tables] = ' + CAST(d.[Tables] AS [CHAR] (1)) + '
AND [Triggers] = ' + CAST(d.[Triggers] AS [CHAR] (1)) + '
AND [UserDefinedAggregates] = ' + CAST(d.[UserDefinedAggregates] AS [CHAR] (1)) + '
AND [UserDefinedDataTypes] = ' + CAST(d.[UserDefinedDataTypes] AS [CHAR] (1)) + '
AND [UserDefinedFunctions] = ' + CAST(d.[UserDefinedFunctions] AS [CHAR] (1)) + '
AND [UserDefinedTableTypes] = ' + CAST(d.[UserDefinedTableTypes] AS [CHAR] (1)) + '
AND [UserDefinedTypes] = ' + CAST(d.[UserDefinedTypes] AS [CHAR] (1)) + '
AND [Users] = ' + CAST(d.[Users] AS [CHAR] (1)) + '
AND [Views] = ' + CAST(d.[Views] AS [CHAR] (1)) + '
AND [XMLSchemaCollections] = ' + CAST(d.[XMLSchemaCollections] AS [CHAR] (1)) + '
AND [RecCreatedDt] = ''' + CAST(d.[RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + d.[RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST(d.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + d.[RecUpdatedUser] + ''''
   , CURRENT_TIMESTAMP
  FROM [deleted] d
  WHERE NOT EXISTS (SELECT * FROM [inserted]
                    WHERE [Name] = d.[Name]
                    AND [InstanceName] = d.[InstanceName]);

  -- updates
  --- add audit info
  UPDATE db
  SET [RecUpdatedDt] = CURRENT_TIMESTAMP
   , [RecUpdatedUser] = ORIGINAL_LOGIN()
  FROM [SQLCfg].[tDb] db
  JOIN [inserted] i 
  ON db.[Name] = i.[Name]
  AND db.[InstanceName] = i.[InstanceName]
  JOIN [deleted] d
  ON i.[Name] = d.[Name]
  AND i.[InstanceName] = d.[InstanceName];

  -- record the change
  INSERT [SQLCfg].[tChange]
   ( [Node]  
   , [Version]
   , [Action]
   , [Definition]
   , [DefinitionDt] )
  SELECT 
     @NodeBase + i.[InstanceName] + '|' + i.[Name]
   , [SQLCfg].[fLastVersion](@NodeBase + i.[InstanceName] + '|' + i.[Name]) + 1
   , 'Modify'
   , 'UPDATE [SQLCfg].[tDb]
SET [Name] = ''' + i.[Name] + '''
 , [InstanceName] = ''' + i.[InstanceName] + ''' 
 , [ActiveDirectory] = ' + CAST(i.[ActiveDirectory] AS [CHAR] (1)) + ' 
 , [ApplicationRoles] = ' + CAST(i.[ApplicationRoles] AS [CHAR] (1)) + ' 
 , [Assemblies] = ' + CAST(i.[Assemblies] AS [CHAR] (1)) + ' 
 , [AsymmetricKeys] = ' + CAST(i.[AsymmetricKeys] AS [CHAR] (1)) + ' 
 , [Certificates] = ' + CAST(i.[Certificates] AS [CHAR] (1)) + '
 , [DatabaseAuditSpecifications] = ' + CAST(i.[DatabaseAuditSpecifications] AS [CHAR] (1)) + '
 , [DatabaseOptions] = ' + CAST(i.[DatabaseOptions] AS [CHAR] (1)) + '
 , [Defaults] = ' + CAST(i.[Defaults] AS [CHAR] (1)) + '
 , [FullTextCatalogs] = ' + CAST(i.[FullTextCatalogs] AS [CHAR] (1)) + ' 
 , [FullTextStopLists] = ' + CAST(i.[FullTextStopLists] AS [CHAR] (1)) + ' 
 , [PartitionFunctions] = ' + CAST(i.[PartitionFunctions] AS [CHAR] (1)) + '
 , [PartitionSchemes] = ' + CAST(i.[PartitionSchemes] AS [CHAR] (1)) + '
 , [PlanGuides] = ' + CAST(i.[PlanGuides] AS [CHAR] (1)) + '
 , [Roles] = ' + CAST(i.[Roles] AS [CHAR] (1)) + '
 , [Rules] = ' + CAST(i.[Rules] AS [CHAR] (1)) + '
 , [Schemas] = ' + CAST(i.[Schemas] AS [CHAR] (1)) + '
 , [ServiceBroker] = ' + CAST(i.[ServiceBroker] AS [CHAR] (1)) + '
 , [StoredProcedures] = ' + CAST(i.[StoredProcedures] AS [CHAR] (1)) + ' 
 , [SymmetricKeys] = ' + CAST(i.[SymmetricKeys] AS [CHAR] (1)) + ' 
 , [Synonyms] = ' + CAST(i.[Synonyms] AS [CHAR] (1)) + '
 , [Tables] = ' + CAST(i.[Tables] AS [CHAR] (1)) + '
 , [Triggers] = ' + CAST(i.[Triggers] AS [CHAR] (1)) + '
 , [UserDefinedAggregates] = ' + CAST(i.[UserDefinedAggregates] AS [CHAR] (1)) + '
 , [UserDefinedDataTypes] = ' + CAST(i.[UserDefinedDataTypes] AS [CHAR] (1)) + '
 , [UserDefinedFunctions] = ' + CAST(i.[UserDefinedFunctions] AS [CHAR] (1)) + '
 , [UserDefinedTableTypes] = ' + CAST(i.[UserDefinedTableTypes] AS [CHAR] (1)) + '
 , [UserDefinedTypes] = ' + CAST(i.[UserDefinedTypes] AS [CHAR] (1)) + '
 , [Users] = ' + CAST(i.[Users] AS [CHAR] (1)) + '
 , [Views] = ' + CAST(i.[Views] AS [CHAR] (1)) + '
 , [XMLSchemaCollections] = ' + CAST(i.[XMLSchemaCollections] AS [CHAR] (1)) + '
 , [RecCreatedDt] = ''' + CAST(i.[RecCreatedDt] AS [VARCHAR] (20)) + '''
 , [RecCreatedUser] = ''' + i.[RecCreatedUser] + '''
 , [RecUpdatedDt] = ''' + CAST(i.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
 , [RecUpdatedUser] = ''' + i.[RecUpdatedUser] + '''
WHERE [Name] = ''' + d.[Name] + '''
AND [InstanceName] = ''' + d.[InstanceName] + ''' 
AND [ActiveDirectory] = ' + CAST(d.[ActiveDirectory] AS [CHAR] (1)) + ' 
AND [ApplicationRoles] = ' + CAST(d.[ApplicationRoles] AS [CHAR] (1)) + ' 
AND [Assemblies] = ' + CAST(d.[Assemblies] AS [CHAR] (1)) + ' 
AND [AsymmetricKeys] = ' + CAST(d.[AsymmetricKeys] AS [CHAR] (1)) + ' 
AND [Certificates] = ' + CAST(d.[Certificates] AS [CHAR] (1)) + '
AND [DatabaseAuditSpecifications] = ' + CAST(d.[DatabaseAuditSpecifications] AS [CHAR] (1)) + ' 
AND [DatabaseOptions] = ' + CAST(d.[DatabaseOptions] AS [CHAR] (1)) + ' 
AND [Defaults] = ' + CAST(d.[Defaults] AS [CHAR] (1)) + '
AND [FullTextCatalogs] = ' + CAST(d.[FullTextCatalogs] AS [CHAR] (1)) + '
AND [FullTextStopLists] = ' + CAST(d.[FullTextStopLists] AS [CHAR] (1)) + '
AND [PartitionFunctions] = ' + CAST(d.[PartitionFunctions] AS [CHAR] (1)) + ' 
AND [PartitionSchemes] = ' + CAST(d.[PartitionSchemes] AS [CHAR] (1)) + '
AND [PlanGuides] = ' + CAST(d.[PlanGuides] AS [CHAR] (1)) + '
AND [Roles] = ' + CAST(d.[Roles] AS [CHAR] (1)) + '
AND [Rules] = ' + CAST(d.[Rules] AS [CHAR] (1)) + '
AND [Schemas] = ' + CAST(d.[Schemas] AS [CHAR] (1)) + '
AND [ServiceBroker] = ' + CAST(d.[ServiceBroker] AS [CHAR] (1)) + '
AND [StoredProcedures] = ' + CAST(d.[StoredProcedures] AS [CHAR] (1)) + '
AND [SymmetricKeys] = ' + CAST(d.[SymmetricKeys] AS [CHAR] (1)) + '
AND [Synonyms] = ' + CAST(d.[Synonyms] AS [CHAR] (1)) + '
AND [Tables] = ' + CAST(d.[Tables] AS [CHAR] (1)) + '
AND [Triggers] = ' + CAST(d.[Triggers] AS [CHAR] (1)) + '
AND [UserDefinedAggregates] = ' + CAST(d.[UserDefinedAggregates] AS [CHAR] (1)) + '
AND [UserDefinedDataTypes] = ' + CAST(d.[UserDefinedDataTypes] AS [CHAR] (1)) + '
AND [UserDefinedFunctions] = ' + CAST(d.[UserDefinedFunctions] AS [CHAR] (1)) + '
AND [UserDefinedTableTypes] = ' + CAST(d.[UserDefinedTableTypes] AS [CHAR] (1)) + '
AND [UserDefinedTypes] = ' + CAST(d.[UserDefinedTypes] AS [CHAR] (1)) + '
AND [Users] = ' + CAST(d.[Users] AS [CHAR] (1)) + '
AND [Views] = ' + CAST(d.[Views] AS [CHAR] (1)) + '
AND [XMLSchemaCollections] = ' + CAST(d.[XMLSchemaCollections] AS [CHAR] (1)) + '
AND [RecCreatedDt] = ''' + CAST(d.[RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + d.[RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST(d.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + d.[RecUpdatedUser] + ''''
   , CURRENT_TIMESTAMP
  FROM [inserted] i 
  JOIN [deleted] d
  ON i.[Name] = d.[Name]
  AND i.[InstanceName] = d.[InstanceName];

  -- inserts
  INSERT [SQLCfg].[tChange]
   ( [Node]  
   , [Version]
   , [Action]
   , [Definition]
   , [DefinitionDt] )
  SELECT 
     @NodeBase + i.[InstanceName] + '|' + i.[Name]
   , [SQLCfg].[fLastVersion](@NodeBase + i.[InstanceName] + '|' + i.[Name]) + 1
   , 'Include'
   , 'INSERT [SQLCfg].[tDb]
( [Name]
, [InstanceName]
, [ActiveDirectory]
, [ApplicationRoles]
, [Assemblies]
, [AsymmetricKeys]
, [Certificates]
, [DatabaseAuditSpecifications]
, [DatabaseOptions]
, [Defaults]
, [FullTextCatalogs]
, [FullTextStopLists]
, [PartitionFunctions]
, [PartitionSchemes]
, [PlanGuides]
, [Roles]
, [Rules]
, [Schemas]
, [ServiceBroker]
, [StoredProcedures]
, [SymmetricKeys]
, [Synonyms]
, [Tables]
, [Triggers]
, [UserDefinedAggregates]
, [UserDefinedDataTypes]
, [UserDefinedFunctions]
, [UserDefinedTableTypes]
, [UserDefinedTypes]
, [Users]
, [Views]
, [XMLSchemaCollections]
, [RecCreatedDt] 
, [RecCreatedUser]
, [RecUpdatedDt]
, [RecUpdatedUser] )
SELECT [Name] = ''' + i.[Name] + '''
AND [InstanceName] = ''' + i.[InstanceName] + ''' 
AND [ActiveDirectory] = ' + CAST(i.[ActiveDirectory] AS [CHAR] (1)) + ' 
AND [ApplicationRoles] = ' + CAST(i.[ApplicationRoles] AS [CHAR] (1)) + ' 
AND [Assemblies] = ' + CAST(i.[Assemblies] AS [CHAR] (1)) + ' 
AND [AsymmetricKeys] = ' + CAST(i.[AsymmetricKeys] AS [CHAR] (1)) + ' 
AND [Certificates] = ' + CAST(i.[Certificates] AS [CHAR] (1)) + '
AND [DatabaseAuditSpecifications] = ' + CAST(i.[DatabaseAuditSpecifications] AS [CHAR] (1)) + ' 
AND [DatabaseOptions] = ' + CAST(i.[DatabaseOptions] AS [CHAR] (1)) + ' 
AND [Defaults] = ' + CAST(i.[Defaults] AS [CHAR] (1)) + '
AND [FullTextCatalogs] = ' + CAST(i.[FullTextCatalogs] AS [CHAR] (1)) + '
AND [FullTextStopLists] = ' + CAST(i.[FullTextStopLists] AS [CHAR] (1)) + '
AND [PartitionFunctions] = ' + CAST(i.[PartitionFunctions] AS [CHAR] (1)) + ' 
AND [PartitionSchemes] = ' + CAST(i.[PartitionSchemes] AS [CHAR] (1)) + '
AND [PlanGuides] = ' + CAST(i.[PlanGuides] AS [CHAR] (1)) + '
AND [Roles] = ' + CAST(i.[Roles] AS [CHAR] (1)) + '
AND [Rules] = ' + CAST(i.[Rules] AS [CHAR] (1)) + '
AND [Schemas] = ' + CAST(i.[Schemas] AS [CHAR] (1)) + '
AND [ServiceBroker] = ' + CAST(i.[ServiceBroker] AS [CHAR] (1)) + '
AND [StoredProcedures] = ' + CAST(i.[StoredProcedures] AS [CHAR] (1)) + '
AND [SymmetricKeys] = ' + CAST(i.[SymmetricKeys] AS [CHAR] (1)) + '
AND [Synonyms] = ' + CAST(i.[Synonyms] AS [CHAR] (1)) + '
AND [Tables] = ' + CAST(i.[Tables] AS [CHAR] (1)) + '
AND [Triggers] = ' + CAST(i.[Triggers] AS [CHAR] (1)) + '
AND [UserDefinedAggregates] = ' + CAST(i.[UserDefinedAggregates] AS [CHAR] (1)) + '
AND [UserDefinedDataTypes] = ' + CAST(i.[UserDefinedDataTypes] AS [CHAR] (1)) + '
AND [UserDefinedFunctions] = ' + CAST(i.[UserDefinedFunctions] AS [CHAR] (1)) + '
AND [UserDefinedTableTypes] = ' + CAST(i.[UserDefinedTableTypes] AS [CHAR] (1)) + '
AND [UserDefinedTypes] = ' + CAST(i.[UserDefinedTypes] AS [CHAR] (1)) + '
AND [Users] = ' + CAST(i.[Users] AS [CHAR] (1)) + '
AND [Views] = ' + CAST(i.[Views] AS [CHAR] (1)) + '
AND [XMLSchemaCollections] = ' + CAST(i.[XMLSchemaCollections] AS [CHAR] (1)) + '
AND [RecCreatedDt] = ''' + CAST(i.[RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + i.[RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST(i.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + i.[RecUpdatedUser] + ''''
   , CURRENT_TIMESTAMP
  FROM [inserted] i
  WHERE NOT EXISTS (SELECT * FROM [deleted]
                    WHERE [Name] = i.[Name]
                    AND [InstanceName] = i.[InstanceName]);

 END TRY 

 BEGIN CATCH

  EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH 

END;
GO 

IF  OBJECT_ID('[SQLCfg].[trgtServiceBroker_Insert_Update_Delete]','TR') IS NOT NULL
 DROP TRIGGER [SQLCfg].[trgtServiceBroker_Insert_Update_Delete];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE TRIGGER [SQLCfg].[trgtServiceBroker_Insert_Update_Delete]
ON [SQLCfg].[tServiceBroker]
FOR INSERT, UPDATE, DELETE
AS
BEGIN
 DECLARE @icount [INT]
  , @dcount [INT]
  , @ucount [INT]
  , @NodeBase [NVARCHAR] (50) 
  , @TextData [VARCHAR] (2048);   

  SET NOCOUNT ON;

  BEGIN TRY   

  SELECT @icount = COUNT(*) FROM [inserted];
  SELECT @dcount = COUNT(*) FROM [deleted];
  SELECT @ucount = COUNT(*) FROM [SQLCfg].[tSQLCfg];

  -- no multi row ops
  IF @icount > 1 OR @dcount > 1
   BEGIN
    SET @TextData = 'Multi-row [SQLCfg].[tServiceBroker] operations are not permitted';
    RAISERROR (@TextData, 16,1);
   END

   SET @NodeBase =  'SQLCfgMetadata|SQLCfg.tServiceBroker|';

   -- deletes
   INSERT [SQLCfg].[tChange]
    ( [Node]  
    , [Version]
    , [Action]
    , [Definition]
    , [DefinitionDt] )
   SELECT 
      @NodeBase + d.[InstanceName] + '|' + d.[DatabaseName]
    , [SQLCfg].[fLastVersion](@NodeBase + d.[InstanceName] + '|' + d.[DatabaseName]) + 1
    , 'Remove'
    , 'DELETE [SQLCfg].[tServiceBroker]
WHERE [DatabaseName] = ''' + d.[DatabaseName] + '''
AND [InstanceName] = ''' + d.[InstanceName] + '''
AND [MessageTypes] = ' + CAST(d.[MessageTypes] AS [CHAR] (1)) + ' 
AND [Priorities] = ' + CAST(d.[Priorities] AS [CHAR] (1)) + ' 
AND [Queues] = ' + CAST(d.[Queues] AS [CHAR] (1)) + ' 
AND [RemoteServiceBindings] = ' + CAST(d.[RemoteServiceBindings] AS [CHAR] (1)) + ' 
AND [Routes] = ' + CAST(d.[Routes] AS [CHAR] (1)) + ' 
AND [ServiceContracts] = ' + CAST(d.[ServiceContracts] AS [CHAR] (1)) + ' 
AND [Services] = ' + CAST(d.[Services] AS [CHAR] (1)) + '
AND [RecCreatedDt] = ''' + CAST(d.[RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + d.[RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST(d.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + d.[RecUpdatedUser] + ''''
    , CURRENT_TIMESTAMP
   FROM [deleted] d 
   WHERE NOT EXISTS (SELECT * FROM [inserted]
                     WHERE [DatabaseName] = d.[DatabaseName]
                     AND [InstanceName] = d.[InstanceName]);

   -- updates
   --- add audit info
   UPDATE s
   SET [RecUpdatedDt] = CURRENT_TIMESTAMP
    , [RecUpdatedUser] = ORIGINAL_LOGIN()
   FROM [SQLCfg].[tServiceBroker] s
   JOIN [inserted] i 
   ON s.[DatabaseName] = i.[DatabaseName]
   AND s.[InstanceName] = i.[InstanceName]
   JOIN [deleted] d
   ON i.[DatabaseName] = d.[DatabaseName]
   AND i.[InstanceName] = d.[InstanceName];

   -- record the change
   INSERT [SQLCfg].[tChange]
    ( [Node]  
    , [Version]
    , [Action]
    , [Definition]
    , [DefinitionDt] )
   SELECT 
      @NodeBase + i.[InstanceName] + '|' + i.[DatabaseName]
    , [SQLCfg].[fLastVersion](@NodeBase + i.[InstanceName] + '|' + i.[DatabaseName]) + 1
    , 'Modify'
    , 'UPDATE [SQLCfg].[tServiceBroker]
SET [DatabaseName] = ''' + i.[DatabaseName] + '''
 , [InstanceName] = ''' + i.[InstanceName] + '''
 , [MessageTypes] = ' + CAST(i.[MessageTypes] AS [CHAR] (1)) + ' 
 , [Priorities] = ' + CAST(i.[Priorities] AS [CHAR] (1)) + ' 
 , [Queues] = ' + CAST(i.[Queues] AS [CHAR] (1)) + ' 
 , [RemoteServiceBindings] = ' + CAST(i.[RemoteServiceBindings] AS [CHAR] (1)) + ' 
 , [Routes] = ' + CAST(i.[Routes] AS [CHAR] (1)) + ' 
 , [ServiceContracts] = ' + CAST(i.[ServiceContracts] AS [CHAR] (1)) + ' 
 , [Services] = ' + CAST(i.[Services] AS [CHAR] (1)) + '
 , [RecCreatedDt] = ''' + CAST(i.[RecCreatedDt] AS [VARCHAR] (20)) + '''
 , [RecCreatedUser] = ''' + i.[RecCreatedUser] + '''
 , [RecUpdatedDt] = ''' + CAST(i.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
 , [RecUpdatedUser] = ''' + i.[RecUpdatedUser] + '''
WHERE [DatabaseName] = ''' + d.[DatabaseName] + '''
AND [InstanceName] = ''' + d.[InstanceName] + '''
AND [MessageTypes] = ' + CAST(d.[MessageTypes] AS [CHAR] (1)) + ' 
AND [Priorities] = ' + CAST(d.[Priorities] AS [CHAR] (1)) + ' 
AND [Queues] = ' + CAST(d.[Queues] AS [CHAR] (1)) + ' 
AND [RemoteServiceBindings] = ' + CAST(d.[RemoteServiceBindings] AS [CHAR] (1)) + ' 
AND [Routes] = ' + CAST(d.[Routes] AS [CHAR] (1)) + ' 
AND [ServiceContracts] = ' + CAST(d.[ServiceContracts] AS [CHAR] (1)) + ' 
AND [Services] = ' + CAST(d.[Services] AS [CHAR] (1)) + '
AND [RecCreatedDt] = ''' + CAST(d.[RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + d.[RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST(d.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + d.[RecUpdatedUser] + ''''
    , CURRENT_TIMESTAMP
   FROM [inserted] i 
   JOIN [deleted] d
   ON i.[DatabaseName] = d.[DatabaseName]
   AND i.[InstanceName] = d.[InstanceName];

   -- inserts

   INSERT [SQLCfg].[tChange]
    ( [Node]  
    , [Version]
    , [Action]
    , [Definition]
    , [DefinitionDt] )
   SELECT 
      @NodeBase + i.[InstanceName] + '|' + i.[DatabaseName]
    , [SQLCfg].[fLastVersion](@NodeBase + i.[InstanceName] + '|' + i.[DatabaseName]) + 1
    , 'Include'
    , 'INSERT [SQLCfg].[tServiceBroker]
    ( [DatabaseName]
    , [InstanceName]
    , [MessageTypes]
    , [Priorities]
    , [Queues]
    , [RemoteServiceBindings]
    , [Routes]
    , [ServiceContracts]
    , [Services]
    , [RecCreatedDt] 
    , [RecCreatedUser]
    , [RecUpdatedDt]
    , [RecUpdatedUser] )
   SELECT [DatabaseName] = ''' + i.[DatabaseName] + '''
   AND [InstanceName] = ''' + i.[InstanceName] + '''
   AND [MessageTypes] = ' + CAST(i.[MessageTypes] AS [CHAR] (1)) + ' 
   AND [Priorities] = ' + CAST(i.[Priorities] AS [CHAR] (1)) + ' 
   AND [Queues] = ' + CAST(i.[Queues] AS [CHAR] (1)) + ' 
   AND [RemoteServiceBindings] = ' + CAST(i.[RemoteServiceBindings] AS [CHAR] (1)) + ' 
   AND [Routes] = ' + CAST(i.[Routes] AS [CHAR] (1)) + ' 
   AND [ServiceContracts] = ' + CAST(i.[ServiceContracts] AS [CHAR] (1)) + ' 
   AND [Services] = ' + CAST(i.[Services] AS [CHAR] (1)) + '
   AND [RecCreatedDt] = ''' + CAST(i.[RecCreatedDt] AS [VARCHAR] (20)) + '''
   AND [RecCreatedUser] = ''' + i.[RecCreatedUser] + '''
   AND [RecUpdatedDt] = ''' + CAST(i.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
   AND [RecUpdatedUser] = ''' + i.[RecUpdatedUser] + ''''
    , CURRENT_TIMESTAMP
   FROM [inserted] i
   WHERE NOT EXISTS (SELECT * FROM [deleted]
                     WHERE [DatabaseName] = i.[DatabaseName]
                     AND [InstanceName] = i.[InstanceName]);

  END TRY 

  BEGIN CATCH

   EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

  END CATCH 

END;

GO

IF  OBJECT_ID('[SQLCfg].[trgtChange_Insert_Update_Delete]','TR') IS NOT NULL
 DROP TRIGGER [SQLCfg].[trgtChange_Insert_Update_Delete];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    Dec 23,2009    bw                 cascade db delete to all db items
*******************************************************************************/

CREATE TRIGGER [SQLCfg].[trgtChange_Insert_Update_Delete]
ON [SQLCfg].[tChange]
INSTEAD OF INSERT, UPDATE, DELETE
AS
BEGIN
 DECLARE @icount [INT]
  , @dcount [INT]
  , @TextData [VARCHAR] (2048)
  , @ConcatEventData [XML];

 SET NOCOUNT ON;

 BEGIN TRY

  SELECT @icount = COUNT(*) FROM [inserted];
  SELECT @dcount = COUNT(*) FROM [deleted];

  IF (@icount) > 1
  OR (@dcount) > 1
   BEGIN
    SET @TextData = 'Multi-row [SQLCfg].[tChange] operations are not supported. icount=%d; dcount= %d';
    RAISERROR (@TextData, 16,1, @icount, @dcount)
   END;

  IF @icount = 1 AND @dcount = 0
   BEGIN
     -- the application determines if current is duplicate of previous
     -- and also serializes changes
     -- here we just add the definition provided
     INSERT [SQLCfg].[tChange]
      (  [Node]
       , [Version]
       , [Action]
       , [EventData]
       , [Definition]
       , [DefinitionDt] ) 
     SELECT [Node] = ISNULL(i.[Node], 0x0)
       , [Version] = [SQLCfg].[fLastVersion](i.[Node]) + 1 
       , [Action] = i.[Action]
       , [EventData] = i.[EventData]
       , [Defintion] = i.[Definition]
       , [DefinitionDt] = i.[EVENTDATA].value('(/ROOT/EVENT_INSTANCE/PostTime)[1]', 'DATETIME') 
     FROM [inserted] i;     

     -- cascade delete to all items in a db if db is deleted
     IF EXISTS (SELECT * 
                FROM [inserted]
                WHERE [Node].[Collection] = 'Databases'
                AND [Action] = 'Delete') 
       INSERT [SQLCfg].[tChange]
        (  [Node]
         , [Version]
         , [Action]
         , [EventData]
         , [Definition]
         , [DefinitionDt] ) 
       SELECT [Node] = c.[Node]
         , [Version] = c.[Version] + 1 
         , [Action] = i.[Action]
         , [EventData] = ISNULL( i.[EventData]
                               , CAST('<ROOT><EVENT_INSTANCE>Database Dropped</EVENT_INSTANCE></ROOT>' AS XML))
         , [Defintion] = i.[Definition]
         , [DefinitionDt] = i.[EVENTDATA].value('(/ROOT/EVENT_INSTANCE/PostTime)[1]', 'DATETIME') 
       FROM [SQLCfg].[tChange] c
       JOIN [inserted] i
       ON c.[Node].[Database] = i.[Node].Item
       WHERE c.[Node].[Type] = 'SQLInstance' 
       AND c.[Version] = [SQLCfg].[fLastVersion](c.[Node]);     

   END;  

  -- only update allowed is append to EventData when an event based compare does not detect differences 
  IF @icount = 1 and @dcount = 1
   BEGIN
       -- this is a little loose but better than parsing xml
       -- can't compare 
   	   UPDATE c
	   SET [EventData] = i.[EventData]
		, [Action] = i.[Action]
		, [DefinitionDt] = ISNULL(i.[DefinitionDt], CURRENT_TIMESTAMP) 
	   FROM [SQLCfg].[tChange] c
	   JOIN inserted i
	   ON c.[Id] = i.[Id]
	   WHERE i.[EventData] IS NOT NULL
	   AND (   c.[EventData] IS NULL 
			OR (i.[EventData].value('count(/ROOT/EVENT_INSTANCE)', 'INT') > c.[EventData].value('count(/ROOT/EVENT_INSTANCE)', 'INT')
			    AND i.[EventData].value('count(/ROOT/EVENT_INSTANCE/EVENT_TYPE)[1]', 'NVARCHAR(50)') = c.[EventData].value('count(/ROOT/EVENT_INSTANCE/EVENT_TYPE)[1]', 'INT')))
  END 

  -- no delete
  IF @icount = 0 and @dcount > 0  
   BEGIN
    SET @TextData = '[SQLCfg].[tChange] delete operations are not permitted.';
    RAISERROR (@TextData, 16,1);
   END;

 END TRY 

 BEGIN CATCH

  EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH 

END;

GO

IF  OBJECT_ID('[SQLCfg].[trgtConnection_Insert_Update_Delete]','TR') IS NOT NULL
 DROP TRIGGER [SQLCfg].[trgtConnection_Insert_Update_Delete]

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11-5-2009      bw                 no null definition if protocol, login,
**                                      or pwd is null         
*******************************************************************************/

CREATE TRIGGER [SQLCfg].[trgtConnection_Insert_Update_Delete]
ON [SQLCfg].[tConnection]
FOR INSERT, UPDATE, DELETE
AS
BEGIN
 DECLARE @icount [INT]
  , @dcount [INT] 
  , @NodeBase [NVARCHAR](50)
  , @TextData [VARCHAR] (2048)
  , @InstanceName [NVARCHAR] (128);

 SET NOCOUNT ON;

 BEGIN TRY
  SELECT @icount = COUNT(*) FROM [inserted];
  SELECT @dcount = COUNT(*) FROM [deleted];

  -- no multi-row
  IF @icount > 1 OR @dcount > 1
   BEGIN
    SET @TextData = 'Multi-row [SQLCfg].[tConnection] operations are not permitted';
    RAISERROR (@TextData,16,1)
   END

  SET @NodeBase = 'SQLCfgMetadata|SQLCfg.tConnection|';
  SELECT @InstanceName = UPPER([InstanceName]) from deleted

  -- deletes
  IF @icount = 0 AND @dcount = 1
   BEGIN
    IF (SELECT [EncryptedConnection] FROM deleted) = 1
      RAISERROR('Remove encrypted connection configuration on Instance [%s] before deleting the connection''s metadata.', 16, 1, @InstanceName);  
 
    -- There can be no configuration left when the connection is deleted
    -- the approach here will leave a change row for each removed row
    SET ROWCOUNT 1

		WHILE EXISTS (SELECT * FROM [SQLCfg].[tServiceBroker] 
					  WHERE [InstanceName] = @InstanceName) 
		 DELETE [SQLCfg].[tServiceBroker]
		 WHERE [InstanceName] = @InstanceName
		 AND [DatabaseName] = (SELECT MIN([DatabaseName])
							   FROM [SQLCfg].[tServiceBroker]
							   WHERE [InstanceName] = @InstanceName);
	                          

		WHILE EXISTS (SELECT * FROM [SQLCfg].[tDb] 
					  WHERE [InstanceName] = @InstanceName)
		 DELETE [SQLCfg].[tDb] 
		 WHERE [InstanceName] = @InstanceName
		 AND [Name] = (SELECT MIN([Name])
					 FROM [SQLCfg].[tDb]
					 WHERE [InstanceName] = @InstanceName);


		DELETE [SQLCfg].[tJobServer]
		WHERE [InstanceName] = @InstanceName;

		DELETE [SQLCfg].[tInstance]
		WHERE [Name] = @InstanceName;

		-- fkey cascades deletes to tSchedule rows but will violate the 'operate on one row at a time' rule
		WHILE EXISTS (SELECT * FROM [SQLCfg].[tSchedule] 
					  WHERE [InstanceName] = @InstanceName)
		 DELETE [SQLCfg].[tSchedule]
		 WHERE [InstanceName] = @InstanceName
		 AND [Id] = (SELECT MIN([Id])
				   FROM [SQLCfg].[tSchedule]
				   WHERE [InstanceName] = @InstanceName);

    SET ROWCOUNT 1

    INSERT [SQLCfg].[tChange]
     ( [Node]
     , [Version]
     , [Action] 
     , [Definition]
     , [DefinitionDt] )
    SELECT
       @NodeBase + [InstanceName]
     , [SQLCfg].[fLastVersion](@Nodebase + [InstanceName]) + 1
     , 'Remove'
     , 'DELETE [SQLCfg].[tConnection]
WHERE [InstanceName] = ''' + [InstanceName] + '''
AND [EncryptedConnection] = ' + CAST([EncryptedConnection] AS [CHAR] (1)) + ' 
AND [TrustServerCertificate] = ' + CAST([TrustServerCertificate] AS [CHAR] (1)) + ' 
AND [NetworkProtocol] = ''' + ISNULL([NetworkProtocol],'NULL') + ''' 
AND [ConnectionTimeout] = ' + CAST([ConnectionTimeout] AS [CHAR] (10)) + ' 
AND [LoginSecure] = ' + CAST([LoginSecure] AS [CHAR] (1)) + ' 
AND [LoginName] = ''' + ISNULL([LoginName],'NULL') + ''' 
AND [EncryptedPassword] = ' + ISNULL(sys.fn_varbintohexstr([EncryptedPassword]), 'NULL') + '
AND [IsDeleted] = ' + CAST([IsDeleted] AS [CHAR] (1)) + ' 
AND [RecCreatedDt] = ''' + CAST([RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + [RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST([RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + [RecUpdatedUser] + ''''
     , CURRENT_TIMESTAMP
    FROM [deleted] 
    WHERE [InstanceName] NOT IN (SELECT [InstanceName] FROM [inserted]);
   END

  -- updates
  IF @icount = 1 AND @dcount = 1
   BEGIN
    -- if LoginSecure, set login and password to null  
    UPDATE s
    SET [Loginname] = NULL
     , [EncryptedPassword] = NULL 
    FROM [inserted] i
    JOIN [SQLCfg].[tConnection] s
    ON i.[InstanceName] = s.[InstanceName]
    WHERE i.[LoginSecure] = 1 
    AND (   s.[LoginName] IS NOT NULL
         OR s.[EncryptedPassword] IS NOT NULL);

    --- add audit info
    UPDATE c
    SET [RecUpdatedDt] = CURRENT_TIMESTAMP
     , [RecUpdatedUser] = ORIGINAL_LOGIN()
     , [InstanceName] = c.InstanceName 
    FROM [SQLCfg].[tConnection] c
    JOIN [inserted] i 
    ON c.[InstanceName] = i.[InstanceName]
    JOIN [deleted] d
    ON i.[InstanceName] = d.[InstanceName];

    -- record the change
    INSERT [SQLCfg].[tChange]
     ( [Node]
     , [Version]
     , [Action] 
     , [Definition]
     , [DefinitionDt] )
    SELECT
       @NodeBase + i.[InstanceName]
     , [SQLCfg].[fLastVersion](@Nodebase + i.[InstanceName]) + 1
     , 'Modify'
     , 'UPDATE [SQLCfg].[tConnection]
SET [InstanceName] = ''' + i.[InstanceName] + '''
 , [EncryptedConnection] = ' + CAST(i.[EncryptedConnection] AS [CHAR] (1)) + ' 
 , [TrustServerCertificate] = ' + CAST(i.[TrustServerCertificate] AS [CHAR] (1)) + ' 
 , [NetworkProtocol] = ''' + ISNULL(i.[NetworkProtocol],'NULL') + ''' 
 , [ConnectionTimeout] = ' + CAST(i.[ConnectionTimeout] AS [CHAR] (10)) + ' 
 , [LoginSecure] = ' + CAST(i.[LoginSecure] AS [CHAR] (1)) + ' 
 , [LoginName] = ' + ISNULL(i.[LoginName], 'NULL') + ' 
 , [EncryptedPassword] = ' + ISNULL(sys.fn_varbintohexstr(i.[EncryptedPassword]),'NULL') + '
 , [IsDeleted] = ' + CAST(i.[IsDeleted] AS [CHAR] (1)) + ' 
 , [RecCreatedDt] = ''' + CAST(i.[RecCreatedDt] AS [VARCHAR] (20)) + '''
 , [RecCreatedUser] = ''' + i.[RecCreatedUser] + '''
 , [RecUpdatedDt] = ''' + CAST(i.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
 , [RecUpdatedUser] = ''' + i.[RecUpdatedUser] + '''
WHERE [InstanceName] = ''' + d.[InstanceName] + '''
AND [EncryptedConnection] = ' + CAST(d.[EncryptedConnection] AS [CHAR] (1)) + ' 
AND [TrustServerCertificate] = ' + CAST(d.[TrustServerCertificate] AS [CHAR] (1)) + ' 
AND [NetworkProtocol] = ''' + ISNULL(d.[NetworkProtocol],'NULL') + ''' 
AND [ConnectionTimeout] = ' + CAST(d.[ConnectionTimeout] AS [CHAR] (10)) + ' 
AND [LoginSecure] = ' + CAST(d.[LoginSecure] AS [CHAR] (1)) + ' 
AND [LoginName] = ''' + ISNULL(d.[LoginName],'NULL') + ''' 
AND [EncryptedPassword] = ' + ISNULL(sys.fn_varbintohexstr(d.[EncryptedPassword]),'NULL') + ' 
AND [IsDeleted] = ' + CAST(d.[IsDeleted] AS [CHAR] (1)) + ' 
AND [RecCreatedDt] = ''' + CAST(d.[RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + d.[RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST(d.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + d.[RecUpdatedUser] + ''''
     , CURRENT_TIMESTAMP
    FROM [inserted] i 
    JOIN [deleted] d
    ON i.[InstanceName] = d.[InstanceName];
   END

  -- inserts
  IF @icount = 1 AND @dcount = 0
   BEGIN

    UPDATE c
    SET [InstanceName] = c.InstanceName 
    FROM [SQLCfg].[tConnection] c
    JOIN [inserted] i 
    ON c.[InstanceName] = i.[InstanceName];
       
    INSERT [SQLCfg].[tChange]
     ( [Node]
     , [Version]
     , [Action] 
     , [Definition]
     , [DefinitionDt] )
    SELECT
       @NodeBase + [InstanceName]
     , [SQLCfg].[fLastVersion](@Nodebase + [InstanceName]) + 1
     , 'Include'
     , 'INSERT [SQLCfg].[tConnection]
 ( [InstanceName]
 , [EncryptedConnection]
 , [TrustServercertificate]
 , [NetworkProtocol]
 , [ConnectionTimeout]
 , [LoginSecure]
 , [LoginName]
 , [EncryptedPassword]
 , [IsDeleted]  
 , [RecCreatedDt] 
 , [RecCreatedUser]
 , [RecUpdatedDt]
 , [RecUpdatedUser])
SELECT [InstanceName] = ''' + [InstanceName] + '''
AND [EncryptedConnection] = ' + CAST([EncryptedConnection] AS [CHAR] (1)) + ' 
AND [TrustServerCertificate] = ' + CAST([TrustServerCertificate] AS [CHAR] (1)) + ' 
AND [NetworkProtocol] = ''' + ISNULL([NetworkProtocol],'NULL') + ''' 
AND [ConnectionTimeout] = ' + CAST([ConnectionTimeout] AS [CHAR] (10)) + ' 
AND [LoginSecure] = ' + CAST([LoginSecure] AS [CHAR] (1)) + ' 
AND [LoginName] = ''' + ISNULL([LoginName],'NULL') + ''' 
AND [EncryptedPassword] = ' + ISNULL(sys.fn_varbintohexstr([EncryptedPassword]),'NULL') + ' 
AND [IsDeleted] = ' + CAST([IsDeleted] AS [CHAR] (1)) + ' 
AND [RecCreatedDt] = ''' + CAST([RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + [RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST([RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + [RecUpdatedUser] + ''''
     , CURRENT_TIMESTAMP
    FROM [inserted] 
    WHERE [InstanceName] NOT IN (SELECT [InstanceName] FROM [deleted]);
   END

 END TRY

 BEGIN CATCH

   EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH 

END;

GO

IF  OBJECT_ID('[SQLCfg].[trgtSchedule_Insert_Update_Delete]','TR') IS NOT NULL
 DROP TRIGGER [SQLCfg].[trgtSchedule_Insert_Update_Delete];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author      Description of Change
**    11/10/2009     bw          remove QueryBaseline references 
**    Jan 21, 2010   bw          bugfix- stop writing reschueduled to tChange          
**              
*******************************************************************************/

CREATE TRIGGER [SQLCfg].[trgtSchedule_Insert_Update_Delete]
ON [SQLCfg].[tSchedule]
FOR INSERT, UPDATE, Delete
AS
BEGIN
 DECLARE @icount [INT]
  , @dcount [INT] 
  , @NodeBase [NVARCHAR] (50) 
  , @TextData [VARCHAR] (2047)
  , @InstanceName [NVARCHAR] (128);

 SET NOCOUNT ON;

 BEGIN TRY
  SELECT @icount = COUNT(*) FROM [inserted];
  SELECT @dcount = COUNT(*) FROM [deleted];

  SET @NodeBase = 'SQLCfgMetadata|SQLCfg.tSchedule|';

  -- no multi-row
  IF @icount > 1 OR @dcount > 1
   BEGIN
    SET @TextData = 'Multi-row [SQLCfg].[tSchedule] operations are not permitted';
    RAISERROR (@TextData,16,1);
   END

  -- inserts
  IF @icount = 1 AND @dcount = 0
   BEGIN
  
    UPDATE s
    SET [InstanceName] = s.[InstanceName] 
    FROM [SQLCfg].[tSchedule] s
    JOIN [inserted] i 
    ON s.[InstanceName] = i.[InstanceName];

    INSERT [SQLCfg].[tChange]
     ( [Node]
     , [Version]
     , [Action] 
     , [Definition]
     , [DefinitionDt] )
    SELECT
       @NodeBase + [InstanceName] + '|ScheduleId=' + CAST(Id as [VARCHAR] (10))
     , [SQLCfg].[fLastVersion](@NodeBase + [InstanceName] + '|ScheduleId=' + CAST(Id as [VARCHAR] (10))) + 1
     , 'Include'
     , 'INSERT [SQLCfg].[tSchedule]
 ( [InstanceName]
 , [Interval]
 , [IntervalType]
 , [IntervalBaseDt]
 , [UseEventNotifications]
 , [IsActive]
 , [RecCreatedDt] 
 , [RecCreatedUser]
 , [RecUpdatedDt]
 , [RecUpdatedUser] )
SELECT [InstanceName] = ''' + [InstanceName] + '''
AND [Interval] = ' + CAST([Interval] AS [VARCHAR] (10)) + ' 
AND [IntervalType] = ''' + [IntervalType] + ''' 
AND [IntervalBaseDt] = ''' + CAST([IntervalBaseDt] AS [VARCHAR] (20)) + ''' 
AND [UseEventNotifications] = ' + CAST([UseEventNotifications] AS [CHAR] (1)) + ' 
AND [IsActive] = ' + CAST([IsActive] AS [CHAR] (1)) + ' 
AND [RecCreatedDt] = ''' + CAST([RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + [RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST([RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + [RecUpdatedUser] + ''''
     , CURRENT_TIMESTAMP
    FROM [inserted] 
    WHERE [InstanceName] NOT IN (SELECT [InstanceName] FROM [deleted]);
   END

  -- updates
  IF @icount = 1 AND @dcount = 1
   BEGIN    

    UPDATE s
    SET [RecUpdatedDt] = CURRENT_TIMESTAMP
     , [RecUpdatedUser] = ORIGINAL_LOGIN()
     , [InstanceName] = s.[InstanceName]
    FROM [SQLCfg].[tSchedule] s
    JOIN [inserted] i 
    ON s.[Id] = i.[Id]
    JOIN [deleted] d
    ON i.[Id] = d.[Id];
    
    -- if only IntervalBaseDate changes do not write a change record
    If EXISTs ( SELECT * 
                FROM inserted i
                JOIN deleted d
                ON i.[Id] = d.[Id]
                WHERE i.[InstanceName] <> d.[InstanceName]
                OR i.[Interval] <> d.[Interval]
                OR i.[IntervalType] <> d.[IntervalType]
                OR i.[UseEventNotifications] <> d.[UseEventNotifications]
                OR i.[IsActive] <> d.[IsActive])
     BEGIN
      INSERT [SQLCfg].[tChange]
       ( [Node]
       , [Version]
       , [Action] 
       , [Definition]
       , [DefinitionDt] )
      SELECT
         @NodeBase + i.[InstanceName] + '|ScheduleId=' + CAST(i.Id as [VARCHAR] (10))
       , [SQLCfg].[fLastVersion](@NodeBase + i.[InstanceName] + '|ScheduleId=' + CAST(i.Id as [VARCHAR] (10))) + 1
       , 'Modify'
       , 'UPDATE [SQLCfg].[tSchedule]
SET [InstanceName] = ''' + i.[InstanceName] + '''
 , [Interval] = ' + CAST(i.[Interval] AS [VARCHAR] (10)) + ' 
 , [IntervalType] = ''' + i.[IntervalType] + ''' 
 , [IntervalBaseDt] = ''' + CAST(i.[IntervalBaseDt] AS [VARCHAR] (20)) + ''' 
 , [UseEventNotifications] = ' + CAST(i.[UseEventNotifications] AS [CHAR] (1)) + ' 
 , [IsActive] = ' + CAST(i.[IsActive] AS [CHAR] (1)) + ' 
 , [RecCreatedDt] = ''' + CAST(i.[RecCreatedDt] AS [VARCHAR] (20)) + '''
 , [RecCreatedUser] = ''' + i.[RecCreatedUser] + '''
 , [RecUpdatedDt] = ''' + CAST(i.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
 , [RecUpdatedUser] = ''' + i.[RecUpdatedUser] + '''
WHERE [InstanceName] = ''' + d.[InstanceName] + '''
AND [Interval] = ' + CAST(d.[Interval] AS [VARCHAR] (10)) + ' 
AND [IntervalType] = ''' + d.[IntervalType] + ''' 
AND [IntervalBaseDt] = ''' + CAST(d.[IntervalBaseDt] AS [VARCHAR] (20)) + ''' 
AND [UseEventNotifications] = ' + CAST(d.[UseEventNotifications] AS [CHAR] (1)) + ' 
AND [IsActive] = ' + CAST(d.[IsActive] AS [CHAR] (1)) + ' 
AND [RecCreatedDt] = ''' + CAST(d.[RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + d.[RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST(d.[RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + d.[RecUpdatedUser] + ''''
       , CURRENT_TIMESTAMP
      FROM [inserted] i 
      JOIN [deleted] d
      ON i.[InstanceName] = d.[InstanceName];
     END
   END

  -- deletes
  IF @icount = 0 AND @dcount = 1
   BEGIN

    -- active schedule with notifications enabled means there is still
    -- notification metadata deployed to the instance
    SELECT @InstanceName = [InstanceName] FROM [deleted]
    WHERE [UseEventNotifications] = 1
    AND [IsActive] = 1;

    IF @@ROWCOUNT > 0
      RAISERROR ('Remove event notifications configuration on Instance [%s] before deleting the Schedule',16,1, @InstanceName);
  
    INSERT [SQLCfg].[tChange]
     ( [Node]
     , [Version]
     , [Action] 
     , [Definition]
     , [DefinitionDt] )
    SELECT
       @NodeBase + [InstanceName] + '|ScheduleId=' + CAST(Id as [VARCHAR] (10))
     , SQLCfg.[fLastVersion](@NodeBase + [InstanceName] + '|ScheduleId=' + CAST(Id as [VARCHAR] (10))) + 1
     , 'Remove'
     , 'DELETE [SQLCfg].[tSchedule]
WHERE [InstanceName] = ''' + [InstanceName] + '''
AND [Interval] = ' + CAST([Interval] AS [VARCHAR] (10)) + ' 
AND [IntervalType] = ''' + [IntervalType] + ''' 
AND [IntervalBaseDt] = ''' + CAST([IntervalBaseDt] AS [VARCHAR] (20)) + ''' 
AND [UseEventNotifications] = ' + CAST([UseEventNotifications] AS [CHAR] (1)) + ' 
AND [IsActive] = ' + CAST([IsActive] AS [CHAR] (1)) + ' 
AND [RecCreatedDt] = ''' + CAST([RecCreatedDt] AS [VARCHAR] (20)) + '''
AND [RecCreatedUser] = ''' + [RecCreatedUser] + '''
AND [RecUpdatedDt] = ''' + CAST([RecUpdatedDt] AS [VARCHAR] (20)) + '''
AND [RecUpdatedUser] = ''' + [RecUpdatedUser] + ''''
     , CURRENT_TIMESTAMP
    FROM [deleted] 
    WHERE [InstanceName] NOT IN (SELECT [InstanceName] FROM [inserted]);
   
  END

 END TRY

 BEGIN CATCH

  EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH 

END;

GO

IF  OBJECT_ID('[SQLCfg].[trgtServiceSettings_Instead]','TR') IS NOT NULL
 DROP TRIGGER [SQLCfg].[trgtServiceSettings_Instead]

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE TRIGGER [SQLCfg].[trgtServiceSettings_Instead]
ON [SQLCfg].[tServiceSettings]
INSTEAD OF INSERT, UPDATE, DELETE
AS
BEGIN
 DECLARE @TextData [VARCHAR] (2047);

 SET NOCOUNT ON;

 BEGIN TRY
    SET @TextData = 'All [SQLCfg].[tServiceSettings] CRUD operations are unsupported at this time.';
    RAISERROR (@TextData,16,1);
 END TRY

 BEGIN CATCH

  EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH 

END;

GO

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'fLastVersion' )
 DROP FUNCTION [SQLCfg].[fLastVersion];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: get the last inserted version for a specified node 
**
**    Note : changes need to be appliaed to assyRefresh too
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE FUNCTION [SQLCfg].[fLastVersion] 
( @Node  [SQLCfgNode] )
RETURNS [INT]
AS
BEGIN
 DECLARE @LastVersion [INT];
 SET @LastVersion = ISNULL( ( SELECT MAX(ISNULL([Version],0))
                              FROM [SQLCfg].[tChange]
                              WHERE [Node] = @Node), 0);
 RETURN @LastVersion;
END

GO


IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pSQLCfgInsert' )
 DROP PROCEDURE [SQLCfg].[pSQLCfgInsert];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Initialize SQLConfiguration on the local server 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/
CREATE PROCEDURE [SQLCfg].[pSQLCfgInsert] 
 ( @LicensedCompany [NVARCHAR] (128) = NULL
 , @LicensedUser [NVARCHAR] (128) = NULL
 , @LicenseCode [NVARCHAR]  (128) = NULL
 , @LicensedInstanceCount [INT] = NULL
 , @LicenseDate [NVARCHAR] (30) = NULL)
AS
BEGIN
 DECLARE @TextData [NVARCHAR](500);

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

 BEGIN TRY

  IF @LicensedCompany IS NULL 
  OR @LicenseCode IS NULL 
  OR @LicensedInstanceCount IS NULL 
  OR @LicenseDate IS NULL
   -- unlicensed, null date will use today but should never happen
   INSERT [SQLCfg].[tSQLCfg] 
    ( [LicensedUser]
    , [LicenseDate] )
   VALUES 
    ( ISNULL(@LicensedUser, ORIGINAL_LOGIN())
    , ISNULL(@LicenseDate, CAST(CAST(CURRENT_TIMESTAMP AS DATE) AS VARCHAR(30)))); 
  ELSE
   -- licensed
   INSERT [SQLCfg].[tSQLCfg] 
    ( [LicensedCompany]
    , [LicensedUser]
    , [LicenseCode]
    , [LicensedInstanceCount]
    , [LicenseDate] )
   VALUES 
    ( @LicensedCompany 
    , @LicensedUser
    , @LicenseCode
    , @LicensedInstanceCount
    , @LicenseDate); 

 END TRY

 BEGIN CATCH

   SET @TextData = '   @LicensedCompany = ' + ISNULL(CHAR(39) + @LicensedCompany + CHAR(39),'NULL') + CHAR(13) + CHAR(10) 
                 + ' , @LicensedUser = ' + ISNULL(CHAR(39) + @LicensedUser + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                 + ' , @LicenseCode = ' + ISNULL(CHAR(39) + @LicenseCode + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                 + ' , @LicensedInstanceCount = ' + ISNULL(CAST(@LicensedInstanceCount AS [VARCHAR] (10)), 'NULL') + CHAR(13) + CHAR(10)
                 + ' , @LicenseDate' + ISNULL(CHAR(39) + @LicenseDate + CHAR(39), 'NULL'); 
    EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH; 

END

GO

GRANT EXECUTE ON [SQLCfg].[pSQLCfgInsert] TO [SQLCfgServiceRole] AS [dbo]
GO

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pSQLCfgUpdate' )
 DROP PROCEDURE [SQLCfg].[pSQLCfgUpdate];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Change the utiity metadata master record
**       used to update to a licensed instance of the SQLConfiguration utility
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pSQLCfgUpdate] 
 ( @LicensedCompany [NVARCHAR] (128) = NULL
 , @LicensedUser [NVARCHAR] (128) = NULL
 , @LicenseCode [NVARCHAR] (128)= NULL
 , @LicensedInstanceCount [INT] = NULL
 , @LicenseDate [NVARCHAR] (30) = NULL)
AS
BEGIN
 DECLARE @TextData [NVARCHAR](500);

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

 BEGIN TRY

  UPDATE [SQLCfg].[tSQLCfg]
  SET [LicensedCompany] = ISNULL(@LicensedCompany, [LicensedCompany])
   , [LicensedUser] = ISNULL(@LicensedUser, [LicensedUser])
   , [LicenseCode] = ISNULL(@LicenseCode, [LicenseCode])
   , [LicensedInstanceCount] = ISNULL(@LicensedInstanceCount, [LicensedInstanceCount])
   , [LicenseDate] = ISNULL(@LicenseDate, [LicenseDate]);

 END TRY

 BEGIN CATCH

   SET @TextData = '   @LicensedCompany = ' + ISNULL(CHAR(39) + @LicensedCompany + CHAR(39),'NULL') + CHAR(13) + CHAR(10) 
                 + ' , @LicensedUser = ' + ISNULL(CHAR(39) + @LicensedUser + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                 + ' , @LicenseCode = ' + ISNULL(CHAR(39) + @LicenseCode + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                 + ' , @LicensedInstanceCount = ' + ISNULL(CAST(@LicensedInstanceCount AS [VARCHAR] (10)), 'NULL') + CHAR(13) + CHAR(10)
                 + ' , @LicenseDate' + ISNULL(CHAR(39) + @LicenseDate + CHAR(39), 'NULL'); 
    EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH; 

END
GO

GRANT EXECUTE ON [SQLCfg].[pSQLCfgUpdate] TO [SQLCfgServiceRole];

GO

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pSQLCfgSelect' )
 DROP PROCEDURE [SQLCfg].[pSQLCfgSelect];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Fetch the licensing metadata for the SQLConfig instance
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pSQLCfgSelect] 
AS
BEGIN

 SET NOCOUNT ON;

 SELECT [LicensedCompany]
  , [LicensedUser]
  , [LicenseCode]
  , [LicensedInstanceCount]
  , [LicenseDate]
 FROM [SQLCfg].[tSQLCfg];

END

GO

GRANT EXECUTE ON [SQLCfg].[pSQLCfgSelect] TO [SQLCfgServiceRole];

GO
IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pSQLCfgGet' )
 DROP PROCEDURE [SQLCfg].[pSQLCfgGet];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Get the licensing metadata for the SQLConfiguration utility instance. 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pSQLCfgGet] 
 ( @LicensedCompany [NVARCHAR] (128) OUTPUT
 , @LicensedUser [NVARCHAR] (128) OUTPUT
 , @LicenseCode [NVARCHAR] (128) OUTPUT
 , @LicensedInstanceCount [INT] OUTPUT
 , @LicenseDate [NVARCHAR] (30) OUTPUT )
AS
BEGIN

 SET NOCOUNT ON;

 SELECT @LicensedCompany = [LicensedCompany]
  , @LicensedUser = [LicensedUser]
  , @LicenseCode = [LicenseCode]
  , @LicensedInstanceCount = [LicensedInstanceCount]
  , @LicenseDate = [LicenseDate]
 FROM [SQLCfg].[tSQLCfg];

END
GO

GRANT EXECUTE ON [SQLCfg].[pSQLCfgGet] TO [SQLCfgServiceRole];

GO

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pInstanceInsert' )
 DROP PROCEDURE [SQLCfg].[pInstanceInsert];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Add the metadata for an SQL instance
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pInstanceInsert] 
 ( @Name [NVARCHAR] (128) 
  , @ActiveDirectory [BIT] = 1
  , @Audits [BIT] = 1
  , @BackupDevices [BIT] = 1
  , @Configuration [BIT] = 1
  , @Credentials [BIT] = 1
  , @CryptographicProviders [BIT] = 1
  , @Databases [BIT] = 1
  , @EndPoints [BIT] = 1
  , @FullTextService [BIT] = 1
  , @Information [BIT] = 1
  , @JobServer [BIT] = 1
  , @Logins [BIT] = 1
  , @LinkedServers [BIT] = 1
  , @Mail [BIT] = 1
  , @ProxyAccount [BIT] = 1
  , @ResourceGovernor [BIT] = 1
  , @Roles [BIT] = 1
  , @ServerAuditSpecifications [BIT] = 1
  , @Settings [BIT] = 1
  , @Triggers [BIT] = 1
  , @UserDefinedMessages [BIT] = 1 )
AS
BEGIN
 DECLARE @TextData [NVARCHAR](500);

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

 BEGIN TRY

  INSERT [SQLCfg].[tInstance]
   ( [Name]
   , [ActiveDirectory]
   , [Audits]
   , [BackupDevices]
   , [Configuration]
   , [Credentials]
   , [CryptographicProviders]
   , [Databases]
   , [EndPoints]
   , [FullTextService]
   , [Information]
   , [JobServer]
   , [Logins]
   , [LinkedServers]
   , [Mail]
   , [ProxyAccount]
   , [ResourceGovernor]
   , [Roles]
   , [ServerAuditSpecifications] 
   , [Settings]
   , [Triggers]
   , [UserDefinedMessages] ) 
  VALUES 
   ( UPPER(@Name)
   , @ActiveDirectory
   , @Audits
   , @BackupDevices
   , @Configuration
   , @Credentials
   , @CryptographicProviders
   , @Databases
   , @EndPoints
   , @FullTextService
   , @Information
   , @JobServer
   , @Logins
   , @LinkedServers
   , @Mail
   , @ProxyAccount
   , @ResourceGovernor
   , @Roles
   , @ServerAuditSpecifications
   , @Settings
   , @Triggers
   , @UserDefinedMessages ); 

 END TRY

 BEGIN CATCH

  SET @TextData = '   @Name = ' + ISNULL(CHAR(39) + @Name + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @ActiveDirectory = ' + ISNULL(CAST(@ActiveDirectory AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Audits = ' + ISNULL(CAST(@Audits AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @BackupDevices = ' + ISNULL(CAST(@BackupDevices AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Configuration = ' + ISNULL(CAST(@Configuration AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Credentials = ' + ISNULL(CAST(@Credentials AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @CryptographicProviders = ' + ISNULL(CAST(@CryptographicProviders AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Databases = ' + ISNULL(CAST(@Databases AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @EndPoints' + ISNULL(CAST(@EndPoints AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @FullTextService' + ISNULL(CAST(@FullTextService AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Information' + ISNULL(CAST(@Information AS [VARCHAR] (6)) ,'NULL') + CHAR(13) + CHAR(10)
                + ' , @JobServer' + ISNULL(CAST(@JobServer AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Logins' + ISNULL(CAST(@Logins AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @LinkedServers' + ISNULL(CAST(@LinkedServers AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Mail' + ISNULL(CAST(@Mail AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @ProxyAccount' + ISNULL(CAST(@ProxyAccount AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @ResourceGovernor' + ISNULL(CAST(@ResourceGovernor AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Roles' + ISNULL(CAST(@Roles AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @ServerAuditSpecifications' + ISNULL(CAST(@ServerAuditSpecifications AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Settings' + ISNULL(CAST(@Settings AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Triggers' + ISNULL(CAST(@Triggers AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @UserDefinedMessages' + ISNULL(CAST(@UserDefinedMessages AS [VARCHAR] (6)),'NULL');
    EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH; 

END
GO

GRANT EXECUTE ON [SQLCfg].[pInstanceInsert] TO [SQLCfgServiceRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pInstanceUpdate' )
 DROP PROCEDURE [SQLCfg].[pInstanceUpdate];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Update the metadata for an SQL instance 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pInstanceUpdate] 
 ( @Name [NVARCHAR] (128) 
 , @ActiveDirectory [BIT] = NULL
 , @Audits [BIT] = NULL
 , @BackupDevices [BIT] = NULL
 , @Configuration [BIT] = NULL
 , @Credentials [BIT] = NULL
 , @CryptographicProviders [BIT] = NULL
 , @Databases [BIT] = NULL
 , @EndPoints [BIT] = NULL
 , @FullTextService [BIT] = NULL
 , @Information [BIT] = NULL
 , @JobServer [BIT] = NULL
 , @Logins [BIT] = NULL
 , @LinkedServers [BIT] = NULL
 , @Mail [BIT] = NULL
 , @ProxyAccount [BIT] = NULL
 , @ResourceGovernor [BIT] = NULL
 , @Roles [BIT] = NULL
 , @ServerAuditSpecifications [BIT] = NULL
 , @Settings [BIT] = NULL
 , @Triggers [BIT] = NULL
 , @UserDefinedMessages [BIT] = NULL )
AS
BEGIN
 DECLARE @TextData [NVARCHAR](500);

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

 BEGIN TRY

  UPDATE [SQLCfg].[tInstance]
  SET [ActiveDirectory] = ISNULL(@ActiveDirectory, [ActiveDirectory])
   , [Audits] = ISNULL(@Audits, [Audits])
   , [BackupDevices] = ISNULL(@BackupDevices, [BackupDevices])
   , [Configuration] = ISNULL(@Configuration, [Configuration])
   , [Credentials] = ISNULL(@Credentials, [Credentials])
   , [CryptographicProviders] = ISNULL(@CryptographicProviders, [CryptographicProviders])
   , [Databases] = ISNULL(@Databases, [Databases])
   , [EndPoints] = ISNULL(@EndPoints, [EndPoints])
   , [FullTextService] = ISNULL(@FullTextService, [FullTextService])
   , [Information] = ISNULL(@Information, [Information])
   , [JobServer] = ISNULL(@JobServer, [JobServer])
   , [Logins] = ISNULL(@Logins, [Logins])
   , [LinkedServers] = ISNULL(@LinkedServers, [LinkedServers])
   , [Mail] = ISNULL(@Mail, [Mail])
   , [ProxyAccount] = ISNULL(@ProxyAccount, [ProxyAccount])
   , [ResourceGovernor] = ISNULL(@ResourceGovernor, [ResourceGovernor])
   , [Roles] = ISNULL(@Roles, [Roles])
   , [ServerAuditSpecifications] = ISNULL(@ServerAuditSpecifications, [ServerAuditSpecifications])
   , [Settings] = ISNULL(@Settings, [Settings])
   , [Triggers] = ISNULL(@Triggers, [Triggers])
   , [UserDefinedMessages] = ISNULL(@UserDefinedMessages, [UserDefinedMessages])
  WHERE [Name] = @Name;

 END TRY

 BEGIN CATCH

  SET @TextData = '   @Name = ' + ISNULL(CHAR(39) + @Name + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @ActiveDirectory = ' + ISNULL(CAST(@ActiveDirectory AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Audits = ' + ISNULL(CAST(@Audits AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @BackupDevices = ' + ISNULL(CAST(@BackupDevices AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Configuration = ' + ISNULL(CAST(@Configuration AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Credentials = ' + ISNULL(CAST(@Credentials AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @CryptographicProviders = ' + ISNULL(CAST(@CryptographicProviders AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Databases = ' + ISNULL(CAST(@Databases AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @EndPoints' + ISNULL(CAST(@EndPoints AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @FullTextService' + ISNULL(CAST(@FullTextService AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Information' + ISNULL(CAST(@Information AS [VARCHAR] (6)) ,'NULL') + CHAR(13) + CHAR(10)
                + ' , @JobServer' + ISNULL(CAST(@JobServer AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Logins' + ISNULL(CAST(@Logins AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @LinkedServers' + ISNULL(CAST(@LinkedServers AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Mail' + ISNULL(CAST(@Mail AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @ProxyAccount' + ISNULL(CAST(@ProxyAccount AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @ResourceGovernor' + ISNULL(CAST(@ResourceGovernor AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Roles' + ISNULL(CAST(@Roles AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @ServerAuditSpecifications' + ISNULL(CAST(@ServerAuditSpecifications AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Settings' + ISNULL(CAST(@Settings AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Triggers' + ISNULL(CAST(@Triggers AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @UserDefinedMessages' + ISNULL(CAST(@UserDefinedMessages AS [VARCHAR] (6)),'NULL');
    EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH; 

END
GO

GRANT EXECUTE ON [SQLCfg].[pInstanceUpdate] TO [SQLCfgServiceRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pInstanceGet' )
 DROP PROCEDURE [SQLCfg].[pInstanceGet];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Fetch the metadata for one SQL instance 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pInstanceGet] 
 ( @Name [NVARCHAR] (128) 
 , @ActiveDirectory [BIT] = 1 OUTPUT
 , @Audits [BIT] = 1 OUTPUT
 , @BackupDevices [BIT] = 1 OUTPUT
 , @Configuration [BIT] = 1 OUTPUT
 , @Credentials [BIT] = 1 OUTPUT
 , @CryprographicProviders [BIT] = 1 OUTPUT
 , @Databases [BIT] = 1 OUTPUT
 , @EndPoints [BIT] = 1 OUTPUT
 , @FullTextService [BIT] = 1 OUTPUT
 , @Information [BIT] = 1 OUTPUT
 , @JobServer [BIT] = 1 OUTPUT
 , @Logins [BIT] = 1 OUTPUT
 , @LinkedServers [BIT] = 1 OUTPUT
 , @Mail [BIT] = 1 OUTPUT
 , @ProxyAccount [BIT] = 1 OUTPUT
 , @ResourceGovernor [BIT] = 1 OUTPUT
 , @Roles [BIT] = 1 OUTPUT
 , @ServerAuditSpecifications [BIT] = 1 OUTPUT
 , @Settings [BIT] = 1 OUTPUT
 , @Triggers [BIT] = 1 OUTPUT
 , @UserDefinedMessages [BIT] = 1 OUTPUT) 
AS
BEGIN

 SET NOCOUNT ON;

  SELECT @ActiveDirectory = [ActiveDirectory]
  , @Audits = [Audits]
  , @BackupDevices = [BackupDevices]
  , @Configuration = [Configuration]
  , @Credentials = [Credentials]
  , @CryprographicProviders = [CryptographicProviders]
  , @Databases = [Databases]
  , @EndPoints = [EndPoints]
  , @FullTextService = [FullTextService]
  , @Information = [Information]
  , @JobServer = [JobServer]
  , @Logins = [Logins]
  , @LinkedServers = [LinkedServers]
  , @Mail = [Mail]
  , @ProxyAccount = [ProxyAccount]
  , @ResourceGovernor = [ResourceGovernor]
  , @Roles = [Roles]
  , @ServerAuditSpecifications = [ServerAuditSpecifications]
  , @Settings = [Settings]
  , @Triggers = [Triggers]
  , @UserDefinedMessages = [UserDefinedMessages]
 FROM [SQLCfg].[tInstance]
 WHERE [Name] = @Name;

END
GO

GRANT EXECUTE ON [SQLCfg].[pInstanceGet] TO [SQLCfgReportingRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pInstanceSelectNameList' )
 DROP PROCEDURE [SQLCfg].[pInstanceSelectNameList];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Fetch the names of all SQL instances 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pInstanceSelectNameList] 
AS
BEGIN

 SET NOCOUNT ON;

  SELECT [Name]
  FROM [SQLCfg].[tInstance];

END
GO

GRANT EXECUTE ON [SQLCfg].[pInstanceSelectNameList] TO [SQLCfgReportingRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pInstanceDelete' )
 DROP PROCEDURE [SQLCfg].[pInstanceDelete];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Remove the metadata for an SQL instance
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pInstanceDelete] 
 ( @Name [NVARCHAR] (128) )
AS
BEGIN
 DECLARE @TextData [NVARCHAR](500);

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

 BEGIN TRY

  DELETE [SQLCfg].[tInstance]
  WHERE [Name] = @Name;

 END TRY

 BEGIN CATCH

  SET @TextData = '   @Name = ' + ISNULL(CHAR(39) + @Name + CHAR(39), 'NULL')
  EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;
 
END CATCH; 

END
GO

GRANT EXECUTE ON [SQLCfg].[pInstanceDelete] TO [SQLCfgServiceRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pInstanceSelectAll' )
 DROP PROCEDURE [SQLCfg].[pInstanceSelectAll];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Fetch the metadata for all SQL Instances 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pInstanceSelectAll] 
AS
BEGIN

 SET NOCOUNT ON;

  SELECT [Name]
  , [ActiveDirectory]
  , [Audits]
  , [BackupDevices]
  , [Configuration]
  , [Credentials]
  , [CryptographicProviders]
  , [Databases]
  , [EndPoints]
  , [FullTextService]
  , [Information]
  , [JobServer]
  , [Logins]
  , [LinkedServers]
  , [Mail]
  , [ProxyAccount]
  , [ResourceGovernor]
  , [Roles]
  , [ServerAuditSpecifications]
  , [Settings]
  , [Triggers]
  , [UserDefinedMessages]
  FROM [SQLCfg].[tInstance];

END
GO

GRANT EXECUTE ON [SQLCfg].[pInstanceSelectAll] TO [SQLCfgReportingRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pJobServerInsert' )
 DROP PROCEDURE [SQLCfg].[pJobServerInsert];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Add the metadata for an SQL instance JobServer 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pJobServerInsert] 
 ( @InstanceName [NVARCHAR] (128)
 , @Alerts [BIT] = 1
 , @AlertSystem [BIT] = 1
 , @Jobs [BIT] = 1
 , @Operators [BIT] = 1 
 , @ProxyAccounts [BIT] = 1 
 , @TargetServers [BIT] = 1 )
AS
BEGIN
 DECLARE @TextData [NVARCHAR](500);

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

 BEGIN TRY

  INSERT [SQLCfg].[tJobServer]
   ( [InstanceName]
   , [Alerts]
   , [AlertSystem]
   , [Jobs]
   , [Operators]
   , [ProxyAccounts]
   , [TargetServers] ) 
  VALUES 
   ( UPPER(@InstanceName) 
   , @Alerts
   , @AlertSystem
   , @Jobs
   , @Operators
   , @ProxyAccounts
   , @TargetServers ); 

 END TRY

 BEGIN CATCH

  SET @TextData = '  @InstanceName = ' + ISNULL(CHAR(39) + @InstanceName + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                +' , @Alerts = ' + ISNULL(CAST(@Alerts AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                +' , @AlertSystem = ' + ISNULL(CAST(@AlertSystem AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                +' , @Jobs = ' + ISNULL(CAST(@Jobs AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                +' , @Operators = ' + ISNULL(CAST(@Operators AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                +' , @ProxyAccounts = ' + ISNULL(CAST(@ProxyAccounts AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                +' , @TargetServers = ' + ISNULL(CAST(@TargetServers AS [VARCHAR] (6)),'NULL');
    EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH; 

END
GO

GRANT EXECUTE ON [SQLCfg].[pJobServerInsert] TO [SQLCfgServiceRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pJobServerUpdate' )
 DROP PROCEDURE [SQLCfg].[pJobServerUpdate];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Update the metadata for an SQL instance JobServer
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pJobServerUpdate] 
 ( @InstanceName [NVARCHAR] (128) 
  , @Alerts [BIT] = NULL
  , @AlertSystem [BIT] = NULL
  , @Jobs [BIT] = NULL
  , @Operators [BIT] = NULL
  , @ProxyAccounts [BIT] = NULL
  , @TargetServers [BIT] = NULL )
AS
BEGIN
 DECLARE @TextData [NVARCHAR](500);

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

 BEGIN TRY

  UPDATE [SQLCfg].[tJobServer]
  SET [Alerts] = ISNULL(@Alerts, [Alerts])
   , [AlertSystem] = ISNULL(@AlertSystem, [AlertSystem])
   , [Jobs] = ISNULL(@Jobs, [Jobs])
   , [Operators] = ISNULL(@Operators, [Operators])
   , [ProxyAccounts] = ISNULL(@ProxyAccounts, [ProxyAccounts])
   , [TargetServers] = ISNULL(@TargetServers, [TargetServers])
  WHERE [InstanceName] = @InstanceName;

 END TRY

 BEGIN CATCH

  SET @TextData = '  @InstanceName = ' + ISNULL(CHAR(39) + @InstanceName + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                +' , @Alerts = ' + ISNULL(CAST(@Alerts AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                +' , @AlertSystem = ' + ISNULL(CAST(@AlertSystem AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                +' , @Jobs = ' + ISNULL(CAST(@Jobs AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                +' , @Operators = ' + ISNULL(CAST(@Operators AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                +' , @ProxyAccounts = ' + ISNULL(CAST(@ProxyAccounts AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                +' , @TargetServers = ' + ISNULL(CAST(@TargetServers AS [VARCHAR] (6)),'NULL');
    EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH; 

END
GO

GRANT EXECUTE ON [SQLCfg].[pJobServerUpdate] TO [SQLCfgServiceRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pJobServerGet' )
 DROP PROCEDURE [SQLCfg].[pJobServerGet];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Fetch the metadata for one SQL instance JobServer
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pJobServerGet] 
 ( @InstanceName [NVARCHAR] (128) 
 , @Alerts [BIT] OUTPUT
 , @AlertSystem [BIT] OUTPUT
 , @Jobs [BIT] OUTPUT
 , @Operators [BIT] OUTPUT
 , @ProxyAccounts [BIT] OUTPUT
 , @TargetServers [BIT] OUTPUT ) 
AS
BEGIN

 SET NOCOUNT ON;

 SELECT @Alerts = [Alerts]
  , @AlertSystem = [AlertSystem]
  , @Jobs = [Jobs]
  , @Operators = [Operators]
  , @ProxyAccounts = [ProxyAccounts]
  , @TargetServers = [TargetServers]
 FROM [SQLCfg].[tJobServer]
 WHERE [InstanceName] = @InstanceName;

END
GO

GRANT EXECUTE ON [SQLCfg].[pJobServerGet] TO [SQLCfgReportingRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pJobServerDelete' )
 DROP PROCEDURE [SQLCfg].[pJobServerDelete];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Remove the metadata for an SQL instance JobServer
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pJobServerDelete] 
 ( @InstanceName [NVARCHAR] (128) )
AS
BEGIN
 DECLARE @TextData [NVARCHAR](500);

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

 BEGIN TRY

  DELETE [SQLCfg].[tJobServer]
  WHERE [InstanceName] = @InstanceName;

 END TRY

 BEGIN CATCH
  
  SET @TextData = '  @InstanceName = ' + ISNULL(CHAR(39) + @InstanceName + CHAR(39),'NULL');
  EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;
 
 END CATCH; 

END
GO

GRANT EXECUTE ON [SQLCfg].[pJobServerDelete] TO [SQLCfgServiceRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pJobServerSelectAll' )
 DROP PROCEDURE [SQLCfg].[pJobServerSelectAll];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Fetch the metadata for all SQL Instance's Jobservers
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pJobServerSelectAll] 
AS
BEGIN

 SET NOCOUNT ON;

 SELECT [InstanceName]
  , [Alerts]
  , [AlertSystem]
  , [Jobs]
  , [Operators]
  , [ProxyAccounts]
  , [TargetServers]
 FROM [SQLCfg].[tJobServer];

END
GO

GRANT EXECUTE ON [SQLCfg].[pJobServerSelectAll] TO [SQLCfgReportingRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pDbInsert' )
 DROP PROCEDURE [SQLCfg].[pDbInsert];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Add the metadata for a database
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pDbInsert] 
 ( @Name [NVARCHAR] (128) 
 , @InstanceName [NVARCHAR] (128) 
 , @ActiveDirectory [BIT] = 1
 , @ApplicationRoles [BIT] = 1
 , @Assemblies [BIT] = 1
 , @AsymmetricKeys [BIT] = 1
 , @Certificates [BIT] = 1
 , @DatabaseAuditSpecifications [BIT] = 1
 , @DatabaseOptions [BIT] = 1
 , @Defaults [BIT] = 1
 , @FullTextCatalogs [BIT] = 1
 , @FullTextStopLists [BIT] = 1
 , @PartitionFunctions [BIT] = 1
 , @PartitionSchemes [BIT] = 1
 , @PlanGuides [BIT] = 1
 , @Roles [BIT] = 1
 , @Rules [BIT] = 1
 , @Schemas [BIT] = 1
 , @ServiceBroker [BIT] = 1
 , @StoredProcedures [BIT] = 1
 , @SymmetricKeys [BIT] = 1
 , @Synonyms [BIT] = 1
 , @Tables [BIT] = 1
 , @Triggers [BIT] = 1
 , @UserDefinedAggregates [BIT] = 1
 , @UserDefinedDataTypes [BIT] = 1
 , @UserDefinedFunctions [BIT] = 1
 , @UserDefinedTableTypes [BIT] = 1
 , @UserDefinedTypes [BIT] = 1
 , @Users [BIT] = 1
 , @Views [BIT] = 1
 , @XMLSchemaCollections [BIT] = 1 )
AS
BEGIN
 DECLARE @TextData [NVARCHAR] (500);

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

 BEGIN TRY

  INSERT [SQLCfg].[tDb]
   ( [Name]
   , [InstanceName]
   , [ActiveDirectory]
   , [ApplicationRoles]
   , [Assemblies]
   , [AsymmetricKeys]
   , [Certificates]
   , [DatabaseAuditSpecifications]
   , [DatabaseOptions]
   , [Defaults]
   , [FullTextCatalogs]
   , [FullTextStopLists]
   , [PartitionFunctions]
   , [PartitionSchemes]
   , [PlanGuides]
   , [Roles]
   , [Rules]
   , [Schemas]
   , [ServiceBroker]
   , [StoredProcedures]
   , [SymmetricKeys]
   , [Synonyms]
   , [Tables]
   , [Triggers]
   , [UserDefinedAggregates]
   , [UserDefinedDataTypes]
   , [UserDefinedFunctions]
   , [UserDefinedTableTypes]
   , [UserDefinedTypes]
   , [Users]
   , [Views]
   , [XMLSchemaCollections] )
  VALUES
   ( @Name
   , UPPER(@InstanceName)
   , @ActiveDirectory
   , @ApplicationRoles
   , @Assemblies
   , @AsymmetricKeys
   , @Certificates
   , @DatabaseAuditSpecifications
   , @DatabaseOptions
   , @Defaults
   , @FullTextCatalogs
   , @FullTextStopLists
   , @PartitionFunctions
   , @PartitionSchemes
   , @PlanGuides
   , @Roles
   , @Rules
   , @Schemas
   , @ServiceBroker
   , @StoredProcedures
   , @SymmetricKeys
   , @Synonyms
   , @Tables
   , @Triggers
   , @UserDefinedAggregates
   , @UserDefinedDataTypes
   , @UserDefinedFunctions
   , @UserDefinedTableTypes
   , @UserDefinedTypes
   , @Users
   , @Views
   , @XMLSchemaCollections );

 END TRY

 BEGIN CATCH

  SET @TextData = '   @Name = ' + ISNULL(CHAR(39) + @Name + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @InstanceName = ' + ISNULL(CHAR(39) + @InstanceName + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @ActiveDirectory = ' + ISNULL(CAST(@ActiveDirectory AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @ApplicationRoles = ' + ISNULL(CAST(@ApplicationRoles AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Assemblies = ' + ISNULL(CAST(@Assemblies AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @AsymmetricKeys = ' + ISNULL(CAST(@AsymmetricKeys AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Certificates = ' + ISNULL(CAST(@Certificates AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @DatabaseAuditSpecifications = ' + ISNULL(CAST(@DatabaseAuditSpecifications AS [VARCHAR] (6)),'NULL')
                + ' , @DatabaseOptions = ' + ISNULL(CAST(@DatabaseOptions AS [VARCHAR] (6)),'NULL')
                + ' , @Defaults = ' + ISNULL(CAST(@Defaults AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @FullTextCatalogs = ' + ISNULL(CAST(@FullTextCatalogs AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @FullTextStopLists = ' + ISNULL(CAST(@FullTextStopLists AS [VARCHAR] (6)),'NULL')
                + ' , @PartitionFunctions = ' + ISNULL(CAST(@PartitionFunctions AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @PartitionSchemes = ' + ISNULL(CAST(@PartitionSchemes AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @PlanGuides = ' + ISNULL(CAST(@PlanGuides AS [VARCHAR] (6)),'NULL')
                + ' , @Roles = ' + ISNULL(CAST(@Roles AS [VARCHAR] (6)),'NULL')
                + ' , @Rules = ' + ISNULL(CAST(@Rules AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(0)
                + ' , @Schemas = ' + ISNULL(CAST(@Schemas AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @ServiceBroker = ' + ISNULL(CAST(@ServiceBroker AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @StoredProcedures = ' + ISNULL(CAST(@StoredProcedures AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @SymmetricKeys = ' + ISNULL(CAST(@SymmetricKeys AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Synonyms = ' + ISNULL(CAST(@Synonyms AS [VARCHAR] (6)),'NULL')
                + ' , @Tables = ' + ISNULL(CAST(@Tables AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Triggers = ' + ISNULL(CAST(@Triggers AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @UserDefinedAggregates = ' + ISNULL(CAST(@UserDefinedAggregates AS [VARCHAR] (6)),'NULL')
                + ' , @UserDefinedDataTypes = ' + ISNULL(CAST(@UserDefinedDataTypes AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(0)
                + ' , @UserDefinedFunctions = ' + ISNULL(CAST(@UserDefinedFunctions AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @UserDefinedTableTypes = ' + ISNULL(CAST(@UserDefinedTableTypes AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @UserDefinedTypes = ' + ISNULL(CAST(@UserDefinedTypes AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Users = ' + ISNULL(CAST(@Users AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Views = ' + ISNULL(CAST(@Views AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @XMLSchemaCollections = ' + ISNULL(CAST(@XMLSchemaCollections AS [VARCHAR] (6)),'NULL');
    EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH; 

END
GO

GRANT EXECUTE ON [SQLCfg].[pDbInsert] TO [SQLCfgServiceRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pDbUpdate' )
 DROP PROCEDURE [SQLCfg].[pDbUpdate];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Modify the metadata for a database
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pDbUpdate] 
 ( @Name [NVARCHAR] (128) 
 , @InstanceName [NVARCHAR] (128) 
 , @ActiveDirectory [BIT] = NULL
 , @ApplicationRoles [BIT] = NULL
 , @Assemblies [BIT] = NULL
 , @AsymmetricKeys [BIT] = NULL
 , @Certificates [BIT] = NULL
 , @DatabaseAuditSpecifications [BIT] = NULL
 , @DatabaseOptions [BIT] = NULL
 , @Defaults [BIT] = NULL
 , @FullTextCatalogs [BIT] = NULL
 , @FullTextStopLists [BIT] = NULL
 , @PartitionFunctions [BIT] = NULL
 , @PartitionSchemes [BIT] = NULL
 , @PlanGuides [BIT] = NULL
 , @Roles [BIT] = NULL
 , @Rules [BIT] = NULL
 , @Schemas [BIT] = NULL
 , @ServiceBroker [BIT] = NULL
 , @StoredProcedures [BIT] = NULL
 , @SymmetricKeys [BIT] = NULL
 , @Synonyms [BIT] = NULL
 , @Tables [BIT] = NULL
 , @Triggers [BIT] = NULL
 , @UserDefinedAggregates [BIT] = NULL
 , @UserDefinedDataTypes [BIT] = NULL
 , @UserDefinedFunctions [BIT] = NULL
 , @UserDefinedTableTypes [BIT] = NULL
 , @UserDefinedTypes [BIT] = NULL
 , @Users [BIT] = NULL
 , @Views [BIT] = NULL
 , @XMLSchemaCollections [BIT] = NULL )
AS
BEGIN
 DECLARE @TextData [NVARCHAR](500);

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

 BEGIN TRY

  UPDATE [SQLCfg].[tDb]
  SET [ActiveDirectory] = ISNULL(@ActiveDirectory, [ActiveDirectory])
   , [ApplicationRoles] = ISNULL(@ApplicationRoles, [ApplicationRoles])
   , [Assemblies] = ISNULL(@Assemblies, [Assemblies])
   , [AsymmetricKeys] = ISNULL(@AsymmetricKeys, [AsymmetricKeys])
   , [Certificates] = ISNULL(@Certificates, [Certificates])
   , [DatabaseAuditSpecifications] = ISNULL(@DatabaseAuditSpecifications, [DatabaseAuditSpecifications])
   , [DatabaseOptions] = ISNULL(@DatabaseOptions, [DatabaseOptions])
   , [Defaults] = ISNULL(@Defaults, [Defaults])
   , [FullTextCatalogs] = ISNULL(@FullTextCatalogs, [FullTextCatalogs])
   , [FullTextStopLists] = ISNULL(@FullTextStopLists, [FullTextStopLists])
   , [PartitionFunctions] = ISNULL(@PartitionFunctions, [PartitionFunctions])
   , [PartitionSchemes] = ISNULL(@PartitionSchemes, [PartitionSchemes])
   , [PlanGuides] = ISNULL(@PlanGuides, [PlanGuides])
   , [Roles] = ISNULL(@Roles, [Roles])
   , [Rules] = ISNULL(@Rules, [Rules])
   , [Schemas] = ISNULL(@Schemas, [Schemas])
   , [ServiceBroker] = ISNULL(@ServiceBroker, [ServiceBroker])
   , [StoredProcedures] = ISNULL(@StoredProcedures, [StoredProcedures])
   , [SymmetricKeys] = ISNULL(@SymmetricKeys, [SymmetricKeys])
   , [Synonyms] = ISNULL(@Synonyms, [Synonyms])
   , [Tables] = ISNULL(@Tables, [Tables])
   , [Triggers] = ISNULL(@Triggers, [Triggers])
   , [UserDefinedAggregates] = ISNULL(@UserDefinedAggregates, [UserDefinedAggregates])
   , [UserDefinedDataTypes] = ISNULL(@UserDefinedDataTypes, [UserDefinedDataTypes])
   , [UserDefinedFunctions] = ISNULL(@UserDefinedFunctions, [UserDefinedFunctions])
   , [UserDefinedTableTypes] = ISNULL(@UserDefinedTableTypes, [UserDefinedTableTypes])
   , [UserDefinedTypes] = ISNULL(@UserDefinedTypes, [UserDefinedTypes])
   , [Users] = ISNULL(@Users, [Users])
   , [Views] = ISNULL(@Views, [Views])
   , [XMLSchemaCollections] = ISNULL(@XMLSchemaCollections, [XMLSchemaCollections])
  WHERE [Name] = @Name
  AND [InstanceName] = @InstanceName;

 END TRY

 BEGIN CATCH

  SET @TextData = '   @Name = ' + ISNULL(CHAR(39) + @Name + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @InstanceName = ' + ISNULL(CHAR(39) + @InstanceName + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @ActiveDirectory = ' + ISNULL(CAST(@ActiveDirectory AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @ApplicationRoles = ' + ISNULL(CAST(@ApplicationRoles AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Assemblies = ' + ISNULL(CAST(@Assemblies AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @AsymmetricKeys = ' + ISNULL(CAST(@AsymmetricKeys AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Certificates = ' + ISNULL(CAST(@Certificates AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @DatabaseAuditSpecifications = ' + ISNULL(CAST(@DatabaseAuditSpecifications AS [VARCHAR] (6)),'NULL')
                + ' , @DatabaseOptions = ' + ISNULL(CAST(@DatabaseOptions AS [VARCHAR] (6)),'NULL')
                + ' , @Defaults = ' + ISNULL(CAST(@Defaults AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @FullTextCatalogs = ' + ISNULL(CAST(@FullTextCatalogs AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @FullTextStopLists = ' + ISNULL(CAST(@FullTextStopLists AS [VARCHAR] (6)),'NULL')
                + ' , @PartitionFunctions = ' + ISNULL(CAST(@PartitionFunctions AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @PartitionSchemes = ' + ISNULL(CAST(@PartitionSchemes AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @PlanGuides = ' + ISNULL(CAST(@PlanGuides AS [VARCHAR] (6)),'NULL')
                + ' , @Roles = ' + ISNULL(CAST(@Roles AS [VARCHAR] (6)),'NULL')
                + ' , @Rules = ' + ISNULL(CAST(@Rules AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(0)
                + ' , @Schemas = ' + ISNULL(CAST(@Schemas AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @ServiceBroker = ' + ISNULL(CAST(@ServiceBroker AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @StoredProcedures = ' + ISNULL(CAST(@StoredProcedures AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @SymmetricKeys = ' + ISNULL(CAST(@SymmetricKeys AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Synonyms = ' + ISNULL(CAST(@Synonyms AS [VARCHAR] (6)),'NULL')
                + ' , @Tables = ' + ISNULL(CAST(@Tables AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Triggers = ' + ISNULL(CAST(@Triggers AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @UserDefinedAggregates = ' + ISNULL(CAST(@UserDefinedAggregates AS [VARCHAR] (6)),'NULL')
                + ' , @UserDefinedDataTypes = ' + ISNULL(CAST(@UserDefinedDataTypes AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(0)
                + ' , @UserDefinedFunctions = ' + ISNULL(CAST(@UserDefinedFunctions AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @UserDefinedTableTypes = ' + ISNULL(CAST(@UserDefinedTableTypes AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @UserDefinedTypes = ' + ISNULL(CAST(@UserDefinedTypes AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Users = ' + ISNULL(CAST(@Users AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Views = ' + ISNULL(CAST(@Views AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @XMLSchemaCollections = ' + ISNULL(CAST(@XMLSchemaCollections AS [VARCHAR] (6)),'NULL');
    EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH; 

END
GO

GRANT EXECUTE ON [SQLCfg].[pDbUpdate] TO [SQLCfgServiceRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pDbDelete' )
 DROP PROCEDURE [SQLCfg].[pDbDelete];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Remove the metadata for a database
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pDbDelete] 
 ( @Name [NVARCHAR] (128)
 , @InstanceName [NVARCHAR] (128) )
AS
BEGIN
 DECLARE @TextData [NVARCHAR](500);

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

 BEGIN TRY

  DELETE [SQLCfg].[tDb]
  WHERE [Name] = @Name
  AND [InstanceName] = @InstanceName; 

 END TRY

 BEGIN CATCH

  SET @TextData = '   @Name = ' + ISNULL(CHAR(39) + @Name + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @InstanceName = ' + ISNULL(CHAR(39) + @InstanceName + CHAR(39),'NULL');
    EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH; 

END
GO

GRANT EXECUTE ON [SQLCfg].[pDbDelete] TO [SQLCfgServiceRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pDbGet' )
 DROP PROCEDURE [SQLCfg].[pDbGet];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Fetch the metadata for a database
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pDbGet] 
 ( @Name [NVARCHAR] (128) 
 , @InstanceName [NVARCHAR] (128) 
 , @ActiveDirectory [BIT] OUTPUT
 , @ApplicationRoles [BIT] OUTPUT
 , @Assemblies [BIT] OUTPUT
 , @AsymmetricKeys [BIT] OUTPUT
 , @Certificates [BIT] OUTPUT
 , @DatabaseAuditSpecfications [BIT] OUTPUT
 , @DatabaseOptions [BIT] OUTPUT
 , @Defaults [BIT] OUTPUT
 , @FullTextCatalogs [BIT] OUTPUT
 , @FullTextStopLists [BIT] OUTPUT
 , @PartitionFunctions [BIT] OUTPUT
 , @PartitionSchemes [BIT] OUTPUT
 , @PlanGuides [BIT] OUTPUT
 , @Roles [BIT] OUTPUT
 , @Rules [BIT] OUTPUT
 , @Schemas [BIT] OUTPUT
 , @ServiceBroker [BIT] OUTPUT
 , @StoredProcedures [BIT] OUTPUT
 , @SymmetricKeys [BIT] OUTPUT
 , @Synonyms [BIT] OUTPUT
 , @Tables [BIT] OUTPUT
 , @Triggers [BIT] OUTPUT
 , @UserDefinedAggregates [BIT] OUTPUT
 , @UserDefinedDataTypes [BIT] OUTPUT
 , @UserDefinedFunctions [BIT] OUTPUT
 , @UserDefinedTableTypes [BIT] OUTPUT
 , @UserDefinedTypes [BIT] OUTPUT
 , @Users [BIT] OUTPUT
 , @Views [BIT] OUTPUT
 , @XMLSchemaCollections [BIT] OUTPUT )
AS
BEGIN

 SET NOCOUNT ON;

 SELECT @ActiveDirectory = [ActiveDirectory]
  , @ApplicationRoles = [ApplicationRoles]
  , @Assemblies = [Assemblies]
  , @AsymmetricKeys = [AsymmetricKeys]
  , @Certificates = [Certificates]
  , @DatabaseAuditSpecfications = [DatabaseAuditSpecifications]
  , @DatabaseOptions = [DatabaseOptions]
  , @Defaults = [Defaults]
  , @FullTextCatalogs = [FullTextCatalogs]
  , @FullTextStopLists = [FullTextStopLists]
  , @PartitionFunctions = [PartitionFunctions]
  , @PartitionSchemes = [PartitionSchemes]
  , @PlanGuides = [PlanGuides]
  , @Roles = [Roles]
  , @Rules = [Rules]
  , @Schemas = [Schemas]
  , @ServiceBroker = [ServiceBroker]
  , @StoredProcedures = [StoredProcedures]
  , @SymmetricKeys = [SymmetricKeys]
  , @Synonyms = [Synonyms]
  , @Tables = [Tables]
  , @Triggers = [Triggers]
  , @UserDefinedAggregates = [UserDefinedAggregates]
  , @UserDefinedDataTypes = [UserDefinedDataTypes]
  , @UserDefinedFunctions = [UserDefinedFunctions]
  , @UserDefinedTableTypes = [UserDefinedTableTypes]
  , @UserDefinedTypes = [UserDefinedTypes]
  , @Users = [Users]
  , @Views = [Views]
  , @XMLSchemaCollections = [XMLSchemaCollections]
 FROM [SQLCfg].[tDb]
 WHERE [Name] = @Name
 AND [InstanceName] = @InstanceName;

END
GO

GRANT EXECUTE ON [SQLCfg].[pDbGet] TO [SQLCfgReportingRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pDbSelectAllForInstance' )
 DROP PROCEDURE [SQLCfg].[pDbSelectAllForInstance];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Fetch the metadata for all database on an SQL Instance 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pDbSelectAllForInstance] 
 ( @InstanceName [NVARCHAR] (128) )
AS
BEGIN

 SET NOCOUNT ON;

 SELECT [Name]
  , [InstanceName]
  , [ActiveDirectory]
  , [ApplicationRoles]
  , [Assemblies]
  , [AsymmetricKeys]
  , [Certificates]
  , [DatabaseAuditSpecifications]
  , [DatabaseOptions]
  , [Defaults]
  , [FullTextCatalogs]
  , [FullTextStopLists]
  , [PartitionFunctions]
  , [PartitionSchemes]
  , [PlanGuides]
  , [Roles]
  , [Rules]
  , [Schemas]
  , [ServiceBroker]
  , [StoredProcedures]
  , [SymmetricKeys]
  , [Synonyms]
  , [Tables]
  , [Triggers]
  , [UserDefinedAggregates]
  , [UserDefinedDataTypes]
  , [UserDefinedFunctions]
  , [UserDefinedTableTypes]
  , [UserDefinedTypes]
  , [Users]
  , [Views]
  , [XMLSchemaCollections]
 FROM [SQLCfg].[tDb]
 WHERE [InstanceName] = @InstanceName;

END
GO

GRANT EXECUTE ON [SQLCfg].[pDbSelectAllForInstance] TO [SQLCfgReportingRole];

GO

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pDbSelectAll' )
 DROP PROCEDURE [SQLCfg].[pDbSelectAll];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Fetch the metadata for all databases 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pDbSelectAll] 
AS
BEGIN

 SET NOCOUNT ON;

 SELECT [Name]
  , [InstanceName]
  , [ActiveDirectory]
  , [ApplicationRoles]
  , [Assemblies]
  , [AsymmetricKeys]
  , [Certificates]
  , [DatabaseAuditSpecifications]
  , [DatabaseOptions]
  , [Defaults]
  , [FullTextCatalogs]
  , [FullTextStopLists]
  , [PartitionFunctions]
  , [PartitionSchemes]
  , [PlanGuides]
  , [Roles]
  , [Rules]
  , [Schemas]
  , [ServiceBroker]
  , [StoredProcedures]
  , [SymmetricKeys]
  , [Synonyms]
  , [Tables]
  , [Triggers]
  , [UserDefinedAggregates]
  , [UserDefinedDataTypes]
  , [UserDefinedFunctions]
  , [UserDefinedTableTypes]
  , [UserDefinedTypes]
  , [Users]
  , [Views]
  , [XMLSchemaCollections]
 FROM [SQLCfg].[tDb];

END
GO

GRANT EXECUTE ON [SQLCfg].[pDbSelectAll] TO [SQLCfgReportingRole];

GO

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pServiceBrokerInsert' )
 DROP PROCEDURE [SQLCfg].[pServiceBrokerInsert];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Add the metadata for a database Service Broker 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pServiceBrokerInsert] 
 ( @DatabaseName [NVARCHAR] (128) 
 , @InstanceName [NVARCHAR] (128) 
 , @MessageTypes [BIT] = 1
 , @Priorities [BIT] = 1
 , @Queues [BIT] = 1
 , @RemoteServiceBindings [BIT] = 1
 , @Routes [BIT] = 1
 , @ServiceContracts [BIT] = 1
 , @Services [BIT] = 1 )
AS
BEGIN
 DECLARE @TextData [NVARCHAR](500);

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

 BEGIN TRY

  INSERT [SQLCfg].[tServiceBroker]
   ( [DatabaseName]
   , [InstanceName]
   , [MessageTypes]
   , [Priorities]
   , [Queues]
   , [RemoteServiceBindings]
   , [Routes]
   , [ServiceContracts]
   , [Services] )
  VALUES
   ( @DatabaseName
   , UPPER(@InstanceName)
   , @MessageTypes
   , @Priorities
   , @Queues
   , @RemoteServiceBindings
   , @Routes
   , @ServiceContracts
   , @Services );

 END TRY

 BEGIN CATCH

  SET @TextData = '   @DatabaseName = ' + ISNULL(CHAR(39) + @DatabaseName + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @InstanceName = ' + ISNULL(CHAR(39) + @InstanceName + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @MessageTypes = ' + ISNULL(CAST(@MessageTypes AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Priorities = ' + ISNULL(CAST(@Priorities AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Queues = ' + ISNULL(CAST(@Queues AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @RemoteServiceBindings = ' + ISNULL(CAST(@RemoteServiceBindings AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Routes = ' + ISNULL(CAST(@Routes AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @ServiceContracts = ' + ISNULL(CAST(@ServiceContracts AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Services = ' + ISNULL(CAST(@Services AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10);
  EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;
 
END CATCH; 

END
GO

GRANT EXECUTE ON [SQLCfg].[pServiceBrokerInsert] TO [SQLCfgServiceRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pServiceBrokerUpdate' )
 DROP PROCEDURE [SQLCfg].[pServiceBrokerUpdate];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Modify the metadata for a database Service Broker 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pServiceBrokerUpdate] 
 ( @DatabaseName [NVARCHAR] (128) 
 , @InstanceName [NVARCHAR] (128) 
 , @MessageTypes [BIT] = NULL
 , @Priorities [BIT] = NULL
 , @Queues [BIT] = NULL
 , @RemoteServiceBindings [BIT] = NULL
 , @Routes [BIT] = NULL
 , @ServiceContracts [BIT] = NULL
 , @Services [BIT] = NULL )
AS
BEGIN
 DECLARE @TextData [NVARCHAR](500);

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

 BEGIN TRY

  UPDATE [SQLCfg].[tServiceBroker]
  SET [MessageTypes] = ISNULL(@MessageTypes, [MessageTypes])
   , [Priorities] = ISNULL(@Priorities, [Priorities]) 
   , [Queues] = ISNULL(@Queues, [Queues])
   , [RemoteServiceBindings] = ISNULL(@RemoteServiceBindings, [RemoteServiceBindings])
   , [Routes] = ISNULL(@Routes, [Routes])
   , [ServiceContracts] = ISNULL(@ServiceContracts, [ServiceContracts])
   , [Services] = ISNULL(@Services, [Services])
  WHERE [DatabaseName] = @DatabaseName
  AND [InstanceName] = @InstanceName;

 END TRY

 BEGIN CATCH

  SET @TextData = '   @DatabaseName = ' + ISNULL(CHAR(39) + @DatabaseName + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @InstanceName = ' + ISNULL(CHAR(39) + @InstanceName + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @MessageTypes = ' + ISNULL(CAST(@MessageTypes AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Priorities = ' + ISNULL(CAST(@Priorities AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Queues = ' + ISNULL(CAST(@Queues AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @RemoteServiceBindings = ' + ISNULL(CAST(@RemoteServiceBindings AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Routes = ' + ISNULL(CAST(@Routes AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @ServiceContracts = ' + ISNULL(CAST(@ServiceContracts AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Services = ' + ISNULL(CAST(@Services AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10);
  EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;
 
 END CATCH; 

END
GO

GRANT EXECUTE ON [SQLCfg].[pServiceBrokerUpdate] TO [SQLCfgServiceRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pServiceBrokerDelete' )
 DROP PROCEDURE [SQLCfg].[pServiceBrokerDelete];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Remove the metadata for a database Service Broker 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pServiceBrokerDelete] 
 ( @DatabaseName [NVARCHAR] (128)
 , @InstanceName [NVARCHAR] (128) )
AS
BEGIN
 DECLARE @TextData [NVARCHAR](500);

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

 BEGIN TRY

  DELETE [SQLCfg].[tServiceBroker]
  WHERE [DatabaseName] = @DatabaseName
  AND [InstanceName] = @InstanceName; 

 END TRY

 BEGIN CATCH
  SET @TextData = '   @DatabaseName = ' + ISNULL(CHAR(39) + @DatabaseName + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @InstanceName = ' + ISNULL(CHAR(39) + @InstanceName + CHAR(39),'NULL');
    EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;
 END CATCH; 

END
GO

GRANT EXECUTE ON [SQLCfg].[pServiceBrokerDelete] TO [SQLCfgServiceRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pServiceBrokerGet' )
 DROP PROCEDURE [SQLCfg].[pServiceBrokerGet];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Fetch the metadata for a database Service Broker 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pServiceBrokerGet] 
 ( @DatabaseName [NVARCHAR] (128) 
 , @InstanceName [NVARCHAR] (128) 
 , @MessageTypes [BIT] OUTPUT
 , @Priorities [BIT] OUTPUT
 , @Queues [BIT] OUTPUT
 , @RemoteServiceBindings [BIT] OUTPUT
 , @Routes [BIT] OUTPUT
 , @ServiceContracts [BIT] OUTPUT
 , @Services [BIT] OUTPUT )
AS
BEGIN

 SET NOCOUNT ON;

 SELECT @MessageTypes = [MessageTypes]
  , @Priorities = [Priorities] 
  , @Queues = [Queues]
  , @RemoteServiceBindings = [RemoteServiceBindings]
  , @Routes = [Routes]
  , @ServiceContracts = [ServiceContracts]
  , @Services = [Services]
 FROM [SQLCfg].[tServiceBroker]
 WHERE [DatabaseName] = @DatabaseName
 AND [InstanceName] = @InstanceName;

END
GO

GRANT EXECUTE ON [SQLCfg].[pServiceBrokerGet] TO [SQLCfgReportingRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pServiceBrokerSelectAllForInstance' )
 DROP PROCEDURE [SQLCfg].[pServiceBrokerSelectAllForInstance];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Fetch the metadata for the Service Brokers in all database on an SQL  
**       Instance  
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pServiceBrokerSelectAllForInstance] 
 ( @InstanceName [NVARCHAR] (128) )
AS
BEGIN

 SET NOCOUNT ON;

 SELECT [DatabaseName]
  , [InstanceName]
  , [MessageTypes]
  , [Priorities]
  , [Queues]
  , [RemoteServiceBindings]
  , [Routes]
  , [ServiceContracts]
  , [Services]
 FROM [SQLCfg].[tServiceBroker]
 WHERE [InstanceName] = @InstanceName;

END
GO

GRANT EXECUTE ON [SQLCfg].[pServiceBrokerSelectAllForInstance] TO [SQLCfgReportingRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pServiceBrokerSelectAll' )
 DROP PROCEDURE [SQLCfg].[pServiceBrokerSelectAll];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Fetch the metadata for the Service Brokers in all database on all SQL  
**       Instances
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pServiceBrokerSelectAll] 
AS
BEGIN

 SET NOCOUNT ON;

 SELECT [DatabaseName]
  , [InstanceName]
  , [MessageTypes]
  , [Priorities]
  , [Queues]
  , [RemoteServiceBindings]
  , [Routes]
  , [ServiceContracts]
  , [Services]
 FROM [SQLCfg].[tServiceBroker];

END
GO

GRANT EXECUTE ON [SQLCfg].[pServiceBrokerSelectAll] TO [SQLCfgReportingRole];


GO

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pConnectionInsert' )
 DROP PROCEDURE [SQLCfg].[pConnectionInsert];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Add the connection details for a target SQL instance. 
** Note: LoginName and encrypted password always added by update and requires 
**       symmetric key that is installed by archive planning UI
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/
CREATE PROCEDURE [SQLCfg].[pConnectionInsert] 
 ( @InstanceName [NVARCHAR] (128)
 , @EncryptedConnection [BIT]
 , @TrustServerCertificate [BIT]
 , @NetworkProtocol [NVARCHAR] (128)
 , @ConnectionTimeout [INT]
 , @LoginSecure [BIT] )
AS
BEGIN
 DECLARE @TextData [NVARCHAR](800);

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

 BEGIN TRY

  -- a logical deleted row will break the insert 
  IF EXISTS (SELECT * FROM [SQLCfg].[tConnection]
             WHERE [InstanceName] = @InstanceName
             AND [IsDeleted] = 1)
    UPDATE [SQLCfg].[tConnection]
    SET [EncryptedConnection] = @EncryptedConnection
     , [TrustServerCertificate] = @TrustServerCertificate
     , [NetworkProtocol] = @NetworkProtocol
     , [ConnectionTimeout] = @ConnectionTimeout
     , [LoginSecure] = @LoginSecure
     , [IsDeleted] = 0
    WHERE [InstanceName] = @InstanceName
    AND [IsDeleted] = 1;
   ELSE
    INSERT [SQLCfg].[tConnection]
     ( [InstanceName]
     , [EncryptedConnection]
     , [TrustServerCertificate]
     , [NetworkProtocol]
     , [ConnectionTimeout]
     , [LoginSecure] )
    VALUES 
     ( UPPER(@InstanceName) 
     , @EncryptedConnection
     , @TrustServerCertificate 
     , @NetworkProtocol
     , @ConnectionTimeout
     , @LoginSecure); 

 END TRY

 BEGIN CATCH

  SET @TextData = '   @InstanceName = ' + ISNULL(CHAR(39) + @InstanceName + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @EncryptedConnection = ' + ISNULL(CAST(@EncryptedConnection AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @TrustServerCertificate = ' + ISNULL(CAST(@TrustServerCertificate AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @NetworkProtocol = ' + ISNULL(CAST(@NetworkProtocol AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @ConnectionTimeout = ' + ISNULL(CAST(@ConnectionTimeout AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @LoginSecure = ' + ISNULL(CAST(@LoginSecure AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10);
  EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH; 

END
GO

GRANT EXECUTE ON [SQLCfg].[pConnectionInsert] TO [SQLCfgAdminRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pConnectionUpdate' )
 DROP PROCEDURE [SQLCfg].[pConnectionUpdate];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Optimistic update of the connection details for a target SQL instance.
**  Note: SQL Login and encrypted password always added by isolated update and 
**        requires symmetric key that is installed by archive planning UI
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/
CREATE PROCEDURE [SQLCfg].[pConnectionUpdate] 
 ( @InstanceName [NVARCHAR] (128)
 , @EncryptedConnection [BIT]
 , @TrustServerCertificate [BIT]
 , @NetworkProtocol [NVARCHAR] (128)
 , @ConnectionTimeout [INT]
 , @LoginSecure [BIT] 
 , @Original_InstanceName [NVARCHAR] (128)
 , @Original_EncryptedConnection [BIT]
 , @Original_TrustServerCertificate [BIT]
 , @IsNull_NetworkProtocol [INT]
 , @Original_NetworkProtocol [NVARCHAR] (128)
 , @Original_ConnectionTimeout [INT]
 , @Original_LoginSecure [BIT] )
AS
BEGIN
 DECLARE @TextData [NVARCHAR] (500);

 SET XACT_ABORT ON;
 SET NOCOUNT OFF;

 BEGIN TRY

  UPDATE [SQLCfg].[tConnection]
  SET [EncryptedConnection] = ISNULL(@EncryptedConnection, [EncryptedConnection])
   , [TrustServerCertificate] = ISNULL(@TrustServerCertificate, [TrustServerCertificate])
   , [NetworkProtocol] = ISNULL(@NetworkProtocol, [NetworkProtocol])
   , [ConnectionTimeout] = ISNULL(@ConnectionTimeout, [ConnectionTimeout])
   , [LoginSecure] = ISNULL(@LoginSecure, [LoginSecure])
  WHERE [InstanceName] = @InstanceName 
  AND [EncryptedConnection] = @Original_EncryptedConnection 
  AND [TrustServerCertificate] = @Original_TrustServerCertificate 
  AND (   ( @IsNull_NetworkProtocol = 1 
           AND [NetworkProtocol] IS NULL) 
       OR [NetworkProtocol] = @Original_NetworkProtocol) 
  AND [ConnectionTimeout] = @Original_ConnectionTimeout 
  AND [LoginSecure] = @Original_LoginSecure;

 END TRY

 BEGIN CATCH

  SET @TextData = '   @InstanceName = ' + ISNULL(CHAR(39) + @InstanceName + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @EncryptedConnection = ' + ISNULL(CAST(@EncryptedConnection AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @TrustServerCertificate = ' + ISNULL(CAST(@TrustServerCertificate AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @NetworkProtocol = ' + ISNULL(CAST(@NetworkProtocol AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @ConnectionTimeout = ' + ISNULL(CAST(@ConnectionTimeout AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @LoginSecure = ' + ISNULL(CAST(@LoginSecure AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10);
  EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH

END
GO

GRANT EXECUTE ON [SQLCfg].[pConnectionUpdate] TO [SQLCfgAdminRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pConnectionGet' )
 DROP PROCEDURE [SQLCfg].[pConnectionGet];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Fetch the connection details for a target SQL instance.
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pConnectionGet] 
 ( @InstanceName [NVARCHAR] (128)  
 , @EncryptedConnection [BIT] OUTPUT
 , @TrustServerCertificate [BIT] OUTPUT
 , @NetworkProtocol [NVARCHAR] (128) OUTPUT
 , @ConnectionTimeout [INT] OUTPUT
 , @LoginSecure [BIT] OUTPUT ) 
AS
BEGIN

 SET NOCOUNT ON;

 SELECT @EncryptedConnection = [EncryptedConnection]
  , @TrustServerCertificate = [TrustServerCertificate]
  , @NetworkProtocol = [NetworkProtocol]
  , @ConnectionTimeout = [ConnectionTimeout]
  , @LoginSecure = [LoginSecure]
 FROM [SQLCfg].[tConnection]
 WHERE [InstanceName] = @InstanceName
 AND [IsDeleted] = 0;

END
GO

GRANT EXECUTE ON [SQLCfg].[pConnectionGet] TO [SQLCfgServiceRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pConnectionDelete' )
 DROP PROCEDURE [SQLCfg].[pConnectionDelete];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Remove the connection details for a target SQL instance. 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/
CREATE PROCEDURE [SQLCfg].[pConnectionDelete] 
 ( @InstanceName [NVARCHAR] (128)
  , @EncryptedConnection [BIT] 
  , @TrustServerCertificate [BIT]
  , @IsNull_NetworkProtocol [INT]
  , @NetworkProtocol [NVARCHAR] (128)
  , @ConnectionTimeout [INT]
  , @LoginSecure [BIT] )
AS
BEGIN
 DECLARE @TextData [NVARCHAR](500);

 SET XACT_ABORT ON;
 SET NOCOUNT OFF;

 BEGIN TRY
  -- get rid of the row if it has no children
  -- otherwise will live with a logical delete
  IF NOT EXISTS (SELECT * FROM [SQLCfg].[tInstance]
                 WHERE [Name] = @InstanceName) 
   DELETE FROM [SQLCfg].[tConnection] 
   WHERE [InstanceName] = @InstanceName 
   AND [EncryptedConnection] = @EncryptedConnection 
   AND [TrustServerCertificate] = @TrustServerCertificate 
   AND (   ( @IsNull_NetworkProtocol = 1 
             AND [NetworkProtocol] IS NULL) 
        OR ([NetworkProtocol] = @NetworkProtocol)) 
   AND [ConnectionTimeout] = @ConnectionTimeout 
   AND [LoginSecure] = @LoginSecure;
 ELSE
   UPDATE [SQLCfg].[tConnection]
   SET [IsDeleted] = 1 
   WHERE [InstanceName] = @InstanceName 
   AND [EncryptedConnection] = @EncryptedConnection 
   AND [TrustServerCertificate] = @TrustServerCertificate 
   AND (   ( @IsNull_NetworkProtocol = 1 
             AND [NetworkProtocol] IS NULL) 
        OR ([NetworkProtocol] = @NetworkProtocol)) 
   AND [ConnectionTimeout] = @ConnectionTimeout 
   AND [LoginSecure] = @LoginSecure;

 END TRY

 BEGIN CATCH
  SET @TextData = '   @InstanceName = ' + ISNULL(CHAR(39) + @InstanceName + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @EncryptedConnection = ' + CONVERT(NCHAR(1),@EncryptedConnection) + CHAR(13) + CHAR(10)
                + ' , @TrustServerCertificate = ' + CONVERT(NCHAR(1),@TrustServerCertificate) + CHAR(13) + CHAR(10)
                + ' , @IsNull_NetworkProtocol = ' + CONVERT(NVARCHAR(10),@IsNull_NetworkProtocol) + CHAR(13) + CHAR(10)
                + ' , @NetworkProtocol = ' + ISNULL(CHAR(39) + @NetworkProtocol + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @ConnectionTimeout = ' + CONVERT(NVARCHAR(10),@ConnectionTimeout) + CHAR(13) + CHAR(10)
                + ' , @LoginSecure = ' + CONVERT(NCHAR(1),@LoginSecure);
  EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;
 END CATCH; 

END
GO

GRANT EXECUTE ON [SQLCfg].[pConnectionDelete] TO [SQLCfgAdminRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pConnectionSelectAll' )
 DROP PROCEDURE [SQLCfg].[pConnectionSelectAll];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Fetch connection details for all target SQL instances.
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pConnectionSelectAll] 
AS
BEGIN

 SET NOCOUNT ON;

 SELECT [InstanceName]
  , [EncryptedConnection]
  , [TrustServerCertificate]
  , [NetworkProtocol]
  , [ConnectionTimeout]
  , [LoginSecure]
 FROM [SQLCfg].[tConnection] 
 WHERE [IsDeleted] = 0;

END
GO

GRANT EXECUTE ON [SQLCfg].[pConnectionSelectAll] TO [SQLCfgReportingRole];

GO

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pConnectionGetTargetConnectionString' )
 DROP PROCEDURE [SQLCfg].[pConnectionGetTargetConnectionString];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: return the connection string for a target instance.
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pConnectionGetTargetConnectionString] 
 ( @SQLInstance [NVARCHAR] (128) )
AS
BEGIN

 SET NOCOUNT ON;

 SELECT 'Data Source=' + [InstanceName] + ';' 
  + CASE WHEN [LoginSecure] = 1 
         THEN 'Integrated Security=True;' 
         ELSE 'Integrated Security=False;User ID=' + [LoginName] + ';Password=password;'
         END 
  + CASE WHEN [EncryptedConnection] = 1 then 'Encrypt=True;' ELSE '' END 
  + CASE WHEN [TrustServerCertificate] = 1 THEN 'TrustServerCertificate=True;' ELSE '' END
  + CASE WHEN [NetworkProtocol] <> '' THEN 'Network Library=' + LEFT([NetworkProtocol], 8) + ';' ELSE '' END
 FROM [SQLCfg].[tConnection]
 WHERE [InstanceName] = @SQLInstance

END
GO

GRANT EXECUTE ON [SQLCfg].[pConnectionGetTargetConnectionString] TO [SQLCfgAdminRole];

GO

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pConnectionUserUpdate' )
 DROP PROCEDURE [SQLCfg].[pConnectionUserUpdate];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Add login and encrypt the password for an SQL Authenticated archive 
**       target instance 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pConnectionUserUpdate] 
 ( @InstanceName [NVARCHAR] (128) 
 , @LoginName [NVARCHAR] (128) 
 , @Password [NVARCHAR] (128) )
AS
BEGIN
 DECLARE @TextData [NVARCHAR](500);

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

 BEGIN TRY

  OPEN SYMMETRIC KEY PasswordKey
    DECRYPTION BY CERTIFICATE ArchiveUsers;

  UPDATE [SQLCfg].[tConnection]
  SET LoginName = @LoginName 
   , EncryptedPassword = EncryptByKey(Key_GUID('PasswordKey'), @Password) 
  WHERE [InstanceName] = @InstanceName;

 END TRY

  BEGIN CATCH  

  SET @TextData = '   @InstanceName = ' + ISNULL(CHAR(39) + @InstanceName + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @LoginName = ' + ISNULL(CHAR(39) + @LoginName + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Password = <encrypted>';
  EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH; 

END
GO

GRANT EXECUTE ON [SQLCfg].[pConnectionUserUpdate] TO [SQLCfgAdminRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pConnectionUserGet' )
 DROP PROCEDURE [SQLCfg].[pConnectionUserGet];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Get SQL Login and decrypt the password for an SQL Authenticated 
**       target instance 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pConnectionUserGet] 
 ( @InstanceName [NVARCHAR] (128)
 , @LoginName [NVARCHAR] (128) OUTPUT 
 , @Password [NVARCHAR] (128) OUTPUT )
AS
BEGIN

 OPEN SYMMETRIC KEY PasswordKey
   DECRYPTION BY CERTIFICATE ArchiveUsers;

 SELECT @LoginName = [LoginName] 
  , @Password = ISNULL(CONVERT([NVARCHAR] (128), DECRYPTBYKEY(EncryptedPassword)),'') 
 FROM [SQLCfg].[tConnection]
 WHERE [InstanceName] = @InstanceName;

END
GO

GRANT EXECUTE ON [SQLCfg].[pConnectionUserGet] TO [SQLCfgServiceRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pScheduleInsert' )
 DROP PROCEDURE [SQLCfg].[pScheduleInsert];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Add the archive schedule for an SQL instance. 
** Note: encrypted password always added by update and requires symmetric key
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/10/2009     bw                 remove QueryBaseline references 
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pScheduleInsert] 
 ( @InstanceName [NVARCHAR] (128)
 , @Interval [INT] 
 , @IntervalType [NVARCHAR] (10) 
 , @IntervalBaseDt [DATETIME]
 , @UseEventNotifications [BIT]
 , @IsActive [BIT]
 , @Id [INT] OUTPUT )
AS
BEGIN
 DECLARE @TextData [NVARCHAR](800);

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

 BEGIN TRY

  INSERT [SQLCfg].[tSchedule]
   ( [InstanceName]
   , [Interval]
   , [IntervalType]
   , [IntervalBaseDt]
   , [UseEventNotifications]
   , [IsActive]) 
  VALUES 
   ( UPPER(@InstanceName) 
   , @Interval
   , @IntervalType
   , @IntervalBaseDt
   , @UseEventNotifications
   , @IsActive ); 

 SELECT @Id = SCOPE_IDENTITY();

 END TRY

  BEGIN CATCH
 
  SET @TextData = '   @InstanceName = ' + ISNULL(CHAR(39) + @InstanceName + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Interval = ' + ISNULL(CAST(@Interval AS [VARCHAR] (10)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @IntervalType = ' + ISNULL(CHAR(39) + @IntervalType + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @IntervalBaseDt = ' + ISNULL(CHAR(39) + CAST(@IntervalBaseDt AS VARCHAR(20)) + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @UseEventNotifications = ' + ISNULL(CAST(@UseEventNotifications AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @IsActive = ' + ISNULL(CAST(@IsActive AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Id = ' + ISNULL(CAST(@Id AS [VARCHAR] (10)),'NULL') + ' OUTPUT' + CHAR(13) + CHAR(10);
  EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH; 

END
GO

GRANT EXECUTE ON [SQLCfg].[pScheduleInsert] TO [SQLCfgAdminRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pScheduleUpdate' )
 DROP PROCEDURE [SQLCfg].[pScheduleUpdate];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Update the archive schedule for an SQL instance. 
** Note: encrypted password always added by update and requires symmetric key
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/10/2009     bw                 remove QueryBaseline references 
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pScheduleUpdate] 
 ( @Id [INT]
 , @InstanceName [NVARCHAR] (128) = NULL
 , @Interval [INT] = NULL
 , @IntervalType [NVARCHAR] (10) = NULL
 , @IntervalBaseDt [DATETIME] = NULL
 , @UseEventNotifications [BIT] = NULL 
 , @IsActive [BIT] = NULL )
AS
BEGIN
 DECLARE @TextData [NVARCHAR] (500);

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

 BEGIN TRY

  UPDATE [SQLCfg].[tSchedule]
  SET [InstanceName] = UPPER(ISNULL(@InstanceName, [InstanceName]))
   , [Interval] = ISNULL(@Interval, [Interval])
   , [IntervalType] = ISNULL(@IntervalType, [IntervalType])
   , [IntervalBaseDt] = ISNULL(@IntervalBaseDt, [IntervalBaseDt])
   , [UseEventNotifications] = ISNULL(@UseEventNotifications, [UseEventNotifications])
   , [IsActive] = ISNULL(@IsActive, [IsActive])
  WHERE [Id] = @Id;

 END TRY

 BEGIN CATCH

  SET @TextData = '   @InstanceName = ' + ISNULL(CHAR(39) + @InstanceName + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Interval = ' + ISNULL(CAST(@Interval AS [VARCHAR] (10)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @IntervalType = ' + ISNULL(CHAR(39) + @IntervalType + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @IntervalBaseDt = ' + ISNULL(CHAR(39) + CAST(@IntervalBaseDt AS VARCHAR(20)) + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @UseEventNotifications = ' + ISNULL(CAST(@UseEventNotifications AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @IsActive = ' + ISNULL(CAST(@IsActive AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @Id = ' + ISNULL(CAST(@Id AS [VARCHAR] (10)),'NULL') + ' OUTPUT' + CHAR(13) + CHAR(10);
  EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH

END
GO

GRANT EXECUTE ON [SQLCfg].[pScheduleUpdate] TO [SQLCfgServiceRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pScheduleGet' )
 DROP PROCEDURE [SQLCfg].[pScheduleGet];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Fetch the specified service settings 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/10/2009     bw                 remove QueryBaseline references 
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pScheduleGet] 
 ( @Id [INT]
 , @InstanceName [NVARCHAR] (128) OUTPUT 
 , @Interval [INT] OUTPUT
 , @IntervalType [NVARCHAR] (10) OUTPUT
 , @IntervalBaseDt [DATETIME] OUTPUT
 , @UseEventNotifications [BIT] OUTPUT
 , @IsActive [BIT] OUTPUT ) 
AS
BEGIN

 SET NOCOUNT ON;

 SELECT @InstanceName 
  , @Interval
  , @IntervalType
  , @IntervalBaseDt
  , @UseEventNotifications
  , @IsActive
 FROM [SQLCfg].[tSchedule]
 WHERE [Id] = @Id;

END
GO

GRANT EXECUTE ON [SQLCfg].[pScheduleGet] TO [SQLCfgReportingRole];

GO

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pScheduleGetCountForInstance' )
 DROP PROCEDURE [SQLCfg].[pScheduleGetCountForInstance];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: the number of schedules set up for a SQL Instance 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/10/2009     bw                 remove QueryBaseline references 
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pScheduleGetCountForInstance] 
 ( @InstanceName [NVARCHAR] (128)  
 , @Count [INT] OUTPUT) 
AS
BEGIN

 SET NOCOUNT ON;

 SELECT @Count = Count(*) 
 FROM [SQLCfg].[tSchedule]
 WHERE [InstanceName] = @InstanceName;

END
GO

GRANT EXECUTE ON [SQLCfg].[pScheduleGetCountForInstance] TO [SQLCfgReportingRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pScheduleGetInstanceNameById' )
 DROP PROCEDURE [SQLCfg].pScheduleGetInstanceNameById;

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Fetch the specified service settings 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].pScheduleGetInstanceNameById 
 ( @Id [INT]
 , @InstanceName [NVARCHAR] (128) OUTPUT ) 
AS
BEGIN

 SET NOCOUNT ON;

 SELECT @InstanceName = InstanceName
 FROM [SQLCfg].[tSchedule]
 WHERE [Id] = @Id;

END
GO

GRANT EXECUTE ON [SQLCfg].pScheduleGetInstanceNameById TO [SQLCfgReportingRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pScheduleDelete' )
 DROP PROCEDURE [SQLCfg].[pScheduleDelete];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Remove the archive schedule for an SQL instance 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pScheduleDelete] 
 ( @Id [INT] )
AS
BEGIN
 DECLARE @TextData [NVARCHAR](500);

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

 BEGIN TRY

  DELETE [SQLCfg].[tSchedule]
  WHERE [Id] = @Id;

 END TRY

 BEGIN CATCH

  SET @TextData = '   @Id = ' + ISNULL(CAST(@Id AS [VARCHAR] (10)),'NULL');
  EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH; 

END
GO

GRANT EXECUTE ON [SQLCfg].[pScheduleDelete] TO [SQLCfgAdminRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pScheduleSelectAll' )
 DROP PROCEDURE [SQLCfg].[pScheduleSelectAll];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Fetch the archive Schedules for all SQL Instances 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/10/2009     bw                 remove QueryBaseline references 
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pScheduleSelectAll] 
AS
BEGIN

 SET NOCOUNT ON;

 SELECT [Id] 
  , [InstanceName]
  , [Interval]
  , [IntervalType]
  , [IntervalBaseDt]
  , [UseEventNotifications]
  , [IsActive]
 FROM [SQLCfg].[tSchedule]
 ORDER BY [InstanceName]
  , [IntervalBaseDt]
  , [Id];

END
GO

GRANT EXECUTE ON [SQLCfg].[pScheduleSelectAll] TO [SQLCfgReportingRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pScheduleSelectAllWithLastNbrItemsProcessed' )
 DROP PROCEDURE [SQLCfg].[pScheduleSelectAllWithLastNbrItemsProcessed];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Fetch the archive Schedules for all SQL Instances include the
**          NbrItemsProcessed from the last execution for the schedule or
**          -1 if no history found. 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/10/2009     bw                 remove QueryBaseline references 
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pScheduleSelectAllWithLastNbrItemsProcessed] 
AS
BEGIN

 SET NOCOUNT ON;
--what if plandomized?
 SELECT s.[Id] 
  , s.[InstanceName]
  , s.[Interval]
  , s.[IntervalType]
  , s.[IntervalBaseDt]
  , s.[UseEventNotifications]
  , s.[IsActive]
  , ISNULL((SELECT  Top 1 [NbrItemsProcessed]             
            FROM [SQLCfg].[tArchiveLog]
            WHERE [ScheduleId] = s.[Id]
            ORDER BY [ActualStartDt] Desc), -1) AS [LastNbrItemsProcessed]
 FROM [SQLCfg].[tSchedule] s
 ORDER BY [InstanceName]
  , [IntervalBaseDt]
  , [Id];

END
GO

GRANT EXECUTE ON [SQLCfg].[pScheduleSelectAllWithLastNbrItemsProcessed] TO [SQLCfgReportingRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pScheduleSelectAllForInstance' )
 DROP PROCEDURE [SQLCfg].[pScheduleSelectAllForInstance];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Fetch the archive Schedules for all SQL Instances
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/10/2009     bw                 remove QueryBaseline references 
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pScheduleSelectAllForInstance] 
 ( @InstanceName [NVARCHAR] (128) )
AS
BEGIN

 SET NOCOUNT ON;

 SELECT [Id] 
  , [InstanceName]
  , [Interval]
  , [IntervalType]
  , [IntervalBaseDt]
  , [UseEventNotifications]
  , [IsActive]
 FROM [SQLCfg].[tSchedule] 
 WHERE [InstanceName] = @InstanceName;

END
GO

GRANT EXECUTE ON [SQLCfg].[pScheduleSelectAllForInstance] TO [SQLCfgReportingRole];

GO 


IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pServiceSettingsSelect' )
 DROP PROCEDURE [SQLCfg].[pServiceSettingsSelect];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Fetch the specified service settings 
**    Note: Will only be one row. Used as a result set here for consistency in 
**          the table adapters (and much less text in the proc!) 
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pServiceSettingsSelect] 
 ( @Name [NVARCHAR] (128) = 'DEFAULT' ) 
AS
BEGIN

 SET NOCOUNT ON;

 SELECT [Name]
  , [AddDatabasesUponDiscovery]
  , [TargetEventNotificationDatabase]
  , [Scripting__Options_Batch__Separator]
  , [Misc_Ignore__Blank__Lines]
  , [Misc_Display__Output_Show__Comparison__Details]
  , [Scripting__Options_Include__DROP__In__Script]
  , [Scripting__Options_Include__IF__EXISTS__With__Drop]
  , [Misc_Display__Output_Show__Scripts__For__Unmatched__Items]
  , [Regular__Expressions_LineReplace__Regex__Options_IgnoreCase_5]
  , [Regular__Expressions_LineReplace__Regex__Options_Multiline_7]
  , [Regular__Expressions_LineReplace__Regex__Options_ExplicitCapture_4]
  , [Regular__Expressions_LineReplace__Regex__Options_Compiled_1]
  , [Regular__Expressions_LineReplace__Regex__Options_SingleLine_9]
  , [Regular__Expressions_LineReplace__Regex__Options_IgnorePatternWhiteSpace_6]
  , [Regular__Expressions_LineReplace__Regex__Options_RightToLeft_8]
  , [Regular__Expressions_LineReplace__Regex__Options_ECMAScript_3]
  , [Regular__Expressions_LineReplace__Regex__Options_CultureInvariant_2]
  , [Regular__Expressions_LineReplace__Pattern_1]
  , [Regular__Expressions_LineReplace__Replacement_2]
  , [Regular__Expressions_LineSplit__Regex__Options_IgnoreCase_5]
  , [Regular__Expressions_LineSplit__Regex__Options_Multiline_7]
  , [Regular__Expressions_LineSplit__Regex__Options_ExplicitCapture_4]
  , [Regular__Expressions_LineSplit__Regex__Options_Compiled_1]
  , [Regular__Expressions_LineSplit__Regex__Options_SingleLine_9]
  , [Regular__Expressions_LineSplit__Regex__Options_IgnorePatternWhiteSpace_6]
  , [Regular__Expressions_LineSplit__Regex__Options_RightToLeft_8]
  , [Regular__Expressions_LineSplit__Regex__Options_ECMAScript_3]
  , [Regular__Expressions_LineSplit__Regex__Options_CultureInvariant_2]
  , [Regular__Expressions_LineSplit__Pattern_3]
  , [Regular__Expressions_NameMatch__Regex__Options_IgnoreCase_5]
  , [Regular__Expressions_NameMatch__Regex__Options_Multiline_7]
  , [Regular__Expressions_NameMatch__Regex__Options_ExplicitCapture_4]
  , [Regular__Expressions_NameMatch__Regex__Options_Compiled_1]
  , [Regular__Expressions_NameMatch__Regex__Options_SingleLine_9]
  , [Regular__Expressions_NameMatch__Regex__Options_IgnorePatternWhiteSpace_6]
  , [Regular__Expressions_NameMatch__Regex__Options_RightToLeft_8]
  , [Regular__Expressions_NameMatch__Regex__Options_ECMAScript_3]
  , [Regular__Expressions_NameMatch__Regex__Options_CultureInvariant_2]
  , [Regular__Expressions_NameMatch__Pattern_4]
  , [Scripting__Options_SMO_AgentAlertJob_1]
  , [Scripting__Options_SMO_AgentJobId_2]
  , [Scripting__Options_SMO_AgentNotify_3]
  , [Scripting__Options_SMO_AllowSystemObjects_10]
  , [Scripting__Options_SMO_AnsiFile_20]
  , [Scripting__Options_SMO_AnsiPadding_30]
  , [Scripting__Options_SMO_BatchSize_35]
  , [Scripting__Options_SMO_Bindings_40]
  , [Scripting__Options_SMO_ChangeTracking_45]
  , [Scripting__Options_SMO_ClusteredIndexes_50]
  , [Scripting__Options_SMO_ContinueScriptingOnError_60]
  , [Scripting__Options_SMO_ConvertUserDefinedDataTypesToBaseType_70]
  , [Scripting__Options_SMO_DdlBodyOnly_80]
  , [Scripting__Options_SMO_DdlHeaderOnly_90]
  , [Scripting__Options_SMO_Default_100]
  , [Scripting__Options_SMO_DriAll_110]
  , [Scripting__Options_SMO_DriAllConstraints_120]
  , [Scripting__Options_SMO_DriAllKeys_130]
  , [Scripting__Options_SMO_DriChecks_140]
  , [Scripting__Options_SMO_DriClustered_150]
  , [Scripting__Options_SMO_DriDefaults_160]
  , [Scripting__Options_SMO_DriForeignKeys_170]
  , [Scripting__Options_SMO_DriIncludeSystemNames_180]
  , [Scripting__Options_SMO_DriIndexes_190]
  , [Scripting__Options_SMO_DriNonClustered_200]
  , [Scripting__Options_SMO_DriPrimaryKey_210]
  , [Scripting__Options_SMO_DriUniqueKeys_220]
  , [Scripting__Options_SMO_DriWithNoCheck_230]
  , [Scripting__Options_SMO_Encoding_240]
  , [Scripting__Options_SMO_EnforceScriptingOptions_250]
  , [Scripting__Options_SMO_ExtendedProperties_260]
  , [Scripting__Options_SMO_FullTextCatalogs_270]
  , [Scripting__Options_SMO_FullTextindexes_280]
  , [Scripting__Options_SMO_FullTextStopLists_285]
  , [Scripting__Options_SMO_IncludeDatabaseContext_290]
  , [Scripting__Options_SMO_IncludeDatabaseRoleMemberships_291]
  , [Scripting__Options_SMO_IncludeFullTextCatalogRootPath_295]
  , [Scripting__Options_SMO_IncludeHeaders_300]
  , [Scripting__Options_SMO_IncludeIfNotExists_301]
  , [Scripting__Options_SMO_Indexes_310]
  , [Scripting__Options_SMO_LoginSID_320]
  , [Scripting__Options_SMO_NoAssemblies_330]
  , [Scripting__Options_SMO_NoCollation_340]
  , [Scripting__Options_SMO_NoCommandTerminator_350]
  , [Scripting__Options_SMO_NoExecuteAs_360]
  , [Scripting__Options_SMO_NoFilegroup_370]
  , [Scripting__Options_SMO_NoFileStream_373]
  , [Scripting__Options_SMO_NoFileStreamColumn_376]
  , [Scripting__Options_SMO_NoIdentities_380]
  , [Scripting__Options_SMO_NoIndexPartitioningSchemes_390]
  , [Scripting__Options_SMO_NoMailProfileAccounts_400]
  , [Scripting__Options_SMO_NoMailProfilePrincipals_410]
  , [Scripting__Options_SMO_NonClusteredIndexes_420]
  , [Scripting__Options_SMO_NoTablePartitioningSchemes_430]
  , [Scripting__Options_SMO_NoVarDecimal_431]
  , [Scripting__Options_SMO_NoViewColumns_440]
  , [Scripting__Options_SMO_NoXMLNameSpaces_450]
  , [Scripting__Options_SMO_OptimizerData_460]
  , [Scripting__Options_SMO_Permissions_470]
  , [Scripting__Options_SMO_PrimaryObject_480]
  , [Scripting__Options_SMO_SchemaQualify_490]
  , [Scripting__Options_SMO_SchemaQualifyForeignKeysReferences_500]
  , [Scripting__Options_SMO_ScriptBatchTerminator_502]
  , [Scripting__Options_SMO_ScriptData_503]
  , [Scripting__Options_SMO_ScriptDataCompression_505]
  , [Scripting__Options_SMO_ScriptDrops_506]
  , [Scripting__Options_SMO_ScriptOwner_508]
  , [Scripting__Options_SMO_ScriptSchema_509]
  , [Scripting__Options_SMO_Statistics_510]
  , [Scripting__Options_SMO_TimestampToBinary_520]
  , [Scripting__Options_SMO_TargetServerVersion_530]
  , [Scripting__Options_SMO_Triggers_540]
  , [Scripting__Options_SMO_WithDependencies_550]
  , [Scripting__Options_SMO_XMLIndexes_560]
 FROM [SQLCfg].[tServiceSettings]
 WHERE [Name] = @Name;

END
GO

GRANT EXECUTE ON [SQLCfg].[pServiceSettingsSelect] TO [SQLCfgReportingRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pChangeInsert' )
 DROP PROCEDURE [SQLCfg].[pChangeInsert];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Add a row indicating a change in managed configuration. Used
**        when a server pull identifies a difference and when a change event 
**        notification is received 
**       
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pChangeInsert] 
 ( @Node [NVARCHAR] (786)
 , @Action [NVARCHAR] (30)
 , @EventData [XML]
 , @Definition [VARCHAR] (MAX)
 , @ChangeId [INT] OUTPUT  
 , @Version [INT] OUTPUT )
AS
BEGIN
 DECLARE @TextData [NVARCHAR](500)
  , @ScopeId [INT];

 /*
 rely upon the implicit transaction.  
 keep this to one DML statement in the ap transaction 
 this is to protect the target server Service Broker's integrity
 causes the errorlogging to be lost if we cancel the txn on the SQLClue host
 because aborting the container transaction in pLogSQLError aborts the Try/Catch 
 DO NOT USE XACT_ABORT so that fatal error will then roll back the queue reader 
 no benefit to OUTPUT clause due to trigger
 */
 SET NOCOUNT ON;

  INSERT [SQLCfg].[tChange] 
   ( [Node]
   , [EventData]
   , [Definition]
   , [Action])
  VALUES 
  ( CASE WHEN RIGHT(@Node,1) = '|' THEN  LEFT(@Node, LEN(@Node) - 1) ELSE @Node END
  , CONVERT(XML, '<ROOT>' + CONVERT([NVARCHAR](MAX), @EventData) + '</ROOT>') 
  , @Definition
  , @Action);
  
  IF @@ROWCOUNT = 1 
   SELECT @ChangeId = [Id]
    , @Version = [Version] 
   FROM [SQLCfg].[tChange]
   WHERE [Node] = @Node
   AND [Version] = [SQLCfg].[fLastVersion](@Node);  
  
  -- if a database has been deleted, need to delete all scripts for that db
  
  
END
GO

GRANT EXECUTE ON [SQLCfg].[pChangeInsert] TO [SQLCfgServiceRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pChangeAppendEvent' )
 DROP PROCEDURE [SQLCfg].[pChangeAppendEvent];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: update a change row with the current eventdata of an event originated 
**       configuration change. When there is more than one event associated with 
**       a change all events should go into the same rows EventData
**    
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pChangeAppendEvent] 
 ( @ChangeId [INT]
 , @Action [NVARCHAR] (30)
 , @EventData [XML] )
AS
BEGIN
 DECLARE @TextData [NVARCHAR](500)
  , @DDLEvents AS XML;

 /*
 when called async by archive, the error is lost when it fails in a Try/Catch here
 only one DML statement and the ap transaction used to protect the
 target server Service Broker causes the errorlogging to be lost so
 aborting the container transaction aborts the Try/Catch and never logs
 */

 SET NOCOUNT ON;
 
  ---- change events can be applied to Add or Change
  SELECT @DDLEvents = [EventData]  
  FROM [SQLCfg].[tChange] WHERE [Id] = @ChangeId;

  -- intention is that proc is never called unless row exists
  IF @@ROWCOUNT = 1 
   BEGIN
    -- XQuery limitation
    -- .modify a non-NULL valued XML column 
    -- assign to a NULL XML column  
    IF @DDLEvents IS NOT NULL
     SET @DDLEvents = CONVERT( XML
                             , REPLACE(CONVERT( NVARCHAR(MAX)
                                              , @DDLEvents)
                                              , N'</ROOT>',CONVERT(NVARCHAR(MAX), @EventData) + N'</ROOT>'));  
     -- XQuery in SQL Server 2008 but wont compile on 2005 host
     --SET @DDLEvents.modify(N'insert sql:variable("@EventData") as last into (/Root)[1]')
    ELSE
     SET @DDLEvents = CONVERT( XML
                              , N'<ROOT>' + CONVERT(NVARCHAR(MAX)
                              , @EventData) + N'</ROOT>');  
   -- should always end up with the last action and date in that results in unchanged definition
    UPDATE [SQLCfg].[tChange]
    SET [EventData] = @DDLEvents
     , [Action] = @Action
     , [DefinitionDt] = ISNULL(@EventData.[value]('(/EVENT_INSTANCE/PostTime)[1]', '[DATETIME]' ), CURRENT_TIMESTAMP) 
    WHERE [Id] = @ChangeId;
    IF @@ROWCOUNT = 0
     RAISERROR ('Event only update to [SQLCfg].[tChange] failed. Action: "%s" ChangeId: [%d]', 16,1, @Action, @ChangeId);
   END

  ELSE
    BEGIN
     SET @TextData = '   @ChangId = ' + CONVERT([NVARCHAR](10), @ChangeId) + CHAR(13) + CHAR(10)
                   + ' , @EventData = ''' + CONVERT([NVARCHAR](MAX), @EventData) + '''';
     EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;
     RAISERROR ('Expected [SQLCfg].[tChange] row not found. Action: "%s" ChangeId: [%d]', 16,1, @Action, @ChangeId);
    END
END
GO

GRANT EXECUTE ON [SQLCfg].[pChangeAppendEvent] TO [SQLCfgServiceRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pChangeApplyLabel' )
 DROP PROCEDURE [SQLCfg].[pChangeApplyLabel];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: associate the current versions at a specific time of all item 
**       Optionally, inclued the definitions for all children of the  
**       specified configuration hierarcy. Primary use case will be to label
**       and instance or database hierarchy 
** Note: NULL label text may be valid, even IF bad style. In this case the label
**       would include a reference to the current user and system time 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/28/2009     bw                 changed to ISO8601 date conversion           
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pChangeApplyLabel] 
 ( @ChangeId [INT]
 , @IncludeChildren [BIT] = 1
 , @Label [NVARCHAR] (MAX) = NULL 
 , @Notes [NVARCHAR] (MAX) = NULL
 , @LabelVersionDate [DATETIME] = NULL)
AS
BEGIN
 DECLARE @LabelId [INT]
  , @RootNode [SQLCfgNode]
  , @LabeledChangeId [INT]
  , @ApLockResource [NVARCHAR] (255)
  , @ApLockMode [NVARCHAR] (32)
  , @ApLockOwner [NVARCHAR] (32)
  , @rc [INT]
  , @rrc [INT]
  , @TextData [NVARCHAR] (MAX);

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

 BEGIN TRY

   BEGIN TRAN
    
     -- if a LabelVersionDate has been provided, get the id of the version of the Change node for that date
     -- if no LabelVersionDate provided then label the most recent version(s) 
     SELECT @LabeledChangeId = [Id]
      , @RootNode = [Node] 
     FROM [SQLCfg].[tChange]
     WHERE [Id] = (SELECT CASE WHEN @LabelVersionDate IS NULL THEN MAX([Id]) ELSE MIN([Id]) END 
                   FROM [SQLCfg].[tChange] 
                   WHERE [Node] = (SELECT [Node] 
                                   FROM [SQLCfg].[tChange]
                                   WHERE [Id] = @ChangeId
                                   AND [RecCreatedDt] > ISNULL(@LabelVersionDate,0)));

     -- create the label
     INSERT [SQLCfg].[tLabel] 
      ( [IncludeChildren]
      , [Label]
      , [Notes])
     VALUES( @IncludeChildren
      , ISNULL(@Label, 'labeled at ' + CAST(CURRENT_TIMESTAMP AS [VARCHAR] (30)) + ' by ' + ORIGINAL_LOGIN())
      , @Notes);

     SET @LabelId = SCOPE_IDENTITY();

     -- apply the label
     INSERT [SQLCfg].[tChangeLabel] ([LabelId], [ChangeId])
     SELECT @LabelId 
      , CASE WHEN @LabelVersionDate IS NULL THEN MAX([Id]) ELSE MIN([Id]) END 
     FROM [SQLCfg].[tChange]
     WHERE CHARINDEX(@RootNode.ToString(), [Node].ToString()) = 1
     AND (@IncludeChildren = 1 OR [Id] = @LabeledChangeId)
     AND [RecCreatedDt] > ISNULL(@LabelVersionDate,0)
     GROUP BY [Node];

   COMMIT TRAN;
  END TRY

  BEGIN CATCH

   SET @TextData = '   @ChangeId = ' + ISNULL(CAST(@ChangeId AS [VARCHAR] (10)),'NULL') + CHAR(13) + CHAR(10)
                 + ' , @IncludeChildren = ' + ISNULL(CAST(@IncludeChildren AS [VARCHAR] (6)),'NULL') + CHAR(13) + CHAR(10)
                 + ' , @Label = ' + ISNULL(CHAR(39) + @Label + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                 + ' , @Notes = <varchar(max)>' + CHAR(13) + CHAR(10)
                 + ' , @LabelVersionDate = ' + ISNULL(CHAR(39) + CAST(@LabelVersionDate AS VARCHAR(20)) + CHAR(39),'NULL');
   EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH;

END
GO

GRANT EXECUTE ON [SQLCfg].[pChangeApplyLabel] TO [SQLCfgAdminRole];

GO

IF EXISTS (SELECT * 
       FROM INFORMATION_SCHEMA.ROUTINES 
       WHERE SPECIFIC_SCHEMA = N'SQLCfg'
       AND SPECIFIC_NAME = N'pChangePurgeInstance' )
 DROP PROCEDURE [SQLCfg].[pChangePurgeInstance];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: Jan 18, 2010
**
**    Desc: completey remove a targeted SQL Server from the archive 
**          ArchiveLog rows are not removed
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
** 
*******************************************************************************/
CREATE PROCEDURE [SQLCfg].[pChangePurgeInstance] 
 ( @InstanceName [NVARCHAR] (128))
WITH EXECUTE AS OWNER -- needed to disable triggers 
AS
BEGIN
 DECLARE @TextData [NVARCHAR] (MAX);

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

 BEGIN TRY

   BEGIN TRAN
    
    DELETE [SQLCfg].[tChangeLabel]
    WHERE [ChangeId] IN (SELECT [ChangeId]
                         FROM [SQLCfg].[tChange] 
                         WHERE [Node].[SQLInstance] = @InstanceName) 
       
    -- do not log anything, it would be deleted else inaccessible anyway
    ALTER TABLE [SQLCfg].[tServiceBroker]
    DISABLE TRIGGER ALL

     DELETE [SQLCfg].[tServiceBroker] 
     WHERE [InstanceName] = @InstanceName
    
    ALTER TABLE [SQLCfg].[tServiceBroker]
    ENABLE TRIGGER ALL

    ALTER TABLE [SQLCfg].[tDb]
    DISABLE TRIGGER ALL

     DELETE [SQLCfg].[tDb] 
     WHERE [InstanceName] = @InstanceName

    ALTER TABLE [SQLCfg].[tDb]
    ENABLE TRIGGER ALL

    ALTER TABLE [SQLCfg].[tJobServer]
    DISABLE TRIGGER ALL
 
     DELETE [SQLCfg].[tJobServer] 
     WHERE [InstanceName] = @InstanceName

    ALTER TABLE [SQLCfg].[tJobServer]
    ENABLE TRIGGER ALL

    ALTER TABLE [SQLCfg].[tInstance]
    DISABLE TRIGGER ALL
 
     DELETE [SQLCfg].[tInstance] 
     WHERE [Name] = @InstanceName

    ALTER TABLE [SQLCfg].[tInstance]
    ENABLE TRIGGER ALL

    ALTER TABLE [SQLCfg].[tChange]
    DISABLE TRIGGER ALL

     DELETE [SQLCfg].[tChange] 
     WHERE [Node].[SQLInstance] = @InstanceName
         
    ALTER TABLE [SQLCfg].[tChange]
    ENABLE TRIGGER ALL

    IF EXISTS (SELECT * 
               FROM [SQLCfg].[tSchedule]
               WHERE [InstanceName] = @InstanceName
               AND [UseEventNotifications] = 1)
     RAISERROR ('Important! Run script [uninstSQLClueDDLEventNotifications.sql] from the "SQLClue Application Resources" 
script library in the SQLClue Notification db (msdb is the default) on SQL Server %s to remove Event 
Notification configuration. ', 1, 1, @InstanceName) 

    ALTER TABLE [SQLCfg].[tSchedule]
    DISABLE TRIGGER ALL

     DELETE [SQLCfg].[tSchedule]
     WHERE [InstanceName] = @InstanceName 

    ALTER TABLE [SQLCfg].[tSchedule]
    ENABLE TRIGGER ALL

    ALTER TABLE [SQLCfg].[tConnection]
    DISABLE TRIGGER ALL
     
     DELETE [SQLCfg].[tConnection]
     WHERE [InstanceName] = @InstanceName
     
    ALTER TABLE [SQLCfg].[tConnection]
    ENABLE TRIGGER ALL

    -- decriment the licensed instance count
    UPDATE [SQLCfg].[tSQLCfg]
    SET [LicensedInstanceCount] = [LicensedInstanceCount] - 1 

   COMMIT TRAN;

  END TRY
   
  BEGIN CATCH

   SET @TextData = '  @InstanceName = ' + ISNULL(CHAR(39) + CAST(@InstanceName AS VARCHAR(128)) + CHAR(39),'NULL');
   EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH;

END
GO

GRANT EXECUTE ON [SQLCfg].[pChangePurgeInstance] TO [SQLCfgAdminRole];

GO
IF EXISTS ( SELECT * 
            FROM INFORMATION_SCHEMA.ROUTINES 
            WHERE SPECIFIC_SCHEMA = N'SQLCfg'
            AND SPECIFIC_NAME = N'pArchiveLogSelectScheduleHistoryByScheduleId' )
 DROP PROCEDURE [SQLCfg].[pArchiveLogSelectScheduleHistoryByScheduleId];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: get the history for an archive Schedule
**       
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/10/2009     bw                 remove QueryBaseline add ArchiveError 
**              
*******************************************************************************/
CREATE Procedure [SQLCfg].[pArchiveLogSelectScheduleHistoryByScheduleId]
 ( @ScheduleId [INT]
 , @BeginDt [DATETIME]
 , @EndDt [DATETIME])
AS
BEGIN

 SET NOCOUNT ON;
 
    SELECT l.[Id] AS [ArchiveLogId]
    , l.[ScheduleId]
    , l.[InstanceName]
    , l.[NbrDDLEventsProcessed]
    , l.[NbrItemsProcessed]
    , l.[NbrItemsAdded]
    , l.[NbrItemsChanged]
    , l.[NbrItemsDeleted]
    , l.[ScheduledStartDt]
    , l.[ActualStartDt]
    , l.[ActualEndDt] 
    , l.[RecCreatedUser]
    , l.[ArchiveError]
    , s1.[Interval]
    , s1.[IntervalType]
    , s1.[IntervalBaseDt]
    , s1.[UseEventNotifications]
    , s1.[IsActive]
   FROM [SQLCfg].[tArchiveLog] l
   JOIN [SQLCfg].[tSchedule] s1
   ON l.[ScheduleId] = s1.[Id] 
   WHERE s1.[Id] = @ScheduleId
   AND (   l.[ScheduledStartDt] BETWEEN @BeginDt AND @EndDt
        OR l.[ActualStartDt]    BETWEEN @BeginDt AND @EndDt); 

END;

GO

GRANT EXECUTE ON [SQLCfg].[pArchiveLogSelectScheduleHistoryByScheduleId] TO [SQLCfgReportingRole];

GO

IF EXISTS ( SELECT * 
            FROM INFORMATION_SCHEMA.ROUTINES 
            WHERE SPECIFIC_SCHEMA = N'SQLCfg'
            AND SPECIFIC_NAME = N'pArchiveLogSelectScheduleHistory' )
 DROP PROCEDURE [SQLCfg].[pArchiveLogSelectScheduleHistory];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: get the history for a SQL Server
**       
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE Procedure [SQLCfg].[pArchiveLogSelectScheduleHistory]
 ( @SQLInstance [NVARCHAR] (128)
 , @BeginDt [DATETIME]
 , @EndDt [DATETIME])
AS
BEGIN

 SET NOCOUNT ON;
 
    SELECT l.[Id] AS [ArchiveLogId]
    , l.[ScheduleId]
    , l.[InstanceName]
    , l.[NbrDDLEventsProcessed]
    , l.[NbrItemsProcessed]
    , l.[NbrItemsAdded]
    , l.[NbrItemsChanged]
    , l.[NbrItemsDeleted]
    , l.[ScheduledStartDt]
    , l.[ActualStartDt]
    , l.[ActualEndDt] 
    , l.[RecCreatedUser]
    , l.[ArchiveError]
    , s1.[Interval]
    , s1.[IntervalType]
    , s1.[IntervalBaseDt]
    , s1.[UseEventNotifications]
    , s1.[IsActive]
   FROM [SQLCfg].[tArchiveLog] l
   JOIN [SQLCfg].[tSchedule] s1
   ON l.[ScheduleId] = s1.[Id] 
   WHERE s1.[InstanceName] = @SQLInstance
   AND (   l.[ScheduledStartDt] BETWEEN @BeginDt AND @EndDt
        OR l.[ActualStartDt]    BETWEEN @BeginDt AND @EndDt); 

END;

GO

GRANT EXECUTE ON [SQLCfg].[pArchiveLogSelectScheduleHistory] TO [SQLCfgReportingRole];

GO

IF EXISTS ( SELECT * 
            FROM INFORMATION_SCHEMA.ROUTINES 
            WHERE SPECIFIC_SCHEMA = N'SQLCfg'
            AND SPECIFIC_NAME = N'pArchiveLogSelectSQLInstanceHistoryByScheduleId' )
 DROP PROCEDURE [SQLCfg].[pArchiveLogSelectSQLInstanceHistoryByScheduleId];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: get all history for an instance based on archive ScheduleId
**       
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/10/2009     bw                 remove QueryBaseline add ArchiveError 
**              
*******************************************************************************/

CREATE Procedure [SQLCfg].[pArchiveLogSelectSQLInstanceHistoryByScheduleId]
 ( @ScheduleId [INT]
 , @BeginDt [DATETIME]
 , @EndDt [DATETIME])
AS
BEGIN

 SET NOCOUNT ON;
 
    SELECT l.[Id] AS [ArchiveLogId]
    , l.[ScheduleId]
    , l.[InstanceName]
    , l.[NbrDDLEventsProcessed]
    , l.[NbrItemsProcessed]
    , l.[NbrItemsAdded]
    , l.[NbrItemsChanged]
    , l.[NbrItemsDeleted]
    , l.[ScheduledStartDt]
    , l.[ActualStartDt]
    , l.[ActualEndDt] 
    , l.[RecCreatedUser]
    , l.[ArchiveError]
    , s2.[Interval]
    , s2.[IntervalType]
    , s2.[IntervalBaseDt]
    , s2.[UseEventNotifications]
    , s2.[IsActive]
   FROM [SQLCfg].[tArchiveLog] l
   JOIN [SQLCfg].[tSchedule] s1
   ON l.[InstanceName] = s1.[InstanceName] 
   JOIN [SQLCfg].[tSchedule] s2
   ON s2.[Id] = l.[ScheduleId]
   WHERE s1.[Id] = @ScheduleId
   AND (   l.[ScheduledStartDt] BETWEEN @BeginDt AND @EndDt
        OR l.[ActualStartDt]    BETWEEN @BeginDt AND @EndDt); 

END;

GO

GRANT EXECUTE ON [SQLCfg].[pArchiveLogSelectSQLInstanceHistoryByScheduleId] TO [SQLCfgReportingRole];

GO

IF EXISTS ( SELECT * 
            FROM INFORMATION_SCHEMA.ROUTINES 
            WHERE SPECIFIC_SCHEMA = N'SQLCfg'
            AND SPECIFIC_NAME = N'pArchiveLogInsert' )
 DROP PROCEDURE [SQLCfg].[pArchiveLogInsert];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Add a summary record for an archive
**       
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/10/2009     bw                 add ArchiveError and alert message          
**
*******************************************************************************/

CREATE Procedure [SQLCfg].[pArchiveLogInsert]
 ( @ScheduleId [INT]
  , @InstanceName [NVARCHAR] (128)
  , @NbrDDLEventsProcessed [INT]
  , @NbrItemsProcessed [INT]
  , @NbrItemsAdded [INT]
  , @NbrItemsChanged [INT]
  , @NbrItemsDeleted [INT]
  , @ScheduledStartDt [DATETIME]   
  , @ActualStartDt [DATETIME]  
  , @ActualEndDt [DATETIME] 
  , @ArchiveError [VARCHAR] (MAX))
AS
BEGIN

 DECLARE @TextData [NVARCHAR] (MAX)
       , @LogId [INT];

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

  BEGIN TRY

   INSERT [SQLCfg].[tArchiveLog]
    ( [ScheduleId]
    , [InstanceName]
    , [NbrDDLEventsProcessed]
    , [NbrItemsProcessed]
    , [NbrItemsAdded]
    , [NbrItemsChanged]
    , [NbrItemsDeleted]
    , [ScheduledStartDt]
    , [ActualStartDt]
    , [ActualEndDt] 
    , [ArchiveError])
   VALUES
    ( @ScheduleId 
    , UPPER(@InstanceName) 
    , @NbrDDLEventsProcessed
    , @NbrItemsProcessed
    , @NbrItemsAdded
    , @NbrItemsChanged
    , @NbrItemsDeleted
    , @ScheduledStartDt
    , @ActualStartDt
    , @ActualEndDt 
    , NULLIF(@ArchiveError, '')); -- does no good use a sparse column if empty string is always inserted

    SET @LogId = SCOPE_IDENTITY()

    /*
      the message text must match the keyword of the alert   
      the user can create alerts for individual schedules by specifying enough of
      the message text to identify the schedule in the alert @event_description_keyword 
      example: 'SQLClue SQL Configuration Archive Exception: Schedule Id 18'
      Only configuration of 2 general alerts on archive success or failure are supported
      by the SQLClue Console's Archive Alert Notification dialog. All other Archive alerts 
      must be configured by the user.  
     */ 
    If NULLIF(@ArchiveError, '') IS NULL 
     RAISERROR ('SQLClue SQL Configuration Archive Complete: Schedule Id %d, Archive Log Id %d',1,1,@ScheduleId, @LogId) WITH LOG
    ELSE
     RAISERROR ('SQLClue SQL Configuration Archive Exception: Schedule Id %d, Archive Log Id %d',9,1,@ScheduleId, @LogId) WITH LOG
    
  END TRY

  BEGIN CATCH

   SET @TextData = '   @ScheduleId = ' + ISNULL(CAST(@ScheduleId AS [VARCHAR] (10)),'NULL') + CHAR(13) + CHAR(10)
                 + ' , @InstanceName = ' + ISNULL(CHAR(39) + @InstanceName + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                 + ' , @NbrDDLEventsProcessed = ' + ISNULL(CAST(@NbrDDLEventsProcessed AS [VARCHAR] (10)),'NULL') + CHAR(13) + CHAR(10)
                 + ' , @NbrItemsProcessed = ' + ISNULL(CAST(@NbrItemsProcessed AS [VARCHAR] (10)),'NULL') + CHAR(13) + CHAR(10)
                 + ' , @NbrItemsAdded = ' + ISNULL(CAST(@NbrItemsAdded AS [VARCHAR] (10)),'NULL') + CHAR(13) + CHAR(10)
                 + ' , @NbrItemsChanged = ' + ISNULL(CAST(@NbrItemsChanged AS [VARCHAR] (10)),'NULL') + CHAR(13) + CHAR(10)
                 + ' , @NbrItemsDeleted = ' + ISNULL(CAST(@NbrItemsDeleted AS [VARCHAR] (10)),'NULL') + CHAR(13) + CHAR(10)
                 + ' , @ScheduledStartDt = ' + ISNULL(CHAR(39) + CAST(@ScheduledStartDt AS [VARCHAR] (21)),'NULL') + CHAR(13) + CHAR(10)
                 + ' , @ActualStartDt = ' + ISNULL(CHAR(39) + CAST(@ActualStartDt AS [VARCHAR] (21)) + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                 + ' , @ActualEndDt = ' + ISNULL(CHAR(39) + CAST(@ActualEndDt AS [VARCHAR] (21)) + CHAR(39),'NULL')
                 + ' , @ArchiveError = ' + ISNULL(CHAR(39) + @ArchiveError  + CHAR(39),'NULL');
    EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH;

END;

GO

GRANT EXECUTE ON [SQLCfg].[pArchiveLogInsert] TO [SQLCfgServiceRole];

GO

If EXISTS (SELECT *
           FROM msdb.dbo.sysalerts
           WHERE name = 'SQLClue: SQL Configuration Archive Succeeded')
 EXEC msdb.dbo.sp_delete_alert @name = 'SQLClue: SQL Configuration Archive Succeeded'             
GO

-- by default the alert does not fire, use UI or SSMS to enable  
-- notification must be configured - can use SQLClue UI for simple notification
-- to set up separate alert for individual schedules - add schedule id to name & message   
EXEC msdb.dbo.sp_add_alert @name = 'SQLClue: SQL Configuration Archive Succeeded' 
     , @message_id = 0 
     , @severity = 1 
     , @enabled = 0
     , @notification_message = 'Archive notifications can be enabled/disabled from the SQLClue Console'  
     , @event_description_keyword = 'SQLClue SQL Configuration Archive Complete:' 

GO

If EXISTS (SELECT *
           FROM msdb.dbo.sysalerts
           WHERE name = 'SQLClue: SQL Configuration Archive Failed')
 EXEC msdb.dbo.sp_delete_alert @name = 'SQLClue: SQL Configuration Archive Failed'             
GO

-- by default the alert is active, use UI or SSMS to disable  
-- notification must be configured - can use SQLClue UI for simple notification
EXEC msdb.dbo.sp_add_alert @name = 'SQLClue: SQL Configuration Archive Failed' 
     , @message_id = 0 
     , @severity = 9  
     , @enabled = 1
     , @notification_message = 'See the Application Event Log and the ArchiveLog table for additional details.'  
     , @event_description_keyword = 'SQLClue SQL Configuration Archive Exception:' 

GO

IF EXISTS ( SELECT * 
            FROM INFORMATION_SCHEMA.ROUTINES 
            WHERE SPECIFIC_SCHEMA = N'SQLCfg'
            AND SPECIFIC_NAME = N'pChangeActionSummaryByNodeForDays' )
 DROP PROCEDURE [SQLCfg].[pChangeActionSummaryByNodeForDays];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Get the number of changes for the last @DaysToShow days
**       optionally filter by Instance, Database, Schema, ItemType and/or Name
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/28/2009     bw                 remove locale specific date conversion          
**              
*******************************************************************************/

CREATE Procedure [SQLCfg].[pChangeActionSummaryByNodeForDays]
 ( @DaysToShow [INT] = 30 
 , @Node [NVARCHAR] (786) = 'All' )
AS
BEGIN

SET NOCOUNT ON;

SELECT [Node].[SQLInstance] As [SQLInstance] 
 , [Node].[Type] As [Type]
 , CAST([RecCreatedDt] AS [DATE]) AS [Date]
 , CASE WHEN @Node = 'All' THEN 'All Nodes' ELSE @Node END AS [Node]
    , Count(*) AS [TotalChangeCount] 
 , SUM(CASE WHEN Action = 'Include' THEN 1 ELSE 0 END) AS [MetadataRowInserts] 
 , SUM(CASE WHEN Action = 'Modify' THEN 1 ELSE 0 END) AS [MetadataRowUpdates] 
 , SUM(CASE WHEN Action = 'Remove' THEN 1 ELSE 0 END) AS [MetadataRowDeletes] 
 , SUM(CASE WHEN Action = 'Add' THEN 1 ELSE 0 END) AS [SQLConfigurationAdded] 
 , SUM(CASE WHEN Action = 'Change' THEN 1 ELSE 0 END) AS [SQLConfigurationChanged] 
 , SUM(CASE WHEN Action = 'Delete' THEN 1 ELSE 0 END) AS [SQLConfigurationRemoved] 
FROM [SQLCfg].[tChange]
WHERE [RecCreatedDt] > CAST(CURRENT_TIMESTAMP - @DaysToShow AS [DATE])
AND [Node] = CASE WHEN @Node = 'All' THEN [Node] ELSE @Node END
GROUP BY [Node].[SQLInstance], [Node].[Type]
 , CAST([RecCreatedDt] AS [DATE])
ORDER BY [Date]
 , [SQLInstance]
 , [Type];

END
GO

GRANT EXECUTE ON [SQLCfg].[pChangeActionSummaryByNodeForDays] TO [SQLCfgReportingRole];

GO
IF EXISTS ( SELECT * 
            FROM INFORMATION_SCHEMA.ROUTINES 
            WHERE SPECIFIC_SCHEMA = N'SQLCfg'
            AND SPECIFIC_NAME = N'pChangeActionByNodeForDays' )
 DROP PROCEDURE [SQLCfg].[pChangeActionByNodeForDays];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Get the list of changes for the last @DaysToShow days
**       optionally filter by Instance, Database, Schema, ItemType and/or Name
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/28/2009     bw                 remove locale specific date conversion          
**              
*******************************************************************************/

CREATE Procedure [SQLCfg].[pChangeActionByNodeForDays]
 ( @DaysToShow [INT] = 30 
 , @Node [NVARCHAR] (786) = 'All' )
AS
BEGIN

SET NOCOUNT ON;

SELECT [Node].[SQLInstance] As [SQLInstance] 
 , [Node].[Type] As [Type]
 , CAST([RecCreatedDt] AS [DATE]) AS [Date]
 , CASE WHEN @Node = 'All' THEN 'All Nodes' ELSE @Node END AS [Node]
 , Action 
FROM [SQLCfg].[tChange]
WHERE [RecCreatedDt] > CAST(CURRENT_TIMESTAMP - @DaysToShow AS [DATE])
AND [Node] = CASE WHEN @Node = 'All' THEN [Node] ELSE @Node END
ORDER BY [Date], [SQLInstance], [Type];

END
GO

GRANT EXECUTE ON [SQLCfg].[pChangeActionByNodeForDays] TO [SQLCfgReportingRole];

GO 

IF EXISTS ( SELECT * 
            FROM INFORMATION_SCHEMA.ROUTINES 
            WHERE SPECIFIC_SCHEMA = N'SQLCfg'
            AND SPECIFIC_NAME = N'pChangesForDate' )
 DROP PROCEDURE [SQLCfg].[pChangesForDate];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: List items changed for a date
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/28/2009     bw                 remove locale specific date conversion          
**                                      include change type and action filters 
*******************************************************************************/

CREATE Procedure [SQLCfg].[pChangesForDate]
 ( @ChangeDate [DATETIME]
 , @SQLInstance [NVARCHAR] (786)
 , @NodeType [NVARCHAR] (30)
 , @Action [NVARCHAR] (30))
AS
BEGIN

SET NOCOUNT ON;

SELECT Id 
 , [Node].ToString() AS [Node]
 , [Node].[Database] AS [Database]
 , [Node].[Collection] AS [Collection]
 , [Node].[Item] AS [ChangeItem]
 , [Version]
 , [Action]
 , [RecCreatedDt]
FROM [SQLCfg].[tChange]
WHERE Node.SQLInstance = @SQLInstance
AND [Node].[Type] = CASE WHEN @NodeType = 'All' THEN [Node].[Type] ELSE @NodeType END
AND [Action] = CASE WHEN @Action = 'All' THEN [Action] ELSE @Action END
AND CAST([RecCreatedDt] AS [DATE]) = CAST(ISNULL(@ChangeDate, CURRENT_TIMESTAMP) AS [DATE])
ORDER BY [Database] DESC, [Collection] DESC, [ChangeItem] DESC; 

END
GO

GRANT EXECUTE ON [SQLCfg].[pChangesForDate] TO [SQLCfgReportingRole];

GO 

IF EXISTS ( SELECT * 
            FROM INFORMATION_SCHEMA.ROUTINES 
            WHERE SPECIFIC_SCHEMA = N'SQLCfg'
            AND SPECIFIC_NAME = N'pChangesForArchive' )
 DROP PROCEDURE [SQLCfg].[pChangesForArchive];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: The items represented by the count of the tArchiveLog row
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    
*******************************************************************************/

CREATE Procedure [SQLCfg].[pChangesForArchive]
 ( @ArchiveLogId [INT]
 , @RootNode [NVARCHAR] (786))
AS
BEGIN

SET NOCOUNT ON;

SELECT c.Id 
 , c.[Node].ToString() AS [Node]
 , c.[Node].[Database] AS [Database]
 , c.[Node].[Collection] AS [Collection]
 , c.[Node].[Item] AS [ChangeItem]
 , c.[Version]
 , c.[Action]
 , c.[RecCreatedDt]
FROM [SQLCfg].[tChange] c
JOIN [SQLCfg].[tArchiveLog] l
ON c.[RecCreatedDt] BETWEEN l.[ActualStartDt] AND l.[ActualEndDt]
WHERE l.[Id] = @ArchiveLogId
AND CHARINDEX(@RootNode, c.Node.ToString()) = 1
ORDER BY c.[Node].[Database] DESC
 , c.[Node].[Collection] DESC
 , c.[Node].[Item] DESC; 

END
GO

GRANT EXECUTE ON [SQLCfg].[pChangesForArchive] TO [SQLCfgReportingRole];

GO 

IF EXISTS ( SELECT * 
            FROM INFORMATION_SCHEMA.ROUTINES 
            WHERE SPECIFIC_SCHEMA = N'SQLCfg'
            AND SPECIFIC_NAME = N'pChangeHistoryByItem' )
 DROP PROCEDURE [SQLCfg].[pChangeHistoryByItem];
GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: List changes on server for an item, most recent changes first
**       Business rule, any thing older than @DaystoShow will not be 
**       considered as candididate for the 'revert' status. Instead a 
**       new - and possibly duplicated version - will be added.
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/28/2009     bw                 remove locale specific date conversion          
**
*******************************************************************************/
CREATE Procedure [SQLCfg].[pChangeHistoryByItem]
 ( @Node [NVARCHAR] (786)
 , @DaysToShow [INT] = 10000 )
AS
BEGIN

SET NOCOUNT ON;

SELECT [Id] 
 , [Version]
 , [Action]
 , CAST([RecCreatedDt] AS [DATE]) AS [Date]
FROM [SQLCfg].[tChange]
WHERE [Node] = @Node
AND [RecCreatedDt] > CAST(CURRENT_TIMESTAMP - @DaysToShow AS [DATE])
ORDER BY [Id] DESC; 

END
GO

GRANT EXECUTE ON [SQLCfg].[pChangeHistoryByItem] TO [SQLCfgReportingRole];

GO 

IF EXISTS ( SELECT * 
            FROM INFORMATION_SCHEMA.ROUTINES 
            WHERE SPECIFIC_SCHEMA = N'SQLCfg'
            AND SPECIFIC_NAME = N'pChangeLatestByItem' )
 DROP PROCEDURE [SQLCfg].[pChangeLatestByItem];

GO

/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Fetch last archived change definition for an item
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**
*******************************************************************************/
CREATE Procedure [SQLCfg].[pChangeLatestByItem]
 ( @Node [NVARCHAR] (786) 
 , @Id [INT] OUTPUT
 , @Definition [NVARCHAR] (MAX) OUTPUT ) 
AS
BEGIN

SET NOCOUNT ON;

-- do not output nulls
SET @Id = 0;
SET @Definition = '';

SELECT @Id = Id
 , @Definition = Definition 
FROM (SELECT Top 1 [Id], [Definition] 
      FROM [SQLCfg].[tChange]
      WHERE [Node] = @Node
      ORDER BY [Id] DESC) derived; 

END
GO

GRANT EXECUTE ON [SQLCfg].[pChangeLatestByItem] TO [SQLCfgReportingRole];

GO 

IF EXISTS ( SELECT * 
            FROM INFORMATION_SCHEMA.ROUTINES 
            WHERE SPECIFIC_SCHEMA = N'SQLCfg'
            AND SPECIFIC_NAME = N'pChangeSelectDefinitionByVersion' )
 DROP PROCEDURE [SQLCfg].[pChangeSelectDefinitionByVersion]; 

GO

/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Fetch an archived change definition 
**          Output parms not used because this is called by report server
**          need same out columns as pChangeSelectDefinitionById
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**
*******************************************************************************/
CREATE Procedure [SQLCfg].[pChangeSelectDefinitionByVersion] 
 ( @Node [NVARCHAR] (786)
 , @Version [INT] ) 
AS
BEGIN

 SET NOCOUNT ON;

 SELECT c.[Id]
  , c.[Node].ToString() AS [Node]
  , c.[Node].[Item] AS [Item]
  , c.[Node].[Type] AS [Type]
  , c.[Version]
  , c.[Action]
  , IsNull(c.[EventData],'') AS [EventData]
  , c.[Definition]
  , c.[DefinitionDt]
  , c.[RecCreatedDt] 
  , c1.[MinVersion]
  , c1.[MaxVersion]
 FROM [SQLCfg].[tChange] c
 JOIN (SELECT [Node]
        , Min([Version]) AS [MinVersion]
        , Max([Version]) AS [MaxVersion] 
       FROM [SQLCfg].[tChange]
       GROUP BY [Node]) c1
 ON c.[Node] = c1.[Node] 
 WHERE c.[Node] = @Node
 AND c.[Version] = @Version;

END
GO

GRANT EXECUTE ON [SQLCfg].[pChangeSelectDefinitionByVersion] TO [SQLCfgReportingRole];

GO 

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pChangeSelectLastestBySQLInstance' )
 DROP PROCEDURE [SQLCfg].[pChangeSelectLastestBySQLInstance];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Get a list of the most recent nodes on a server  
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pChangeSelectLastestBySQLInstance] 
 ( @SQLInstance [NVARCHAR](128) )
AS
BEGIN

    SELECT [Id]
     , [Action]
     , [Type]
     , [SubType]
     , [SQLInstance]
     , [Database]
     , [Collection]
     , [Item]
    FROM (SELECT c.[Id] AS [Id]
           , c.[Action] AS [Action]
           , c.[Node].[Type] AS [Type]
           , c.[Node].[SubType] AS [SubType]
           , c.[Node].[SQLInstance] AS [SQLInstance]
           , c.[Node].[Database] AS [Database]
           , c.[Node].[Collection] AS [Collection]
           , c.[Node].[Item] AS [Item]
          FROM [SQLCfg].[tChange] c
          JOIN (SELECT MAX([Version]) as [Version], [Node] 
                FROM [SQLCfg].[tChange]
                WHERE [Node].[SQLInstance] = @SQLInstance 
                AND [Node].[Type] = 'SQLInstance' 
                GROUP BY [Node]) AS latest
          ON c.[Node] = latest.[Node]
          AND c.[Version] = latest.[Version]) derived
    ORDER BY CASE WHEN [SubType] = 'Server' THEN 1
                  WHEN [SubType] = 'JobServer' THEN 2
                  ELSE 3 END
     , [Database] 
     , [Collection]
     , [Item];
 
END

GO

GRANT EXECUTE ON [SQLCfg].[pChangeSelectLastestBySQLInstance] TO [SQLCfgReportingRole];

GO

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pChangeGetLatestHierarchyForInstance' )
 DROP PROCEDURE [SQLCfg].[pChangeGetLatestHierarchyForInstance];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Get a list of the most recent nodes on a server  
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    Jan 16, 2010   bw                 sorting done in application       
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pChangeGetLatestHierarchyForInstance] 
 ( @SQLInstance [NVARCHAR](128) )
AS
BEGIN

    SELECT c.[Node].ToString() AS [TreeViewNodePath]
     , c.[Id] AS [ChangeId]  
     , latest.[Version]  
    FROM [SQLCfg].[tChange] c
    JOIN (SELECT MAX([Version]) as [Version], [Node]
          FROM [SQLCfg].[tChange]
          GROUP BY [Node]) AS latest
    ON c.[Node] = latest.[Node]
    AND c.Version = latest.Version
    WHERE c.[Node].[SQLInstance] = @SQLInstance 
    AND c.[Node].[Type] = 'SQLInstance'


END
GO

GRANT EXECUTE ON [SQLCfg].[pChangeGetLatestHierarchyForInstance] TO [SQLCfgReportingRole]

GO

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pChangeSelectByContains' )
 DROP PROCEDURE [SQLCfg].[pChangeSelectByContains];

GO

/******************************************************************************
**    Auth: Bill Wunder
**    Date: January 21, 2010
**
**    Desc: all archive nodes matching the specified CONTAINS predicate    
**       
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/
CREATE PROCEDURE [SQLCfg].[pChangeSelectByContains] 
 ( @SearchString [NVARCHAR] (4000)
 , @LatestVersion [Bit]
 , @Type [NVARCHAR] (12))
AS
BEGIN

    SELECT c.[Node].[SQLInstance] AS [SQLInstance]
        , c.[Node].[Type] AS [Type]
        , c.[Node].[SubType] AS [SubType]
        , c.[Node].[Database] AS [Database]
        , c.[Node].[Collection] As [Collection]
        , c.[Node].[Item] AS [Item]
        , c.[Version] as [Version]
        , c.[Node].ToString() as [Node]
    FROM SQLCfg.tChange c
    LEFT JOIN (SELECT MAX([Version]) as [Version], [Node]
               FROM [SQLCfg].[tChange]
               GROUP BY [Node]) AS latest
    ON c.[Node] = latest.[Node]
    AND c.[Version] = latest.[Version]
    WHERE c.[Node].[Type]  = @Type 
    AND (CONTAINS((c.[Definition]), @SearchString)
         OR CHARINDEX(REPLACE(REPLACE(REPLACE(@SearchString, '"', ''),'[',''),']',''), c.[Node].ToString()) > 1)
    AND (@LatestVersion = 0 
         OR c.[Version] = latest.[Version])
    ORDER BY [Node], [Version]

END
GO

GRANT EXECUTE ON [SQLCfg].[pChangeSelectByContains] TO [SQLCfgReportingRole];

GO

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pChangeGetAllNodesForInstance' )
 DROP PROCEDURE [SQLCfg].[pChangeGetAllNodesForInstance];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: list of all repository nodes for a SQL Server  
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pChangeGetAllNodesForInstance] 
 ( @SQLInstance [NVARCHAR](128) )
AS
BEGIN

 SELECT [Id]
  , [Node]
  , [Database]
  , [SubType]
  , [Collection]
  , [Item]
  , [Length]
  , [Version]
  , [Action]
  , [HasEventData] 
  , [ChangeDate]
 FROM (SELECT [Id]
        , [Node].ToString() AS [Node]
        , ISNULL([Node].[Database],'') AS [Database]
        , [Node].[SubType] AS [SubType]
        , [Node].[Collection] AS [Collection]
        , [Node].[Item] AS [Item]
        , [Node].[Length] AS [Length]
        , [Version]
        , [Action]
        , CASE WHEN [EventData] IS NULL THEN 0 ELSE 1 END AS [HasEventData] 
        , ISNULL([DefinitionDt], [RecCreatedDt]) AS [ChangeDate]
       FROM [SQLCfg].[tChange]
       WHERE [Node].[Type] = 'SQLInstance'
       AND [Node].[SQLInstance] = @SQLInstance) derived
 ORDER BY [Database] ASC
  , CASE WHEN [SubType] = 'Server' Then 1
         WHEN [SubType] = 'JobServer' Then 2
         WHEN [SubType] = 'Database' Then 3
         WHEN [SubType] = 'ServiceBroker' Then 4
         END  
  , [Collection] ASC
  , [Item] ASC
  , [Version] DESC;

END
GO

GRANT EXECUTE ON [SQLCfg].[pChangeGetAllNodesForInstance] TO [SQLCfgReportingRole];

GO

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pChangeGetLatestItemsForNode' )
 DROP PROCEDURE [SQLCfg].[pChangeGetLatestItemsForNode];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Get a list of the most recent nodes on a server  
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pChangeGetLatestItemsForNode] 
 ( @Node [NVARCHAR](786) )
AS
BEGIN

  -- exploits that versions and changeids are always increasing
  SELECT MAX(c.Id) AS [ChangeId]
   , c.[Node]
   , c.[Node].[Item] as [Item]
   , MAX(c.[Version]) as [Version]
    FROM [SQLCfg].[tChange] c
  WHERE c.[Node].[Type] = 'SQLInstance' 
  AND c.[Node].Path = @Node  
  GROUP BY [Node]
  ORDER BY [Item];

END
GO

GRANT EXECUTE ON [SQLCfg].[pChangeGetLatestItemsForNode] TO [SQLCfgReportingRole];

GO

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pChangeSelectNodesForDateRange' )
 DROP PROCEDURE [SQLCfg].[pChangeSelectNodesForDateRange];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: changes that occurred on an instance during a time interval
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pChangeSelectNodesForDateRange] 
 ( @BeginDt [DATETIME]
 , @EndDt [DATETIME] )
AS
BEGIN

  --assert: versions and changeids are always increasing
  SELECT c.[Node].[SQLInstance] AS [SQLInstance]
   , COUNT(c.[Action]) AS [NbrChanges]
   , SUM(CASE WHEN c.[Action] = 'Add' THEN 1 ELSE 0 END) AS [Add]
   , SUM(CASE WHEN c.[Action] = 'Change' THEN 1 ELSE 0 END) AS [Change] 
   , SUM(CASE WHEN c.[Action] = 'Delete' THEN 1 ELSE 0 END) AS [Delete]
   , CAST(c.[RecCreatedDt] AS [DATE]) AS [RecordDate]
  FROM [SQLCfg].[tChange] c
  WHERE c.[Node].[Type] = 'SQLInstance' 
  AND c.[RecCreatedDt] BETWEEN @BeginDt AND @EndDt  
  GROUP BY c.[Node].[SQLInstance]
   , CAST(c.[RecCreatedDt] AS [DATE])
  ORDER BY [RecordDate];

END
GO

GRANT EXECUTE ON [SQLCfg].[pChangeSelectNodesForDateRange] TO [SQLCfgReportingRole];

GO

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pChangeSelectLatestByNodeParent' )
 DROP PROCEDURE [SQLCfg].[pChangeSelectLatestByNodeParent];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Get a list of the most recent immediate descendants (1 level only)   
**       
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/
CREATE PROCEDURE [SQLCfg].[pChangeSelectLatestByNodeParent] 
 ( @NodeParent [NVARCHAR] (786) )
AS
BEGIN

SELECT [Node].[Item]
 , MAX([Version]) AS [Version]  
FROM [SQLCfg].[tChange]
WHERE [Node].[Path] = @NodeParent 
GROUP BY [Node]	    	    
ORDER By [Node].[Item];

END
GO

GRANT EXECUTE ON [SQLCfg].[pChangeSelectLatestByNodeParent] TO [SQLCfgReportingRole];

GO

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pChangeGetLastCountByNodeParent' )
 DROP PROCEDURE [SQLCfg].[pChangeGetLastCountByNodeParent];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Get a count of all latest version nodes under a hierarchy level   
**       
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/
CREATE PROCEDURE [SQLCfg].[pChangeGetLastCountByNodeParent] 
 ( @NodeParent [NVARCHAR] (786)
 , @NbrDescendents [INT] OUTPUT )
AS
BEGIN
 SELECT @NbrDescendents = COUNT(c.[Node].[Item])  
 FROM [SQLCfg].[tChange] c  
 JOIN (SELECT MAX([Version]) AS [Version], [Node]   
       FROM [SQLCfg].[tChange]  
       WHERE [Node].ToString() Like @NodeParent + '%'   
       GROUP BY [Node]) AS latest  
 ON c.[Node] = latest.[Node]  
 AND c.[Version] = latest.[Version];  
 
 SELECT @NbrDescendents = COUNT(c.[Node].[Item])
 FROM [SQLCfg].[tChange] c
 JOIN (SELECT MAX([Version]) AS [Version], [Node] 
       FROM [SQLCfg].[tChange]
       WHERE [Node].[Path] = @NodeParent 
       GROUP BY [Node]) AS latest
 ON c.[Node] = latest.[Node]
 AND c.[Version] = latest.[Version];
 
END

GO

GRANT EXECUTE ON [SQLCfg].[pChangeGetLastCountByNodeParent] TO [SQLCfgReportingRole];

GO

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pChangeSelectDatabaseListForInstance' )
 DROP PROCEDURE [SQLCfg].[pChangeSelectDatabaseListForInstance];

GO

/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: all databases containing archive records on an SQL Server instance    
**       
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/
CREATE PROCEDURE [SQLCfg].[pChangeSelectDatabaseListForInstance] 
 ( @SQLInstance [NVARCHAR] (128) )
AS
BEGIN

SELECT DISTINCT [Node].[Database] AS [DatabaseName]
FROM [SQLCfg].[tChange]
WHERE [Node].[SQLInstance] = @SQLInstance
ORDER BY [Node].[Database]

END
GO

GRANT EXECUTE ON [SQLCfg].[pChangeSelectDatabaseListForInstance] TO [SQLCfgReportingRole];

GO

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pChangeSelectScheduleListForInstance' )
 DROP PROCEDURE [SQLCfg].[pChangeSelectScheduleListForInstance];

GO

/******************************************************************************
**    Auth: Bill Wunder
**    Date: January 21, 2010
**
**    Desc: Node path for all schedules that belong to a SQL Server instance    
**       
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**              
*******************************************************************************/
CREATE PROCEDURE [SQLCfg].[pChangeSelectScheduleListForInstance] 
 ( @SQLInstance [NVARCHAR] (128) )
AS
BEGIN

    SELECT Distinct [Node].[Path] AS [CfgCollection]
    FROM SQLCfg.tChange 
    WHERE [Node].[Type]  = 'metadata' 
    AND [Node].[SubType] = 'Schedule'
    AND [Node].[Item] = @SQLInstance
    ORDER BY [CfgCollection]

END
GO

GRANT EXECUTE ON [SQLCfg].[pChangeSelectScheduleListForInstance] TO [SQLCfgReportingRole];

GO

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pSQLErrorLogSelectMostRecent' )
 DROP PROCEDURE [SQLCfg].[pSQLErrorLogSelectMostRecent];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Get the SQL errors for the the last n days  
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**    11/28/2009     bw                 add date conversion          
**              
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pSQLErrorLogSelectMostRecent] 
 ( @DaysToGet [INT] = 30 )
AS
BEGIN

 SELECT [UserName]
  , [DBName]
  , [ErrorNumber]
  , [ErrorSeverity]
  , [ErrorState]
  , [ErrorProcedure]
  , [ErrorLine]
  , [ErrorMessage]
  , [TextData]
  , [Notes]
  , [RecCreatedDt] 
 FROM [SQLCfg].[tSQLErrorLog]  
 WHERE [RecCreatedDt] > CAST(CURRENT_TIMESTAMP - @DaysToGet AS DATE);
 
END
GO

GRANT EXECUTE ON [SQLCfg].[pSQLErrorLogSelectMostRecent] TO [SQLCfgReportingRole];

GO

IF EXISTS ( SELECT * 
            FROM INFORMATION_SCHEMA.ROUTINES 
            WHERE SPECIFIC_SCHEMA = N'SQLCfg'
            AND SPECIFIC_NAME = N'pInstanceInit' )
 DROP PROCEDURE [SQLCfg].[pInstanceInit];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Init the scripting actions for a specified remote server  
**       state for the Repository SQL Instance. Relies on db/called proc  
**       defaults. Called at setup. Idempotent. All metadata inserts are 
**       serialized using the 'Create SQLConfigRepository Metadata' applock 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pInstanceInit]
 ( @InstanceName [NVARCHAR](128)
 , @VersionMajor [INT]
 , @EngineEdition [INT])
AS
BEGIN
 DECLARE @rc [INT]
  , @TextData [NVARCHAR] (500)
  , @Use2005Features [BIT]
  , @Use2008Features [BIT]
  , @HasJobServer [BIT];

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

 BEGIN TRY

  SET @InstanceName = UPPER(@InstanceName)
  
  -- Express and MSDE have no jobserver
  IF @EngineEdition in (1,4)
   SET @HasJobServer = 0;
  ELSE
   SET @HasJobServer = 1;

  IF @VersionMajor < 9
   SET @Use2005Features = 0
  ELSE
   SET @Use2005Features = 1

  IF @VersionMajor < 10
   SET @Use2008Features = 0
  ELSE
   SET @Use2008Features = 1

  BEGIN TRAN

   -- server
   EXEC @rc = [SQLCfg].[pInstanceInsert] @Name = @InstanceName
                                          , @ActiveDirectory  = @Use2005Features
                                          , @Audits = @Use2008Features
                                          , @BackupDevices = 1
                                          , @Configuration = 1
                                          , @Credentials = @Use2005Features
                                          , @CryptographicProviders = @Use2008Features
                                          , @Databases = 1
                                          , @EndPoints = @Use2005Features
                                          , @FullTextService = @Use2005Features
                                          , @Information = 1
                                          , @JobServer = @HasJobServer
                                          , @Logins = 1
                                          , @LinkedServers = 1
                                          , @Mail = @Use2005Features
                                          , @ProxyAccount = @Use2005Features
                                          , @ResourceGovernor = @Use2008Features
                                          , @Roles = 1
                                          , @ServerAuditSpecifications = @Use2008Features
                                          , @Settings = 1
                                          , @Triggers = @Use2005Features
                                          , @UserDefinedMessages = 1;
   IF @rc <> 0
    RAISERROR('[SQLCfg].[pInstanceInsert] Insert Failed @rc: %d; SQLInstance: %s',16,1, @rc, @InstanceName);   

   -- SQLExpress has no JobServer support
   EXEC @rc = [SQLCfg].[pJobServerInsert] @InstanceName = @InstanceName
                                           , @Alerts = @HasJobServer
                                           , @AlertSystem = @HasJobServer
                                           , @Jobs = @HasJobServer
                                           , @Operators = @HasJobServer
                                           , @ProxyAccounts = @HasJobServer
                                           , @TargetServers = @HasJobServer;
                             
                                             
   IF @rc <> 0
    RAISERROR('[SQLCfg].[pJobServerInsert] Insert Failed @rc: %d; SQLInstance: %s',16,1, @rc, @InstanceName);  

   COMMIT TRAN;
  END TRY

  BEGIN CATCH

  SET @TextData = '   @InstanceName = ' + ISNULL(CHAR(39) + @InstanceName + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                + ' , @VersionMajor = ' + ISNULL(CAST(@VersionMajor AS [VARCHAR] (10)),'NULL') + CHAR(13) + CHAR(10)
                + ' , @EngineEdition = ' + ISNULL(CAST(@EngineEdition AS [VARCHAR] (10)),'NULL'); 
  EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

 END CATCH;

END
GO

GRANT EXECUTE ON [SQLCfg].[pInstanceInit] TO [SQLCfgAdminRole];

GO

IF EXISTS ( SELECT * 
            FROM INFORMATION_SCHEMA.ROUTINES 
            WHERE SPECIFIC_SCHEMA = N'SQLCfg'
            AND SPECIFIC_NAME = N'pDbInit' )
 DROP PROCEDURE [SQLCfg].[pDbInit];

GO

/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Init the scripting actions for a specified database. Idempotent.  
**       All metadata DMA is serialized using the 'Create   
**       SQLConfigRepository Metadata' applock 
**
** Note: default configuration of new databases on managed instances will 
**       use db level options specified here. Changing the values here will
**       affect settings for all new databases added by application.  
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pDbInit]
 ( @InstanceName [NVARCHAR](128)
 , @DBName [NVARCHAR](128)
 , @VersionMajor [INT])
AS
BEGIN
 DECLARE @rc [INT]
  , @TextData [NVARCHAR] (500) 
  , @Use2005Features [BIT]
  , @Use2008Features [BIT];

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

 SET @InstanceName = UPPER(@InstanceName) 

  -- for best security sample databases should never be installed in a production or Internet exposed system
  IF @DBName NOT IN ('tempdb') --'AdventureWorks','AdventureWorksDB','AdventureWorksLT','AdventureWorksLTSub','Pubs','Northwind'
  AND NOT EXISTS(SELECT * FROM [SQLCfg].[tDb] WHERE [Name] = @DBName AND [InstanceName] = @InstanceName) 
   BEGIN 

    BEGIN TRY

     IF @VersionMajor < 9
      SET @Use2005Features = 0;
     ELSE
      SET @Use2005Features = 1;

     IF @VersionMajor < 10
      SET @Use2008Features = 0;
     ELSE
      SET @Use2008Features = 1;

      BEGIN TRAN

       -- add any databases to this list that should get the restricted system db scripting options
       -- additiional branches could be added if there are databases that should get a different
       -- but fixed option set. 
       IF @DBName IN ('master','msdb','distribution','ReportServer', 'ReportServerTempDB')
        BEGIN  
          -- changing the table defaults is not recommended! change here instead 
          -- for increased security and maintainability, user configuration should 
          -- not be created in "System" databases  
          EXEC @rc = [SQLCfg].[pDbInsert] @Name = @DBName
                                            , @InstanceName = @InstanceName
                                            , @ActiveDirectory = @Use2005Features
                                            , @ApplicationRoles = 1
                                            , @Assemblies = @Use2005Features
                                            , @AsymmetricKeys = @Use2005Features
                                            , @Certificates = @Use2005Features
                                            , @DatabaseAuditSpecifications = @Use2008Features
                                            , @DatabaseOptions = 1
                                            , @Defaults = 0
                                            , @FullTextCatalogs = 0
                                            , @FullTextStopLists = 0
                                            , @PartitionFunctions = 0
                                            , @PartitionSchemes = 0
                                            , @PlanGuides = 0
                                            , @Roles = 1
                                            , @Rules = 0
                                            , @Schemas = @Use2005Features
                                            , @ServiceBroker = @Use2005Features
                                            , @StoredProcedures = 1
                                            , @SymmetricKeys = @Use2005Features
                                            , @Synonyms = @Use2005Features
                                            , @Tables = 1
                                            , @Triggers = 1
                                            , @UserDefinedAggregates = 0
                                            , @UserDefinedDataTypes = 1
                                            , @UserDefinedFunctions = 1
                                            , @UserDefinedTableTypes = 0
                                            , @UserDefinedTypes = 0
                                            , @Users = 1
                                            , @Views = 0 
                                            , @XMLSchemaCollections = 0;
           END
          ELSE -- everything else is a "User" database
           BEGIN
            IF (SELECT AddDatabasesUponDiscovery FROM SQLCfg.tServiceSettings WHERE Name = 'Default') = 1
               -- changing the table defaults is not recommended! 
              EXEC @rc = [SQLCfg].[pDbInsert] @Name = @DBName
                                               , @InstanceName = @InstanceName
                                               , @ActiveDirectory = @Use2005Features
                                               , @ApplicationRoles = 1
                                               , @Assemblies = @Use2005Features
                                               , @AsymmetricKeys = @Use2005Features
                                               , @Certificates = @Use2005Features
                                               , @DatabaseAuditSpecifications = @Use2008Features
                                               , @DatabaseOptions = 1
                                               , @Defaults = 1
                                               , @FullTextCatalogs = @Use2005Features
                                               , @FullTextStopLists = @Use2008Features
                                               , @PartitionFunctions = @Use2005Features
                                               , @PartitionSchemes = @Use2005Features
                                               , @PlanGuides = @Use2008Features
                                               , @Roles = 1
                                               , @Rules = 1
                                               , @Schemas = @Use2005Features
                                               , @ServiceBroker = @Use2005Features
                                               , @StoredProcedures = 1
                                               , @SymmetricKeys = @Use2005Features
                                               , @Synonyms = @Use2005Features
                                               , @Tables = 1
                                               , @Triggers = 1
                                               , @UserDefinedAggregates = @Use2005Features
                                               , @UserDefinedDataTypes = 1
                                               , @UserDefinedFunctions = 1
                                               , @UserDefinedTableTypes = @Use2008Features
                                               , @UserDefinedTypes = @Use2005Features
                                               , @Users = 1
                                               , @Views = 1
                                               , @XMLSchemaCollections = @Use2005Features;      
            ELSE
             BEGIN
              -- still need to insert the row, just set to do nothing if autodiscovery off
              EXEC @rc = [SQLCfg].[pDbInsert] @Name = @DBName
                                               , @InstanceName = @InstanceName
                                               , @ActiveDirectory = 0
                                               , @ApplicationRoles = 0
                                               , @Assemblies = 0
                                               , @AsymmetricKeys = 0
                                               , @Certificates = 0
                                               , @DatabaseAuditSpecifications = 0
                                               , @DatabaseOptions = 0
                                               , @Defaults = 0
                                               , @FullTextCatalogs = 0
                                               , @FullTextStopLists = 0
                                               , @PartitionFunctions = 0
                                               , @PartitionSchemes = 0
                                               , @PlanGuides = 0 
                                               , @Roles = 0
                                               , @Rules = 0
                                               , @Schemas = 0
                                               , @ServiceBroker = 0
                                               , @StoredProcedures = 0
                                               , @SymmetricKeys = 0
                                               , @Synonyms = 0
                                               , @Tables = 0
                                               , @Triggers = 0
                                               , @UserDefinedAggregates = 0
                                               , @UserDefinedDataTypes = 0
                                               , @UserDefinedFunctions = 0
                                               , @UserDefinedTableTypes = 0
                                               , @UserDefinedTypes = 0
                                               , @Users = 0
                                               , @Views = 0
                                               , @XMLSchemaCollections = 0;
              -- a little slight of hand to make the SB config go in as all off
              SET @Use2005Features = 0;      
             END
          END -- systen dbs get diff settings
         IF @rc <> 0
          RAISERROR('[SQLCfg].[pDbInsert] Failed @rc: %d',16,1, @rc);  
       
          -- could easily have implicit SB config in MSDB so add even to system dbs
          EXEC @rc = [SQLCfg].[pServiceBrokerInsert] @DatabaseName = @DBName
                                                      , @InstanceName = @InstanceName
                                                      , @MessageTypes = @Use2005Features
                                                      , @Priorities = @Use2008Features
                                                      , @Queues = @Use2005Features
                                                      , @RemoteServiceBindings = @Use2005Features
                                                      , @Routes = @Use2005Features
                                                      , @ServiceContracts = @Use2005Features
                                                      , @Services = @Use2005Features; 
          IF @rc <> 0
           RAISERROR('[SQLCfg].[pServiceBrokerInsert] Insert Failed @rc: %d',16,1, @rc);  

       COMMIT TRAN;
      END TRY

      BEGIN CATCH
 
       SET @TextData = '   @InstanceName = ' + ISNULL(CHAR(39) + @InstanceName + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                     + ' , @DbName = ' + ISNULL(CHAR(39) + @DbName + CHAR(39),'NULL') + CHAR(13) + CHAR(10)
                     + ' , @VersionMajor = ' + ISNULL(CAST(@VersionMajor AS [VARCHAR] (10)),'NULL');
      EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

     END CATCH;

  END -- tempdb no-op

END
GO

GRANT EXECUTE ON [SQLCfg].[pDbInit] TO [SQLCfgServiceRole];

GO

IF EXISTS ( SELECT * 
            FROM INFORMATION_SCHEMA.ROUTINES 
            WHERE SPECIFIC_SCHEMA = N'SQLCfg'
            AND SPECIFIC_NAME = N'pRepositoryInit' )
 DROP PROCEDURE [SQLCfg].[pRepositoryInit];

GO
/******************************************************************************
**    Auth: Bill Wunder
**    Date: April 1, 2007
**
**    Desc: Init the scripting actions for configuration sync with the current  
**       state for the Repository SQL Instance/db. Relies on db/called proc  
**       defaults. Called at setup. Idempotent. All metadata inserts are 
**       serialized using the 'Create SQLConfigRepository Metadata' applock 
**
*******************************************************************************
**    Change History
*******************************************************************************
**    Date           Author             Description of Change
**
*******************************************************************************/

CREATE PROCEDURE [SQLCfg].[pRepositoryInit]
AS
BEGIN
 DECLARE @rc [INT]
  , @rrc [INT]
  , @InstanceName [NVARCHAR] (128) 
  , @DBName [NVARCHAR] (128) 
  , @TextData [NVARCHAR] (500) 
  , @ApLockResource [NVARCHAR] (255)
  , @ApLockMode [NVARCHAR] (32)
  , @ApLockOwner [NVARCHAR] (32)
  , @VersionMajor [INT]
  , @EngineEdition [INT];

 SET XACT_ABORT ON;
 SET NOCOUNT ON;

 BEGIN TRY

  BEGIN TRAN
   
   SET @InstanceName = UPPER(@@SERVERNAME)
   
   SET @VersionMajor = LEFT(CAST(SERVERPROPERTY('ProductVersion') AS [VARCHAR](128))
                            , CHARINDEX('.', CAST(SERVERPROPERTY('ProductVersion') AS VARCHAR(128))) - 1);
   SET @EngineEdition = CAST(SERVERPROPERTY('EngineEdition') AS [INT]);

    -- metadata
    IF NOT EXISTS (SELECT * FROM [SQLCfg].[tSQLCfg])
     BEGIN
      EXEC @rc = [SQLCfg].[pSQLCfgInsert];
 
      IF @rc <> 0        
       RAISERROR('[SQLCfg].[pSQLCfgInsert] Failed with @rc: %d',16,1, @rc);
     END

    -- server
    IF NOT EXISTS (SELECT * FROM [SQLCfg].[tConnection] 
                   WHERE [InstanceName] = @InstanceName
                   AND [IsDeleted] = 0)
     BEGIN
      EXEC @rc = [SQLCfg].[pConnectionInsert] @InstanceName = @InstanceName
                                               , @EncryptedConnection = 0
                                               , @TrustServerCertificate = 0
                                               , @NetworkProtocol = 'dbmslpcn (Shared Memory)'
                                               , @ConnectionTimeout = 60
                                               , @LoginSecure = 1;

      IF @rc <> 0        
       RAISERROR('[SQLCfg].[pConnectionInsert] Failed with @rc: %d',16,1, @rc);
     END 

    If NOT EXISTS (SELECT * FROM [SQLCfg].[tServiceSettings])
     BEGIN
      -- set the service application settings 
      ALTER TABLE [SQLCfg].[tServiceSettings]
      DISABLE TRIGGER ALL;

      INSERT [SQLCfg].[tServiceSettings] (Name) VALUES('DEFAULT');

      ALTER TABLE [SQLCfg].[tServiceSettings]
      ENABLE TRIGGER ALL;
     END
 
    IF NOT EXISTS (SELECT * FROM [SQLCfg].[tInstance] 
                   WHERE [Name] = @InstanceName)
     BEGIN
      EXEC @rc = [SQLCfg].[pInstanceInit] @InstanceName = @InstanceName
                                        , @VersionMajor = @VersionMajor
                                        , @EngineEdition = @EngineEdition;     
      IF @rc <> 0        
       RAISERROR('[SQLCfg].[pInstanceInit] Failed with @rc: %d',16,1, @rc);  
     END 
     
    -- all databases
    SELECT @DBName = MIN([name]) 
    FROM [master].[sys].[databases] 
    WHERE [name] not in ('tempdb');

    WHILE @DBName IS NOT NULL
     BEGIN 
      -- assert: user objects are not created in system databases
      -- permissions configuration change will be captured by monitoring principals in those databases
      IF NOT EXISTS (SELECT * FROM [SQLCfg].[tDb] 
                     WHERE [InstanceName] = @InstanceName
                     AND [Name] = @DbName) 
        BEGIN  
         EXEC @rc = [SQLCfg].[pDbInit] @InstanceName = @InstanceName
                                        , @DBName = @DBName 
                                        , @VersionMajor = @VersionMajor;
         IF @rc <> 0
          RAISERROR('[SQLCfg].[pDbInsert] Failed at Database [%s] with @rc = d.',16,1, @DBName, @rc);  
        END 

      SELECT @DBName = MIN(name) 
      FROM [master].[sys].[databases]
      WHERE [name] > @DBName
      AND [name] NOT IN ('tempdb');
     END 

    -- label the init change history
    EXEC [SQLCfg].[pChangeApplyLabel] @ChangeId = 1
                                       , @IncludeChildren = 1
                                       , @Label ='Repository Init';

   COMMIT TRAN;

   -- if it ran successfully, don't want it around anymore
   EXEC sp_executesql N'DROP PROCEDURE [SQLCfg].[pRepositoryInit]';

  END TRY

  BEGIN CATCH

    SET @TextData = '';
    EXEC [SQLCfg].[pLogSQLError] @TextData, @@PROCID;

  END CATCH;

END

GO

IF EXISTS (SELECT * 
           FROM INFORMATION_SCHEMA.ROUTINES 
           WHERE SPECIFIC_SCHEMA = N'SQLCfg'
           AND SPECIFIC_NAME = N'pConfigurationCatalog' )
 DROP PROCEDURE [SQLCfg].[pConfigurationCatalog];

GO

/******************************************************************************
**	Auth: Bill Wunder
**	Date: April 1, 2007
**
**	Desc: Catalog of all current configuration items   
**
*******************************************************************************
**	Change History
*******************************************************************************
**	Date		   Author		     Description of Change
**	          
*******************************************************************************/
CREATE PROCEDURE [SQLCfg].[pConfigurationCatalog] 
AS
BEGIN

 SELECT [Node].[SQLInstance] AS [SQLInstance]
  , [Node].[Database] AS [Database]
  , [Node].[Type] AS [Type]
  , [Node].[SubType] AS [SubType]
  , [Node].[Collection] AS [Collection] 
  , [Node].[Item] AS [Item]
  , MAX([Version]) AS [Version]
  , [Node].ToString() AS [Node]
 FROM [SQLCfg].[tChange] c
 GROUP BY Node.ToString()
  , [Node].[SQLInstance]
  , [Node].[Database]
  , [Node].[Type]
  , [Node].[SubType]
  , [Node].[Collection]
  , [Node].[Item]
 ORDER BY Node.ToString()
  , [Node].[SQLInstance]
  , [Node].[Database]
  , [Node].[Type]
  , [Node].[SubType]
  , [Node].[Collection]
  , [Node].[Item];

END;
GO

GRANT EXECUTE ON [SQLCfg].[pConfigurationCatalog] TO [SQLCfgReportingRole];

GO

